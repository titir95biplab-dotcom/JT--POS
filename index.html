<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Juice Therapy - Smart POS</title>
    <meta name="theme-color" content="#FF6B35">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="logo.png" type="image/png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-messaging.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, query, where, orderBy, onSnapshot, serverTimestamp, increment, addDoc, runTransaction, Timestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCbHeWurSgxdE1cYFvTGsoyzpK7PQ_1Z0o", 
            authDomain: "jt-s-pos.firebaseapp.com",
            projectId: "jt-s-pos",
            storageBucket: "jt-s-pos.firebasestorage.app",
            messagingSenderId: "365172962139",
            appId: "1:365172962139:web:eaad048f98d2af1ff8207e"
        };

        const app = initializeApp(firebaseConfig);
        const messaging = getMessaging(app);
        window.auth = getAuth(app);
        window.db = getFirestore(app);
        window.firebaseModules = { 
            signInWithEmailAndPassword, signOut, onAuthStateChanged, 
            collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, addDoc, runTransaction,
            query, where, orderBy, onSnapshot, serverTimestamp, increment, Timestamp, getMessaging, getToken, onMessage, messaging 
        };
        window.firebaseReady = true;
    </script>
    
    <style>
        :root {
            --primary: #FF6B35;
            --secondary: #1A1A2E;
            --bg: #121212;
            --surface: #1E1E2E;
            --text: #FFFFFF;
            --text-muted: #A0A0A0;
            --success: #4CAF50;
            --danger: #FF5252;
            --warning: #FFC107;
            --info: #2196F3;
            --radius: 12px;
            --spacing: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Manrope', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background: var(--bg); color: var(--text); overflow-x: hidden; padding-bottom: 60px; }
        
        /* Utils */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }
        .font-bold { font-weight: bold; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }

        /* Components */
        .btn {
            padding: 12px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s;
            font-size: 0.95rem; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:active { transform: scale(0.98); }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; }
        .btn-danger { background: rgba(255, 82, 82, 0.2); color: var(--danger); }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: black; }
        .btn-info { background: var(--info); color: white; }
        
        .input {
            width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px; color: white; font-size: 1rem; margin-bottom: 10px;
        }
        .input:focus { outline: none; border-color: var(--primary); }

        .card { background: var(--surface); border-radius: var(--radius); padding: var(--spacing); margin-bottom: var(--spacing); }

        /* Login Screen */
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-box { width: 100%; max-width: 400px; text-align: center; }
        .logo { width: 120px; margin-bottom: 20px; }

        /* Header */
        header { background: var(--surface); padding: 15px; position: sticky; top: 0; z-index: 50; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }

        /* Layouts */
        .app-layout { max-width: 1200px; margin: 20px auto; padding: 0 15px; }

        /* POS Specific Layout */
        .pos-container { display: grid; grid-template-columns: 1fr 350px; gap: 20px; height: calc(100vh - 140px); }
        .pos-left { display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        
        .menu-area { display: grid; grid-template-columns: 110px 1fr; gap: 15px; flex: 1; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 10px; background: rgba(255,255,255,0.02); }
        
        .cat-sidebar { overflow-y: auto; padding-right: 5px; display: flex; flex-direction: column; gap: 8px; }
        .cat-btn { 
            padding: 10px 5px; font-size: 0.75rem; background: rgba(255,255,255,0.05); 
            border-radius: 6px; text-align: center; cursor: pointer; word-break: break-word; line-height: 1.2;
        }
        .cat-btn.active { background: var(--primary); color: white; font-weight: bold; }

        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; overflow-y: auto; align-content: start; padding-bottom: 50px; }
        /* Updated Item Card Design */
        .menu-item { 
            background: rgba(255,255,255,0.05); 
            border-radius: 12px; 
            cursor: pointer; 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
            height: 100%; 
            min-height: 110px; /* Increased height for better spacing */
            border: 1px solid transparent;
            overflow: hidden; /* Keeps everything inside the box */
            transition: transform 0.2s, background 0.2s;
            position: relative;
        }
        
        .menu-item:active { transform: scale(0.96); }
        .menu-item:hover { border-color: var(--primary); background: rgba(255,255,255,0.08); }

        /* Item Name Limit (prevents overflow) */
        .item-name-clamp {
            font-weight: 600; 
            font-size: 0.9rem; 
            line-height: 1.3;
            padding: 10px 10px 0 10px;
            
            /* Logic to cut off text after 3 lines */
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Price Section pinned to bottom */
        .item-price-tag {
            color: var(--primary); 
            font-weight: bold; 
            padding: 5px 10px 10px 10px;
            margin-top: auto; /* Pushes to bottom */
        }

        /* Cart Panel */
        .cart-panel { background: var(--surface); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; height: 100%; }
        .cart-items { flex: 1; overflow-y: auto; margin: 10px 0; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .qty-controls { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; padding: 2px; }
        .qty-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; }

        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { flex: 1; white-space: nowrap; }
        .tab-btn.active { background: var(--primary); }

        /* Order Cards */
        .order-card { padding: 15px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); margin-bottom: 10px; border-radius: 8px; }
        .order-status { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; font-weight: bold; }
        .status-requested { background: var(--info); color: white; }
        .status-pending { background: var(--warning); color: black; }
        .status-completed { background: var(--success); color: white; }
        .status-cancelled { background: var(--danger); color: white; }

        /* Admin Dashboard Cards */
        .stat-card { background: var(--surface); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .stat-value { font-size: 2rem; font-weight: bold; color: var(--primary); margin: 10px 0; }
        .stat-label { font-size: 0.9rem; color: var(--text-muted); }

        /* Install Button */
        #installBtn { position: fixed; bottom: 20px; right: 20px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.5); display: none; }

        /* Notification */
        #notification { position: fixed; top: 20px; right: 20px; background: #333; padding: 15px 25px; border-radius: 8px; z-index: 1000; transform: translateX(150%); transition: 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .pos-container { grid-template-columns: 1fr; height: auto; display: block; }
            .pos-left { height: 60vh; margin-bottom: 20px; }
            .menu-area { grid-template-columns: 80px 1fr; }
            .cart-panel { height: auto; }
            .header-content h2 { font-size: 1.2rem; }
            .item-grid { grid-template-columns: repeat(2, 1fr); }
            .grid-4 { grid-template-columns: 1fr 1fr; }
        }
/* KOT PRINT STYLES (2-inch / 58mm) */
@media print {
    /* Hide everything by default */
    body * { visibility: hidden; height: 0; overflow: hidden; }
    
    /* Show only the KOT Receipt */
    #kot-receipt, #kot-receipt * { 
        visibility: visible; 
        height: auto; 
        overflow: visible; 
    }

    #kot-receipt {
        position: absolute;
        left: 0;
        top: 0;
        width: 58mm; /* 2-inch width */
        padding: 0;
        margin: 0;
        background: white;
        color: black;
        font-family: 'Courier New', monospace; /* Monospace looks best on thermal */
    }

    /* Remove browser headers/footers */
    @page { margin: 0; size: auto; }
}

/* KOT Layout Styling (Screen View - Hidden) */
#kot-receipt { display: none; }
@media print { #kot-receipt { display: block; } }

.kot-header { text-align: center; border-bottom: 2px dashed black; padding-bottom: 5px; margin-bottom: 5px; }
.kot-title { font-weight: bold; font-size: 1.2rem; text-transform: uppercase; }
.kot-meta { font-size: 0.8rem; margin-top: 2px; }
.kot-items { border-bottom: 2px dashed black; padding-bottom: 5px; margin-bottom: 5px; font-size: 0.9rem; font-weight: bold; }
.kot-item-row { display: flex; gap: 5px; margin-bottom: 2px; }
.kot-footer { text-align: center; font-size: 0.8rem; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="notification"></div>
    <button id="pwaInstallBtn" class="btn btn-primary hidden" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);">
    üì≤ Install App
</button>

    <div id="loginScreen" class="login-container">
        <div class="login-box card">
            <img src="logo.png" alt="Juice Therapy" class="logo" onerror="this.style.display='none'">
            <h2 style="margin-bottom: 20px;">Juice Therapy POS</h2>
            
            <div class="flex gap-2" style="margin-bottom: 20px; justify-content: center;">
                <button class="btn btn-secondary" onclick="setLoginMode('customer')" id="btnRoleCust">Customer</button>
                <button class="btn btn-secondary" onclick="setLoginMode('staff')" id="btnRoleStaff">Staff/Admin</button>
            </div>
            <div id="customerLogin" class="hidden">
                <input type="tel" id="custPhoneLogin" class="input" placeholder="Enter Phone Number" maxlength="10">
                <button class="btn btn-primary w-full" onclick="loginCustomer()">Enter</button>
            </div>
            <div id="staffLogin" class="hidden">
                <input type="email" id="staffEmail" class="input" placeholder="Email">
                <input type="password" id="staffPass" class="input" placeholder="Password">
                <button class="btn btn-primary w-full" onclick="loginStaff()">Login</button>
            </div>
        </div>
    </div>

    <div id="adminPanel" class="hidden">
        <header>
            <div class="header-content">
                <div class="flex items-center gap-2">
                    <img src="logo.png" style="height:30px;"> 
                    <h2>Admin Dashboard</h2>
                </div>
                <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
            </div>
        </header>
        <div class="app-layout">
            <div class="tabs">
                <button class="btn btn-secondary tab-btn active" onclick="switchAdminTab('dashboard')" id="btn-adm-dash">üìä Analytics</button>
                <button class="btn btn-secondary tab-btn" onclick="switchAdminTab('menu')" id="btn-adm-menu">üçî Menu</button>
                <button class="btn btn-secondary tab-btn" onclick="switchAdminTab('orders')" id="btn-adm-orders">üìú Orders</button>
                <button class="btn btn-secondary tab-btn" onclick="switchAdminTab('settings')" id="btn-adm-settings">‚öôÔ∏è Settings</button>
            </div>

            <div id="adm-view-dashboard">
    <div class="card">
        <h3>Sales Analytics</h3>
        
        <div class="flex gap-2" style="margin: 15px 0; align-items: flex-end;">
            <div>
                <label class="text-muted" style="font-size:0.8rem;">From</label>
                <input type="date" id="dashStart" class="input" style="margin:0;">
            </div>
            <div>
                <label class="text-muted" style="font-size:0.8rem;">To</label>
                <input type="date" id="dashEnd" class="input" style="margin:0;">
            </div>
            <button class="btn btn-primary" onclick="loadAnalytics()">Go</button>
        </div>

        <div class="grid-4" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:10px;">
            <div class="stat-card">
                <div class="stat-label">Total Sales</div>
                <div class="stat-value" id="statTotalSales">‚Çπ0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Orders</div>
                <div class="stat-value" id="statTotalOrders">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg Order Value</div>
                <div class="stat-value" id="statAvgValue">‚Çπ0</div>
            </div>
            <div class="stat-card" style="border-color: var(--warning);">
                <div class="stat-label">Bonus Redeemed</div>
                <div class="stat-value" id="statBonus">‚Çπ0</div>
            </div>
            <div class="stat-card" style="border-color: var(--success);">
                <div class="stat-label">Cash Collected</div>
                <div class="stat-value" id="statCash">‚Çπ0</div>
            </div>
            <div class="stat-card" style="border-color: var(--info);">
                <div class="stat-label">Online Collected</div>
                <div class="stat-value" id="statOnline">‚Çπ0</div>
            </div>
        </div>

        <div style="margin-top: 20px;">
            <h4 style="margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom:5px;">Top Selling Items (Selected Date Range)</h4>
            <div id="topItemsList" style="max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px;">
                <p class="text-muted">Loading data...</p>
            </div>
        </div>
    </div>

    <div class="card" style="margin-top: 20px;">
        <h3>Last 30 Days Trend</h3>
        <div style="position: relative; height: 300px; width: 100%;">
            <canvas id="salesChart"></canvas>
        </div>
    </div>

    <div class="card" style="margin-top: 20px;">
        <h3>Detailed Item Analytics</h3>
        <p class="text-muted" style="font-size: 0.8rem; margin-bottom: 10px;">Based on the date range selected above.</p>
        
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; text-align: left; font-size: 0.9rem;">
                <thead>
                    <tr style="border-bottom: 2px solid rgba(255,255,255,0.1);">
                        <th style="padding: 10px;">Item Name</th>
                        <th style="padding: 10px; text-align: center;">Qty Sold</th>
                        <th style="padding: 10px; text-align: right;">Revenue Generated</th>
                    </tr>
                </thead>
                <tbody id="itemAnalyticsTable">
                    <tr><td colspan="3" class="text-center text-muted" style="padding:20px;">Click 'Go' to load data</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

            <div id="adm-view-menu" class="hidden">
                <div class="flex justify-between items-center" style="margin-bottom: 15px;">
                    <h3>Manage Categories & Items</h3>
                    <div class="flex gap-2">
                        <button class="btn btn-secondary" onclick="showCategoryModal()">+ Category</button>
                        <button class="btn btn-primary" onclick="showAddItemModal()">+ Add Item</button>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>Categories</h4>
                    <div id="adminCategoryList" class="flex gap-2" style="flex-wrap: wrap; margin-top: 10px;"></div>
                </div>

                <h4>Menu Items</h4>
                <div id="adminMenuGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 10px;"></div>
            </div>

            <div id="adm-view-orders" class="hidden">
    <h3>Order History</h3>
    
    <div class="card" style="margin: 15px 0; padding: 15px;">
        <div class="grid-2" style="margin-bottom: 10px;">
            <div>
                <label class="text-muted" style="font-size: 0.8rem;">Start Date</label>
                <input type="date" id="historyStart" class="input">
            </div>
            <div>
                <label class="text-muted" style="font-size: 0.8rem;">End Date</label>
                <input type="date" id="historyEnd" class="input">
            </div>
        </div>
        <button class="btn btn-primary w-full" onclick="searchHistory()">üîç Search History</button>
    </div>

    <h4 style="margin-bottom: 10px;">Results</h4>
    <div id="adminOrdersList">
        <p class="text-muted text-center" style="padding:20px;">Select dates and click Search to view past orders.</p>
    </div>
</div>

            <div id="adm-view-settings" class="hidden">
                <div class="card">
                    <h3>Store Profile & Status</h3>
<div style="display:flex; flex-direction:column; gap:10px; margin-top:15px;">
    <label class="text-muted">Outlet Name</label>
    <input type="text" id="storeName" class="input" placeholder="e.g. Juice Therapy">

    <label class="text-muted">Store Phone Number (without +91)</label>
    <input type="tel" id="storePhone" class="input" placeholder="e.g. 9007952259">
    <label class="text-muted">Store UPI ID (for receiving payments)</label>
    <input type="text" id="storeUpi" class="input" placeholder="e.g. 9876543210@upl or merchant@okicici">
    
    <label class="text-muted">Address</label>
    <textarea id="storeAddress" class="input" placeholder="Full Address" rows="3"></textarea>
    
    <label class="text-muted">Opening Hours</label>
    <div class="flex gap-2">
        <input type="time" id="storeOpenTime" class="input">
        <span style="align-self:center;">to</span>
        <input type="time" id="storeCloseTime" class="input">
    </div>

    <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center;">
        <span>Outlet Status:</span>
        <label class="flex items-center gap-2" style="cursor:pointer;">
            <input type="checkbox" id="storeIsOpen" style="transform:scale(1.5);">
            <span id="storeStatusLabel" style="font-weight:bold; color:var(--success);">OPEN</span>
        </label>
    </div>
    
    <label class="text-muted">Bill Footer Note</label>
    <input type="text" id="storeFooter" class="input" placeholder="e.g. Thank you!">
    
    <label class="text-muted">Website / Promo Link</label>
    <input type="text" id="storeLink" class="input" placeholder="e.g. www.juicetherapy.com">
    
    <button class="btn btn-primary w-full" onclick="saveStoreSettings()">üíæ Save Settings</button>
</div>
                </div>
            </div>
        </div>
    </div>

    <div id="outletPanel" class="hidden">
        <header>
            <div class="header-content">
    <div class="flex items-center gap-2">
        <img src="logo.png" style="height:30px;"> 
        <h2>Outlet POS</h2>
    </div>
    
    <div class="flex gap-2">
        <button id="btnConnectPrinter" class="btn btn-warning btn-sm" onclick="connectPrinter()">üñ®Ô∏è Connect</button>
        <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
    </div>
</div>
        </header>
        <div class="app-layout">
            <div class="tabs">
    <button class="btn btn-secondary tab-btn active" onclick="switchOutletTab('pos')" id="tab-pos" title="New Order">üõí</button>
    
    <button class="btn btn-secondary tab-btn" onclick="switchOutletTab('incoming')" id="tab-incoming" title="Incoming" style="position: relative;">
        üîî 
        <span id="badgeIncoming" class="hidden" style="background:red; border-radius:50%; width:10px; height:10px; display:inline-block; position:absolute; top:5px; right:5px; border:1px solid white;"></span>
    </button>
    
    <button class="btn btn-secondary tab-btn" onclick="switchOutletTab('current')" id="tab-current" title="Current">‚è≥</button>
    <button class="btn btn-secondary tab-btn" onclick="switchOutletTab('completed')" id="tab-completed" title="Completed">‚úÖ</button>
</div>

            <div id="view-pos" class="pos-container">
                <div class="pos-left">
                    <input type="text" class="input" placeholder="üîç Search items..." onkeyup="filterMenu(this.value)">
                    <div class="menu-area">
                        <div class="cat-sidebar" id="posSidebar"></div>
                        <div class="item-grid" id="posGrid"></div>
                    </div>
                </div>
                <div class="cart-panel">
                    <div class="flex justify-between items-center">
                        <h3>Cart</h3>
                        <span class="btn-danger" style="padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;" onclick="clearCart()">Clear</span>
                    </div>
                    <div style="margin-top: 10px;">
                        <input type="tel" id="posPhone" class="input" placeholder="Customer Phone (Auto-create)" maxlength="10">
                    </div>
                    <div class="cart-items" id="cartItemsList"></div>
                    <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
                        <div class="flex justify-between font-bold" style="font-size: 1.2rem; margin-bottom: 10px;">
                            <span>Total</span>
                            <span id="cartTotal">‚Çπ0</span>
                        </div>
                        <button id="btnPlaceOrder" class="btn btn-primary w-full" onclick="placeOrder()">Place Order</button>
                        <button id="btnUpdateOrder" class="btn btn-warning w-full hidden" onclick="updateExistingOrder()">Update Order</button>
                    </div>
                </div>
            </div>

            <div id="view-incoming" class="hidden">
                <div id="incomingOrdersList"></div>
            </div>

            <div id="view-current" class="hidden">
                <div id="currentOrdersList"></div>
            </div>

            <div id="view-completed" class="hidden">
                <div id="completedOrdersList"></div>
            </div>
        </div>
    </div>

    <div id="customerPanel" class="hidden">
        <header>
            <div class="header-content">
    <div class="flex items-center gap-2">
        <img src="logo.png" style="height:30px;"> 
        <h2>My Juice Therapy</h2>
    </div>
    <div class="flex gap-2 items-center">
        <button class="btn btn-secondary btn-sm" style="position:relative;" onclick="openNotifications()">
            üîî
            <span id="custNotifBadge" class="hidden" style="position:absolute; top:-5px; right:-5px; background:red; color:white; font-size:0.7rem; padding:2px 6px; border-radius:10px;">New</span>
        </button>
        <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
    </div>
</div>
        </header>
        <div class="app-layout">
<div id="custOutletInfo" class="card" style="border-left: 5px solid var(--success); margin-bottom: 20px;">
    <div class="flex justify-between items-start">
        <div>
            <h2 id="infoStoreName" style="color:var(--primary); margin-bottom:5px;">Juice Therapy</h2>
            <p id="infoAddress" class="text-muted" style="font-size:0.9rem; margin-bottom:5px;"></p>
            <div class="flex gap-2" style="font-size:0.85rem; color:#aaa;">
                <span>üïí <span id="infoTiming">--:-- to --:--</span></span>
                <span>‚Ä¢</span>
                <span id="infoStatus" style="font-weight:bold; color:var(--success);">OPEN</span>
            </div>
        </div>
    </div>

    <div class="grid-4" style="grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-top:15px;">
        <button class="btn btn-secondary btn-sm" onclick="contactStore('call')">üìû Call</button>
        <button class="btn btn-secondary btn-sm" style="background:#25D366; color:white;" onclick="contactStore('whatsapp')">üí¨ WhatsApp</button>
        <button class="btn btn-secondary btn-sm" onclick="contactStore('save')">üíæ Save No.</button>
    </div>
</div>
            <div class="card text-center" style="background: linear-gradient(135deg, var(--primary), #FF9F43);">
                <h3>Welcome, <span id="custNameDisplay">Guest</span></h3>
                <h1 style="font-size: 3rem; margin: 10px 0;" id="custPoints">0</h1>
                <p>Bonus Points Available</p>
            </div>
            <div class="tabs">
                <button class="btn btn-secondary tab-btn active" onclick="switchCustTab('menu')" id="btn-cust-menu">üçî Order Now</button>
                <button class="btn btn-secondary tab-btn" onclick="switchCustTab('history')" id="btn-cust-history">üìú My History</button>
            </div>
            <div id="cust-view-menu">
<input type="text" class="input" placeholder="üîç Search items..." 
           style="margin-bottom: 10px;" 
           onkeyup="filterCustomerMenu(this.value)">                
<div class="pos-container" style="height: 60vh;">
                    <div class="pos-left">
                         <div class="menu-area">
                            <div class="cat-sidebar" id="custSidebar"></div>
                            <div class="item-grid" id="custGrid"></div>
                         </div>
                    </div>
                    <div class="cart-panel">
                        <h3>My Cart</h3>
                        <div class="cart-items" id="custCartItems"></div>
                        <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
                            <div class="flex justify-between font-bold" style="font-size: 1.2rem; margin-bottom: 10px;">
                                <span>Total</span>
                                <span id="custCartTotal">‚Çπ0</span>
                            </div>
                            <button class="btn btn-primary w-full" onclick="placeCustomerOrder()">Request Order</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="cust-view-history" class="hidden">
                <div id="custHistoryList"></div>
            </div>
        </div>
    </div>

    <div id="paymentModal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 400; display: flex; align-items: center; justify-content: center;">
        <div class="card" style="width: 90%; max-width: 400px;">
            
            <div id="paymentInputSection">
                <h3 style="margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">Final Billing</h3>
                
                <div class="flex justify-between" style="margin-bottom: 10px;">
                    <span class="text-muted">Customer:</span>
                    <span id="payCustPhone" class="font-bold">...</span>
                </div>
                
                <div class="flex justify-between" style="margin-bottom: 10px;">
                    <span class="text-muted">Bill Total:</span>
                    <span id="payBillTotal" class="font-bold" style="font-size: 1.2rem;">‚Çπ0</span>
                </div>

                <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                    <div class="flex justify-between items-center">
                        <span>Available Bonus:</span>
                        <span id="payAvailPoints" style="color: var(--primary); font-weight: bold;">0 pts</span>
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                        <input type="number" id="redeemInput" class="input" placeholder="0" style="margin:0; text-align: right;" oninput="updatePaymentCalc()">
                        <button class="btn btn-sm btn-secondary" onclick="useMaxPoints()">Max</button>
                    </div>
                    <div class="text-muted" style="font-size: 0.8rem; margin-top: 5px;">1 Point = ‚Çπ1 | New bonus will add to balance.</div>
                </div>

                <div style="margin-bottom: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <label class="text-muted" style="font-size: 0.9rem; display: block; margin-bottom: 8px;">Payment Mode</label>
                    <div class="flex gap-2">
                        <button id="btnModeCash" class="btn btn-sm btn-primary w-full" onclick="setPaymentMode('Cash')">üíµ Cash</button>
                        <button id="btnModeOnline" class="btn btn-sm btn-secondary w-full" onclick="setPaymentMode('Online')">üì± Online / UPI</button>
                    </div>
                    <input type="hidden" id="paymentModeInput" value="Cash">
                </div>

                <div class="flex justify-between" style="margin-bottom: 20px; font-size: 1.3rem; font-weight: bold; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                    <span>Net Payable:</span>
                    <span id="payNetTotal" style="color: var(--success);">‚Çπ0</span>
                </div>

                <div id="cashCalcSection" style="margin-bottom: 20px; padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
                    <div class="flex justify-between items-center" style="margin-bottom: 8px;">
                        <span class="text-muted">üíµ Customer Gave:</span>
                        <input type="number" id="cashGiven" class="input" placeholder="‚Çπ" style="width: 120px; margin:0; text-align: right; font-size: 1.1rem; font-weight: bold;" oninput="calculateChange()">
                    </div>
                    <div class="flex justify-between items-center" style="font-size: 1.1rem; font-weight: bold; border-top: 1px dashed rgba(255,255,255,0.2); padding-top: 8px;">
                        <span>üîÑ Return Change:</span>
                        <span id="cashReturn" style="color: var(--warning);">‚Çπ0</span>
                    </div>
                </div>

                <div class="flex gap-2">
                    <button class="btn btn-secondary w-full" onclick="closePaymentModal()">Cancel</button>
                    <button class="btn btn-success w-full" onclick="processPayment()">Confirm & Pay</button>
                </div>
            </div>

            <div id="paymentSuccessSection" class="hidden text-center" style="padding: 10px;">
                <div style="font-size: 4rem; margin-bottom: 10px;">‚úÖ</div>
                <h3 style="margin-bottom: 5px;">Payment Successful!</h3>
                <p class="text-muted" style="margin-bottom: 20px;">Order #<span id="billSerial"></span> completed.</p>
                
                <div style="display:flex; flex-direction:column; gap:10px;">
                    <button class="btn btn-secondary w-full" style="background:#444; color:white; border:1px solid #666;" onclick="printBillDirect(PAYMENT_DATA.orderId)">
        üñ®Ô∏è Print Receipt
    </button>
                    <button class="btn btn-success w-full" style="background:#25D366; border:none;" onclick="sendBill('whatsapp')">
                        üì± Send via WhatsApp
                    </button>
                    <button class="btn btn-primary w-full" onclick="sendBill('sms')">
                        üí¨ Send via SMS
                    </button>
                    <button class="btn btn-secondary w-full" onclick="closePaymentModal()">
                        ‚ùå Close
                    </button>
                </div>
            </div>

        </div>
    </div>

    <div id="addItemModal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200; display: flex; align-items: center; justify-content: center;">
        <div class="card" style="width: 90%; max-width: 400px;">
            <h3>Add/Edit Item</h3>
            <input type="text" id="newItemName" class="input" placeholder="Item Name">
            <input type="number" id="newItemPrice" class="input" placeholder="Price">
            <select id="newItemCat" class="input"><option value="">Select Category</option></select>
            <div class="flex gap-2" style="margin-top: 10px;">
                <button class="btn btn-secondary w-full" onclick="document.getElementById('addItemModal').classList.add('hidden')">Cancel</button>
                <button class="btn btn-primary w-full" onclick="saveMenuItem()">Save</button>
            </div>
        </div>
    </div>

    <div id="addCategoryModal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 210; display: flex; align-items: center; justify-content: center;">
        <div class="card" style="width: 90%; max-width: 350px;">
            <h3>New Category</h3>
            <input type="text" id="newCatName" class="input" placeholder="Category Name">
            <div class="flex gap-2" style="margin-top: 10px;">
                <button class="btn btn-secondary w-full" onclick="document.getElementById('addCategoryModal').classList.add('hidden')">Cancel</button>
                <button class="btn btn-primary w-full" onclick="saveCategory()">Save</button>
            </div>
        </div>
    </div>

    <div id="customerNameModal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 300; display: flex; align-items: center; justify-content: center;">
        <div class="card" style="width: 90%; max-width: 400px; text-align: center;">
            <h3 style="margin-bottom: 10px;">Welcome!</h3>
            <p style="margin-bottom: 20px; color: var(--text-muted);">Please enter your name to continue.</p>
            <input type="text" id="newCustName" class="input" placeholder="Your Name">
            <button class="btn btn-primary w-full" onclick="saveCustomerName()">Start Ordering</button>
        </div>
    </div>

    <script>
        const STATE = {
            user: null,
            role: null, 
            menu: [],
            categories: [],
            cart: [],
            custCart: [], 
            orders: [],
            editingOrderId: null,
            activeCategory: 'All',
            tempPhone: null,
	    searchQuery: '',
            storeSettings: { name: 'Juice Therapy', address: '', footer: 'Thank you!', link: '' }
        };
let TEMP_EDIT_ITEMS = [];
let SALES_CHART_INSTANCE = null;
        window.onload = () => {
           
            const checkFirebase = setInterval(() => {
                if (window.firebaseReady) {
                    clearInterval(checkFirebase);
                    initApp();
                }
            }, 100);
            
            const d = new Date();
            document.getElementById('dashEnd').valueAsDate = d;
            d.setMonth(d.getMonth() - 1);
            document.getElementById('dashStart').valueAsDate = d;
        };

        function initApp() {
        // LISTEN FOR FOREGROUND MESSAGES (While app is open)
const { onMessage, messaging } = window.firebaseModules;
onMessage(messaging, (payload) => {
    console.log('Message received. ', payload);
    const { title, body, image } = payload.notification;
    
    // Show browser notification
    if (Notification.permission === 'granted') {
        new Notification(title, {
            body: body,
            icon: '/logo.png',
            image: image || null
        });
    }
    
    // Also show toast for in-app visibility
    showToast(`üîî ${title}: ${body}`);
});
    window.firebaseModules.onAuthStateChanged(window.auth, (user) => {
        if (user) {
            // CASE A: Staff/Admin is logged in via Firebase Auth
            checkUserRole(user); 
        } else {
            // CASE B: No Staff logged in. Check for Customer Session.
            const savedPhone = localStorage.getItem('jt_cust_phone');
            
            if (savedPhone) {
                restoreCustomerSession(savedPhone);
            } else {
                // CASE C: No one is logged in
                document.getElementById('loginScreen').classList.remove('hidden');
            }
        }
    });
}

        async function checkUserRole(user) {
            // Load Store Settings for everyone (needed for bills)
            loadStoreSettings();

            if (user.email === 'admin@jt.com' || user.email === 'titir95biplab@gmail.com') {
                STATE.role = 'admin';
                showPanel('adminPanel');
                loadCategories();
                loadMenu();
                loadAnalytics();
                return;
            } 
            
            const { doc, getDoc } = window.firebaseModules;
            try {
                const userDoc = await getDoc(doc(window.db, 'staff', user.uid)); 
                if (userDoc.exists() && userDoc.data().role === 'admin') {
                    STATE.role = 'admin';
                    showPanel('adminPanel');
                    loadCategories();
                    loadMenu();
                    loadAnalytics();
                } else {
                    STATE.role = 'staff';
                    showPanel('outletPanel');
                    loadCategories();
                    loadMenu();
                    loadOrders(); 
                }
            } catch (e) {
                STATE.role = 'staff';
                showPanel('outletPanel');
                loadCategories();
                loadMenu();
                loadOrders(); 
            }
        }

        function showPanel(panelId) {
            ['loginScreen', 'adminPanel', 'outletPanel', 'customerPanel'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(panelId).classList.remove('hidden');
        }

        function setLoginMode(mode) {
            document.getElementById('customerLogin').classList.add('hidden');
            document.getElementById('staffLogin').classList.add('hidden');
            document.getElementById('btnRoleCust').classList.remove('btn-primary');
            document.getElementById('btnRoleStaff').classList.remove('btn-primary');
            if(mode === 'customer') {
                document.getElementById('customerLogin').classList.remove('hidden');
                document.getElementById('btnRoleCust').classList.add('btn-primary');
            } else {
                document.getElementById('staffLogin').classList.remove('hidden');
                document.getElementById('btnRoleStaff').classList.add('btn-primary');
            }
        }

        async function loginStaff() {
            const email = document.getElementById('staffEmail').value;
            const pass = document.getElementById('staffPass').value;
            try { await window.firebaseModules.signInWithEmailAndPassword(window.auth, email, pass); } 
            catch (e) { showToast(e.message, 'error'); }
        }

        async function loginCustomer() {
    let rawPhone = document.getElementById('custPhoneLogin').value;
    
    // 1. Sanitize: Remove spaces, dashes, +91, etc.
    // This turns "+91 900-795-2259" into "9007952259"
    const phone = rawPhone.replace(/\D/g, '').slice(-10); 

    // 2. Check length AFTER cleaning
    if (phone.length !== 10) {
        return showToast('Please enter valid 10-digit number', 'error');
    }
    
    const { doc, getDoc } = window.firebaseModules;
            
            try {
                // Show loading feedback (Optional but good)
                showToast('Checking ID...', 'info');

                const snap = await getDoc(doc(window.db, 'customers', phone));
                
                if (!snap.exists() || !snap.data().name) {
                    STATE.tempPhone = phone;
                    document.getElementById('customerNameModal').classList.remove('hidden');
                    return;
                }
                
                finalizeCustomerLogin(phone, snap.data());

            } catch (e) {
                console.error("Login Error:", e);
                // This will tell us if it's a Permission issue!
                showToast('Login Failed: ' + e.message, 'error'); 
            }
        }

async function restoreCustomerSession(phone) {
    const { doc, getDoc } = window.firebaseModules;
    try {
        const snap = await getDoc(doc(window.db, 'customers', phone));
        if (snap.exists()) {
            // User exists, log them back in with fresh data
            finalizeCustomerLogin(phone, snap.data());
        } else {
            // User might have been deleted, clear invalid session
            localStorage.removeItem('jt_cust_phone');
            document.getElementById('loginScreen').classList.remove('hidden');
        }
    } catch (e) {
        console.error("Session Restore Error:", e);
        document.getElementById('loginScreen').classList.remove('hidden');
    }
}

        async function saveCustomerName() {
            const name = document.getElementById('newCustName').value;
            if(!name) return showToast('Name is required', 'error');
            const { doc, setDoc, serverTimestamp } = window.firebaseModules;
            await setDoc(doc(window.db, 'customers', STATE.tempPhone), {
                phone: STATE.tempPhone, name: name, points: 0, joined: serverTimestamp()
            }, { merge: true });
            document.getElementById('customerNameModal').classList.add('hidden');
            finalizeCustomerLogin(STATE.tempPhone, { name, points: 0 });
        }

        function finalizeCustomerLogin(phone, data) {
            localStorage.setItem('jt_cust_phone', phone);
            STATE.user = { uid: phone, phone: phone, name: data.name };
            STATE.role = 'customer';
            document.getElementById('custNameDisplay').innerText = data.name;
            document.getElementById('custPoints').innerText = data.points || 0;
            loadCategories();
            loadMenu();
            loadCustomerHistory(phone);
            loadStoreSettings();
            loadCustomerNotifications();
    
    // ASK FOR PERMISSION NOW üëá
    requestNotificationPermission();

    showPanel('customerPanel');
        }

        function logout() {
    // 1. CLEAR CUSTOMER SESSION
    localStorage.removeItem('jt_cust_phone');
    
    // 2. SIGN OUT STAFF (Firebase)
    window.auth.signOut();
    
    // 3. RELOAD
    location.reload();
}

        // --- ADMIN SETTINGS & TABS ---
        function switchAdminTab(tab) {
            ['dashboard', 'menu', 'orders', 'settings'].forEach(t => {
                const btn = document.getElementById(`btn-adm-${t}`);
                const view = document.getElementById(`adm-view-${t}`);
                if(btn) btn.classList.remove('active');
                if(view) view.classList.add('hidden');
            });

            const activeBtn = document.getElementById(`btn-adm-${tab}`);
            const activeView = document.getElementById(`adm-view-${tab}`);
            
            if(activeBtn) activeBtn.classList.add('active');
            if(activeView) activeView.classList.remove('hidden');

           if(tab === 'orders') {
        const d = new Date();
        document.getElementById('historyEnd').valueAsDate = d;
        document.getElementById('historyStart').valueAsDate = d; // Default to "Today"
    }
            if(tab === 'dashboard') loadAnalytics();
            if(tab === 'menu') updateCategorySelects();
        }

        function loadStoreSettings() {
    const { doc, onSnapshot } = window.firebaseModules;
    onSnapshot(doc(window.db, 'settings', 'store'), (snap) => {
        if (snap.exists()) {
            STATE.storeSettings = snap.data();
            const s = STATE.storeSettings;

            // 1. Update Admin Inputs (Only if element exists)
            if(document.getElementById('storeName')) {
                document.getElementById('storeName').value = s.name || '';
                document.getElementById('storePhone').value = s.phone || '9007952259';
document.getElementById('storeUpi').value = s.upi || '';
                document.getElementById('storeAddress').value = s.address || '';
                document.getElementById('storeOpenTime').value = s.openTime || '';
                document.getElementById('storeCloseTime').value = s.closeTime || '';
                document.getElementById('storeFooter').value = s.footer || '';
                document.getElementById('storeLink').value = s.link || '';
                
                // Toggle Switch Logic
                const check = document.getElementById('storeIsOpen');
                const label = document.getElementById('storeStatusLabel');
                check.checked = s.isOpen !== false; // Default to true if undefined
                
                // Add event listener to change label dynamically when clicked
                check.onchange = () => {
                    label.innerText = check.checked ? "OPEN" : "CLOSED";
                    label.style.color = check.checked ? "var(--success)" : "var(--danger)";
                };
                // Trigger once to set initial state text
                check.onchange(); 
            }

            // 2. Update Customer Info Card
            if(document.getElementById('infoStoreName')) {
                document.getElementById('infoStoreName').innerText = s.name || 'Juice Therapy';
                document.getElementById('infoAddress').innerText = s.address || '';
                
                // Timing Format
                const t1 = formatTime(s.openTime);
                const t2 = formatTime(s.closeTime);
                document.getElementById('infoTiming').innerText = (t1 && t2) ? `${t1} - ${t2}` : 'Timings not set';

                // Status Indicator
                const statusEl = document.getElementById('infoStatus');
                const cardEl = document.getElementById('custOutletInfo');
                
                if (s.isOpen === false) {
                    statusEl.innerText = "CLOSED";
                    statusEl.style.color = "var(--danger)";
                    cardEl.style.borderLeftColor = "var(--danger)";
                } else {
                    statusEl.innerText = "OPEN";
                    statusEl.style.color = "var(--success)";
                    cardEl.style.borderLeftColor = "var(--success)";
                }
            }
        }
    });
}

        async function saveStoreSettings() {
    // 1. Get Values
    const isOpen = document.getElementById('storeIsOpen').checked;
    
    const settings = {
        name: document.getElementById('storeName').value,
        phone: document.getElementById('storePhone').value,
        upi: document.getElementById('storeUpi').value, // <--- NEW FIELD
        address: document.getElementById('storeAddress').value,
        openTime: document.getElementById('storeOpenTime').value,
        closeTime: document.getElementById('storeCloseTime').value,
        isOpen: isOpen,
        footer: document.getElementById('storeFooter').value,
        link: document.getElementById('storeLink').value
    };
    
    try {
        const { doc, setDoc } = window.firebaseModules;
        
        // 2. Save with Merge (Protects existing data)
        await setDoc(doc(window.db, 'settings', 'store'), settings, { merge: true });
        
        // 3. Force UI Update (Visual Feedback)
        const statusLabel = document.getElementById('storeStatusLabel');
        statusLabel.innerText = isOpen ? "OPEN" : "CLOSED";
        statusLabel.style.color = isOpen ? "var(--success)" : "var(--danger)";
        
        showToast('Settings Saved Successfully!');
        
    } catch (e) {
        console.error("Save Error:", e);
        // Alert the user if it fails (so you know if it's a permission issue)
        showToast('Error Saving: ' + e.message, 'error');
        
        // Optional: Revert checkbox if save failed
        document.getElementById('storeIsOpen').checked = !isOpen; 
    }
}

// Helper for contact buttons
function contactStore(action) {
    const phone = STATE.storeSettings.phone || '9007952259';
    const cleanPhone = phone.replace(/\D/g, ''); // Remove spaces/dashes
    
    if (action === 'call') {
        window.open(`tel:+91${cleanPhone}`, '_self');
    } 
    else if (action === 'whatsapp') {
        window.open(`https://wa.me/91${cleanPhone}`, '_blank');
    } 
    else if (action === 'save') {
        // Generate vCard for "Save Contact"
        const vCardData = `BEGIN:VCARD
VERSION:3.0
FN:${STATE.storeSettings.name || 'Juice Therapy'}
TEL;TYPE=CELL:+91${cleanPhone}
END:VCARD`;
        const blob = new Blob([vCardData], { type: "text/vcard" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "JuiceTherapy.vcf";
        a.click();
        URL.revokeObjectURL(url);
    }
}

function callCustomer(phone, event) {
    if(event) event.stopPropagation(); // Prevent opening order details
    if(!phone) return showToast('No phone number found', 'error');
    
    // Remove spaces or dashes just in case
    const cleanPhone = phone.toString().replace(/\D/g, ''); 
    window.open(`tel:+91${cleanPhone}`, '_self');
}

// Helper for 12-hour time format
function formatTime(timeStr) {
    if (!timeStr) return '';
    const [h, m] = timeStr.split(':');
    const hour = parseInt(h);
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const h12 = hour % 12 || 12;
    return `${h12}:${m} ${ampm}`;
}

        function loadCategories() {
            const { collection, onSnapshot, query, orderBy } = window.firebaseModules;
            onSnapshot(query(collection(window.db, 'categories'), orderBy('name')), (snap) => {
                STATE.categories = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if (STATE.role === 'admin') renderAdminCategories();
                updateCategorySelects();
                if(STATE.role === 'staff') renderOutletMenu();
                if(STATE.role === 'customer') renderCustomerMenu();
            });
        }

        function renderAdminCategories() {
            const list = document.getElementById('adminCategoryList');
            list.innerHTML = STATE.categories.map(c => `
                <div class="btn btn-secondary btn-sm" style="display:inline-flex; gap:5px;">
                    ${c.name} 
                    <span style="cursor:pointer; color:var(--danger);" onclick="deleteCategory('${c.id}')">&times;</span>
                </div>
            `).join('');
        }

        function updateCategorySelects() {
            const opts = `<option value="">Select Category</option>` + STATE.categories.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            document.getElementById('newItemCat').innerHTML = opts;
        }

        async function saveCategory() {
            const name = document.getElementById('newCatName').value;
            if(!name) return;
            await window.firebaseModules.addDoc(window.firebaseModules.collection(window.db, 'categories'), { name });
            document.getElementById('addCategoryModal').classList.add('hidden');
            document.getElementById('newCatName').value = '';
        }

        async function deleteCategory(id) {
            if(!confirm('Delete Category?')) return;
            await window.firebaseModules.deleteDoc(window.firebaseModules.doc(window.db, 'categories', id));
        }

        function showCategoryModal() { document.getElementById('addCategoryModal').classList.remove('hidden'); }

        function loadMenu() {
            const { collection, onSnapshot, query, orderBy } = window.firebaseModules;
            onSnapshot(query(collection(window.db, 'menu'), orderBy('name')), (snap) => {
                STATE.menu = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if (STATE.role === 'admin') renderAdminMenu();
                if (STATE.role === 'staff') renderOutletMenu();
                if (STATE.role === 'customer') renderCustomerMenu();
            });
        }

        function renderAdminMenu() {
            const grid = document.getElementById('adminMenuGrid');
            grid.innerHTML = STATE.menu.map(item => `
                <div class="card" style="margin:0;">
                    <div class="flex justify-between">
                        <h4>${item.name}</h4>
                        <span class="text-muted">‚Çπ${item.price}</span>
                    </div>
                    <div class="text-muted" style="font-size:0.8rem;">${item.category || 'Uncategorized'}</div>
                    <div class="flex gap-2" style="margin-top:10px;">
                        <button class="btn btn-secondary w-full" onclick="editItem('${item.id}')">Edit</button>
                        <button class="btn btn-danger w-full" onclick="deleteItem('${item.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // --- ADMIN ANALYTICS & ORDERS ---
        async function loadAnalytics() {
    const startInput = document.getElementById('dashStart').value;
    const endInput = document.getElementById('dashEnd').value;
    
    if(!startInput || !endInput) return showToast('Please select dates', 'error');

    // 1. Setup Dates
    const startDate = new Date(startInput);
    const endDate = new Date(endInput);
    endDate.setHours(23, 59, 59, 999);

    const { collection, query, where, getDocs, orderBy } = window.firebaseModules;
    
    // UI Loading State
    document.getElementById('statTotalSales').innerText = '...';
    document.getElementById('topItemsList').innerHTML = '<p class="text-muted">Analyzing...</p>';
    
    // 2. Query ALL Completed Orders (We filter by date in JS to allow flexible "Last 30 Days" graph logic)
    // NOTE: For huge databases, you would split this into two queries, but for <5000 orders this is faster.
    const q = query(collection(window.db, 'orders'), where('status', '==', 'completed'));
    
    try {
        const snap = await getDocs(q);
        
        // --- Variables for Selected Range ---
        let totalSales = 0;
        let count = 0;
        let bonusRedeemed = 0;
        let cashTotal = 0;
        let onlineTotal = 0;
        let itemMap = {}; // Format: { "Mango Shake": { qty: 5, revenue: 500 } }

        // --- Variables for Last 30 Days Graph ---
        let dailySales = {}; // Format: { "2023-10-01": 5000, "2023-10-02": 3200 }
        
        // Initialize last 30 days keys
        for (let i = 29; i >= 0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            const dateKey = d.toISOString().split('T')[0];
            dailySales[dateKey] = 0;
        }

        // 3. Process Data
        snap.forEach(doc => {
            const data = doc.data();
            if (!data.timestamp) return;
            
            const orderDate = data.timestamp.toDate();
            const dateKey = orderDate.toISOString().split('T')[0];

            // A. Populate Graph Data (Last 30 Days)
            if (dailySales.hasOwnProperty(dateKey)) {
                dailySales[dateKey] += (data.finalPaid || data.total || 0);
            }

            // B. Filter for Selected Range (Metrics & Item Analytics)
            if (orderDate >= startDate && orderDate <= endDate) {
                const finalAmt = data.finalPaid !== undefined ? data.finalPaid : data.total;
                
                totalSales += finalAmt;
                count++;
                bonusRedeemed += (data.redeemed || 0);

                // Payment Mode Split
                if (data.paymentMode === 'Online') onlineTotal += finalAmt;
                else cashTotal += finalAmt; // Default to cash if undefined or 'Cash'

                // Item Analysis
                if (data.items && Array.isArray(data.items)) {
                    data.items.forEach(item => {
                        if (!itemMap[item.name]) {
                            itemMap[item.name] = { qty: 0, revenue: 0 };
                        }
                        itemMap[item.name].qty += (item.qty || 0);
                        itemMap[item.name].revenue += (item.price * item.qty || 0);
                    });
                }
            }
        });

        // 4. Update Metric Cards
        document.getElementById('statTotalSales').innerText = '‚Çπ' + totalSales;
        document.getElementById('statTotalOrders').innerText = count;
        document.getElementById('statAvgValue').innerText = count ? '‚Çπ' + Math.floor(totalSales/count) : '‚Çπ0';
        document.getElementById('statBonus').innerText = '‚Çπ' + bonusRedeemed;
        document.getElementById('statCash').innerText = '‚Çπ' + cashTotal;
        document.getElementById('statOnline').innerText = '‚Çπ' + onlineTotal;

        // 5. Update Top Items List & Detailed Table
        renderItemAnalytics(itemMap);

        // 6. Render Graph
        renderSalesChart(dailySales);

    } catch (e) {
        console.error("Analytics Error:", e);
        showToast('Error loading analytics', 'error');
    }
}

function renderItemAnalytics(itemMap) {
    // Convert Map to Array and Sort by Quantity Descending
    const sortedItems = Object.entries(itemMap)
        .map(([name, data]) => ({ name, ...data }))
        .sort((a, b) => b.qty - a.qty);

    // A. Render Top 5 Items List
    const topListEl = document.getElementById('topItemsList');
    if (sortedItems.length === 0) {
        topListEl.innerHTML = '<p class="text-muted">No items sold in this period.</p>';
    } else {
        topListEl.innerHTML = sortedItems.slice(0, 5).map((item, index) => `
            <div style="display:flex; justify-content:space-between; border-bottom:1px solid rgba(255,255,255,0.05); padding:5px 0;">
                <span>${index+1}. ${item.name}</span>
                <span class="text-muted">${item.qty} sold</span>
            </div>
        `).join('');
    }

    // B. Render Detailed Table
    const tableBody = document.getElementById('itemAnalyticsTable');
    if (sortedItems.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted" style="padding:20px;">No data</td></tr>';
    } else {
        tableBody.innerHTML = sortedItems.map(item => `
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                <td style="padding: 10px;">${item.name}</td>
                <td style="padding: 10px; text-align: center;">${item.qty}</td>
                <td style="padding: 10px; text-align: right;">‚Çπ${item.revenue}</td>
            </tr>
        `).join('');
    }
}

function renderSalesChart(dailyData) {
    const ctx = document.getElementById('salesChart').getContext('2d');
    
    // Prepare Data Arrays
    const labels = Object.keys(dailyData).map(dateStr => {
        const d = new Date(dateStr);
        return `${d.getDate()}/${d.getMonth()+1}`; // Format: DD/MM
    });
    const dataPoints = Object.values(dailyData);

    // DESTROY OLD CHART (Crucial to prevent glitches)
    if (SALES_CHART_INSTANCE) {
        SALES_CHART_INSTANCE.destroy();
    }

    // Create New Chart
    SALES_CHART_INSTANCE = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Daily Sales (‚Çπ)',
                data: dataPoints,
                borderColor: '#FF6B35', // Your Primary Brand Color
                backgroundColor: 'rgba(255, 107, 53, 0.2)',
                borderWidth: 2,
                tension: 0.3, // Curve smoothing
                fill: true,
                pointRadius: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: { 
                    mode: 'index', 
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            return ' Sales: ‚Çπ' + context.raw;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                    ticks: { color: '#888' }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#888', maxTicksLimit: 10 }
                }
            }
        }
    });
}

        function loadAdminOrders() {
            const { collection, query, where, onSnapshot } = window.firebaseModules;
            
            const q = query(collection(window.db, 'orders'), where('status', '==', 'completed'));
            
            onSnapshot(q, (snap) => {
                const list = document.getElementById('adminOrdersList');
                
                if(snap.empty) {
                    list.innerHTML = '<p class="text-muted text-center">No completed orders found.</p>';
                    return;
                }

                const orders = snap.docs.map(d => ({id: d.id, ...d.data()}));
                orders.sort((a, b) => {
                    const tA = a.timestamp ? a.timestamp.seconds : 0;
                    const tB = b.timestamp ? b.timestamp.seconds : 0;
                    return tB - tA;
                });

                list.innerHTML = orders.map(o => {
                    const dateStr = o.timestamp ? new Date(o.timestamp.toDate()).toLocaleDateString() : 'N/A';
                    return `
                    <div class="order-card" onclick="viewOrderDetails('${o.id}')" style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;">
                        <div>
                            <div style="font-weight:bold; font-size:1.1rem;">${o.customerName || o.phone}</div>
                            <div class="text-muted" style="font-size:0.85rem;">${dateStr} ‚Ä¢ ‚Çπ${o.total} ‚Ä¢ ${o.paymentMode || 'Cash'}</div>
                            <div class="text-muted" style="font-size:0.8rem;">${o.items.length} Items</div>
                        </div>
                        <div>
                            <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); adminDeleteOrder('${o.id}')">Delete</button>
                        </div>
                    </div>
                `;}).join('');
            });
        }
        
        async function adminDeleteOrder(id) {
            if(!confirm('Delete this record? Warning: 5% Bonus points awarded will be deducted from the customer.')) return;
            
            const { doc, runTransaction } = window.firebaseModules;
            
            try {
                await runTransaction(window.db, async (transaction) => {
                    // 1. Get Order
                    const orderRef = doc(window.db, 'orders', id);
                    const orderDoc = await transaction.get(orderRef);
                    
                    if (!orderDoc.exists()) throw "Order does not exist!";
                    
                    const orderData = orderDoc.data();
                    
                    // 2. Adjust Customer Points if order was completed
                    if (orderData.status === 'completed' && orderData.phone) {
                        const bonus = Math.floor(orderData.total * 0.05);
                        const custRef = doc(window.db, 'customers', orderData.phone);
                        const custDoc = await transaction.get(custRef);
                        
                        if (custDoc.exists()) {
                            const currentPoints = custDoc.data().points || 0;
                            transaction.update(custRef, { points: currentPoints - bonus });
                        }
                    }
                    
                    // 3. Delete Order
                    transaction.delete(orderRef);
                });
                
                showToast('Order deleted & points reversed');
                loadAdminOrders(); 
            } catch (e) {
                console.error(e);
                showToast('Error: ' + e.message, 'error');
            }
        }

// --- ORDER DETAILS & ADMIN EDIT ---
        let CURRENT_VIEW_ORDER_ID = null;

        async function viewOrderDetails(orderId) {
            CURRENT_VIEW_ORDER_ID = orderId;
            const { doc, getDoc } = window.firebaseModules;
            
            // 1. Fetch Order
            const snap = await getDoc(doc(window.db, 'orders', orderId));
            if(!snap.exists()) return showToast('Order not found', 'error');
            const data = snap.data();
// 1. Load items into temporary state
TEMP_EDIT_ITEMS = JSON.parse(JSON.stringify(data.items)); // Deep copy to avoid reference issues

// 2. Populate the "Add Item" dropdown
const itemSelect = document.getElementById('adminAddItemSelect');
itemSelect.innerHTML = `<option value="">+ Add Menu Item</option>` + 
    STATE.menu.map(m => `<option value="${m.id}">${m.name} (‚Çπ${m.price})</option>`).join('');

            // 2. Populate Modal Fields
            document.getElementById('viewStoreName').innerText = STATE.storeSettings?.name || 'Juice Therapy';
            document.getElementById('viewOrderId').innerText = `Order #${data.timestamp ? data.timestamp.toMillis().toString().slice(-4) : '...'}`;
            document.getElementById('viewDate').innerText = data.timestamp ? data.timestamp.toDate().toLocaleString() : '';
            
            document.getElementById('editCustName').value = data.customerName || 'Guest';
            document.getElementById('editCustPhone').value = data.phone || '';
            
            // Populate Items
            const itemsHtml = data.items.map(i => `
                <div class="flex justify-between" style="font-size:0.9rem; margin-bottom:4px;">
                    <span>${i.qty} x ${i.name}</span>
                    <span>‚Çπ${i.price * i.qty}</span>
                </div>
            `).join('');
            document.getElementById('viewItemsList').innerHTML = itemsHtml;

            // Populate Payment
            document.getElementById('editTotal').value = data.finalPaid || data.total;
            document.getElementById('editMode').value = data.paymentMode || 'Cash';

            // 3. Reset Edit State
            disableAdminEdit();
            
            // 4. Show "Edit" button ONLY if Admin
            if(STATE.role === 'admin') {
                document.getElementById('btnAdminEdit').classList.remove('hidden');
            } else {
                document.getElementById('btnAdminEdit').classList.add('hidden');
            }

            document.getElementById('orderDetailsModal').classList.remove('hidden');
        }

        function closeDetailsModal() {
            document.getElementById('orderDetailsModal').classList.add('hidden');
        }

        // --- ADMIN EDIT LOGIC ---
        function enableAdminEdit() {
            // Enable Inputs
            document.getElementById('editCustName').disabled = false;
            document.getElementById('editCustPhone').disabled = false;
            document.getElementById('editTotal').disabled = false;
            document.getElementById('editMode').disabled = false;
  
// NEW: Toggle Item Views
    document.getElementById('viewItemsList').classList.add('hidden'); // Hide static
    document.getElementById('editItemsWrapper').classList.remove('hidden'); // Show dynamic
    
    renderEditItems(); // Draw the editable list
          
            // Toggle Buttons
            document.getElementById('btnAdminEdit').classList.add('hidden');
            document.getElementById('btnAdminSave').classList.remove('hidden');
        }

        function disableAdminEdit() {
            document.getElementById('editCustName').disabled = true;
            document.getElementById('editCustPhone').disabled = true;
            document.getElementById('editTotal').disabled = true;
            document.getElementById('editMode').disabled = true;
            
// NEW: Toggle Item Views Back
    document.getElementById('viewItemsList').classList.remove('hidden');
    document.getElementById('editItemsWrapper').classList.add('hidden');
            document.getElementById('btnAdminEdit').classList.remove('hidden');
            document.getElementById('btnAdminSave').classList.add('hidden');
        }

        async function saveAdminOrder() {
    if(!confirm('Save changes to this historical order?\n(Customer points will be recalculated)')) return;

    // 1. Prepare the New Data from your Inputs/Temp State
    const newTotal = Number(document.getElementById('editTotal').value);
    const newItems = TEMP_EDIT_ITEMS;
    const newPhone = document.getElementById('editCustPhone').value;
    const newName = document.getElementById('editCustName').value;
    const newMode = document.getElementById('editMode').value;

    try {
        const { doc, runTransaction, serverTimestamp } = window.firebaseModules;
        
        // 2. Run a Transaction (Ensures points & order update together)
        await runTransaction(window.db, async (transaction) => {
            
            // A. Get references
            const orderRef = doc(window.db, 'orders', CURRENT_VIEW_ORDER_ID);
            const orderDoc = await transaction.get(orderRef);
            if (!orderDoc.exists()) throw "Order does not exist!";

            const oldOrderData = orderDoc.data();
            const isCompleted = oldOrderData.status === 'completed';

            // B. Calculate Point Adjustments (Only if order is completed)
            let newBonus = 0;
            
            if (isCompleted) {
                // Calculate what the bonus SHOULD be now (5% of new total)
                newBonus = Math.floor(newTotal * 0.05);

                // Get the OLD bonus (use recorded 'bonusEarned' or calculate it if missing)
                const oldBonus = oldOrderData.bonusEarned !== undefined 
                    ? oldOrderData.bonusEarned 
                    : Math.floor(oldOrderData.total * 0.05);

                const pointDifference = newBonus - oldBonus;

                // Update Customer Points
                // Note: We use the OLD phone to find the customer in case you changed the number
                const custPhone = oldOrderData.phone; 
                const custRef = doc(window.db, 'customers', custPhone);
                const custDoc = await transaction.get(custRef);

                if (custDoc.exists()) {
                    const currentPoints = custDoc.data().points || 0;
                    const newBalance = currentPoints + pointDifference;
                    
                    // Prevent negative points (optional, but good practice)
                    if (newBalance < 0) {
                        // You can throw an error here if you want to block the edit, 
                        // or just set it to 0. We'll allow it but warn in console.
                        console.warn("Customer points dropped below zero.");
                    }

                    transaction.update(custRef, { points: newBalance });
                }
            }

            // C. Update the Order Document
            transaction.update(orderRef, {
                customerName: newName,
                phone: newPhone,
                finalPaid: newTotal,
                total: newTotal,
                paymentMode: newMode,
                items: newItems,
                bonusEarned: newBonus // Save the new bonus amount so next time it's accurate
            });
        });
        
        // 3. Success UI Updates
        showToast('Order & Points Updated Successfully');
        disableAdminEdit();
        closeDetailsModal();
        
        // Refresh Lists
        if(STATE.role === 'admin') searchHistory();
        else loadOrders(); 

    } catch(e) {
        console.error(e);
        showToast('Update Failed: ' + e.message, 'error');
    }
}

// 1. Render the editable list with Qty inputs and Delete buttons
function renderEditItems() {
    const container = document.getElementById('editItemsList');
    container.innerHTML = TEMP_EDIT_ITEMS.map((item, index) => `
        <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.05); padding:8px; border-radius:6px;">
            <div style="flex:1;">
                <div style="font-size:0.9rem;">${item.name}</div>
                <div class="text-muted" style="font-size:0.75rem;">‚Çπ${item.price} each</div>
            </div>
            <div style="display:flex; align-items:center; gap:8px;">
                <input type="number" value="${item.qty}" min="1" 
                    style="width:50px; padding:4px; border-radius:4px; border:none;"
                    onchange="adminUpdateItemQty(${index}, this.value)">
                <button class="btn btn-danger btn-sm" onclick="adminRemoveItem(${index})">üóëÔ∏è</button>
            </div>
        </div>
    `).join('');
    
    recalcEditTotal(); // Auto-update the total price
}

// 2. Update Quantity
function adminUpdateItemQty(index, newQty) {
    const qty = parseInt(newQty);
    if (qty > 0) {
        TEMP_EDIT_ITEMS[index].qty = qty;
        recalcEditTotal();
    }
}

// 3. Remove Item
function adminRemoveItem(index) {
    TEMP_EDIT_ITEMS.splice(index, 1);
    renderEditItems();
}

// 4. Add New Item from Dropdown
function adminAddNewItem(selectEl) {
    const itemId = selectEl.value;
    if (!itemId) return;

    const menuItem = STATE.menu.find(m => m.id === itemId);
    if (menuItem) {
        // Check if already exists, just add qty
        const existing = TEMP_EDIT_ITEMS.find(i => i.id === itemId);
        if (existing) {
            existing.qty++;
        } else {
            TEMP_EDIT_ITEMS.push({ ...menuItem, qty: 1 });
        }
        renderEditItems();
    }
    selectEl.value = ""; // Reset dropdown
}

// 5. Auto-Calculate Total
function recalcEditTotal() {
    const total = TEMP_EDIT_ITEMS.reduce((sum, item) => sum + (item.price * item.qty), 0);
    document.getElementById('editTotal').value = total;
}

        function filterAdminOrders(val) {
            const cards = document.querySelectorAll('#adminOrdersList .order-card');
            cards.forEach(c => c.style.display = c.innerText.includes(val) ? 'flex' : 'none');
        }

        // --- MENU ITEM LOGIC ---
        function showAddItemModal(id = null) {
            document.getElementById('addItemModal').classList.remove('hidden');
            if(id) {
                const item = STATE.menu.find(i => i.id === id);
                document.getElementById('newItemName').value = item.name;
                document.getElementById('newItemPrice').value = item.price;
                document.getElementById('newItemCat').value = item.category;
                document.getElementById('addItemModal').dataset.id = id;
            } else {
                document.getElementById('newItemName').value = '';
                document.getElementById('newItemPrice').value = '';
                document.getElementById('newItemCat').value = '';
                delete document.getElementById('addItemModal').dataset.id;
            }
        }

        async function saveMenuItem() {
            const name = document.getElementById('newItemName').value;
            const price = Number(document.getElementById('newItemPrice').value);
            const category = document.getElementById('newItemCat').value;
            const id = document.getElementById('addItemModal').dataset.id;
            const { collection, addDoc, doc, updateDoc } = window.firebaseModules;
            try {
                if(id) { await updateDoc(doc(window.db, 'menu', id), { name, price, category }); } 
                else { await addDoc(collection(window.db, 'menu'), { name, price, category }); }
                document.getElementById('addItemModal').classList.add('hidden');
                showToast('Saved');
            } catch(e) { showToast(e.message, 'error'); }
        }

        async function editItem(id) { showAddItemModal(id); }
        async function deleteItem(id) {
            if(!confirm('Delete item?')) return;
            await window.firebaseModules.deleteDoc(window.firebaseModules.doc(window.db, 'menu', id));
        }

        // --- OUTLET POS ---
        function switchOutletTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            ['view-pos', 'view-incoming', 'view-current', 'view-completed'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
        }

function filterMenu(text) {
            STATE.searchQuery = text.trim().toLowerCase();
            renderOutletMenu();
        }

        function renderOutletMenu() {
            const sidebar = document.getElementById('posSidebar');
            
            // 1. Safe Category Rendering (Fixes clicking issues)
            const cats = ['All', ...STATE.categories.map(c => c.name)];
            
            sidebar.innerHTML = cats.map(cat => {
                // Escape quotes to prevent code breaking on names like "Chef's Special"
                const safeCat = cat.replace(/'/g, "\\'");
                const isActive = STATE.activeCategory === cat;
                
                return `
                <div class="cat-btn ${isActive ? 'active' : ''}" 
                     onclick="filterCategory('${safeCat}')">${cat}</div>
                `;
            }).join('');
            
            const grid = document.getElementById('posGrid');
            let items = [];

            // 2. Robust Filtering Logic
            if (STATE.searchQuery) {
                // If searching, ignore category and look at names
                items = STATE.menu.filter(item => 
                    item.name.toLowerCase().includes(STATE.searchQuery)
                );
            } else {
                // If filtering by category
                if (STATE.activeCategory === 'All') {
                    items = STATE.menu;
                } else {
                    // FIX: Compare trimmed strings to ignore accidental spaces
                    items = STATE.menu.filter(m => 
                        (m.category || '').trim() === STATE.activeCategory.trim()
                    );
                }
            }
            
            // 3. Render Items (With New Visual Design)
            if (items.length === 0) {
                const msg = STATE.searchQuery 
                    ? `No items match "${STATE.searchQuery}"` 
                    : `No items in ${STATE.activeCategory}`;
                grid.innerHTML = `<div class="text-muted" style="grid-column: 1/-1; text-align:center; padding:20px;">${msg}</div>`;
            } else {
                grid.innerHTML = items.map(item => {
                    const cartItem = STATE.cart.find(c => c.id === item.id);
                    const qty = cartItem ? cartItem.qty : 0;
                    
                    // Quantity Badge
                    const qtyBadge = qty > 0 
                        ? `<div style="position:absolute; top:8px; right:8px; background:white; color:var(--primary); width:22px; height:22px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:0.8rem; box-shadow:0 2px 5px rgba(0,0,0,0.5); z-index:2;">${qty}</div>` 
                        : '';
                    
                    // Highlight if selected
                    const selectedStyle = qty > 0 ? 'border-color: var(--primary); background: rgba(255, 107, 53, 0.15);' : '';

                    return `
                    <div class="menu-item" onclick="addToCart('${item.id}')" style="${selectedStyle}">
                        ${qtyBadge}
                        <div class="item-name-clamp" title="${item.name}">${item.name}</div>
                        <div class="item-price-tag">‚Çπ${item.price}</div>
                    </div>
                `}).join('');
            }
        }

        function filterCategory(cat) {
            STATE.activeCategory = cat;
            
            // Clear Search when switching categories
            STATE.searchQuery = ''; 
            const searchInput = document.querySelector('#view-pos input[type="text"]');
            if(searchInput) searchInput.value = '';

            if(STATE.role === 'staff') renderOutletMenu();
            if(STATE.role === 'customer') renderCustomerMenu();
        }

        function addToCart(itemId) {
            const item = STATE.menu.find(i => i.id === itemId);
            const targetCart = STATE.role === 'customer' ? STATE.custCart : STATE.cart;
            const existing = targetCart.find(c => c.id === itemId);
            if(existing) existing.qty++;
            else targetCart.push({ ...item, qty: 1 });
            renderActiveCart();
        }

        function updateQty(itemId, delta) {
            const targetCart = STATE.role === 'customer' ? STATE.custCart : STATE.cart;
            const item = targetCart.find(c => c.id === itemId);
            if(!item) return;
            item.qty += delta;
            if(item.qty <= 0) {
                if(STATE.role === 'customer') STATE.custCart = STATE.custCart.filter(c => c.id !== itemId);
                else STATE.cart = STATE.cart.filter(c => c.id !== itemId);
            }
            renderActiveCart();
        }

        function clearCart() {
            STATE.cart = [];
            STATE.editingOrderId = null;
            document.getElementById('posPhone').value = '';
            document.getElementById('btnPlaceOrder').classList.remove('hidden');
            document.getElementById('btnUpdateOrder').classList.add('hidden');
            renderActiveCart();
        }

        function renderActiveCart() {
            if(STATE.role === 'customer') {
                renderCartGeneric(document.getElementById('custCartItems'), document.getElementById('custCartTotal'), STATE.custCart);
                renderCustomerMenu();
            } else {
                renderCartGeneric(document.getElementById('cartItemsList'), document.getElementById('cartTotal'), STATE.cart);
                renderOutletMenu();
            }
        }

        function renderCartGeneric(container, totalEl, cartArray) {
            if(cartArray.length === 0) {
                container.innerHTML = '<div class="text-center text-muted" style="margin-top:20px;">Cart is empty</div>';
                totalEl.innerText = '‚Çπ0';
                return;
            }
            let total = 0;
            container.innerHTML = cartArray.map(item => {
                total += item.price * item.qty;
                return `
                    <div class="cart-item">
                        <div>
                            <div style="font-size: 0.9rem;">${item.name}</div>
                            <div class="text-muted" style="font-size: 0.8rem;">‚Çπ${item.price} x ${item.qty}</div>
                        </div>
                        <div class="qty-controls">
                            <div class="qty-btn" onclick="updateQty('${item.id}', -1)">-</div>
                            <span style="padding: 0 5px;">${item.qty}</span>
                            <div class="qty-btn" onclick="updateQty('${item.id}', 1)">+</div>
                        </div>
                    </div>
                `;
            }).join('');
            totalEl.innerText = '‚Çπ' + total;
        }

        async function placeOrder() {
            const phone = document.getElementById('posPhone').value;
            if(phone.length !== 10) return showToast('Enter 10-digit Phone', 'error');
            if(STATE.cart.length === 0) return showToast('Cart is empty', 'error');
            await submitOrder(phone, STATE.cart, 'pending');
            clearCart();
            switchOutletTab('current');
        }

        async function placeCustomerOrder() {
            if(STATE.custCart.length === 0) return showToast('Cart is empty', 'error');
            await submitOrder(STATE.user.phone, STATE.custCart, 'requested');
            STATE.custCart = [];
            renderActiveCart();
            showToast('Order Request Sent');
            switchCustTab('history');
        }

        async function submitOrder(phone, items, status) {
            const { addDoc, collection, serverTimestamp, doc, setDoc, getDoc } = window.firebaseModules;
            
            // 1. Fetch Customer Details
            const custRef = doc(window.db, 'customers', phone);
            const custSnap = await getDoc(custRef);
            
            let custName = ''; // Default if name not found

            if (!custSnap.exists()) {
                // Create new customer if they don't exist
                await setDoc(custRef, { phone, points: 0, joined: serverTimestamp() });
            } else {
                // Get existing name
                custName = custSnap.data().name || '';
            }
            
            const total = items.reduce((s, i) => s + (i.price * i.qty), 0);
            
            // 2. Save Order WITH Name
            await addDoc(collection(window.db, 'orders'), {
                items: items, 
                phone: phone, 
                customerName: custName, // <--- Name restored here
                total: total, 
                status: status, 
                timestamp: serverTimestamp()
            });
        }

        function loadOrders() {
    const { collection, query, orderBy, onSnapshot, where } = window.firebaseModules;
    
    // 1. Define "Start of Today" (Midnight)
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // 2. Updated Query: Only fetch orders where timestamp is >= Today
    // NOTE: This will require a Firestore Index. Check your browser console for the link!
    const q = query(
        collection(window.db, 'orders'), 
        where('timestamp', '>=', today),
        orderBy('timestamp', 'desc')
    );
    
    onSnapshot(q, (snap) => {
        const orders = snap.docs.map(d => ({id: d.id, ...d.data()}));

STATE.orders = orders;
        
        // Filter 1: Incoming Requests
        const requested = orders.filter(o => o.status === 'requested');
        renderIncoming(requested);
        
        // Filter 2: Pending Orders
        const pending = orders.filter(o => o.status === 'pending');
        renderCurrentOrders(pending);
        
        // Filter 3: Completed Orders (Already filtered to "Today" by the query above)
        const completed = orders.filter(o => o.status === 'completed');
        renderCompletedOrders(completed);
        
        // Badge Logic
        const badge = document.getElementById('badgeIncoming');
        if(requested.length > 0) badge.classList.remove('hidden');
        else badge.classList.add('hidden');
    });
}

async function searchHistory() {
    const startVal = document.getElementById('historyStart').value;
    const endVal = document.getElementById('historyEnd').value;
    
    if(!startVal || !endVal) return showToast('Please select both dates', 'error');

    const startDate = new Date(startVal);
    const endDate = new Date(endVal);
    endDate.setHours(23, 59, 59, 999); // Set to end of the selected day

    // UI Loading State
    const list = document.getElementById('adminOrdersList');
    list.innerHTML = '<p class="text-center">Searching...</p>';

    const { collection, query, where, orderBy, getDocs } = window.firebaseModules;

    try {
        // Query for history range
        const q = query(
            collection(window.db, 'orders'),
            where('timestamp', '>=', startDate),
            where('timestamp', '<=', endDate),
            orderBy('timestamp', 'desc')
        );

        const snap = await getDocs(q);

        if(snap.empty) {
            list.innerHTML = '<p class="text-muted text-center" style="padding:20px;">No orders found in this range.</p>';
            return;
        }

        const orders = snap.docs.map(d => ({id: d.id, ...d.data()}));

        // Render Results (Reusing your card design)
        list.innerHTML = orders.map(o => {
            const dateStr = o.timestamp ? new Date(o.timestamp.toDate()).toLocaleDateString() + ' ' + new Date(o.timestamp.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'N/A';
            
            // Determine status color
            let statusColor = '#4CAF50'; // Default success
            if(o.status === 'cancelled') statusColor = '#FF5252';
            if(o.status === 'pending') statusColor = '#FFC107';

            return `
            <div class="order-card" onclick="viewOrderDetails('${o.id}')" style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;">
                <div>
                    <div style="font-weight:bold; font-size:1.1rem;">${o.customerName || o.phone}</div>
                    <div class="text-muted" style="font-size:0.85rem;">${dateStr} ‚Ä¢ <span style="color:${statusColor}">${o.status.toUpperCase()}</span></div>
                    <div class="text-muted" style="font-size:0.8rem;">‚Çπ${o.total} ‚Ä¢ ${o.paymentMode || 'Cash'}</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-weight:bold; font-size:1.2rem;">‚Çπ${o.total}</div>
                    <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); adminDeleteOrder('${o.id}')" style="margin-top:5px;">üóëÔ∏è</button>
                </div>
            </div>
        `;}).join('');

    } catch (e) {
        console.error(e);
        list.innerHTML = `<p class="text-danger text-center">Error: ${e.message}</p>`;
        // Note: The first time you run this, check the console for the index link!
    }
}

        function renderIncoming(orders) {
            document.getElementById('incomingOrdersList').innerHTML = orders.map(o => {
                let timeStr = o.timestamp ? o.timestamp.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                const callBtn = `<button class="btn btn-secondary btn-sm" style="padding:2px 6px; margin-left:8px; border-radius:50%;" onclick="callCustomer('${o.phone}', event)">üìû</button>`;

const customerDisplay = o.customerName 
    ? `<strong>${o.customerName}</strong> <span style="font-weight:normal; font-size:0.8rem">(${o.phone})</span>${callBtn}`
    : `<strong>${o.phone}</strong>${callBtn}`;

                return `
                <div class="order-card">
                    <div class="flex justify-between" style="align-items:center; margin-bottom:8px;">
                        <div>
                            <span class="order-status status-requested">REQUESTED</span>
                            <span class="text-muted" style="font-size:0.75rem;">${timeStr}</span>
                        </div>
                        <strong style="font-size:1.1rem;">‚Çπ${o.total}</strong>
                    </div>
                    
                    <div style="margin-bottom:8px;">${customerDisplay}</div>
                    
                    <div class="text-muted" style="font-size:0.9rem; border-top:1px solid rgba(255,255,255,0.1); padding-top:8px;">
                        ${o.items.map(i => `${i.qty}x ${i.name}`).join(', ')}
                    </div>
                    
                    <div class="flex gap-2" style="margin-top:10px;">
                        <button class="btn btn-success w-full" onclick="updateOrderStatus('${o.id}', 'pending')">Accept</button>
                        <button class="btn btn-danger w-full" onclick="updateOrderStatus('${o.id}', 'cancelled')">Reject</button>
                    </div>
                </div>
            `}).join('');
        }

       function renderCurrentOrders(orders) {
            document.getElementById('currentOrdersList').innerHTML = orders.map(o => {
                // 1. Format Date & Time
                let timeStr = 'Just now';
                if(o.timestamp) {
                    const d = o.timestamp.toDate();
                    timeStr = `${d.getDate()}/${d.getMonth()+1} ${d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                }

                const callBtn = `<button class="btn btn-secondary btn-sm" style="padding:2px 6px; margin-left:8px; border-radius:50%;" onclick="callCustomer('${o.phone}', event)">üìû</button>`;

// 2. Format Name & Phone Display
const customerDisplay = o.customerName 
    ? `<div style="font-weight:bold; font-size:1rem; line-height:1.2; display:flex; align-items:center;">
          ${o.customerName} ${callBtn}
       </div>
       <div style="font-size:0.85rem; color:#aaa;">${o.phone}</div>`
    : `<div style="font-weight:bold; font-size:1rem; display:flex; align-items:center;">
          ${o.phone} ${callBtn}
       </div>`;

                return `
                <div class="order-card">
                    <div class="flex justify-between" style="align-items:flex-start; margin-bottom:8px;">
                        <div>
                            <div style="margin-bottom:5px;">${customerDisplay}</div>
                            <span class="order-status status-pending" style="font-size:0.65rem;">PENDING</span>
                            <span class="text-muted" style="font-size:0.75rem; margin-left:5px;">üìÖ ${timeStr}</span>
                        </div>
                        <div style="text-align:right;">
                            <strong style="font-size:1.2rem; display:block;">‚Çπ${o.total}</strong>
                            <button class="btn btn-danger btn-sm" style="padding: 2px 8px; margin-top:5px; font-size:0.7rem;" onclick="deletePendingOrder('${o.id}')">üóëÔ∏è Cancel</button>
                        </div>
                    </div>
                    
                    <div class="text-muted" style="font-size:0.9rem; border-top:1px solid rgba(255,255,255,0.1); padding-top:8px; margin-top:5px;">
                        ${o.items.map(i => `${i.qty}x ${i.name}`).join(', ')}
                    </div>
                    
                    <div class="flex gap-2" style="margin-top:12px;">
    <button class="btn btn-secondary" style="background:#444;" onclick="printKOTDirect('${o.id}')">üñ®Ô∏è KOT</button>
    
    <button class="btn btn-secondary w-full" onclick="editOrder('${o.id}')">‚úèÔ∏è Edit</button>
    <button class="btn btn-success w-full" onclick="openPaymentModal('${o.id}', ${o.total}, '${o.phone}')">‚úÖ Bill</button>
</div>
                </div>
            `}).join('');
        }

function printKOT(orderId) {
    // 1. Find the order in our local list (Pending or Completed)
    // We search all lists to be safe
    const allOrders = [...STATE.orders]; 
    const order = allOrders.find(o => o.id === orderId);

    if (!order) return showToast('Order data not found for printing', 'error');

    // 2. Format Data
    const serial = order.timestamp ? order.timestamp.toMillis().toString().slice(-4) : '????';
    const dateObj = order.timestamp ? order.timestamp.toDate() : new Date();
    const time = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const totalQty = order.items.reduce((sum, i) => sum + i.qty, 0);

    // 3. Generate HTML
    const html = `
        <div class="kot-header">
            <div class="kot-title">KOT #${serial}</div>
            <div class="kot-meta">${time} ‚Ä¢ ${order.status.toUpperCase()}</div>
            <div class="kot-meta">Customer: ${order.customerName || 'Guest'}</div>
        </div>
        <div class="kot-items">
            ${order.items.map(item => `
                <div class="kot-item-row">
                    <div style="width:20px;">${item.qty}</div>
                    <div style="flex:1;">${item.name}</div>
                </div>
            `).join('')}
        </div>
        <div class="kot-footer">
            Total Items: ${totalQty}<br>
            *** KITCHEN COPY ***
        </div>
    `;

    // 4. Inject and Print
    document.getElementById('kot-receipt').innerHTML = html;
    
    // Small delay to ensure rendering before print trigger
    setTimeout(() => {
        window.print();
    }, 200);
}

        function renderCompletedOrders(orders) {
            document.getElementById('completedOrdersList').innerHTML = orders.map(o => {
                // 1. Format Date & Time
                let timeStr = '';
                if(o.timestamp) {
                    const d = o.timestamp.toDate();
                    timeStr = `${d.getDate()}/${d.getMonth()+1} ${d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                }

                // 2. Format Name & Phone
                const customerDisplay = o.customerName 
                    ? `<div style="font-weight:bold; font-size:1rem; line-height:1.2;">${o.customerName}</div><div style="font-size:0.85rem; color:#aaa;">${o.phone}</div>`
                    : `<div style="font-weight:bold; font-size:1rem;">${o.phone}</div>`;

                return `
                <div class="order-card" onclick="viewOrderDetails('${o.id}')" style="cursor:pointer;">
                    <div class="flex justify-between" style="align-items:flex-start;">
                        <div>
                            <div style="margin-bottom:5px;">${customerDisplay}</div>
                            <span class="order-status status-completed" style="font-size:0.65rem;">COMPLETED</span>
                            <span class="text-muted" style="font-size:0.75rem; margin-left:5px;">üìÖ ${timeStr}</span>
                        </div>
                        <div style="text-align:right;">
                            <strong style="font-size:1.2rem; display:block;">‚Çπ${o.total}</strong>
                            <span class="text-muted" style="font-size:0.7rem;">${o.paymentMode || 'Cash'}</span>
                        </div>
                    </div>
                    
                    <div class="text-muted" style="font-size:0.9rem; border-top:1px solid rgba(255,255,255,0.1); padding-top:8px; margin-top:8px;">
                        ${o.items.map(i => `${i.qty}x ${i.name}`).join(', ')}
                    </div>

<div class="flex gap-2" style="margin-top:10px;">
    <button class="btn btn-secondary btn-sm" style="background:#444;" onclick="event.stopPropagation(); printBillDirect('${o.id}')">
        üñ®Ô∏è
    </button>
    <button class="btn btn-secondary w-full btn-sm" onclick="callCustomer('${o.phone}', event)">
        üìû Call
    </button>

    <button class="btn btn-success w-full btn-sm" onclick="event.stopPropagation(); sendBillFromHistory('${o.phone}', '${o.id}', 'whatsapp')">
        üì± WA
    </button>
    <button class="btn btn-primary w-full btn-sm" onclick="event.stopPropagation(); sendBillFromHistory('${o.phone}', '${o.id}', 'sms')">
        üí¨ SMS
    </button>
</div>
                </div>
            `}).join('');
        }

        // Added 'type' parameter to handle both sms and whatsapp
        function sendBillFromHistory(phone, orderId, type) {
            const { doc, getDoc } = window.firebaseModules;
            getDoc(doc(window.db, 'orders', orderId)).then(snap => {
                if(snap.exists()) {
                    const data = snap.data();
                    // Load data into global state so sendBill() can read it
                    PAYMENT_DATA = { 
                        ...data, 
                        serial: data.timestamp ? data.timestamp.toMillis().toString().slice(-4) : '0000', 
                        bonusEarned: data.bonusEarned || 0, 
                        finalPaid: data.finalPaid || data.total, 
                        change: data.changeReturn || 0, 
                        mode: data.paymentMode || 'Cash' 
                    };
                    // Call the main send function with the specific type
                    sendBill(type);
                }
            });
        }

        async function updateOrderStatus(id, status) {
            await window.firebaseModules.updateDoc(window.firebaseModules.doc(window.db, 'orders', id), { status });
        }

        function editOrder(orderId) {
            const { doc, getDoc } = window.firebaseModules;
            getDoc(doc(window.db, 'orders', orderId)).then(snap => {
                if(snap.exists()) {
                    const data = snap.data();
                    STATE.cart = data.items;
                    STATE.editingOrderId = orderId;
                    switchOutletTab('pos');
                    document.getElementById('posPhone').value = data.phone;
                    document.getElementById('btnPlaceOrder').classList.add('hidden');
                    document.getElementById('btnUpdateOrder').classList.remove('hidden');
                    renderActiveCart();
                    showToast('Order Loaded for Editing');
                }
            });
        }
async function deletePendingOrder(orderId) {
            if(!confirm('Are you sure you want to cancel this order?')) return;
            
            try {
                // FIX: Use updateDoc instead of deleteDoc to avoid Permission Errors.
                // Marking as 'cancelled' removes it from the Pending list essentially "deleting" it from view.
                const { doc, updateDoc } = window.firebaseModules;
                
                await updateDoc(doc(window.db, 'orders', orderId), {
                    status: 'cancelled'
                });
                
                showToast('Order Cancelled Successfully');
            } catch (e) {
                console.error(e);
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function updateExistingOrder() {
            if(!STATE.editingOrderId) return;
            
            // 1. Capture the (potentially edited) Phone Number
            const newPhone = document.getElementById('posPhone').value;
            
            if(!newPhone || newPhone.length !== 10) {
                return showToast('Please enter a valid 10-digit phone number', 'error');
            }

            const total = STATE.cart.reduce((s, i) => s + (i.price * i.qty), 0);
            
            const { doc, updateDoc, getDoc, setDoc, serverTimestamp } = window.firebaseModules;

            try {
                // 2. Ensure Customer Exists (in case the number was changed to a new customer)
                const custRef = doc(window.db, 'customers', newPhone);
                const custSnap = await getDoc(custRef);
                
                let custName = '';
                if (!custSnap.exists()) {
                    // Create new customer profile for the new number
                    await setDoc(custRef, { phone: newPhone, points: 0, joined: serverTimestamp() });
                } else {
                    custName = custSnap.data().name || '';
                }

                // 3. Update the Order with New Items AND New Phone/Name
                await updateDoc(doc(window.db, 'orders', STATE.editingOrderId), {
                    items: STATE.cart, 
                    total: total,
                    phone: newPhone,       // Update Phone
                    customerName: custName // Update Name associated with that phone
                });
                
                showToast('Order & Phone Updated');
                clearCart();
                switchOutletTab('current');

            } catch (e) {
                console.error(e);
                showToast('Update failed: ' + e.message, 'error');
            }
        }

        // --- PAYMENT & BILLING ---
        let PAYMENT_DATA = { orderId: null, total: 0, phone: null, maxPoints: 0 };

        function setPaymentMode(mode) {
            document.getElementById('paymentModeInput').value = mode;
            const btnCash = document.getElementById('btnModeCash');
            const btnOnline = document.getElementById('btnModeOnline');
            const cashSection = document.getElementById('cashCalcSection');
            
            if(mode === 'Cash') {
                btnCash.classList.add('btn-primary');
                btnCash.classList.remove('btn-secondary');
                btnOnline.classList.add('btn-secondary');
                btnOnline.classList.remove('btn-primary');
                cashSection.classList.remove('hidden');
            } else {
                btnOnline.classList.add('btn-primary');
                btnOnline.classList.remove('btn-secondary');
                btnCash.classList.add('btn-secondary');
                btnCash.classList.remove('btn-primary');
                cashSection.classList.add('hidden');
            }
        }

        function calculateChange() {
            const given = parseInt(document.getElementById('cashGiven').value) || 0;
            const redeem = parseInt(document.getElementById('redeemInput').value) || 0;
            const netPayable = PAYMENT_DATA.total - redeem;
            const change = given - netPayable;
            const returnEl = document.getElementById('cashReturn');
            
            if(change >= 0) {
                returnEl.innerText = '‚Çπ' + change;
                returnEl.style.color = 'var(--success)';
            } else {
                returnEl.innerText = 'Short by ‚Çπ' + Math.abs(change);
                returnEl.style.color = 'var(--danger)';
            }
        }

        async function openPaymentModal(orderId, total, phone) {
            PAYMENT_DATA = { orderId, total, phone, maxPoints: 0 };
            
            // UI Reset
            document.getElementById('payCustPhone').innerText = phone;
            document.getElementById('payBillTotal').innerText = '‚Çπ' + total;
            document.getElementById('redeemInput').value = '';
            document.getElementById('payNetTotal').innerText = '‚Çπ' + total;
            document.getElementById('payAvailPoints').innerText = 'Loading...';
            document.getElementById('cashGiven').value = '';
            document.getElementById('cashReturn').innerText = '‚Çπ0';
            
            // SHOW Input Section, HIDE Success Section
            document.getElementById('paymentModal').classList.remove('hidden');
            document.getElementById('paymentInputSection').classList.remove('hidden');
            document.getElementById('paymentSuccessSection').classList.add('hidden');

            setPaymentMode('Cash');

            // Fetch Customer Points
            const { doc, getDoc } = window.firebaseModules;
            const custRef = doc(window.db, 'customers', phone);
            const snap = await getDoc(custRef);
            
            if(snap.exists()) {
                const pts = snap.data().points || 0;
                PAYMENT_DATA.maxPoints = pts;
                document.getElementById('payAvailPoints').innerText = pts + ' pts';
            } else {
                document.getElementById('payAvailPoints').innerText = '0 pts';
            }
        }

        function updatePaymentCalc() {
            let redeem = parseInt(document.getElementById('redeemInput').value) || 0;
            const bill = PAYMENT_DATA.total;
            const max = PAYMENT_DATA.maxPoints;

            if (redeem > max) redeem = max;
            if (redeem > bill) redeem = bill;

            document.getElementById('redeemInput').value = redeem > 0 ? redeem : '';
            document.getElementById('payNetTotal').innerText = '‚Çπ' + (bill - redeem);
            calculateChange();
        }

        function useMaxPoints() {
            let maxUsable = Math.min(PAYMENT_DATA.maxPoints, PAYMENT_DATA.total);
            document.getElementById('redeemInput').value = maxUsable;
            updatePaymentCalc();
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.add('hidden');
        }

        async function processPayment() {
            const redeem = parseInt(document.getElementById('redeemInput').value) || 0;
            const netPayable = PAYMENT_DATA.total - redeem;
            const payMode = document.getElementById('paymentModeInput').value;
            const cashGiven = parseInt(document.getElementById('cashGiven').value) || 0;
            const changeReturn = cashGiven - netPayable;

            if(!confirm(`Confirm Payment?\nMode: ${payMode}\nAmount: ‚Çπ${netPayable}`)) return;

            const { doc, runTransaction } = window.firebaseModules;

            try {
                await runTransaction(window.db, async (transaction) => {
                    const orderRef = doc(window.db, 'orders', PAYMENT_DATA.orderId);
                    const custRef = doc(window.db, 'customers', PAYMENT_DATA.phone);

                    const orderDoc = await transaction.get(orderRef);
                    const custDoc = await transaction.get(custRef);
                    if (!orderDoc.exists()) throw "Order not found!";
                    
                    // Save items for bill
                    PAYMENT_DATA.items = orderDoc.data().items;
                    PAYMENT_DATA.serial = orderDoc.data().timestamp ? orderDoc.data().timestamp.toMillis().toString().slice(-4) : '0000';
                    
                    const currentPoints = custDoc.exists() ? (custDoc.data().points || 0) : 0;
                    if (redeem > currentPoints) throw "Insufficient points!";

                    const newBonus = Math.floor(netPayable * 0.05);
                    
                    // Update Customer
                    if(custDoc.exists()) {
                        transaction.update(custRef, { points: (currentPoints - redeem) + newBonus });
                    }

                    // Update Order
                    transaction.update(orderRef, { 
                        status: 'completed',
                        redeemed: redeem,
                        finalPaid: netPayable,
                        bonusEarned: newBonus,
                        paymentMode: payMode,
                        cashGiven: (payMode === 'Cash' ? cashGiven : 0),
                        changeReturn: (payMode === 'Cash' ? changeReturn : 0)
                    });

                    // Store Data for Bill
                    PAYMENT_DATA.finalPaid = netPayable;
                    PAYMENT_DATA.redeemed = redeem;
                    PAYMENT_DATA.bonusEarned = newBonus;
                    PAYMENT_DATA.cashGiven = cashGiven;
                    PAYMENT_DATA.change = changeReturn;
                    PAYMENT_DATA.mode = payMode;
                });

                // Show Success Screen
                document.getElementById('paymentInputSection').classList.add('hidden');
                document.getElementById('paymentSuccessSection').classList.remove('hidden');
                document.getElementById('billSerial').innerText = PAYMENT_DATA.serial;
                showToast(`Paid! Earned ${PAYMENT_DATA.bonusEarned} pts`);
            } catch (e) {
                console.error(e);
                showToast('Payment Failed: ' + e, 'error');
            }
        }

        function sendBill(type) {
            const s = STATE.storeSettings || { name: 'Juice Therapy', address: '', footer: 'Thank you!', link: '' };
            const d = PAYMENT_DATA;
            const date = new Date().toLocaleString('en-IN');
            
            let text = `üßæ *${s.name}*\n${s.address}\n\n`;
            text += `--------------------------------\n`;
            text += `*BILL RECEIPT* #${d.serial}\nDate: ${date}\nCustomer: ${d.phone}\n`;
            text += `--------------------------------\n`;
            
            if(d.items) {
                d.items.forEach(i => {
                    text += `${i.name} x ${i.qty} = ‚Çπ${i.price * i.qty}\n`;
                });
            }
            
            text += `--------------------------------\n`;
            text += `Total Amount:   ‚Çπ${d.total}\n`;
            if(d.redeemed > 0) text += `Bonus Used:    -‚Çπ${d.redeemed}\n`;
            text += `--------------------------------\n`;
            text += `*NET PAYABLE:   ‚Çπ${d.finalPaid}*\n`;
            text += `Paid via:       ${d.mode}\n`;
            
            if(d.mode === 'Cash') {
                text += `Cash Given:     ‚Çπ${d.cashGiven}\n`;
                text += `Return Change:  ‚Çπ${d.change}\n`;
            }
            
            text += `--------------------------------\n`;
            text += `Points Earned:  +${d.bonusEarned}\n`;
            text += `--------------------------------\n`;
            text += `${s.footer}\n${s.link}`;

            const encoded = encodeURIComponent(text);
            
            if (type === 'whatsapp') {
                window.open(`https://wa.me/91${d.phone}?text=${encoded}`, '_blank');
            } else {
                const shortText = `Bill for ${s.name}: ‚Çπ${d.finalPaid} paid. Points earned: ${d.bonusEarned}. Thanks!`;
                window.open(`sms:${d.phone}?body=${encodeURIComponent(shortText)}`, '_blank');
            }
        }

        // --- CUSTOMER PANEL ---
        function switchCustTab(tab) {
            document.getElementById('btn-cust-menu').classList.toggle('active', tab === 'menu');
            document.getElementById('btn-cust-history').classList.toggle('active', tab === 'history');
            document.getElementById('cust-view-menu').classList.toggle('hidden', tab !== 'menu');
            document.getElementById('cust-view-history').classList.toggle('hidden', tab !== 'history');
        }
function filterCustomerMenu(text) {
    STATE.searchQuery = text.trim().toLowerCase();
    renderCustomerMenu();
}
        function renderCustomerMenu() {
    const sidebar = document.getElementById('custSidebar');
    
    // 1. Render Categories (Safe rendering)
    const cats = ['All', ...STATE.categories.map(c => c.name)];
    
    sidebar.innerHTML = cats.map(cat => {
        const safeCat = cat.replace(/'/g, "\\'"); // Prevent errors with names like "Chef's"
        return `
        <div class="cat-btn ${cat === STATE.activeCategory ? 'active' : ''}" 
             onclick="filterCategory('${safeCat}')">${cat}</div>
        `;
    }).join('');
    
    const grid = document.getElementById('custGrid');
    let items = [];

    // 2. LOGIC FIX: Handle Search vs Category
    if (STATE.searchQuery) {
        // If searching, ignore category and search ALL items
        items = STATE.menu.filter(item => 
            item.name.toLowerCase().includes(STATE.searchQuery)
        );
    } else {
        // If not searching, use Category
        if (STATE.activeCategory === 'All') {
            items = STATE.menu;
        } else {
            // Trim strings to ensure "Juice " matches "Juice"
            items = STATE.menu.filter(m => 
                (m.category || '').trim() === STATE.activeCategory.trim()
            );
        }
    }
    
    // 3. Render Items
    if (items.length === 0) {
        grid.innerHTML = '<div class="text-muted" style="grid-column: 1/-1; text-align:center; padding:20px;">No items found</div>';
    } else {
        grid.innerHTML = items.map(item => {
            const cartItem = STATE.custCart.find(c => c.id === item.id);
            const qty = cartItem ? cartItem.qty : 0;
            
            // Badge & Styling
            const qtyBadge = qty > 0 ? `<div style="position:absolute; top:8px; right:8px; background:white; color:var(--primary); width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; box-shadow:0 2px 4px rgba(0,0,0,0.3); font-size:0.8rem;">${qty}</div>` : '';
            const borderStyle = qty > 0 ? 'border: 1px solid var(--primary); background: rgba(255, 107, 53, 0.1);' : '';

            return `
            <div class="menu-item" onclick="addToCart('${item.id}')" style="position:relative; ${borderStyle}">
                ${qtyBadge}
                <div style="font-weight:600; font-size: 0.9rem; padding-right:15px;">${item.name}</div>
                <div style="color: var(--primary); margin-top:5px;">‚Çπ${item.price}</div>
            </div>
        `}).join('');
    }
}

        function loadCustomerHistory(phone) {
            const { collection, query, where, onSnapshot } = window.firebaseModules;
            
            const q = query(collection(window.db, 'orders'), where('phone', '==', phone));
            
            onSnapshot(q, (snap) => {
                const list = document.getElementById('custHistoryList');
                if(snap.empty) { 
                    list.innerHTML = '<p class="text-center text-muted" style="padding:20px;">No orders found.</p>'; 
                    return; 
                }

                const sortedDocs = snap.docs.sort((a, b) => {
                    const tA = a.data().timestamp ? a.data().timestamp.seconds : 0;
                    const tB = b.data().timestamp ? b.data().timestamp.seconds : 0;
                    return tB - tA;
                });

                list.innerHTML = sortedDocs.map(d => {
                    const o = d.data();
                    let stClass = 'status-pending';
                    if (o.status === 'completed') stClass = 'status-completed';
                    else if (o.status === 'requested') stClass = 'status-requested';
                    else if (o.status === 'cancelled') stClass = 'status-cancelled';

                    let dateStr = 'Processing...';
                    if(o.timestamp) {
                        const dateObj = o.timestamp.toDate();
                        dateStr = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    }

                    return `
                        <div class="order-card">
                            <div class="flex justify-between" style="margin-bottom:8px;">
                                <div style="display:flex; flex-direction:column; gap:4px;">
                                    <span class="order-status ${stClass}" style="width:fit-content;">${o.status.toUpperCase()}</span>
                                    <span style="font-size:0.75rem; color:#888;">${dateStr}</span>
                                </div>
                                <div style="font-weight:bold; font-size:1.1rem;">‚Çπ${o.total}</div>
                            </div>
                            <div class="text-muted" style="font-size:0.85rem; border-top:1px solid rgba(255,255,255,0.05); padding-top:8px;">
                                ${o.items.map(i => `${i.qty} x ${i.name}`).join(', ')}
                            </div>
                        </div>
                    `;
                }).join('');
            });
        }

        function showToast(msg, type='success') {
            const el = document.getElementById('notification');
            el.innerText = msg;
            el.style.backgroundColor = type === 'error' ? 'var(--danger)' : 'var(--surface)';
            el.style.transform = 'translateX(0)';
            setTimeout(() => el.style.transform = 'translateX(150%)', 3000);
        }

        window.installPWA = async () => {
            if (window.deferredPrompt) {
                window.deferredPrompt.prompt();
                const { outcome } = await window.deferredPrompt.userChoice;
                if (outcome === 'accepted') document.getElementById('installBtn').style.display = 'none';
                window.deferredPrompt = null;
            }
        };
// ==========================================
// WEB BLUETOOTH PRINTING LOGIC
// ==========================================
let bluetoothDevice;
let printCharacteristic;

async function connectPrinter() {
    try {
        // 1. Request Device
        bluetoothDevice = await navigator.bluetooth.requestDevice({
            filters: [{ services: ['000018f0-0000-1000-8000-00805f9b34fb'] }], 
            optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
        });

        // 2. Connect
        const server = await bluetoothDevice.gatt.connect();
        const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
        printCharacteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');

        // UI Update
        const btn = document.getElementById('btnConnectPrinter');
        btn.innerText = "‚úÖ Connected";
        btn.classList.remove('btn-warning');
        btn.classList.add('btn-success');
        showToast('Printer Connected!');

        // Handle Disconnect
        bluetoothDevice.addEventListener('gattserverdisconnected', () => {
            printCharacteristic = null;
            btn.innerText = "üñ®Ô∏è Connect";
            btn.classList.add('btn-warning');
            btn.classList.remove('btn-success');
        });

    } catch (error) {
        console.error(error);
        // Fallback for generic printers
        tryGenericConnection();
    }
}

async function tryGenericConnection() {
    try {
        bluetoothDevice = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
        });
        const server = await bluetoothDevice.gatt.connect();
        const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
        printCharacteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');
        
        const btn = document.getElementById('btnConnectPrinter');
        btn.innerText = "‚úÖ Connected";
        btn.classList.remove('btn-warning');
        btn.classList.add('btn-success');
        showToast('Printer Connected!');
    } catch(e) {
        showToast('Connection Failed: ' + e.message, 'error');
    }
}

async function printKOTDirect(orderId) {
    if (!printCharacteristic) return showToast('Please Connect Printer First', 'error');

    const order = STATE.orders.find(o => o.id === orderId);
    if (!order) return showToast('Order not found', 'error');

    const serial = order.timestamp ? order.timestamp.toMillis().toString().slice(-4) : '????';
    const dateObj = order.timestamp ? order.timestamp.toDate() : new Date();
    const time = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    const encoder = new TextEncoder();
    let data = [];
    const addText = (text) => data.push(...encoder.encode(text));
    const addCmd = (...cmds) => data.push(...cmds);

    // ESC/POS Commands
    addCmd(0x1B, 0x40); // Init
    addCmd(0x1B, 0x61, 1); // Center
    addCmd(0x1B, 0x21, 0x30); // Double Height/Width
    addText(`KOT #${serial}\n`);
    addCmd(0x1B, 0x21, 0x00); // Normal
    addText(`${time}\n${order.status.toUpperCase()}\n`);
    addText(`Cust: ${order.customerName || 'Guest'}\n`);
    addText(`Ph: ${order.phone || 'N/A'}\n`);
    addText("--------------------------------\n");
    
    addCmd(0x1B, 0x61, 0); // Left
    order.items.forEach(item => {
        addCmd(0x1B, 0x45, 1); // Bold
        addText(`${item.qty} x ${item.name}\n`);
        addCmd(0x1B, 0x45, 0); // Bold Off
    });

    addText("--------------------------------\n");
    addCmd(0x1B, 0x61, 1); // Center
    addText("KITCHEN COPY\n\n\n"); 

    const uint8Data = new Uint8Array(data);
    const chunkSize = 50;
    
    for (let i = 0; i < uint8Data.length; i += chunkSize) {
        const chunk = uint8Data.slice(i, i + chunkSize);
        await printCharacteristic.writeValue(chunk);
        await new Promise(resolve => setTimeout(resolve, 20));
    }
}
async function printBillDirect(orderId) {
    if (!printCharacteristic) return showToast('Please Connect Printer First', 'error');

    // 1. Fetch Order
    // Try finding in STATE.orders first
    let order = STATE.orders.find(o => o.id === orderId);
    
    // Fallback: If not found (rare) or if we just paid and STATE isn't updated yet, use PAYMENT_DATA
    if (!order && PAYMENT_DATA.orderId === orderId) {
        order = { ...PAYMENT_DATA, items: PAYMENT_DATA.items || [] };
    }
    
    if (!order) return showToast('Order data not found', 'error');
    
    const s = STATE.storeSettings || { name: 'Juice Therapy', address: '', phone: '', footer: 'Thank you!' };

    // 2. Prepare Data
    // Use safe fallbacks for values to prevent crashes
    const serial = (order.timestamp && order.timestamp.toMillis) 
        ? order.timestamp.toMillis().toString().slice(-4) 
        : (PAYMENT_DATA.serial || '----');
        
    const dateObj = (order.timestamp && order.timestamp.toDate) 
        ? order.timestamp.toDate() 
        : new Date();
        
    const date = dateObj.toLocaleDateString();
    const time = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    // Encoder Helpers
    const encoder = new TextEncoder();
    let data = [];
    const addText = (text) => data.push(...encoder.encode(text));
    const addCmd = (...cmds) => data.push(...cmds);

    try {
        // --- START RECEIPT ---
        addCmd(0x1B, 0x40); // Initialize
        addCmd(0x1B, 0x61, 1); // Center Align

        // STORE HEADER
        addCmd(0x1B, 0x21, 0x30); // Double Height/Width
        addText(`${s.name}\n`);
        addCmd(0x1B, 0x21, 0x00); // Normal Text
        
        if(s.address) addText(`${s.address}\n`);
        const storePhone = s.phone || ''; 
        if(storePhone) addText(`Ph: ${storePhone}\n`);
        addText("--------------------------------\n");
        
        // BILL META
        addCmd(0x1B, 0x61, 0); // Left Align
        addText(`Date: ${date} ${time}\n`);
        addText(`Bill No: ${serial}\n`);
        addText(`Cust: ${order.customerName || 'Guest'}\n`);
        addText(`Ph: ${order.phone || 'N/A'}\n`);
        addText("--------------------------------\n");
        
        // ITEMS HEADER
        addText("Item             Qty    Price   Amt\n");
        addText("--------------------------------\n");

        // ITEMS LIST
        if(order.items && Array.isArray(order.items)) {
            order.items.forEach(item => {
                const amt = (item.price * item.qty).toFixed(2);
                addText(`${item.name}\n`);
                // Formatting for 58mm paper (approx 32 chars)
                addText(`   x ${item.qty}    ${item.price}   ${amt}\n`);
            });
        }

        addText("--------------------------------\n");

        // TOTALS
        addCmd(0x1B, 0x61, 2); // Right Align
        addText(`Total:  ${order.total}\n`);
        
        if(order.redeemed > 0) {
            addText(`Bonus Used: -${order.redeemed}\n`);
        }
        
        addCmd(0x1B, 0x45, 1); // Bold ON
        const finalPay = order.finalPaid !== undefined ? order.finalPaid : order.total;
        addText(`NET PAYABLE:  ${finalPay}\n`);
        addCmd(0x1B, 0x45, 0); // Bold OFF
        
        addText(`Mode: ${order.paymentMode || 'Cash'}\n`);
        
        // Cash Details
        // Check both Order object and Payment Data fallback
        const cashGiven = order.cashGiven || PAYMENT_DATA.cashGiven;
        const change = order.changeReturn || PAYMENT_DATA.change;
        
        if(order.paymentMode === 'Cash' && cashGiven) {
            addText(`Cash Given:  ${cashGiven}\n`);
            addText(`Change:  ${change}\n`);
        }

        addText("--------------------------------\n");
        
        // FOOTER
        addCmd(0x1B, 0x61, 1); // Center Align
        const bonusEarned = order.bonusEarned || PAYMENT_DATA.bonusEarned;
        if(bonusEarned > 0) {
            addText(`* Points Earned: ${bonusEarned} *\n`);
        }
        
        if(s.footer) addText(`${s.footer}\n`);
        addText("\n\n\n"); // Feed paper

        // --- SEND TO PRINTER (WITH CHUNKING) ---
        // This is the CRITICAL FIX for long bills
        const uint8Data = new Uint8Array(data);
        const chunkSize = 50; // Safe size for most bluetooth printers
        
        for (let i = 0; i < uint8Data.length; i += chunkSize) {
            const chunk = uint8Data.slice(i, i + chunkSize);
            await printCharacteristic.writeValue(chunk);
            // Tiny delay to let printer buffer process data
            await new Promise(resolve => setTimeout(resolve, 20)); 
        }

    } catch (e) {
        console.error(e);
        showToast('Print Error: ' + e.message, 'error');
    }
}
// ==========================================
// PWA INSTALLATION LOGIC
// ==========================================
let deferredPrompt; // Stores the browser's install event

// 1. Register Service Worker
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
            .then(reg => console.log('Service Worker Registered'))
            .catch(err => console.log('SW Registration Failed: ', err));
    });
}

// 2. Listen for "Can be installed" event
window.addEventListener('beforeinstallprompt', (e) => {
    // Prevent Chrome 67 and earlier from automatically showing the prompt
    e.preventDefault();
    // Stash the event so it can be triggered later.
    deferredPrompt = e;
    
    // SHOW the Install Button
    const btn = document.getElementById('pwaInstallBtn');
    if(btn) {
        btn.classList.remove('hidden');
        
        // Add Click Event
        btn.addEventListener('click', async () => {
            // Hide button immediately
            btn.classList.add('hidden');
            // Show the browser's install prompt
            deferredPrompt.prompt();
            // Wait for user choice
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to install prompt: ${outcome}`);
            deferredPrompt = null;
        });
    }
});

// 3. Listen for "App Successfully Installed"
window.addEventListener('appinstalled', () => {
    // Hide the button permanently
    const btn = document.getElementById('pwaInstallBtn');
    if(btn) btn.classList.add('hidden');
    console.log('PWA Installed Successfully');
    
    // Optional: Send analytics or show a "Thank You" toast
    showToast('App Installed! Launching...');
});

// ==========================================
// PUSH NOTIFICATION LOGIC
// ==========================================
async function requestNotificationPermission() {
    try {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            console.log('Notification permission granted.');
            
            const { getToken, messaging } = window.firebaseModules;
            
            // Wait for service worker to be ready
            const registration = await navigator.serviceWorker.ready;

            // Get the Device Token
            const token = await getToken(messaging, { 
                vapidKey: 'BNMWPFfWtc6-5ZSm0Eru3u3f-iB7zSpzY2vlHos7HEjbKQPfstSGgFXSnzivajBU4fto4oSKlWCQJwhtjKmNzLQ',
                serviceWorkerRegistration: registration
            });

            if (token) {
                console.log('FCM Token:', token);
                // Save this token to the user's profile in Firestore
                saveTokenToDatabase(token);
            } else {
                console.log('No registration token available.');
            }
        } else {
            console.log('Unable to get permission to notify.');
        }
    } catch (err) {
        console.log('An error occurred while retrieving token. ', err);
    }
}

async function saveTokenToDatabase(token) {
    // Only save if a user is logged in
    if (!STATE.user) return;

// Handle both customer and staff users
const userId = STATE.user.phone || STATE.user.email || window.auth.currentUser?.uid;
if (!userId) return;

    const { doc, setDoc, serverTimestamp } = window.firebaseModules;
    // Save to a sub-collection 'tokens' or directly on the user doc
    await setDoc(doc(window.db, 'customers', STATE.user.phone), {
        fcmToken: token,
        lastLogin: serverTimestamp()
    }, { merge: true });
    
    console.log('Token saved to database');
}


// ==========================================
// NOTIFICATIONS & OFFERS LOGIC
// ==========================================

function loadCustomerNotifications() {
    const { collection, query, where, orderBy, onSnapshot } = window.firebaseModules;
    // Order by newest first
    const q = query(
        collection(window.db, 'notifications'), 
        where('target', 'in', ['ALL', STATE.user.phone]), 
        orderBy('timestamp', 'desc')
    );

    onSnapshot(q, (snap) => {
        const list = document.getElementById('custNotificationList');
        const badge = document.getElementById('custNotifBadge');
        
        // Safety check: if HTML elements are missing, stop here
        if(!list || !badge) return; 

        if(snap.empty) {
            list.innerHTML = '<div class="text-center text-muted" style="padding:20px;">No new offers at the moment.</div>';
            return;
        }

        // Check for new notifications since last view
        const lastCheck = localStorage.getItem('jt_last_notif_check') || 0;
        let hasNew = false;

        list.innerHTML = snap.docs.map(d => {
            const c = d.data();
            const time = c.timestamp ? c.timestamp.toMillis() : 0;
            const dateStr = c.timestamp ? c.timestamp.toDate().toLocaleDateString() : '';
            
            if(time > lastCheck) hasNew = true;

            return `
            <div style="background:rgba(255,255,255,0.05); border-radius:10px; padding:15px; margin-bottom:15px; border:1px solid rgba(255,255,255,0.1);">
                ${c.image ? `<img src="${c.image}" style="width:100%; max-height:200px; object-fit:cover; border-radius:8px; margin-bottom:10px;">` : ''}
                <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:5px;">
                    <h4 style="color:var(--primary); margin:0;">${c.title}</h4>
                    <span style="font-size:0.7rem; color:#888; white-space:nowrap;">${dateStr}</span>
                </div>
                <p style="font-size:0.95rem; line-height:1.5; color:#eee;">${c.message}</p>
            </div>
            `;
        }).join('');

        if(hasNew) badge.classList.remove('hidden');
    });
}

function openNotifications() {
    const modal = document.getElementById('notificationModal');
    if(modal) {
        modal.classList.remove('hidden');
        // Hide Badge when opened
        document.getElementById('custNotifBadge').classList.add('hidden');
        // Update "Last Seen" timestamp locally
        localStorage.setItem('jt_last_notif_check', Date.now());
    }
}
    </script>

<div id="orderDetailsModal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 500; display: flex; align-items: center; justify-content: center;">
    <div class="card" style="width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto;">
        
        <div class="flex justify-between items-center" style="margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
            <h3>Order Details</h3>
            <button class="btn btn-secondary btn-sm" onclick="closeDetailsModal()">‚úñ</button>
        </div>

        <div id="billContent">
            <div class="text-center" style="margin-bottom: 15px;">
                <h2 id="viewStoreName" style="color:var(--primary);">Juice Therapy</h2>
                <p class="text-muted" style="font-size:0.8rem;" id="viewOrderId">#0000</p>
                <p class="text-muted" style="font-size:0.8rem;" id="viewDate">...</p>
            </div>

            <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                <label class="text-muted" style="font-size:0.75rem;">Customer</label>
                <input id="editCustName" class="input" style="margin-bottom:5px;" disabled>
                <input id="editCustPhone" class="input" style="margin-bottom:0;" disabled>
            </div>

            <div id="viewItemsList" style="border-top: 1px dashed rgba(255,255,255,0.2); border-bottom: 1px dashed rgba(255,255,255,0.2); padding: 10px 0; margin-bottom: 10px;"></div>

<div id="editItemsWrapper" class="hidden" style="margin-bottom: 15px; border-top: 1px dashed rgba(255,255,255,0.2); padding-top: 10px;">
    <div id="editItemsList" style="display:flex; flex-direction:column; gap:8px;"></div>
    
    <div style="margin-top: 10px; display:flex; gap:5px;">
        <select id="adminAddItemSelect" class="input" style="margin:0;" onchange="adminAddNewItem(this)">
            <option value="">+ Add Menu Item</option>
        </select>
    </div>
</div>

            <div class="grid-2" style="gap:10px;">
                <div>
                    <label class="text-muted" style="font-size:0.75rem;">Total (‚Çπ)</label>
                    <input type="number" id="editTotal" class="input" disabled>
                </div>
                <div>
                    <label class="text-muted" style="font-size:0.75rem;">Payment Mode</label>
                    <select id="editMode" class="input" disabled>
                        <option value="Cash">Cash</option>
                        <option value="Online">Online</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="detailsActions" class="flex gap-2" style="margin-top: 20px;">
            <button class="btn btn-secondary w-full" onclick="closeDetailsModal()">Close</button>
            <button id="btnAdminEdit" class="btn btn-warning w-full hidden" onclick="enableAdminEdit()">‚úèÔ∏è Edit</button>
            <button id="btnAdminSave" class="btn btn-success w-full hidden" onclick="saveAdminOrder()">üíæ Save</button>
        </div>
    </div>
</div>
<div id="kot-receipt">
    </div>

<div id="notificationModal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 600; display: flex; align-items: center; justify-content: center;">
    <div class="card" style="width: 90%; max-width: 400px; max-height: 80vh; display:flex; flex-direction:column;">
        <div class="flex justify-between items-center" style="margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
            <h3>üì¢ Offers & Updates</h3>
            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('notificationModal').classList.add('hidden')">‚úñ</button>
        </div>
        <div id="custNotificationList" style="overflow-y:auto; flex:1; padding-right:5px;">
            </div>
    </div>
</div>

</body>
</html>