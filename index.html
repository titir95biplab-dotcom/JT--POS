<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Juice Therapy - Smart POS</title>
    <meta name="theme-color" content="#FF6B35">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="logo.png" type="image/png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, query, where, orderBy, onSnapshot, serverTimestamp, increment, addDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCbHeWurSgxdE1cYFvTGsoyzpK7PQ_1Z0o", 
            authDomain: "jt-s-pos.firebaseapp.com",
            projectId: "jt-s-pos",
            storageBucket: "jt-s-pos.firebasestorage.app",
            messagingSenderId: "365172962139",
            appId: "1:365172962139:web:eaad048f98d2af1ff8207e"
        };

        const app = initializeApp(firebaseConfig);
        window.auth = getAuth(app);
        window.db = getFirestore(app);
        window.firebaseModules = { 
            signInWithEmailAndPassword, signOut, onAuthStateChanged, 
            collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, addDoc, runTransaction,
            query, where, orderBy, onSnapshot, serverTimestamp, increment 
        };
        window.firebaseReady = true;
    </script>
    
    <style>
        :root {
            --primary: #FF6B35;
            --secondary: #1A1A2E;
            --bg: #121212;
            --surface: #1E1E2E;
            --text: #FFFFFF;
            --text-muted: #A0A0A0;
            --success: #4CAF50;
            --danger: #FF5252;
            --warning: #FFC107;
            --radius: 12px;
            --spacing: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Manrope', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background: var(--bg); color: var(--text); overflow-x: hidden; padding-bottom: 60px; }
        
        /* Utils */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }
        .font-bold { font-weight: bold; }
        
        /* Components */
        .btn {
            padding: 12px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s;
            font-size: 0.95rem; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:active { transform: scale(0.98); }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; }
        .btn-danger { background: rgba(255, 82, 82, 0.2); color: var(--danger); }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: black; }
        
        .input {
            width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px; color: white; font-size: 1rem; margin-bottom: 10px;
        }
        .input:focus { outline: none; border-color: var(--primary); }

        .card { background: var(--surface); border-radius: var(--radius); padding: var(--spacing); margin-bottom: var(--spacing); }

        /* Login Screen */
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-box { width: 100%; max-width: 400px; text-align: center; }
        .logo { width: 120px; margin-bottom: 20px; }

        /* Header */
        header { background: var(--surface); padding: 15px; position: sticky; top: 0; z-index: 50; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }

        /* Layouts */
        .app-layout { max-width: 1200px; margin: 20px auto; padding: 0 15px; }

        /* POS Specific Layout */
        .pos-container { display: grid; grid-template-columns: 1fr 350px; gap: 20px; height: calc(100vh - 140px); }
        .pos-left { display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        
        /* New Menu Layout: Sidebar + Grid */
        .menu-area { display: grid; grid-template-columns: 110px 1fr; gap: 15px; flex: 1; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 10px; background: rgba(255,255,255,0.02); }
        
        .cat-sidebar { overflow-y: auto; padding-right: 5px; display: flex; flex-direction: column; gap: 8px; }
        .cat-btn { 
            padding: 10px 5px; font-size: 0.75rem; background: rgba(255,255,255,0.05); 
            border-radius: 6px; text-align: center; cursor: pointer; word-break: break-word; line-height: 1.2;
        }
        .cat-btn.active { background: var(--primary); color: white; font-weight: bold; }

        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; overflow-y: auto; align-content: start; padding-bottom: 50px; }
        .menu-item { 
            background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; cursor: pointer; 
            display: flex; flex-direction: column; justify-content: space-between; min-height: 90px; border: 1px solid transparent;
        }
        .menu-item:hover { border-color: var(--primary); }
        .menu-item.selected { background: rgba(255, 107, 53, 0.2); border-color: var(--primary); }

        /* Cart Panel */
        .cart-panel { background: var(--surface); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; height: 100%; }
        .cart-items { flex: 1; overflow-y: auto; margin: 10px 0; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .qty-controls { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; padding: 2px; }
        .qty-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; }

        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { flex: 1; white-space: nowrap; }
        .tab-btn.active { background: var(--primary); }

        /* Order Cards */
        .order-card { padding: 15px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); margin-bottom: 10px; border-radius: 8px; }
        .order-status { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; font-weight: bold; }
        .status-pending { background: var(--warning); color: black; }
        .status-completed { background: var(--success); color: white; }

        /* Install Button */
        #installBtn { position: fixed; bottom: 20px; right: 20px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.5); display: none; }

        /* Notification */
        #notification { position: fixed; top: 20px; right: 20px; background: #333; padding: 15px 25px; border-radius: 8px; z-index: 1000; transform: translateX(150%); transition: 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .pos-container { grid-template-columns: 1fr; height: auto; display: block; }
            .pos-left { height: 60vh; margin-bottom: 20px; }
            .menu-area { grid-template-columns: 80px 1fr; }
            .cart-panel { height: auto; }
            .header-content h2 { font-size: 1.2rem; }
            .item-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

    <!-- Notification Toast -->
    <div id="notification"></div>

    <!-- Install Button -->
    <button id="installBtn" class="btn btn-primary" onclick="installPWA()">üì≤ Install App</button>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box card">
            <img src="logo.png" alt="Juice Therapy" class="logo" onerror="this.style.display='none'">
            <h2 style="margin-bottom: 20px;">Juice Therapy POS</h2>
            
            <div class="flex gap-2" style="margin-bottom: 20px; justify-content: center;">
                <button class="btn btn-secondary" onclick="setLoginMode('customer')" id="btnRoleCust">Customer</button>
                <button class="btn btn-secondary" onclick="setLoginMode('staff')" id="btnRoleStaff">Staff/Admin</button>
            </div>

            <!-- Customer Login -->
            <div id="customerLogin" class="hidden">
                <input type="tel" id="custPhoneLogin" class="input" placeholder="Enter Phone Number" maxlength="10">
                <button class="btn btn-primary w-full" onclick="loginCustomer()">Enter</button>
            </div>

            <!-- Staff Login -->
            <div id="staffLogin" class="hidden">
                <input type="email" id="staffEmail" class="input" placeholder="Email">
                <input type="password" id="staffPass" class="input" placeholder="Password">
                <button class="btn btn-primary w-full" onclick="loginStaff()">Login</button>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="hidden">
        <header>
            <div class="header-content">
                <div class="flex items-center gap-2">
                    <img src="logo.png" style="height:30px;"> 
                    <h2>Admin Dashboard</h2>
                </div>
                <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
            </div>
        </header>
        <div class="app-layout">
            <div class="flex justify-between items-center" style="margin-bottom: 15px;">
                <h3>Menu Management</h3>
                <button class="btn btn-primary" onclick="showAddItemModal()">+ Add New Item</button>
            </div>

            <div id="adminMenuGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                <!-- Admin Items Rendered Here -->
            </div>
        </div>
    </div>

    <!-- Outlet POS Panel -->
    <div id="outletPanel" class="hidden">
        <header>
            <div class="header-content">
                <div class="flex items-center gap-2">
                    <img src="logo.png" style="height:30px;"> 
                    <h2>Outlet POS</h2>
                </div>
                <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
            </div>
        </header>
        <div class="app-layout">
            <!-- 3 Top Buttons -->
            <div class="tabs">
                <button class="btn btn-secondary tab-btn active" onclick="switchOutletTab('pos')" id="tab-pos">üõí New Order (POS)</button>
                <button class="btn btn-secondary tab-btn" onclick="switchOutletTab('current')" id="tab-current">‚è≥ Current Orders</button>
                <button class="btn btn-secondary tab-btn" onclick="switchOutletTab('completed')" id="tab-completed">‚úÖ Completed</button>
            </div>

            <!-- TAB 1: POS Interface -->
            <div id="view-pos" class="pos-container">
                <div class="pos-left">
                    <input type="text" class="input" placeholder="üîç Search items..." onkeyup="filterMenu(this.value)">
                    <div class="menu-area">
                        <!-- Left Sidebar Categories -->
                        <div class="cat-sidebar" id="posSidebar">
                            <!-- JS Generated -->
                        </div>
                        <!-- Right Grid Items -->
                        <div class="item-grid" id="posGrid">
                            <!-- JS Generated -->
                        </div>
                    </div>
                </div>
                
                <!-- Cart Section -->
                <div class="cart-panel">
                    <div class="flex justify-between items-center">
                        <h3>Current Order</h3>
                        <span class="btn-danger" style="padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;" onclick="clearCart()">Clear</span>
                    </div>
                    
                    <div style="margin-top: 10px;">
                        <input type="tel" id="posPhone" class="input" placeholder="Customer Phone (Auto-create)" maxlength="10">
                    </div>

                    <div class="cart-items" id="cartItemsList">
                        <div class="text-center text-muted" style="margin-top: 20px;">Cart is empty</div>
                    </div>

                    <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
                        <div class="flex justify-between font-bold" style="font-size: 1.2rem; margin-bottom: 10px;">
                            <span>Total</span>
                            <span id="cartTotal">‚Çπ0</span>
                        </div>
                        <button id="btnPlaceOrder" class="btn btn-primary w-full" onclick="placeOrder()">Place Order</button>
                        <button id="btnUpdateOrder" class="btn btn-warning w-full hidden" onclick="updateExistingOrder()">Update Order</button>
                    </div>
                </div>
            </div>

            <!-- TAB 2: Current Orders -->
            <div id="view-current" class="hidden">
                <div id="currentOrdersList"></div>
            </div>

            <!-- TAB 3: Completed Orders -->
            <div id="view-completed" class="hidden">
                <div id="completedOrdersList"></div>
            </div>
        </div>
    </div>

    <!-- Customer Panel -->
    <div id="customerPanel" class="hidden">
        <header>
            <div class="header-content">
                <div class="flex items-center gap-2">
                    <img src="logo.png" style="height:30px;"> 
                    <h2>My Juice Therapy</h2>
                </div>
                <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
            </div>
        </header>
        <div class="app-layout">
            <div class="card text-center" style="background: linear-gradient(135deg, var(--primary), #FF9F43);">
                <h3>Welcome, <span id="custNameDisplay">Guest</span></h3>
                <h1 style="font-size: 3rem; margin: 10px 0;" id="custPoints">0</h1>
                <p>Bonus Points Available</p>
            </div>

            <!-- Customer Tabs -->
            <div class="tabs">
                <button class="btn btn-secondary tab-btn active" onclick="switchCustTab('menu')" id="btn-cust-menu">üçî Order Now</button>
                <button class="btn btn-secondary tab-btn" onclick="switchCustTab('history')" id="btn-cust-history">üìú My History</button>
            </div>

            <!-- Customer Menu Tab -->
            <div id="cust-view-menu">
                <div class="pos-container" style="height: 60vh;">
                    <div class="pos-left">
                         <div class="menu-area">
                            <div class="cat-sidebar" id="custSidebar"></div>
                            <div class="item-grid" id="custGrid"></div>
                         </div>
                    </div>
                    <div class="cart-panel">
                        <h3>My Cart</h3>
                        <div class="cart-items" id="custCartItems"></div>
                        <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
                            <div class="flex justify-between font-bold" style="font-size: 1.2rem; margin-bottom: 10px;">
                                <span>Total</span>
                                <span id="custCartTotal">‚Çπ0</span>
                            </div>
                            <button class="btn btn-primary w-full" onclick="placeCustomerOrder()">Place Order</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customer History Tab -->
            <div id="cust-view-history" class="hidden">
                <div id="custHistoryList"></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Item Modal -->
    <div id="addItemModal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200; display: flex; align-items: center; justify-content: center;">
        <div class="card" style="width: 90%; max-width: 400px;">
            <h3>Add/Edit Item</h3>
            <input type="text" id="newItemName" class="input" placeholder="Item Name">
            <input type="number" id="newItemPrice" class="input" placeholder="Price">
            <input list="categoryOptions" id="newItemCat" class="input" placeholder="Category (Select or Type New)">
            <datalist id="categoryOptions"></datalist>
            
            <div class="flex gap-2" style="margin-top: 10px;">
                <button class="btn btn-secondary w-full" onclick="document.getElementById('addItemModal').classList.add('hidden')">Cancel</button>
                <button class="btn btn-primary w-full" onclick="saveMenuItem()">Save</button>
            </div>
        </div>
    </div>

    <!-- Customer Name Modal -->
    <div id="customerNameModal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 300; display: flex; align-items: center; justify-content: center;">
        <div class="card" style="width: 90%; max-width: 400px; text-align: center;">
            <h3 style="margin-bottom: 10px;">Welcome!</h3>
            <p style="margin-bottom: 20px; color: var(--text-muted);">Please enter your name to continue.</p>
            <input type="text" id="newCustName" class="input" placeholder="Your Name">
            <button class="btn btn-primary w-full" onclick="saveCustomerName()">Start Ordering</button>
        </div>
    </div>

    <script>
        // --- APP STATE ---
        const STATE = {
            user: null,
            role: null, 
            menu: [],
            categories: [],
            cart: [],
            custCart: [], // Separate cart for customer view
            orders: [],
            editingOrderId: null,
            activeCategory: 'All',
            tempPhone: null
        };

        // --- INIT ---
        window.onload = () => {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                window.deferredPrompt = e;
                document.getElementById('installBtn').style.display = 'flex';
            });

            const checkFirebase = setInterval(() => {
                if (window.firebaseReady) {
                    clearInterval(checkFirebase);
                    initApp();
                }
            }, 100);
        };

        function initApp() {
            window.firebaseModules.onAuthStateChanged(window.auth, (user) => {
                if (user) {
                    checkUserRole(user.uid);
                } else {
                    document.getElementById('loginScreen').classList.remove('hidden');
                }
            });
        }

        async function checkUserRole(uid) {
            if (window.auth.currentUser.email === 'admin@jt.com') {
                STATE.role = 'admin';
                showPanel('adminPanel');
                loadMenu();
            } else {
                STATE.role = 'staff';
                showPanel('outletPanel');
                loadMenu();
                loadOrders(); 
            }
        }

        function showPanel(panelId) {
            ['loginScreen', 'adminPanel', 'outletPanel', 'customerPanel'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(panelId).classList.remove('hidden');
        }

        function setLoginMode(mode) {
            document.getElementById('customerLogin').classList.add('hidden');
            document.getElementById('staffLogin').classList.add('hidden');
            document.getElementById('btnRoleCust').classList.remove('btn-primary');
            document.getElementById('btnRoleStaff').classList.remove('btn-primary');
            
            if(mode === 'customer') {
                document.getElementById('customerLogin').classList.remove('hidden');
                document.getElementById('btnRoleCust').classList.add('btn-primary');
            } else {
                document.getElementById('staffLogin').classList.remove('hidden');
                document.getElementById('btnRoleStaff').classList.add('btn-primary');
            }
        }

        // --- AUTH ---
        async function loginStaff() {
            const email = document.getElementById('staffEmail').value;
            const pass = document.getElementById('staffPass').value;
            try {
                await window.firebaseModules.signInWithEmailAndPassword(window.auth, email, pass);
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        async function loginCustomer() {
            const phone = document.getElementById('custPhoneLogin').value;
            if (phone.length !== 10) return showToast('Invalid phone', 'error');

            const { doc, getDoc } = window.firebaseModules;
            const custRef = doc(window.db, 'customers', phone);
            const snap = await getDoc(custRef);
            
            // If new user or name missing, force name input
            if (!snap.exists() || !snap.data().name) {
                STATE.tempPhone = phone;
                document.getElementById('customerNameModal').classList.remove('hidden');
                return;
            }

            finalizeCustomerLogin(phone, snap.data());
        }

        async function saveCustomerName() {
            const name = document.getElementById('newCustName').value;
            if(!name) return showToast('Name is required', 'error');

            const { doc, setDoc, serverTimestamp } = window.firebaseModules;
            const phone = STATE.tempPhone;
            
            // Create/Update customer
            await setDoc(doc(window.db, 'customers', phone), {
                phone: phone,
                name: name,
                points: 0,
                joined: serverTimestamp()
            }, { merge: true });

            document.getElementById('customerNameModal').classList.add('hidden');
            finalizeCustomerLogin(phone, { name, points: 0 });
        }

        function finalizeCustomerLogin(phone, data) {
            STATE.user = { uid: phone, phone: phone, name: data.name };
            STATE.role = 'customer';
            
            document.getElementById('custNameDisplay').innerText = data.name;
            document.getElementById('custPoints').innerText = data.points || 0;
            
            loadMenu(); // For customer menu
            loadCustomerHistory(phone);
            showPanel('customerPanel');
        }

        function logout() {
            window.auth.signOut();
            location.reload();
        }

        // --- DATA LOADING ---
        function loadMenu() {
            const { collection, onSnapshot, query, orderBy } = window.firebaseModules;
            const q = query(collection(window.db, 'menu'), orderBy('name'));
            
            onSnapshot(q, (snap) => {
                STATE.menu = snap.docs.map(d => ({id: d.id, ...d.data()}));
                const cats = new Set(STATE.menu.map(m => m.category).filter(Boolean));
                STATE.categories = ['All', ...Array.from(cats).sort()];
                
                if (STATE.role === 'admin') renderAdminMenu();
                if (STATE.role === 'staff') renderOutletMenu();
                if (STATE.role === 'customer') renderCustomerMenu();
                updateCategoryDatalist();
            });
        }

        // --- ADMIN FUNCTIONS ---
        function renderAdminMenu() {
            const grid = document.getElementById('adminMenuGrid');
            grid.innerHTML = STATE.menu.map(item => `
                <div class="card" style="margin:0;">
                    <div class="flex justify-between">
                        <h4>${item.name}</h4>
                        <span class="text-muted">‚Çπ${item.price}</span>
                    </div>
                    <div class="text-muted" style="font-size:0.8rem;">${item.category}</div>
                    <div class="flex gap-2" style="margin-top:10px;">
                        <button class="btn btn-secondary w-full" onclick="editItem('${item.id}')">Edit</button>
                        <button class="btn btn-danger w-full" onclick="deleteItem('${item.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function showAddItemModal(id = null) {
            document.getElementById('addItemModal').classList.remove('hidden');
            if(id) {
                const item = STATE.menu.find(i => i.id === id);
                document.getElementById('newItemName').value = item.name;
                document.getElementById('newItemPrice').value = item.price;
                document.getElementById('newItemCat').value = item.category;
                document.getElementById('addItemModal').dataset.id = id;
            } else {
                document.getElementById('newItemName').value = '';
                document.getElementById('newItemPrice').value = '';
                document.getElementById('newItemCat').value = '';
                delete document.getElementById('addItemModal').dataset.id;
            }
        }

        function updateCategoryDatalist() {
            const dl = document.getElementById('categoryOptions');
            dl.innerHTML = STATE.categories.filter(c => c !== 'All').map(c => `<option value="${c}">`).join('');
        }

        async function saveMenuItem() {
            const name = document.getElementById('newItemName').value;
            const price = Number(document.getElementById('newItemPrice').value);
            const category = document.getElementById('newItemCat').value || 'Uncategorized';
            const id = document.getElementById('addItemModal').dataset.id;
            const { collection, addDoc, doc, updateDoc } = window.firebaseModules;
            try {
                if(id) {
                    await updateDoc(doc(window.db, 'menu', id), { name, price, category });
                    showToast('Item updated');
                } else {
                    await addDoc(collection(window.db, 'menu'), { name, price, category });
                    showToast('Item added');
                }
                document.getElementById('addItemModal').classList.add('hidden');
            } catch(e) { showToast(e.message, 'error'); }
        }

        async function deleteItem(id) {
            if(!confirm('Delete this item?')) return;
            await window.firebaseModules.deleteDoc(window.firebaseModules.doc(window.db, 'menu', id));
            showToast('Item deleted');
        }

        // --- OUTLET POS FUNCTIONS ---
        function switchOutletTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            ['view-pos', 'view-current', 'view-completed'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
        }

        function renderOutletMenu() {
            const sidebar = document.getElementById('posSidebar');
            sidebar.innerHTML = STATE.categories.map(cat => `
                <div class="cat-btn ${cat === STATE.activeCategory ? 'active' : ''}" 
                     onclick="filterCategory('${cat}')">${cat}</div>
            `).join('');

            const grid = document.getElementById('posGrid');
            const items = STATE.activeCategory === 'All' ? STATE.menu : STATE.menu.filter(m => m.category === STATE.activeCategory);
            grid.innerHTML = items.map(item => `
                <div class="menu-item" onclick="addToCart('${item.id}')">
                    <div style="font-weight:600; font-size: 0.9rem;">${item.name}</div>
                    <div style="color: var(--primary);">‚Çπ${item.price}</div>
                </div>
            `).join('');
        }

        function filterCategory(cat) {
            STATE.activeCategory = cat;
            if(STATE.role === 'staff') renderOutletMenu();
            if(STATE.role === 'customer') renderCustomerMenu();
        }

        function filterMenu(query) {
            if(!query) return renderOutletMenu();
            const lower = query.toLowerCase();
            const filtered = STATE.menu.filter(m => m.name.toLowerCase().includes(lower));
            document.getElementById('posGrid').innerHTML = filtered.map(item => `
                <div class="menu-item" onclick="addToCart('${item.id}')">
                    <div style="font-weight:600; font-size: 0.9rem;">${item.name}</div>
                    <div style="color: var(--primary);">‚Çπ${item.price}</div>
                </div>
            `).join('');
        }

        // --- CART LOGIC (SHARED BUT SEPARATE ARRAYS) ---
        function addToCart(itemId) {
            const item = STATE.menu.find(i => i.id === itemId);
            const targetCart = STATE.role === 'customer' ? STATE.custCart : STATE.cart;
            
            const existing = targetCart.find(c => c.id === itemId);
            if(existing) existing.qty++;
            else targetCart.push({ ...item, qty: 1 });
            
            if(STATE.role === 'customer') renderCustCart();
            else renderCart();
        }

        function updateQty(itemId, delta) {
            const targetCart = STATE.role === 'customer' ? STATE.custCart : STATE.cart;
            const item = targetCart.find(c => c.id === itemId);
            if(!item) return;
            item.qty += delta;
            if(item.qty <= 0) {
                if(STATE.role === 'customer') STATE.custCart = STATE.custCart.filter(c => c.id !== itemId);
                else STATE.cart = STATE.cart.filter(c => c.id !== itemId);
            }
            if(STATE.role === 'customer') renderCustCart();
            else renderCart();
        }

        function clearCart() {
            STATE.cart = [];
            STATE.editingOrderId = null;
            document.getElementById('posPhone').value = '';
            document.getElementById('btnPlaceOrder').classList.remove('hidden');
            document.getElementById('btnUpdateOrder').classList.add('hidden');
            renderCart();
        }

        function renderCart() {
            const list = document.getElementById('cartItemsList');
            const totalEl = document.getElementById('cartTotal');
            renderCartGeneric(list, totalEl, STATE.cart);
        }

        function renderCustCart() {
            const list = document.getElementById('custCartItems');
            const totalEl = document.getElementById('custCartTotal');
            renderCartGeneric(list, totalEl, STATE.custCart);
        }

        function renderCartGeneric(container, totalEl, cartArray) {
            if(cartArray.length === 0) {
                container.innerHTML = '<div class="text-center text-muted" style="margin-top:20px;">Cart is empty</div>';
                totalEl.innerText = '‚Çπ0';
                return;
            }
            let total = 0;
            container.innerHTML = cartArray.map(item => {
                const sub = item.price * item.qty;
                total += sub;
                return `
                    <div class="cart-item">
                        <div>
                            <div style="font-size: 0.9rem;">${item.name}</div>
                            <div class="text-muted" style="font-size: 0.8rem;">‚Çπ${item.price} x ${item.qty}</div>
                        </div>
                        <div class="qty-controls">
                            <div class="qty-btn" onclick="updateQty('${item.id}', -1)">-</div>
                            <span style="padding: 0 5px;">${item.qty}</span>
                            <div class="qty-btn" onclick="updateQty('${item.id}', 1)">+</div>
                        </div>
                    </div>
                `;
            }).join('');
            totalEl.innerText = '‚Çπ' + total;
        }

        async function placeOrder() {
            const phone = document.getElementById('posPhone').value;
            if(phone.length !== 10) return showToast('Enter 10-digit Phone', 'error');
            if(STATE.cart.length === 0) return showToast('Cart is empty', 'error');

            await submitOrder(phone, STATE.cart);
            clearCart();
            switchOutletTab('current');
        }

        async function placeCustomerOrder() {
            if(STATE.custCart.length === 0) return showToast('Cart is empty', 'error');
            await submitOrder(STATE.user.phone, STATE.custCart);
            STATE.custCart = [];
            renderCustCart();
            showToast('Order Sent to Outlet');
            switchCustTab('history');
        }

        async function submitOrder(phone, items) {
            const { addDoc, collection, serverTimestamp, doc, setDoc, getDoc } = window.firebaseModules;
            
            // Ensure customer exists
            const custRef = doc(window.db, 'customers', phone);
            const custSnap = await getDoc(custRef);
            if (!custSnap.exists()) {
                await setDoc(custRef, { phone, points: 0, joined: serverTimestamp() });
            }

            const total = items.reduce((s, i) => s + (i.price * i.qty), 0);
            const order = {
                items: items,
                phone: phone,
                total: total,
                status: 'pending',
                timestamp: serverTimestamp()
            };

            await addDoc(collection(window.db, 'orders'), order);
        }

        // --- CUSTOMER PANEL LOGIC ---
        function switchCustTab(tab) {
            document.getElementById('btn-cust-menu').classList.toggle('active', tab === 'menu');
            document.getElementById('btn-cust-history').classList.toggle('active', tab === 'history');
            document.getElementById('cust-view-menu').classList.toggle('hidden', tab !== 'menu');
            document.getElementById('cust-view-history').classList.toggle('hidden', tab !== 'history');
        }

        function renderCustomerMenu() {
            const sidebar = document.getElementById('custSidebar');
            sidebar.innerHTML = STATE.categories.map(cat => `
                <div class="cat-btn ${cat === STATE.activeCategory ? 'active' : ''}" 
                     onclick="filterCategory('${cat}')">${cat}</div>
            `).join('');

            const grid = document.getElementById('custGrid');
            const items = STATE.activeCategory === 'All' ? STATE.menu : STATE.menu.filter(m => m.category === STATE.activeCategory);
            grid.innerHTML = items.map(item => `
                <div class="menu-item" onclick="addToCart('${item.id}')">
                    <div style="font-weight:600; font-size: 0.9rem;">${item.name}</div>
                    <div style="color: var(--primary);">‚Çπ${item.price}</div>
                </div>
            `).join('');
        }

        // --- ORDER MANAGEMENT (OUTLET) ---
        function loadOrders() {
            const { collection, query, orderBy, onSnapshot } = window.firebaseModules;
            const q = query(collection(window.db, 'orders'), orderBy('timestamp', 'desc'));
            onSnapshot(q, (snap) => {
                const orders = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderCurrentOrders(orders.filter(o => o.status === 'pending'));
                renderCompletedOrders(orders.filter(o => o.status === 'completed'));
            });
        }

        function renderCurrentOrders(orders) {
            const container = document.getElementById('currentOrdersList');
            container.innerHTML = orders.map(o => `
                <div class="order-card">
                    <div class="flex justify-between">
                        <div>
                            <span class="order-status status-pending">PENDING</span>
                            <span style="font-weight:bold; margin-left:10px;">${o.phone}</span>
                        </div>
                        <div style="font-weight:bold;">‚Çπ${o.total}</div>
                    </div>
                    <div style="margin: 10px 0; font-size: 0.9rem; color: #ccc;">
                        ${o.items.map(i => `${i.qty}x ${i.name}`).join(', ')}
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-secondary w-full" onclick="editOrder('${o.id}')">‚úèÔ∏è Edit</button>
                        <button class="btn btn-success w-full" onclick="completeOrder('${o.id}', ${o.total}, '${o.phone}')">‚úÖ Complete</button>
                    </div>
                </div>
            `).join('');
        }

        function renderCompletedOrders(orders) {
            const container = document.getElementById('completedOrdersList');
            container.innerHTML = orders.map(o => `
                <div class="order-card">
                    <div class="flex justify-between">
                        <div>
                            <span class="order-status status-completed">COMPLETED</span>
                            <span style="font-weight:bold; margin-left:10px;">${o.phone}</span>
                        </div>
                        <div style="font-weight:bold;">‚Çπ${o.total}</div>
                    </div>
                    <div style="margin: 10px 0; font-size: 0.9rem; color: #ccc;">
                        ${o.items.map(i => `${i.qty}x ${i.name}`).join(', ')}
                    </div>
                    <button class="btn btn-primary w-full" onclick="sendBill('${o.phone}', '${o.total}')">üì± Send Bill</button>
                </div>
            `).join('');
        }

        // --- EDITING & COMPLETING ---
        function editOrder(orderId) {
            const { doc, getDoc } = window.firebaseModules;
            getDoc(doc(window.db, 'orders', orderId)).then(snap => {
                if(snap.exists()) {
                    const data = snap.data();
                    STATE.cart = data.items;
                    STATE.editingOrderId = orderId;
                    switchOutletTab('pos');
                    document.getElementById('posPhone').value = data.phone;
                    document.getElementById('btnPlaceOrder').classList.add('hidden');
                    document.getElementById('btnUpdateOrder').classList.remove('hidden');
                    renderCart();
                    showToast('Order Loaded for Editing');
                }
            });
        }

        async function updateExistingOrder() {
            if(!STATE.editingOrderId) return;
            const total = STATE.cart.reduce((s, i) => s + (i.price * i.qty), 0);
            const { doc, updateDoc } = window.firebaseModules;
            await updateDoc(doc(window.db, 'orders', STATE.editingOrderId), {
                items: STATE.cart,
                total: total
            });
            showToast('Order Updated');
            clearCart();
            switchOutletTab('current');
        }

        async function completeOrder(orderId, total, phone) {
            if(!confirm('Mark as Completed? 5% Bonus will be added.')) return;
            
            const bonus = Math.floor(total * 0.05);
            const { doc, runTransaction, serverTimestamp } = window.firebaseModules;
            
            try {
                await runTransaction(window.db, async (transaction) => {
                    // Update Order Status
                    const orderRef = doc(window.db, 'orders', orderId);
                    transaction.update(orderRef, { status: 'completed' });

                    // Update Customer Bonus
                    const custRef = doc(window.db, 'customers', phone);
                    const custDoc = await transaction.get(custRef);
                    
                    if(custDoc.exists()) {
                        const newPoints = (custDoc.data().points || 0) + bonus;
                        transaction.update(custRef, { points: newPoints });
                    }
                });
                showToast(`Order Completed! +${bonus} points added.`);
            } catch(e) {
                console.error(e);
                showToast('Transaction failed', 'error');
            }
        }

        function sendBill(phone, total) {
            const msg = `Juice Therapy Invoice\nTotal: ‚Çπ${total}\nThank you for visiting!`;
            window.open(`https://wa.me/91${phone}?text=${encodeURIComponent(msg)}`);
        }

        // --- CUSTOMER HISTORY ---
        function loadCustomerHistory(phone) {
            const { collection, query, where, orderBy, onSnapshot } = window.firebaseModules;
            const q = query(collection(window.db, 'orders'), where('phone', '==', phone), orderBy('timestamp', 'desc'));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('custHistoryList');
                if(snap.empty) {
                    list.innerHTML = '<p class="text-muted text-center">No orders yet.</p>';
                } else {
                    list.innerHTML = snap.docs.map(d => {
                        const o = d.data();
                        const date = o.timestamp ? o.timestamp.toDate().toLocaleDateString() : '';
                        const statusClass = o.status === 'completed' ? 'status-completed' : 'status-pending';
                        return `
                            <div class="order-card">
                                <div class="flex justify-between">
                                    <div>
                                        <span class="order-status ${statusClass}">${o.status.toUpperCase()}</span>
                                        <span style="margin-left: 10px;">${date}</span>
                                    </div>
                                    <span class="font-bold">‚Çπ${o.total}</span>
                                </div>
                                <div class="text-muted" style="font-size:0.8rem; margin-top:5px;">${o.items.map(i => i.name).join(', ')}</div>
                            </div>
                        `;
                    }).join('');
                }
            });
        }

        function showToast(msg, type='success') {
            const el = document.getElementById('notification');
            el.innerText = msg;
            el.style.backgroundColor = type === 'error' ? 'var(--danger)' : 'var(--surface)';
            el.style.transform = 'translateX(0)';
            setTimeout(() => el.style.transform = 'translateX(150%)', 3000);
        }

        window.installPWA = async () => {
            if (window.deferredPrompt) {
                window.deferredPrompt.prompt();
                const { outcome } = await window.deferredPrompt.userChoice;
                if (outcome === 'accepted') document.getElementById('installBtn').style.display = 'none';
                window.deferredPrompt = null;
            }
        };
    </script>
</body>
</html>
