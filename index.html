<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Juice Therapy - Smart POS</title>
    <meta name="theme-color" content="#FF6B35">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="logo.png" type="image/png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, query, where, orderBy, onSnapshot, serverTimestamp, increment, addDoc, runTransaction, Timestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCbHeWurSgxdE1cYFvTGsoyzpK7PQ_1Z0o", 
            authDomain: "jt-s-pos.firebaseapp.com",
            projectId: "jt-s-pos",
            storageBucket: "jt-s-pos.firebasestorage.app",
            messagingSenderId: "365172962139",
            appId: "1:365172962139:web:eaad048f98d2af1ff8207e"
        };

        const app = initializeApp(firebaseConfig);
        window.auth = getAuth(app);
        window.db = getFirestore(app);
        window.firebaseModules = { 
            signInWithEmailAndPassword, signOut, onAuthStateChanged, 
            collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, addDoc, runTransaction,
            query, where, orderBy, onSnapshot, serverTimestamp, increment, Timestamp 
        };
        window.firebaseReady = true;
    </script>
    
    <style>
        :root {
            --primary: #FF6B35;
            --secondary: #1A1A2E;
            --bg: #121212;
            --surface: #1E1E2E;
            --text: #FFFFFF;
            --text-muted: #A0A0A0;
            --success: #4CAF50;
            --danger: #FF5252;
            --warning: #FFC107;
            --info: #2196F3;
            --radius: 12px;
            --spacing: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Manrope', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background: var(--bg); color: var(--text); overflow-x: hidden; padding-bottom: 60px; }
        
        /* Utils */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }
        .font-bold { font-weight: bold; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }

        /* Components */
        .btn {
            padding: 12px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s;
            font-size: 0.95rem; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:active { transform: scale(0.98); }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; }
        .btn-danger { background: rgba(255, 82, 82, 0.2); color: var(--danger); }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: black; }
        .btn-info { background: var(--info); color: white; }
        
        .input {
            width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px; color: white; font-size: 1rem; margin-bottom: 10px;
        }
        .input:focus { outline: none; border-color: var(--primary); }

        .card { background: var(--surface); border-radius: var(--radius); padding: var(--spacing); margin-bottom: var(--spacing); }

        /* Login Screen */
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-box { width: 100%; max-width: 400px; text-align: center; }
        .logo { width: 120px; margin-bottom: 20px; }

        /* Header */
        header { background: var(--surface); padding: 15px; position: sticky; top: 0; z-index: 50; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }

        /* Layouts */
        .app-layout { max-width: 1200px; margin: 20px auto; padding: 0 15px; }

        /* POS Specific Layout */
        .pos-container { display: grid; grid-template-columns: 1fr 350px; gap: 20px; height: calc(100vh - 140px); }
        .pos-left { display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        
        .menu-area { display: grid; grid-template-columns: 110px 1fr; gap: 15px; flex: 1; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 10px; background: rgba(255,255,255,0.02); }
        
        .cat-sidebar { overflow-y: auto; padding-right: 5px; display: flex; flex-direction: column; gap: 8px; }
        .cat-btn { 
            padding: 10px 5px; font-size: 0.75rem; background: rgba(255,255,255,0.05); 
            border-radius: 6px; text-align: center; cursor: pointer; word-break: break-word; line-height: 1.2;
        }
        .cat-btn.active { background: var(--primary); color: white; font-weight: bold; }

        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; overflow-y: auto; align-content: start; padding-bottom: 50px; }
        .menu-item { 
            background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; cursor: pointer; 
            display: flex; flex-direction: column; justify-content: space-between; min-height: 90px; border: 1px solid transparent;
        }
        .menu-item:hover { border-color: var(--primary); }
        .menu-item.selected { background: rgba(255, 107, 53, 0.2); border-color: var(--primary); }

        /* Cart Panel */
        .cart-panel { background: var(--surface); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; height: 100%; }
        .cart-items { flex: 1; overflow-y: auto; margin: 10px 0; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .qty-controls { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; padding: 2px; }
        .qty-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; }

        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { flex: 1; white-space: nowrap; }
        .tab-btn.active { background: var(--primary); }

        /* Order Cards */
        .order-card { padding: 15px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); margin-bottom: 10px; border-radius: 8px; }
        .order-status { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; font-weight: bold; }
        .status-requested { background: var(--info); color: white; }
        .status-pending { background: var(--warning); color: black; }
        .status-completed { background: var(--success); color: white; }
        .status-cancelled { background: var(--danger); color: white; }

        /* Admin Dashboard Cards */
        .stat-card { background: var(--surface); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .stat-value { font-size: 2rem; font-weight: bold; color: var(--primary); margin: 10px 0; }
        .stat-label { font-size: 0.9rem; color: var(--text-muted); }

        /* Install Button */
        #installBtn { position: fixed; bottom: 20px; right: 20px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.5); display: none; }

        /* Notification */
        #notification { position: fixed; top: 20px; right: 20px; background: #333; padding: 15px 25px; border-radius: 8px; z-index: 1000; transform: translateX(150%); transition: 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .pos-container { grid-template-columns: 1fr; height: auto; display: block; }
            .pos-left { height: 60vh; margin-bottom: 20px; }
            .menu-area { grid-template-columns: 80px 1fr; }
            .cart-panel { height: auto; }
            .header-content h2 { font-size: 1.2rem; }
            .item-grid { grid-template-columns: repeat(2, 1fr); }
            .grid-4 { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <div id="notification"></div>
    <button id="installBtn" class="btn btn-primary" onclick="installPWA()">üì≤ Install App</button>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box card">
            <img src="logo.png" alt="Juice Therapy" class="logo" onerror="this.style.display='none'">
            <h2 style="margin-bottom: 20px;">Juice Therapy POS</h2>
            
            <div class="flex gap-2" style="margin-bottom: 20px; justify-content: center;">
                <button class="btn btn-secondary" onclick="setLoginMode('customer')" id="btnRoleCust">Customer</button>
                <button class="btn btn-secondary" onclick="setLoginMode('staff')" id="btnRoleStaff">Staff/Admin</button>
            </div>
            <div id="customerLogin" class="hidden">
                <input type="tel" id="custPhoneLogin" class="input" placeholder="Enter Phone Number" maxlength="10">
                <button class="btn btn-primary w-full" onclick="loginCustomer()">Enter</button>
            </div>
            <div id="staffLogin" class="hidden">
                <input type="email" id="staffEmail" class="input" placeholder="Email">
                <input type="password" id="staffPass" class="input" placeholder="Password">
                <button class="btn btn-primary w-full" onclick="loginStaff()">Login</button>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="hidden">
        <header>
            <div class="header-content">
                <div class="flex items-center gap-2">
                    <img src="logo.png" style="height:30px;"> 
                    <h2>Admin Dashboard</h2>
                </div>
                <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
            </div>
        </header>
        <div class="app-layout">
            <div class="tabs">
                <button class="btn btn-secondary tab-btn active" onclick="switchAdminTab('dashboard')" id="btn-adm-dash">üìä Analytics</button>
                <button class="btn btn-secondary tab-btn" onclick="switchAdminTab('menu')" id="btn-adm-menu">üçî Menu Manager</button>
                <button class="btn btn-secondary tab-btn" onclick="switchAdminTab('orders')" id="btn-adm-orders">üìú Order Manager</button>
            </div>

            <!-- Dashboard -->
            <div id="adm-view-dashboard">
                <div class="card">
                    <h3>Sales Analytics</h3>
                    <div class="flex gap-2" style="margin: 15px 0;">
                        <input type="date" id="dashStart" class="input" style="margin:0;">
                        <input type="date" id="dashEnd" class="input" style="margin:0;">
                        <button class="btn btn-primary" onclick="loadAnalytics()">Go</button>
                    </div>
                    <div class="grid-4">
                        <div class="stat-card">
                            <div class="stat-label">Total Sales</div>
                            <div class="stat-value" id="statTotalSales">‚Çπ0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Orders</div>
                            <div class="stat-value" id="statTotalOrders">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Avg Order Value</div>
                            <div class="stat-value" id="statAvgValue">‚Çπ0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Menu Manager -->
            <div id="adm-view-menu" class="hidden">
                <div class="flex justify-between items-center" style="margin-bottom: 15px;">
                    <h3>Manage Categories & Items</h3>
                    <div class="flex gap-2">
                        <button class="btn btn-secondary" onclick="showCategoryModal()">+ Category</button>
                        <button class="btn btn-primary" onclick="showAddItemModal()">+ Add Item</button>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>Categories</h4>
                    <div id="adminCategoryList" class="flex gap-2" style="flex-wrap: wrap; margin-top: 10px;"></div>
                </div>

                <h4>Menu Items</h4>
                <div id="adminMenuGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 10px;"></div>
            </div>

            <!-- Order Manager -->
            <div id="adm-view-orders" class="hidden">
                <h3>Completed Orders History</h3>
                <input type="text" class="input" placeholder="Search by Phone Number..." onkeyup="filterAdminOrders(this.value)" style="margin: 10px 0;">
                <div id="adminOrdersList"></div>
            </div>
        </div>
    </div>

    <!-- Outlet POS Panel -->
    <div id="outletPanel" class="hidden">
        <header>
            <div class="header-content">
                <div class="flex items-center gap-2">
                    <img src="logo.png" style="height:30px;"> 
                    <h2>Outlet POS</h2>
                </div>
                <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
            </div>
        </header>
        <div class="app-layout">
            <div class="tabs">
                <button class="btn btn-secondary tab-btn active" onclick="switchOutletTab('pos')" id="tab-pos">üõí New Order</button>
                <button class="btn btn-secondary tab-btn" onclick="switchOutletTab('incoming')" id="tab-incoming">üîî Incoming <span id="badgeIncoming" class="hidden" style="background:red;border-radius:50%;width:8px;height:8px;display:inline-block;"></span></button>
                <button class="btn btn-secondary tab-btn" onclick="switchOutletTab('current')" id="tab-current">‚è≥ Current</button>
                <button class="btn btn-secondary tab-btn" onclick="switchOutletTab('completed')" id="tab-completed">‚úÖ Completed</button>
            </div>

            <!-- POS -->
            <div id="view-pos" class="pos-container">
                <div class="pos-left">
                    <input type="text" class="input" placeholder="üîç Search items..." onkeyup="filterMenu(this.value)">
                    <div class="menu-area">
                        <div class="cat-sidebar" id="posSidebar"></div>
                        <div class="item-grid" id="posGrid"></div>
                    </div>
                </div>
                <div class="cart-panel">
                    <div class="flex justify-between items-center">
                        <h3>Cart</h3>
                        <span class="btn-danger" style="padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;" onclick="clearCart()">Clear</span>
                    </div>
                    <div style="margin-top: 10px;">
                        <input type="tel" id="posPhone" class="input" placeholder="Customer Phone (Auto-create)" maxlength="10">
                    </div>
                    <div class="cart-items" id="cartItemsList"></div>
                    <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
                        <div class="flex justify-between font-bold" style="font-size: 1.2rem; margin-bottom: 10px;">
                            <span>Total</span>
                            <span id="cartTotal">‚Çπ0</span>
                        </div>
                        <button id="btnPlaceOrder" class="btn btn-primary w-full" onclick="placeOrder()">Place Order</button>
                        <button id="btnUpdateOrder" class="btn btn-warning w-full hidden" onclick="updateExistingOrder()">Update Order</button>
                    </div>
                </div>
            </div>

            <!-- Incoming Requests -->
            <div id="view-incoming" class="hidden">
                <div id="incomingOrdersList"></div>
            </div>

            <!-- Current -->
            <div id="view-current" class="hidden">
                <div id="currentOrdersList"></div>
            </div>

            <!-- Completed -->
            <div id="view-completed" class="hidden">
                <div id="completedOrdersList"></div>
            </div>
        </div>
    </div>

    <!-- Customer Panel -->
    <div id="customerPanel" class="hidden">
        <header>
            <div class="header-content">
                <div class="flex items-center gap-2">
                    <img src="logo.png" style="height:30px;"> 
                    <h2>My Juice Therapy</h2>
                </div>
                <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
            </div>
        </header>
        <div class="app-layout">
            <div class="card text-center" style="background: linear-gradient(135deg, var(--primary), #FF9F43);">
                <h3>Welcome, <span id="custNameDisplay">Guest</span></h3>
                <h1 style="font-size: 3rem; margin: 10px 0;" id="custPoints">0</h1>
                <p>Bonus Points Available</p>
            </div>
            <div class="tabs">
                <button class="btn btn-secondary tab-btn active" onclick="switchCustTab('menu')" id="btn-cust-menu">üçî Order Now</button>
                <button class="btn btn-secondary tab-btn" onclick="switchCustTab('history')" id="btn-cust-history">üìú My History</button>
            </div>
            <div id="cust-view-menu">
                <div class="pos-container" style="height: 60vh;">
                    <div class="pos-left">
                         <div class="menu-area">
                            <div class="cat-sidebar" id="custSidebar"></div>
                            <div class="item-grid" id="custGrid"></div>
                         </div>
                    </div>
                    <div class="cart-panel">
                        <h3>My Cart</h3>
                        <div class="cart-items" id="custCartItems"></div>
                        <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
                            <div class="flex justify-between font-bold" style="font-size: 1.2rem; margin-bottom: 10px;">
                                <span>Total</span>
                                <span id="custCartTotal">‚Çπ0</span>
                            </div>
                            <button class="btn btn-primary w-full" onclick="placeCustomerOrder()">Request Order</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="cust-view-history" class="hidden">
                <div id="custHistoryList"></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Item -->
    <div id="addItemModal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200; display: flex; align-items: center; justify-content: center;">
        <div class="card" style="width: 90%; max-width: 400px;">
            <h3>Add/Edit Item</h3>
            <input type="text" id="newItemName" class="input" placeholder="Item Name">
            <input type="number" id="newItemPrice" class="input" placeholder="Price">
            <select id="newItemCat" class="input">
                <option value="">Select Category</option>
            </select>
            <div class="flex gap-2" style="margin-top: 10px;">
                <button class="btn btn-secondary w-full" onclick="document.getElementById('addItemModal').classList.add('hidden')">Cancel</button>
                <button class="btn btn-primary w-full" onclick="saveMenuItem()">Save</button>
            </div>
        </div>
    </div>

    <!-- Add Category -->
    <div id="addCategoryModal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 210; display: flex; align-items: center; justify-content: center;">
        <div class="card" style="width: 90%; max-width: 350px;">
            <h3>New Category</h3>
            <input type="text" id="newCatName" class="input" placeholder="Category Name">
            <div class="flex gap-2" style="margin-top: 10px;">
                <button class="btn btn-secondary w-full" onclick="document.getElementById('addCategoryModal').classList.add('hidden')">Cancel</button>
                <button class="btn btn-primary w-full" onclick="saveCategory()">Save</button>
            </div>
        </div>
    </div>

    <!-- Customer Name Modal -->
    <div id="customerNameModal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 300; display: flex; align-items: center; justify-content: center;">
        <div class="card" style="width: 90%; max-width: 400px; text-align: center;">
            <h3 style="margin-bottom: 10px;">Welcome!</h3>
            <p style="margin-bottom: 20px; color: var(--text-muted);">Please enter your name to continue.</p>
            <input type="text" id="newCustName" class="input" placeholder="Your Name">
            <button class="btn btn-primary w-full" onclick="saveCustomerName()">Start Ordering</button>
        </div>
    </div>

    <script>
        const STATE = {
            user: null,
            role: null, 
            menu: [],
            categories: [],
            cart: [],
            custCart: [], 
            orders: [],
            editingOrderId: null,
            activeCategory: 'All',
            tempPhone: null
        };

        window.onload = () => {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                window.deferredPrompt = e;
                document.getElementById('installBtn').style.display = 'flex';
            });
            const checkFirebase = setInterval(() => {
                if (window.firebaseReady) {
                    clearInterval(checkFirebase);
                    initApp();
                }
            }, 100);
            
            // Set Default Dates for dashboard
            const d = new Date();
            document.getElementById('dashEnd').valueAsDate = d;
            d.setMonth(d.getMonth() - 1);
            document.getElementById('dashStart').valueAsDate = d;
        };

        function initApp() {
            window.firebaseModules.onAuthStateChanged(window.auth, (user) => {
                if (user) checkUserRole(user); 
                else document.getElementById('loginScreen').classList.remove('hidden');
            });
        }

        async function checkUserRole(user) {
            if (user.email === 'admin@jt.com' || user.email === 'titir95biplab@gmail.com') {
                STATE.role = 'admin';
                showPanel('adminPanel');
                loadCategories();
                loadMenu();
                loadAnalytics();
                return;
            } 
            
            const { doc, getDoc } = window.firebaseModules;
            try {
                const userDoc = await getDoc(doc(window.db, 'staff', user.uid)); 
                if (userDoc.exists() && userDoc.data().role === 'admin') {
                    STATE.role = 'admin';
                    showPanel('adminPanel');
                    loadCategories();
                    loadMenu();
                    loadAnalytics();
                } else {
                    STATE.role = 'staff';
                    showPanel('outletPanel');
                    loadCategories();
                    loadMenu();
                    loadOrders(); 
                }
            } catch (e) {
                STATE.role = 'staff';
                showPanel('outletPanel');
                loadCategories();
                loadMenu();
                loadOrders(); 
            }
        }

        function showPanel(panelId) {
            ['loginScreen', 'adminPanel', 'outletPanel', 'customerPanel'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(panelId).classList.remove('hidden');
        }

        function setLoginMode(mode) {
            document.getElementById('customerLogin').classList.add('hidden');
            document.getElementById('staffLogin').classList.add('hidden');
            document.getElementById('btnRoleCust').classList.remove('btn-primary');
            document.getElementById('btnRoleStaff').classList.remove('btn-primary');
            if(mode === 'customer') {
                document.getElementById('customerLogin').classList.remove('hidden');
                document.getElementById('btnRoleCust').classList.add('btn-primary');
            } else {
                document.getElementById('staffLogin').classList.remove('hidden');
                document.getElementById('btnRoleStaff').classList.add('btn-primary');
            }
        }

        async function loginStaff() {
            const email = document.getElementById('staffEmail').value;
            const pass = document.getElementById('staffPass').value;
            try { await window.firebaseModules.signInWithEmailAndPassword(window.auth, email, pass); } 
            catch (e) { showToast(e.message, 'error'); }
        }

        async function loginCustomer() {
            const phone = document.getElementById('custPhoneLogin').value;
            if (phone.length !== 10) return showToast('Invalid phone', 'error');
            const { doc, getDoc } = window.firebaseModules;
            const snap = await getDoc(doc(window.db, 'customers', phone));
            if (!snap.exists() || !snap.data().name) {
                STATE.tempPhone = phone;
                document.getElementById('customerNameModal').classList.remove('hidden');
                return;
            }
            finalizeCustomerLogin(phone, snap.data());
        }

        async function saveCustomerName() {
            const name = document.getElementById('newCustName').value;
            if(!name) return showToast('Name is required', 'error');
            const { doc, setDoc, serverTimestamp } = window.firebaseModules;
            await setDoc(doc(window.db, 'customers', STATE.tempPhone), {
                phone: STATE.tempPhone, name: name, points: 0, joined: serverTimestamp()
            }, { merge: true });
            document.getElementById('customerNameModal').classList.add('hidden');
            finalizeCustomerLogin(STATE.tempPhone, { name, points: 0 });
        }

        function finalizeCustomerLogin(phone, data) {
            STATE.user = { uid: phone, phone: phone, name: data.name };
            STATE.role = 'customer';
            document.getElementById('custNameDisplay').innerText = data.name;
            document.getElementById('custPoints').innerText = data.points || 0;
            loadCategories();
            loadMenu();
            loadCustomerHistory(phone);
            showPanel('customerPanel');
        }

        function logout() {
            window.auth.signOut();
            location.reload();
        }

        // --- ADMIN FUNCTIONS ---
        function switchAdminTab(tab) {
            ['dashboard', 'menu', 'orders'].forEach(t => {
                const btn = document.getElementById(`btn-adm-${t}`);
                const view = document.getElementById(`adm-view-${t}`);
                if(btn) btn.classList.remove('active');
                if(view) view.classList.add('hidden');
            });

            const activeBtn = document.getElementById(`btn-adm-${tab}`);
            const activeView = document.getElementById(`adm-view-${tab}`);
            
            if(activeBtn) activeBtn.classList.add('active');
            if(activeView) activeView.classList.remove('hidden');

            if(tab === 'orders') loadAdminOrders();
            if(tab === 'dashboard') loadAnalytics();
            if(tab === 'menu') updateCategorySelects();
        }

        function loadCategories() {
            const { collection, onSnapshot, query, orderBy } = window.firebaseModules;
            onSnapshot(query(collection(window.db, 'categories'), orderBy('name')), (snap) => {
                STATE.categories = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if (STATE.role === 'admin') renderAdminCategories();
                updateCategorySelects();
                if(STATE.role === 'staff') renderOutletMenu();
                if(STATE.role === 'customer') renderCustomerMenu();
            });
        }

        function renderAdminCategories() {
            const list = document.getElementById('adminCategoryList');
            list.innerHTML = STATE.categories.map(c => `
                <div class="btn btn-secondary btn-sm" style="display:inline-flex; gap:5px;">
                    ${c.name} 
                    <span style="cursor:pointer; color:var(--danger);" onclick="deleteCategory('${c.id}')">&times;</span>
                </div>
            `).join('');
        }

        function updateCategorySelects() {
            const opts = `<option value="">Select Category</option>` + STATE.categories.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            document.getElementById('newItemCat').innerHTML = opts;
        }

        async function saveCategory() {
            const name = document.getElementById('newCatName').value;
            if(!name) return;
            await window.firebaseModules.addDoc(window.firebaseModules.collection(window.db, 'categories'), { name });
            document.getElementById('addCategoryModal').classList.add('hidden');
            document.getElementById('newCatName').value = '';
        }

        async function deleteCategory(id) {
            if(!confirm('Delete Category?')) return;
            await window.firebaseModules.deleteDoc(window.firebaseModules.doc(window.db, 'categories', id));
        }

        function showCategoryModal() { document.getElementById('addCategoryModal').classList.remove('hidden'); }

        function loadMenu() {
            const { collection, onSnapshot, query, orderBy } = window.firebaseModules;
            onSnapshot(query(collection(window.db, 'menu'), orderBy('name')), (snap) => {
                STATE.menu = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if (STATE.role === 'admin') renderAdminMenu();
                if (STATE.role === 'staff') renderOutletMenu();
                if (STATE.role === 'customer') renderCustomerMenu();
            });
        }

        function renderAdminMenu() {
            const grid = document.getElementById('adminMenuGrid');
            grid.innerHTML = STATE.menu.map(item => `
                <div class="card" style="margin:0;">
                    <div class="flex justify-between">
                        <h4>${item.name}</h4>
                        <span class="text-muted">‚Çπ${item.price}</span>
                    </div>
                    <div class="text-muted" style="font-size:0.8rem;">${item.category || 'Uncategorized'}</div>
                    <div class="flex gap-2" style="margin-top:10px;">
                        <button class="btn btn-secondary w-full" onclick="editItem('${item.id}')">Edit</button>
                        <button class="btn btn-danger w-full" onclick="deleteItem('${item.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // --- ADMIN ANALYTICS & ORDERS ---
        async function loadAnalytics() {
            const startInput = document.getElementById('dashStart').value;
            const endInput = document.getElementById('dashEnd').value;
            
            if(!startInput || !endInput) return;

            const startDate = new Date(startInput);
            const endDate = new Date(endInput);
            endDate.setHours(23, 59, 59);

            const { collection, query, where, getDocs } = window.firebaseModules;
            
            const q = query(collection(window.db, 'orders'), where('status', '==', 'completed'));
            
            const snap = await getDocs(q);
            let totalSales = 0;
            let count = 0;

            snap.forEach(d => {
                const data = d.data();
                if(data.timestamp) {
                    const orderDate = data.timestamp.toDate();
                    if(orderDate >= startDate && orderDate <= endDate) {
                        totalSales += (data.total || 0);
                        count++;
                    }
                }
            });

            document.getElementById('statTotalSales').innerText = '‚Çπ' + totalSales;
            document.getElementById('statTotalOrders').innerText = count;
            document.getElementById('statAvgValue').innerText = count ? '‚Çπ' + Math.floor(totalSales/count) : '‚Çπ0';
        }

        function loadAdminOrders() {
            const { collection, query, where, onSnapshot } = window.firebaseModules;
            
            const q = query(collection(window.db, 'orders'), where('status', '==', 'completed'));
            
            onSnapshot(q, (snap) => {
                const list = document.getElementById('adminOrdersList');
                
                if(snap.empty) {
                    list.innerHTML = '<p class="text-muted text-center">No completed orders found.</p>';
                    return;
                }

                const orders = snap.docs.map(d => ({id: d.id, ...d.data()}));
                orders.sort((a, b) => {
                    const tA = a.timestamp ? a.timestamp.seconds : 0;
                    const tB = b.timestamp ? b.timestamp.seconds : 0;
                    return tB - tA;
                });

                list.innerHTML = orders.map(o => {
                    const dateStr = o.timestamp ? new Date(o.timestamp.toDate()).toLocaleDateString() : 'N/A';
                    return `
                    <div class="order-card" style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-weight:bold; font-size:1.1rem;">${o.phone}</div>
                            <div class="text-muted" style="font-size:0.85rem;">${dateStr} ‚Ä¢ ‚Çπ${o.total}</div>
                            <div class="text-muted" style="font-size:0.8rem;">${o.items.length} Items</div>
                        </div>
                        <div>
                            <button class="btn btn-danger btn-sm" onclick="adminDeleteOrder('${o.id}')">Delete</button>
                        </div>
                    </div>
                `;}).join('');
            });
        }
        
        // ** FIXED: Deleting order adjusts points **
        async function adminDeleteOrder(id) {
            if(!confirm('Delete this record? Warning: 5% Bonus points awarded will be deducted from the customer.')) return;
            
            const { doc, runTransaction } = window.firebaseModules;
            
            try {
                await runTransaction(window.db, async (transaction) => {
                    // 1. Get Order
                    const orderRef = doc(window.db, 'orders', id);
                    const orderDoc = await transaction.get(orderRef);
                    
                    if (!orderDoc.exists()) throw "Order does not exist!";
                    
                    const orderData = orderDoc.data();
                    
                    // 2. Adjust Customer Points if order was completed
                    if (orderData.status === 'completed' && orderData.phone) {
                        const bonus = Math.floor(orderData.total * 0.05);
                        const custRef = doc(window.db, 'customers', orderData.phone);
                        const custDoc = await transaction.get(custRef);
                        
                        if (custDoc.exists()) {
                            const currentPoints = custDoc.data().points || 0;
                            transaction.update(custRef, { points: currentPoints - bonus });
                        }
                    }
                    
                    // 3. Delete Order
                    transaction.delete(orderRef);
                });
                
                showToast('Order deleted & points reversed');
                loadAdminOrders(); 
            } catch (e) {
                console.error(e);
                showToast('Error: ' + e.message, 'error');
            }
        }

        function filterAdminOrders(val) {
            const cards = document.querySelectorAll('#adminOrdersList .order-card');
            cards.forEach(c => c.style.display = c.innerText.includes(val) ? 'flex' : 'none');
        }

        // --- MENU ITEM LOGIC ---
        function showAddItemModal(id = null) {
            document.getElementById('addItemModal').classList.remove('hidden');
            if(id) {
                const item = STATE.menu.find(i => i.id === id);
                document.getElementById('newItemName').value = item.name;
                document.getElementById('newItemPrice').value = item.price;
                document.getElementById('newItemCat').value = item.category;
                document.getElementById('addItemModal').dataset.id = id;
            } else {
                document.getElementById('newItemName').value = '';
                document.getElementById('newItemPrice').value = '';
                document.getElementById('newItemCat').value = '';
                delete document.getElementById('addItemModal').dataset.id;
            }
        }

        async function saveMenuItem() {
            const name = document.getElementById('newItemName').value;
            const price = Number(document.getElementById('newItemPrice').value);
            const category = document.getElementById('newItemCat').value;
            const id = document.getElementById('addItemModal').dataset.id;
            const { collection, addDoc, doc, updateDoc } = window.firebaseModules;
            try {
                if(id) { await updateDoc(doc(window.db, 'menu', id), { name, price, category }); } 
                else { await addDoc(collection(window.db, 'menu'), { name, price, category }); }
                document.getElementById('addItemModal').classList.add('hidden');
                showToast('Saved');
            } catch(e) { showToast(e.message, 'error'); }
        }

        async function editItem(id) { showAddItemModal(id); }
        async function deleteItem(id) {
            if(!confirm('Delete item?')) return;
            await window.firebaseModules.deleteDoc(window.firebaseModules.doc(window.db, 'menu', id));
        }

        // --- OUTLET POS ---
        function switchOutletTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            ['view-pos', 'view-incoming', 'view-current', 'view-completed'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
        }

        function renderOutletMenu() {
            const sidebar = document.getElementById('posSidebar');
            const cats = ['All', ...STATE.categories.map(c => c.name)];
            
            sidebar.innerHTML = cats.map(cat => {
                const safeCat = cat.replace(/'/g, "\\'");
                return `
                <div class="cat-btn ${cat === STATE.activeCategory ? 'active' : ''}" 
                     onclick="filterCategory('${safeCat}')">${cat}</div>
                `;
            }).join('');
            
            const grid = document.getElementById('posGrid');
            const items = STATE.activeCategory === 'All' 
                ? STATE.menu 
                : STATE.menu.filter(m => (m.category || '').trim() === STATE.activeCategory);
            
            if (items.length === 0) {
                grid.innerHTML = '<div class="text-muted" style="grid-column: 1/-1; text-align:center; padding:20px;">No items found in ' + STATE.activeCategory + '</div>';
            } else {
                grid.innerHTML = items.map(item => {
                    // 1. Find Qty in Cart
                    const cartItem = STATE.cart.find(c => c.id === item.id);
                    const qty = cartItem ? cartItem.qty : 0;
                    
                    // 2. Create Badge HTML
                    const qtyBadge = qty > 0 ? `<div style="position:absolute; top:8px; right:8px; background:white; color:var(--primary); width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; box-shadow:0 2px 4px rgba(0,0,0,0.3); font-size:0.8rem;">${qty}</div>` : '';
                    
                    // 3. Highlight Border if selected
                    const borderStyle = qty > 0 ? 'border: 1px solid var(--primary); background: rgba(255, 107, 53, 0.1);' : '';

                    return `
                    <div class="menu-item" onclick="addToCart('${item.id}')" style="position:relative; ${borderStyle}">
                        ${qtyBadge}
                        <div style="font-weight:600; font-size: 0.9rem; padding-right:15px;">${item.name}</div>
                        <div style="color: var(--primary); margin-top:5px;">‚Çπ${item.price}</div>
                    </div>
                `}).join('');
            }
        }

        function filterCategory(cat) {
            STATE.activeCategory = cat;
            if(STATE.role === 'staff') renderOutletMenu();
            if(STATE.role === 'customer') renderCustomerMenu();
        }

        function addToCart(itemId) {
            const item = STATE.menu.find(i => i.id === itemId);
            const targetCart = STATE.role === 'customer' ? STATE.custCart : STATE.cart;
            const existing = targetCart.find(c => c.id === itemId);
            if(existing) existing.qty++;
            else targetCart.push({ ...item, qty: 1 });
            renderActiveCart();
        }

        function updateQty(itemId, delta) {
            const targetCart = STATE.role === 'customer' ? STATE.custCart : STATE.cart;
            const item = targetCart.find(c => c.id === itemId);
            if(!item) return;
            item.qty += delta;
            if(item.qty <= 0) {
                if(STATE.role === 'customer') STATE.custCart = STATE.custCart.filter(c => c.id !== itemId);
                else STATE.cart = STATE.cart.filter(c => c.id !== itemId);
            }
            renderActiveCart();
        }

        function clearCart() {
            STATE.cart = [];
            STATE.editingOrderId = null;
            document.getElementById('posPhone').value = '';
            document.getElementById('btnPlaceOrder').classList.remove('hidden');
            document.getElementById('btnUpdateOrder').classList.add('hidden');
            renderActiveCart();
        }

        function renderActiveCart() {
            if(STATE.role === 'customer') {
                renderCartGeneric(document.getElementById('custCartItems'), document.getElementById('custCartTotal'), STATE.custCart);
                // Refresh Menu to update badges
                renderCustomerMenu();
            } else {
                renderCartGeneric(document.getElementById('cartItemsList'), document.getElementById('cartTotal'), STATE.cart);
                // Refresh Menu to update badges
                renderOutletMenu();
            }
        }

        function renderCartGeneric(container, totalEl, cartArray) {
            if(cartArray.length === 0) {
                container.innerHTML = '<div class="text-center text-muted" style="margin-top:20px;">Cart is empty</div>';
                totalEl.innerText = '‚Çπ0';
                return;
            }
            let total = 0;
            container.innerHTML = cartArray.map(item => {
                total += item.price * item.qty;
                return `
                    <div class="cart-item">
                        <div>
                            <div style="font-size: 0.9rem;">${item.name}</div>
                            <div class="text-muted" style="font-size: 0.8rem;">‚Çπ${item.price} x ${item.qty}</div>
                        </div>
                        <div class="qty-controls">
                            <div class="qty-btn" onclick="updateQty('${item.id}', -1)">-</div>
                            <span style="padding: 0 5px;">${item.qty}</span>
                            <div class="qty-btn" onclick="updateQty('${item.id}', 1)">+</div>
                        </div>
                    </div>
                `;
            }).join('');
            totalEl.innerText = '‚Çπ' + total;
        }

        async function placeOrder() {
            const phone = document.getElementById('posPhone').value;
            if(phone.length !== 10) return showToast('Enter 10-digit Phone', 'error');
            if(STATE.cart.length === 0) return showToast('Cart is empty', 'error');
            await submitOrder(phone, STATE.cart, 'pending');
            clearCart();
            switchOutletTab('current');
        }

        async function placeCustomerOrder() {
            if(STATE.custCart.length === 0) return showToast('Cart is empty', 'error');
            await submitOrder(STATE.user.phone, STATE.custCart, 'requested');
            STATE.custCart = [];
            renderActiveCart();
            showToast('Order Request Sent');
            switchCustTab('history');
        }

        async function submitOrder(phone, items, status) {
            const { addDoc, collection, serverTimestamp, doc, setDoc, getDoc } = window.firebaseModules;
            const custRef = doc(window.db, 'customers', phone);
            const custSnap = await getDoc(custRef);
            if (!custSnap.exists()) await setDoc(custRef, { phone, points: 0, joined: serverTimestamp() });
            
            const total = items.reduce((s, i) => s + (i.price * i.qty), 0);
            await addDoc(collection(window.db, 'orders'), {
                items: items, phone: phone, total: total, status: status, timestamp: serverTimestamp()
            });
        }

        function loadOrders() {
            const { collection, query, orderBy, onSnapshot } = window.firebaseModules;
            onSnapshot(query(collection(window.db, 'orders'), orderBy('timestamp', 'desc')), (snap) => {
                const orders = snap.docs.map(d => ({id: d.id, ...d.data()}));
                
                const requested = orders.filter(o => o.status === 'requested');
                renderIncoming(requested);
                
                const pending = orders.filter(o => o.status === 'pending');
                renderCurrentOrders(pending);
                
                const completed = orders.filter(o => o.status === 'completed');
                renderCompletedOrders(completed);
                
                const badge = document.getElementById('badgeIncoming');
                if(requested.length > 0) badge.classList.remove('hidden');
                else badge.classList.add('hidden');
            });
        }

        function renderIncoming(orders) {
            document.getElementById('incomingOrdersList').innerHTML = orders.map(o => `
                <div class="order-card">
                    <div class="flex justify-between">
                        <div><span class="order-status status-requested">REQUESTED</span> <strong>${o.phone}</strong></div>
                        <strong>‚Çπ${o.total}</strong>
                    </div>
                    <div class="text-muted">${o.items.map(i => `${i.qty}x ${i.name}`).join(', ')}</div>
                    <div class="flex gap-2" style="margin-top:10px;">
                        <button class="btn btn-success w-full" onclick="updateOrderStatus('${o.id}', 'pending')">Accept</button>
                        <button class="btn btn-danger w-full" onclick="updateOrderStatus('${o.id}', 'cancelled')">Reject</button>
                    </div>
                </div>
            `).join('');
        }

        function renderCurrentOrders(orders) {
            document.getElementById('currentOrdersList').innerHTML = orders.map(o => `
                <div class="order-card">
                    <div class="flex justify-between">
                        <div><span class="order-status status-pending">PENDING</span> <strong>${o.phone}</strong></div>
                        <strong>‚Çπ${o.total}</strong>
                    </div>
                    <div class="text-muted">${o.items.map(i => `${i.qty}x ${i.name}`).join(', ')}</div>
                    <div class="flex gap-2" style="margin-top:10px;">
                        <button class="btn btn-secondary w-full" onclick="editOrder('${o.id}')">‚úèÔ∏è Edit</button>
                        <button class="btn btn-success w-full" onclick="completeOrder('${o.id}', ${o.total}, '${o.phone}')">‚úÖ Complete</button>
                    </div>
                </div>
            `).join('');
        }

        function renderCompletedOrders(orders) {
            document.getElementById('completedOrdersList').innerHTML = orders.map(o => `
                <div class="order-card">
                    <div class="flex justify-between">
                        <div><span class="order-status status-completed">COMPLETED</span> <strong>${o.phone}</strong></div>
                        <strong>‚Çπ${o.total}</strong>
                    </div>
                    <div class="text-muted">${o.items.map(i => `${i.qty}x ${i.name}`).join(', ')}</div>
                    <button class="btn btn-primary w-full" style="margin-top:10px;" onclick="sendBill('${o.phone}', '${o.total}')">üì± Send Bill</button>
                </div>
            `).join('');
        }

        async function updateOrderStatus(id, status) {
            await window.firebaseModules.updateDoc(window.firebaseModules.doc(window.db, 'orders', id), { status });
        }

        function editOrder(orderId) {
            const { doc, getDoc } = window.firebaseModules;
            getDoc(doc(window.db, 'orders', orderId)).then(snap => {
                if(snap.exists()) {
                    const data = snap.data();
                    STATE.cart = data.items;
                    STATE.editingOrderId = orderId;
                    switchOutletTab('pos');
                    document.getElementById('posPhone').value = data.phone;
                    document.getElementById('btnPlaceOrder').classList.add('hidden');
                    document.getElementById('btnUpdateOrder').classList.remove('hidden');
                    renderActiveCart();
                    showToast('Order Loaded for Editing');
                }
            });
        }

        async function updateExistingOrder() {
            if(!STATE.editingOrderId) return;
            const total = STATE.cart.reduce((s, i) => s + (i.price * i.qty), 0);
            await window.firebaseModules.updateDoc(window.firebaseModules.doc(window.db, 'orders', STATE.editingOrderId), {
                items: STATE.cart, total: total
            });
            showToast('Order Updated');
            clearCart();
            switchOutletTab('current');
        }

        async function completeOrder(orderId, total, phone) {
            if(!confirm('Mark as Completed? 5% Bonus will be added.')) return;
            
            const bonus = Math.floor(total * 0.05);
            const { doc, runTransaction, serverTimestamp } = window.firebaseModules;
            
            try {
                await runTransaction(window.db, async (transaction) => {
                    const orderRef = doc(window.db, 'orders', orderId);
                    const custRef = doc(window.db, 'customers', phone);

                    const custDoc = await transaction.get(custRef);

                    transaction.update(orderRef, { status: 'completed' });
                    
                    if(custDoc.exists()) {
                        const newPoints = (custDoc.data().points || 0) + bonus;
                        transaction.update(custRef, { points: newPoints });
                    }
                });
                showToast(`Completed! +${bonus} pts`);
            } catch(e) {
                console.error(e);
                showToast('Error: ' + e.message, 'error');
            }
        }

        function sendBill(phone, total) {
            const msg = `Juice Therapy Invoice\nTotal: ‚Çπ${total}\nThank you for visiting!`;
            window.open(`https://wa.me/91${phone}?text=${encodeURIComponent(msg)}`);
        }

        // --- CUSTOMER PANEL ---
        function switchCustTab(tab) {
            document.getElementById('btn-cust-menu').classList.toggle('active', tab === 'menu');
            document.getElementById('btn-cust-history').classList.toggle('active', tab === 'history');
            document.getElementById('cust-view-menu').classList.toggle('hidden', tab !== 'menu');
            document.getElementById('cust-view-history').classList.toggle('hidden', tab !== 'history');
        }

        function renderCustomerMenu() {
            const sidebar = document.getElementById('custSidebar');
            const cats = ['All', ...STATE.categories.map(c => c.name)];
            
            sidebar.innerHTML = cats.map(cat => {
                const safeCat = cat.replace(/'/g, "\\'");
                return `
                <div class="cat-btn ${cat === STATE.activeCategory ? 'active' : ''}" 
                     onclick="filterCategory('${safeCat}')">${cat}</div>
                `;
            }).join('');
            
            const grid = document.getElementById('custGrid');
            const items = STATE.activeCategory === 'All' 
                ? STATE.menu 
                : STATE.menu.filter(m => (m.category || '').trim() === STATE.activeCategory);
            
            if (items.length === 0) {
                grid.innerHTML = '<div class="text-muted" style="grid-column: 1/-1; text-align:center; padding:20px;">No items found</div>';
            } else {
                grid.innerHTML = items.map(item => {
                    // 1. Find Qty in Customer Cart
                    const cartItem = STATE.custCart.find(c => c.id === item.id);
                    const qty = cartItem ? cartItem.qty : 0;
                    
                    // 2. Badge HTML
                    const qtyBadge = qty > 0 ? `<div style="position:absolute; top:8px; right:8px; background:white; color:var(--primary); width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; box-shadow:0 2px 4px rgba(0,0,0,0.3); font-size:0.8rem;">${qty}</div>` : '';
                    
                    const borderStyle = qty > 0 ? 'border: 1px solid var(--primary); background: rgba(255, 107, 53, 0.1);' : '';

                    return `
                    <div class="menu-item" onclick="addToCart('${item.id}')" style="position:relative; ${borderStyle}">
                        ${qtyBadge}
                        <div style="font-weight:600; font-size: 0.9rem; padding-right:15px;">${item.name}</div>
                        <div style="color: var(--primary); margin-top:5px;">‚Çπ${item.price}</div>
                    </div>
                `}).join('');
            }
        }

        function loadCustomerHistory(phone) {
            const { collection, query, where, onSnapshot } = window.firebaseModules;
            
            const q = query(collection(window.db, 'orders'), where('phone', '==', phone));
            
            onSnapshot(q, (snap) => {
                const list = document.getElementById('custHistoryList');
                if(snap.empty) { 
                    list.innerHTML = '<p class="text-center text-muted" style="padding:20px;">No orders found.</p>'; 
                    return; 
                }

                const sortedDocs = snap.docs.sort((a, b) => {
                    const tA = a.data().timestamp ? a.data().timestamp.seconds : 0;
                    const tB = b.data().timestamp ? b.data().timestamp.seconds : 0;
                    return tB - tA;
                });

                list.innerHTML = sortedDocs.map(d => {
                    const o = d.data();
                    let stClass = 'status-pending';
                    if (o.status === 'completed') stClass = 'status-completed';
                    else if (o.status === 'requested') stClass = 'status-requested';
                    else if (o.status === 'cancelled') stClass = 'status-cancelled';

                    let dateStr = 'Processing...';
                    if(o.timestamp) {
                        const dateObj = o.timestamp.toDate();
                        dateStr = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    }

                    return `
                        <div class="order-card">
                            <div class="flex justify-between" style="margin-bottom:8px;">
                                <div style="display:flex; flex-direction:column; gap:4px;">
                                    <span class="order-status ${stClass}" style="width:fit-content;">${o.status.toUpperCase()}</span>
                                    <span style="font-size:0.75rem; color:#888;">${dateStr}</span>
                                </div>
                                <div style="font-weight:bold; font-size:1.1rem;">‚Çπ${o.total}</div>
                            </div>
                            <div class="text-muted" style="font-size:0.85rem; border-top:1px solid rgba(255,255,255,0.05); padding-top:8px;">
                                ${o.items.map(i => `${i.qty} x ${i.name}`).join(', ')}
                            </div>
                        </div>
                    `;
                }).join('');
            });
        }

        function showToast(msg, type='success') {
            const el = document.getElementById('notification');
            el.innerText = msg;
            el.style.backgroundColor = type === 'error' ? 'var(--danger)' : 'var(--surface)';
            el.style.transform = 'translateX(0)';
            setTimeout(() => el.style.transform = 'translateX(150%)', 3000);
        }

        window.installPWA = async () => {
            if (window.deferredPrompt) {
                window.deferredPrompt.prompt();
                const { outcome } = await window.deferredPrompt.userChoice;
                if (outcome === 'accepted') document.getElementById('installBtn').style.display = 'none';
                window.deferredPrompt = null;
            }
        };
    </script>
</body>
</html>
