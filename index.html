<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Juice Therapy - Smart POS</title>
    
    <!-- Primary Meta Tags -->
    <meta name="title" content="Juice Therapy - Smart POS">
    <meta name="description" content="Smart Point of Sale system for Juice Therapy">
    
    <!-- Theme Colors -->
    <meta name="theme-color" content="#FF6B35">
    <meta name="msapplication-TileColor" content="#FF6B35">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Standard Favicon -->
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="shortcut icon" href="logo.png" type="image/png">
    
    <!-- Apple-Specific Meta Tags for PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Juice Therapy">
    
    <!-- Apple Touch Icons (Required for iOS Home Screen) -->
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="apple-touch-icon" sizes="152x152" href="logo.png">
    <link rel="apple-touch-icon" sizes="180x180" href="logo.png">
    <link rel="apple-touch-icon" sizes="167x167" href="logo.png">
    
    <!-- Apple Splash Screens (Optional but recommended) -->
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <!-- iOS Safari Pinned Tab Icon -->
    <link rel="mask-icon" href="logo.png" color="#FF6B35">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        // 1. UPDATE THIS IMPORT LINE (Added 'getCountFromServer')
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-messaging.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, query, where, orderBy, onSnapshot, serverTimestamp, increment, addDoc, runTransaction, Timestamp, getCountFromServer } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCbHeWurSgxdE1cYFvTGsoyzpK7PQ_1Z0o", 
            authDomain: "jt-s-pos.firebaseapp.com",
            projectId: "jt-s-pos",
            storageBucket: "jt-s-pos.firebasestorage.app",
            messagingSenderId: "365172962139",
            appId: "1:365172962139:web:eaad048f98d2af1ff8207e"
        };

        const app = initializeApp(firebaseConfig);
        const messaging = getMessaging(app);
        window.auth = getAuth(app);
        window.db = getFirestore(app);
        
        // 2. UPDATE THIS LIST (Added 'getCountFromServer' at the end)
        window.firebaseModules = { 
            signInWithEmailAndPassword, signOut, onAuthStateChanged, 
            collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, addDoc, runTransaction,
            query, where, orderBy, onSnapshot, serverTimestamp, increment, Timestamp, getMessaging, getToken, onMessage, messaging,
            getCountFromServer // <--- IMPORTANT: Added this here!
        };
        window.firebaseReady = true;

// --- 1. PASTE THIS TRACKER HERE (AT THE TOP) ---
async function trackUserActivity(phone) {
    console.log("Tracking activity for:", phone); 
    const { doc, updateDoc, serverTimestamp } = window.firebaseModules;
    try {
        await updateDoc(doc(window.db, 'customers', phone), {
            lastActive: serverTimestamp() 
        });
        console.log("‚úÖ Success: lastActive updated in DB");
    } catch(e) { 
        console.error("‚ùå Tracker Failed:", e); 
    }
}
    </script>
    
    <style>
        :root {
            --primary: #FF6B35;
            --primary-light: #FF8555;
            --primary-dark: #E85525;
            --secondary: #1A1A2E;
            --bg: #0A0E27;
            --bg-gradient: linear-gradient(135deg, #0A0E27 0%, #16213E 100%);
            --surface: #1E2139;
            --surface-hover: #252A45;
            --text: #FFFFFF;
            --text-muted: #9CA3AF;
            --success: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --info: #3B82F6;
            --radius: 16px;
            --radius-lg: 24px;
            --spacing: 16px;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.3);
            --shadow-glow: 0 0 20px rgba(255, 107, 53, 0.3);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Manrope', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background: var(--bg-gradient); color: var(--text); overflow-x: hidden; padding-bottom: 60px; min-height: 100vh; }
        
        /* Utils */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }
        .font-bold { font-weight: bold; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }

        /* Components */
        .btn {
            padding: 14px 24px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.95rem; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .btn:active::before {
            width: 300px;
            height: 300px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .btn:active { transform: translateY(0); }
        .btn-sm { padding: 8px 16px; font-size: 0.85rem; }
        .btn-primary { 
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); 
            color: white; 
            box-shadow: var(--shadow-glow);
        }
        .btn-primary:hover { box-shadow: 0 0 30px rgba(255, 107, 53, 0.5); }
        .btn-secondary { background: var(--surface); color: white; border: 1px solid rgba(255,255,255,0.1); }
        .btn-secondary:hover { background: var(--surface-hover); border-color: rgba(255,255,255,0.2); }
        .btn-danger { background: linear-gradient(135deg, var(--danger) 0%, #DC2626 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, var(--success) 0%, #059669 100%); color: white; }
        .btn-warning { background: linear-gradient(135deg, var(--warning) 0%, #D97706 100%); color: white; }
        .btn-info { background: linear-gradient(135deg, var(--info) 0%, #2563EB 100%); color: white; }
        
        .input {
            width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.05); 
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 12px; color: white; font-size: 1rem; margin-bottom: 12px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        .input:focus { 
            outline: none; 
            border-color: var(--primary); 
            background: rgba(255,255,255,0.08);
            box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
        }
        .input::placeholder { color: var(--text-muted); }

        .card { 
            background: rgba(30, 33, 57, 0.6); 
            backdrop-filter: blur(20px);
            border-radius: var(--radius-lg); 
            padding: calc(var(--spacing) * 1.25); 
            margin-bottom: var(--spacing); 
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }
        .card:hover { 
            border-color: rgba(255,255,255,0.15);
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        /* Login Screen */
        .login-container { 
            min-height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 20px;
            background: var(--bg-gradient);
            position: relative;
        }
        .login-container::before {
            content: '';
            position: absolute;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(255, 107, 53, 0.15) 0%, transparent 70%);
            border-radius: 50%;
            filter: blur(60px);
            animation: float 6s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(30px, -30px); }
        }
        .login-box { 
            width: 100%; 
            max-width: 420px; 
            text-align: center;
            position: relative;
            z-index: 1;
        }
        .logo { 
            width: 140px; 
            margin-bottom: 30px;
            filter: drop-shadow(0 4px 12px rgba(255, 107, 53, 0.3));
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Header */
        header { 
            background: rgba(30, 33, 57, 0.8); 
            backdrop-filter: blur(20px);
            padding: 18px 20px; 
            position: sticky; 
            top: 0; 
            z-index: 50; 
            border-bottom: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
        }
        .header-content { 
            max-width: 1200px; 
            margin: 0 auto; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }

        /* Layouts */
        .app-layout { max-width: 1200px; margin: 20px auto; padding: 0 15px; }

        /* POS Specific Layout */
        .pos-container { display: grid; grid-template-columns: 1fr 350px; gap: 20px; height: calc(100vh - 140px); }
        .pos-left { display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        
        .menu-area { 
            display: flex;
            flex-direction: column;
            gap: 16px; 
            flex: 1; 
            overflow: hidden; 
            border: 1px solid rgba(255,255,255,0.15); 
            border-radius: var(--radius-lg); 
            padding: 16px; 
            background: rgba(30, 33, 57, 0.4);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-md);
        }
        
        .cat-sidebar { 
            display: flex;
            flex-direction: row;
            gap: 12px; 
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 10px;
            flex-shrink: 0;
        }
        .cat-sidebar::-webkit-scrollbar {
            height: 6px;
        }
        .cat-btn { 
            padding: 12px 24px; 
            font-size: 0.95rem; 
            background: rgba(255,255,255,0.06); 
            border-radius: 12px; 
            text-align: center; 
            cursor: pointer; 
            white-space: nowrap;
            line-height: 1.4;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            font-weight: 600;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .cat-btn:hover { 
            background: rgba(255,255,255,0.1); 
            transform: translateY(-2px);
            border-color: rgba(255, 107, 53, 0.3);
        }
        .cat-btn.active { 
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); 
            color: white; 
            font-weight: 700;
            box-shadow: var(--shadow-glow);
            border-color: var(--primary);
        }

        .item-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            grid-template-rows: repeat(3, 1fr);
            gap: 16px; 
            overflow-y: auto; 
            align-content: start; 
            padding-bottom: 20px; 
            padding-right: 6px;
            flex: 1;
            height: 100%;
        }
        /* Updated Item Card Design - Larger Blocks */
        .menu-item { 
            background: rgba(255,255,255,0.06); 
            border-radius: var(--radius); 
            cursor: pointer; 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
            height: 100%; 
            min-height: 140px;
            aspect-ratio: 1 / 1;
            border: 2px solid rgba(255,255,255,0.1);
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            backdrop-filter: blur(10px);
        }
        .menu-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        .menu-item:hover::before {
            transform: scaleX(1);
        }
        .menu-item:hover {
            transform: translateY(-4px);
            border-color: rgba(255, 107, 53, 0.4);
            background: rgba(255,255,255,0.1);
            box-shadow: 0 8px 24px rgba(255, 107, 53, 0.2);
        }
        .menu-item:active {
            transform: translateY(-2px) scale(0.98);
        }

        /* Item Name Limit - Larger Text */
        .item-name-clamp {
            font-weight: 700; 
            font-size: 1.05rem; 
            line-height: 1.4;
            padding: 14px 14px 8px 14px;
            
            /* Logic to cut off text after 3 lines */
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            word-break: break-word;
            flex: 1;
            text-align: center;
        }

        /* Price Section - Larger */
        .item-price-tag {
            color: var(--primary); 
            font-weight: 800; 
            font-size: 1.15rem;
            padding: 8px 14px 14px 14px;
            margin-top: auto;
            text-align: center;
            background: rgba(255, 107, 53, 0.1);
            border-top: 1px solid rgba(255, 107, 53, 0.2);
        }

        /* Cart Panel */
        .cart-panel { 
            background: rgba(30, 33, 57, 0.6); 
            backdrop-filter: blur(20px);
            border-radius: var(--radius-lg); 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            height: 100%;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: var(--shadow-md);
        }
        .cart-items { 
            flex: 1; 
            overflow-y: auto; 
            margin: 15px 0; 
            padding-right: 8px;
        }
        .cart-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px 0; 
            border-bottom: 1px solid rgba(255,255,255,0.08);
            transition: all 0.2s ease;
            gap: 12px;
        }
        .cart-item > div:first-child {
            flex: 1;
            min-width: 0; /* Allows text truncation */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 0.9rem;
        }
        .cart-item:hover {
            background: rgba(255,255,255,0.03);
            padding-left: 8px;
            margin: 0 -8px;
        }
        .qty-controls { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 8px; 
            padding: 4px 6px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .qty-btn { 
            width: 28px; 
            height: 28px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            font-weight: bold;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        .qty-btn:hover {
            background: rgba(255, 107, 53, 0.2);
            color: var(--primary);
        }
        .qty-btn:active {
            transform: scale(0.9);
        }

        /* Tabs */
        .tabs { 
            display: flex; 
            gap: 12px; 
            margin-bottom: 20px; 
            overflow-x: auto; 
            padding-bottom: 8px;
            padding: 4px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
        }
        .tab-btn { 
            flex: 1; 
            white-space: nowrap;
            transition: all 0.3s ease;
            border-radius: 8px;
        }
        .tab-btn.active { 
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            box-shadow: var(--shadow-glow);
            transform: translateY(-2px);
        }

        /* Order Cards */
        .order-card { 
            padding: 18px; 
            background: rgba(30, 33, 57, 0.5); 
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1); 
            margin-bottom: 14px; 
            border-radius: var(--radius);
            transition: all 0.3s ease;
            cursor: pointer;
            overflow: hidden; /* Prevent content overflow */
        }
        .order-card:hover {
            border-color: rgba(255, 107, 53, 0.3);
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
        }
        .order-card strong {
            display: block;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 0.95rem;
            margin-bottom: 6px;
        }
        .order-card .text-muted {
            font-size: 0.85rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .order-status { 
            font-size: 0.7rem; 
            padding: 4px 10px; 
            border-radius: 12px; 
            text-transform: uppercase; 
            font-weight: 700;
            letter-spacing: 0.5px;
            display: inline-block;
        }
        .status-requested { background: linear-gradient(135deg, var(--info), #2563EB); color: white; }
        .status-pending { background: linear-gradient(135deg, var(--warning), #D97706); color: white; }
        .status-completed { background: linear-gradient(135deg, var(--success), #059669); color: white; }
        .status-cancelled { background: linear-gradient(135deg, var(--danger), #DC2626); color: white; }

        /* Admin Dashboard Cards */
        .stat-card { 
            background: rgba(30, 33, 57, 0.6); 
            backdrop-filter: blur(20px);
            padding: 24px; 
            border-radius: var(--radius-lg); 
            text-align: center; 
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
        }
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: rgba(255, 107, 53, 0.3);
        }
        .stat-value { 
            font-size: 2.5rem; 
            font-weight: 800; 
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 12px 0;
            text-shadow: 0 2px 10px rgba(255, 107, 53, 0.3);
            word-break: break-word;
            overflow-wrap: break-word;
        }
        .stat-label { 
            font-size: 0.95rem; 
            color: var(--text-muted);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            word-break: break-word;
            overflow-wrap: break-word;
        }

        /* Install Button */
        #installBtn { position: fixed; bottom: 20px; right: 20px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.5); display: none; }

        /* Notification */
        #notification { 
            position: fixed; 
            top: 80px; 
            right: 20px; 
            background: rgba(30, 33, 57, 0.95); 
            backdrop-filter: blur(20px);
            padding: 16px 28px; 
            border-radius: var(--radius); 
            z-index: 1000; 
            transform: translateX(150%); 
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255,255,255,0.15);
            min-width: 250px;
        }
        #notification.show {
            transform: translateX(0);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            /* POS Layout Restructure for Mobile */
            .pos-container { 
                grid-template-columns: 1fr; 
                height: auto; 
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            .pos-left { 
                height: 75vh; 
                margin-bottom: 0;
                order: 1;
            }
            .cart-panel { 
                height: auto; 
                min-height: 350px;
                order: 2;
                padding: 16px;
            }

            /* Menu Area - Mobile Optimized */
            .menu-area { 
                padding: 12px;
                gap: 12px;
                flex-direction: column;
            }

            /* Categories - Horizontal Scroll on Mobile */
            .cat-sidebar {
                gap: 8px;
                flex-direction: row;
                overflow-x: auto;
                overflow-y: hidden;
                padding-bottom: 8px;
                padding-right: 0;
                order: 1;
            }
            .cat-btn {
                padding: 10px 20px;
                font-size: 0.9rem;
                font-weight: 700;
                min-width: fit-content;
            }

            /* Items Grid - Mobile 3x3 FULL SPACE */
            .item-grid { 
                grid-template-columns: repeat(3, 1fr);
                grid-template-rows: repeat(3, 1fr);
                gap: 8px;
                order: 2;
                padding-bottom: 10px;
                padding-right: 0;
                height: 100%;
            }

            /* Menu Item Cards - Mobile 3x3 Grid */
            .menu-item {
                min-height: 0;
                height: 100%;
                aspect-ratio: 1 / 1;
                padding: 0;
            }
            .item-name-clamp {
                font-size: 0.75rem;
                font-weight: 700;
                padding: 8px 6px 4px 6px;
                line-height: 1.2;
                -webkit-line-clamp: 3;
                flex: 1;
            }
            .item-price-tag {
                font-size: 0.8rem;
                font-weight: 800;
                padding: 4px 6px 8px 6px;
            }

            /* Cart Items - Mobile */
            .cart-items {
                margin: 12px 0;
            }
            .cart-item {
                padding: 10px 0;
                gap: 10px;
            }
            .cart-item > div:first-child {
                font-size: 0.875rem;
                font-weight: 500;
            }
            .qty-controls {
                gap: 8px;
                padding: 3px 5px;
            }
            .qty-btn {
                width: 26px;
                height: 26px;
                font-size: 0.9rem;
            }

            /* Header - Mobile */
            .header-content h2 { 
                font-size: 1.15rem;
                font-weight: 700;
            }

            /* Admin Dashboard - Mobile Optimized */
            .tabs {
                gap: 6px;
                padding: 6px;
                flex-wrap: nowrap;
                overflow-x: auto;
                margin-bottom: 15px;
            }
            .tab-btn {
                padding: 10px 14px;
                font-size: 0.8rem;
                white-space: nowrap;
                min-width: fit-content;
                flex-shrink: 0;
                font-weight: 600;
            }

            /* Cards - Mobile Padding */
            .card {
                padding: 16px;
                margin-bottom: 12px;
            }
            .card h2, .card h3 { 
                font-size: 1.25rem;
                font-weight: 700;
                word-break: break-word;
                margin-bottom: 12px;
            }
            .card h4 {
                font-size: 1.05rem;
                margin-bottom: 8px;
            }
            .card p {
                font-size: 0.9rem;
                line-height: 1.5;
                padding: 2px 0;
            }
            .card label {
                font-size: 0.85rem;
                margin-bottom: 6px;
                display: block;
            }

            /* Stat Cards - Mobile */
            .stat-card {
                padding: 18px 14px;
                min-height: 110px;
            }
            .stat-value {
                font-size: 1.8rem;
                margin: 8px 0;
            }
            .stat-label {
                font-size: 0.75rem;
                letter-spacing: 0.5px;
            }

            /* Order Cards - Mobile */
            .order-card {
                padding: 14px;
                margin-bottom: 12px;
            }
            .order-card strong {
                font-size: 0.925rem;
                margin-bottom: 6px;
            }
            .order-card .text-muted {
                font-size: 0.825rem;
            }
            .order-status {
                font-size: 0.65rem;
                padding: 5px 10px;
            }

            /* Grid Layouts - Mobile */
            .grid-2 { 
                grid-template-columns: 1fr;
                gap: 12px;
            }
            .grid-4 { 
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            /* Buttons - Mobile */
            .btn {
                padding: 12px 20px;
                font-size: 0.9rem;
            }
            .btn-sm {
                padding: 8px 14px;
                font-size: 0.8rem;
            }

            /* Input Fields - Mobile */
            .input {
                padding: 12px 14px;
                font-size: 0.95rem;
                margin-bottom: 10px;
            }

            /* App Layout - Mobile */
            .app-layout {
                padding: 0 12px;
                margin: 15px auto;
            }

            /* Login - Mobile */
            .login-box {
                padding: 0 10px;
            }
            .logo {
                width: 110px;
            }

            /* Modals - Mobile */
            .card[style*="max-width: 420px"],
            .card[style*="max-width: 400px"] {
                width: 95% !important;
                max-width: 95% !important;
                padding: 18px !important;
            }

            /* Notification Toast - Mobile */
            #notification {
                right: 10px;
                left: 10px;
                top: 70px;
                min-width: auto;
                padding: 14px 18px;
            }

            /* Customer Panel Mobile Specific */
            #cust-view-menu .pos-container {
                height: auto !important;
                min-height: 75vh;
            }

            /* Search Input - Mobile */
            input[placeholder*="Search"] {
                font-size: 1rem;
                padding: 14px 16px;
            }

            /* Better touch targets for mobile */
            .btn, .cat-btn, .menu-item, .qty-btn {
                -webkit-tap-highlight-color: rgba(255, 107, 53, 0.2);
            }

            /* Improved spacing for better readability */
            h1 { font-size: 1.75rem; margin-bottom: 12px; }
            h2 { font-size: 1.4rem; margin-bottom: 10px; }
            h3 { font-size: 1.15rem; margin-bottom: 8px; }
            h4 { font-size: 1rem; margin-bottom: 6px; }

            /* Better form element visibility */
            select.input {
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23fff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 12px center;
                padding-right: 36px;
            }
        }

        /* Small Mobile Phones (<400px) */
        @media (max-width: 400px) {
            .pos-left {
                height: 70vh;
            }
            .item-grid {
                grid-template-columns: repeat(3, 1fr);
                grid-template-rows: repeat(3, 1fr);
                gap: 6px;
            }
            .menu-item {
                min-height: 0;
                height: 100%;
            }
            .item-name-clamp {
                font-size: 0.7rem;
                padding: 6px 5px 3px 5px;
                line-height: 1.15;
                -webkit-line-clamp: 2;
            }
            .item-price-tag {
                font-size: 0.75rem;
                padding: 3px 5px 6px 5px;
            }
            .cat-btn {
                padding: 8px 16px;
                font-size: 0.85rem;
            }
            .tabs {
                gap: 4px;
            }
            .tab-btn {
                padding: 8px 10px;
                font-size: 0.75rem;
            }
            .stat-value {
                font-size: 1.5rem;
            }
            .grid-4 {
                grid-template-columns: 1fr;
            }
            h1 { font-size: 1.5rem; }
            h2 { font-size: 1.25rem; }
            h3 { font-size: 1.1rem; }
        }

        /* Medium Mobile (401px-600px) */
        @media (min-width: 401px) and (max-width: 600px) {
            .pos-left {
                height: 75vh;
            }
            .item-grid {
                grid-template-columns: repeat(3, 1fr);
                grid-template-rows: repeat(3, 1fr);
                gap: 8px;
            }
            .menu-item {
                min-height: 0;
                height: 100%;
            }
            .item-name-clamp {
                font-size: 0.75rem;
                padding: 8px 6px 4px 6px;
                line-height: 1.2;
                -webkit-line-clamp: 3;
            }
            .item-price-tag {
                font-size: 0.8rem;
                padding: 4px 6px 8px 6px;
            }
        }

        /* Large Mobile (601px-768px) */
        @media (min-width: 601px) and (max-width: 768px) {
            .pos-left {
                height: 75vh;
            }
            .item-grid {
                grid-template-columns: repeat(3, 1fr);
                grid-template-rows: repeat(3, 1fr);
                gap: 10px;
            }
            .menu-item {
                min-height: 0;
                height: 100%;
            }
            .item-name-clamp {
                font-size: 0.8rem;
                padding: 9px 7px 5px 7px;
                -webkit-line-clamp: 3;
                line-height: 1.25;
            }
            .item-price-tag {
                font-size: 0.85rem;
                padding: 5px 7px 9px 7px;
            }
        }

        /* Tablet Responsive */
        @media (min-width: 769px) and (max-width: 1024px) {
            .item-grid {
                grid-template-columns: repeat(3, 1fr);
                grid-template-rows: repeat(3, 1fr);
                gap: 14px;
            }
            .pos-container {
                grid-template-columns: 1fr 300px;
                gap: 15px;
            }
            .menu-area {
                padding: 14px;
            }
            .cat-btn {
                padding: 11px 20px;
                font-size: 0.9rem;
            }
            .menu-item {
                min-height: 135px;
                aspect-ratio: 1 / 1;
            }
            .item-name-clamp {
                font-size: 1rem;
                padding: 13px 12px 7px 12px;
                line-height: 1.4;
                -webkit-line-clamp: 3;
            }
            .item-price-tag {
                font-size: 1.1rem;
                padding: 7px 12px 13px 12px;
            }
            .cart-panel {
                padding: 18px;
            }
            .card {
                padding: 18px;
            }
            .stat-card {
                padding: 20px 16px;
            }
            .tab-btn {
                padding: 10px 16px;
                font-size: 0.875rem;
            }
        }

        /* Large Desktop */
        @media (min-width: 1400px) {
            .item-grid {
                grid-template-columns: repeat(4, 1fr);
                grid-template-rows: repeat(3, 1fr);
            }
            .menu-item {
                min-height: 145px;
            }
            .item-name-clamp {
                font-size: 1.1rem;
            }
            .item-price-tag {
                font-size: 1.2rem;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
        }

        /* Loading Animation */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        .loading-shimmer {
            animation: shimmer 2s infinite linear;
            background: linear-gradient(90deg, transparent 0%, rgba(255,107,53,0.1) 50%, transparent 100%);
            background-size: 1000px 100%;
        }

        /* Fade In Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        /* Text Overflow Prevention Utilities */
        .text-ellipsis {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .text-wrap {
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        
        /* Ensure all text in cards doesn't overflow */
        .card p, .card div {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* Universal Card Content Spacing */
        .card > * {
            margin-bottom: 8px;
        }
        .card > *:last-child {
            margin-bottom: 0;
        }

        /* Better Text Contrast for All Elements */
        .menu-item, .cart-item, .order-card, .card {
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Ensure proper spacing in all containers */
        .card input,
        .card select,
        .card textarea,
        .card button {
            margin-top: 4px;
        }
/* KOT PRINT STYLES (2-inch / 58mm) */
@media print {
    /* Hide everything by default */
    body * { visibility: hidden; height: 0; overflow: hidden; }
    
    /* Show only the KOT Receipt */
    #kot-receipt, #kot-receipt * { 
        visibility: visible; 
        height: auto; 
        overflow: visible; 
    }

    #kot-receipt {
        position: absolute;
        left: 0;
        top: 0;
        width: 58mm; /* 2-inch width */
        padding: 0;
        margin: 0;
        background: white;
        color: black;
        font-family: 'Courier New', monospace; /* Monospace looks best on thermal */
    }

    /* Remove browser headers/footers */
    @page { margin: 0; size: auto; }
}

/* KOT Layout Styling (Screen View - Hidden) */
#kot-receipt { display: none; }
@media print { #kot-receipt { display: block; } }

.kot-header { text-align: center; border-bottom: 2px dashed black; padding-bottom: 5px; margin-bottom: 5px; }
.kot-title { font-weight: bold; font-size: 1.2rem; text-transform: uppercase; }
.kot-meta { font-size: 0.8rem; margin-top: 2px; }
.kot-items { border-bottom: 2px dashed black; padding-bottom: 5px; margin-bottom: 5px; font-size: 0.9rem; font-weight: bold; }
.kot-item-row { display: flex; gap: 5px; margin-bottom: 2px; }
.kot-footer { text-align: center; font-size: 0.8rem; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="notification"></div>
    <button id="pwaInstallBtn" class="btn btn-primary hidden" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);">
    üì≤ Install App
</button>

    <div id="loginScreen" class="login-container">
        <div class="login-box card">
            <img src="logo.png" alt="Juice Therapy" class="logo" onerror="this.style.display='none'">
            <h2 style="margin-bottom: 20px;">Juice Therapy POS</h2>
            
            <div class="flex gap-2" style="margin-bottom: 20px; justify-content: center;">
                <button class="btn btn-secondary" onclick="setLoginMode('customer')" id="btnRoleCust">Customer</button>
                <button class="btn btn-secondary" onclick="setLoginMode('staff')" id="btnRoleStaff">Staff/Admin</button>
            </div>
            <div id="customerLogin" class="hidden">
                <input type="tel" id="custPhoneLogin" class="input" placeholder="Enter Phone Number" maxlength="10">
                <button class="btn btn-primary w-full" onclick="loginCustomer()">Enter</button>
            </div>
            <div id="staffLogin" class="hidden">
                <input type="email" id="staffEmail" class="input" placeholder="Email">
                <input type="password" id="staffPass" class="input" placeholder="Password">
                <button class="btn btn-primary w-full" onclick="loginStaff()">Login</button>
            </div>
        </div>
    </div>

    <div id="adminPanel" class="hidden">
        <header>
            <div class="header-content">
                <div class="flex items-center gap-2">
                    <img src="logo.png" style="height:30px;"> 
                    <h2>Admin Dashboard</h2>
                </div>
                <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
            </div>
        </header>
        <div class="app-layout">
            <div class="tabs">
                <button class="btn btn-secondary tab-btn active" onclick="switchAdminTab('dashboard')" id="btn-adm-dash">üìä Analytics</button>
                <button class="btn btn-secondary tab-btn" onclick="switchAdminTab('menu')" id="btn-adm-menu">üçî Menu</button>
                <button class="btn btn-secondary tab-btn" onclick="switchAdminTab('orders')" id="btn-adm-orders">üìú Orders</button>
                <button class="btn btn-secondary tab-btn" onclick="switchAdminTab('settings')" id="btn-adm-settings">‚öôÔ∏è Settings</button>
<button class="btn btn-secondary tab-btn" onclick="switchAdminTab('notify')" id="btn-adm-notify">üì¢ Notify</button>
            </div>

<div id="adm-view-notify" class="hidden">
    <div class="card">
        <h3>üì¢ Broadcast Notification</h3>
        <p class="text-muted" style="margin-bottom: 15px;">Send offers to all customers. Saved for 7 days.</p>
        
        <label class="text-muted">Title</label>
        <input type="text" id="notifTitle" class="input" placeholder="e.g. 50% OFF Weekend!">
        
        <label class="text-muted">Message Body</label>
        <textarea id="notifBody" class="input" rows="3" placeholder="Description..."></textarea>
        
        <label class="text-muted">Image URL (Optional)</label>
        <input type="text" id="notifImage" class="input" placeholder="https://...">
        
        <button class="btn btn-primary w-full" onclick="sendBroadcastNotification()">üöÄ Send to All Devices</button>
    </div>
    
    <div style="margin-top: 20px;">
        <h4>Recent Broadcasts</h4>
        <div id="adminNotifHistory"></div>
    </div>
</div>
            <div id="adm-view-dashboard">
    <div class="card">
        <h3>Sales Analytics</h3>
        <div class="flex gap-2" style="margin: 15px 0 5px 0;">
    <button id="btnToday" class="btn btn-sm btn-secondary" onclick="setDashboardRange('today')">Today</button>
    <button id="btnYesterday" class="btn btn-sm btn-secondary" onclick="setDashboardRange('yesterday')">Yesterday</button>
    <button id="btnLast7" class="btn btn-sm btn-secondary" onclick="setDashboardRange('last7')">Last 7 Days</button>
</div>
        <div class="flex gap-2" style="margin: 15px 0; align-items: flex-end;">
            <div>
                <label class="text-muted" style="font-size:0.8rem;">From</label>
                <input type="date" id="dashStart" class="input" style="margin:0;">
            </div>
            <div>
                <label class="text-muted" style="font-size:0.8rem;">To</label>
                <input type="date" id="dashEnd" class="input" style="margin:0;">
            </div>
            <button class="btn btn-primary" onclick="resetDateButtons(); loadAnalytics();">Go</button>
        </div>

        <div class="grid-4" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:10px;">
            <div class="stat-card">
    <div class="stat-label">Total Sales</div>
    <div class="stat-value" id="statTotalSales">‚Çπ0</div>
</div>


            <div class="stat-card">
                <div class="stat-label">Total Orders</div>
                <div class="stat-value" id="statTotalOrders">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg Order Value</div>
                <div class="stat-value" id="statAvgValue">‚Çπ0</div>
            </div>
            <div class="stat-card" style="border-color: var(--warning);">
                <div class="stat-label">Bonus Redeemed</div>
                <div class="stat-value" id="statBonus">‚Çπ0</div>
            </div>
            <div class="stat-card" style="border-color: var(--success);">
                <div class="stat-label">Cash Collected</div>
                <div class="stat-value" id="statCash">‚Çπ0</div>
            </div>
            <div class="stat-card" style="border-color: var(--info);">
                <div class="stat-label">Online Collected</div>
                <div class="stat-value" id="statOnline">‚Çπ0</div>
            </div>
<div class="stat-card" style="border-color: #9C27B0;">
    <div class="stat-label">Active Users (7 Days)</div>
    <div class="stat-value" id="statActiveUsers">0</div>
</div>
        </div>

        <div style="margin-top: 20px;">
            <h4 style="margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom:5px;">Top Selling Items (Selected Date Range)</h4>
            <div id="topItemsList" style="max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px;">
                <p class="text-muted">Loading data...</p>
            </div>
        </div>
    </div>

    <div class="card" style="margin-top: 20px;">
        <h3>Last 30 Days Trend</h3>
        <div style="position: relative; height: 300px; width: 100%;">
            <canvas id="salesChart"></canvas>
        </div>
    </div>

    <div class="card" style="margin-top: 20px;">
        <h3>Detailed Item Analytics</h3>
        <p class="text-muted" style="font-size: 0.8rem; margin-bottom: 10px;">Based on the date range selected above.</p>
        
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; text-align: left; font-size: 0.9rem;">
                <thead>
                    <tr style="border-bottom: 2px solid rgba(255,255,255,0.1);">
                        <th style="padding: 10px;">Item Name</th>
                        <th style="padding: 10px; text-align: center;">Qty Sold</th>
                        <th style="padding: 10px; text-align: right;">Revenue Generated</th>
                    </tr>
                </thead>
                <tbody id="itemAnalyticsTable">
                    <tr><td colspan="3" class="text-center text-muted" style="padding:20px;">Click 'Go' to load data</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

            <div id="adm-view-menu" class="hidden">
                <div class="flex justify-between items-center" style="margin-bottom: 15px;">
                    <h3>Manage Categories & Items</h3>
                    <div class="flex gap-2">
                        <button class="btn btn-secondary" onclick="showCategoryModal()">+ Category</button>
                        <button class="btn btn-primary" onclick="showAddItemModal()">+ Add Item</button>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>Categories</h4>
                    <div id="adminCategoryList" class="flex gap-2" style="flex-wrap: wrap; margin-top: 10px;"></div>
                </div>

                <h4>Menu Items</h4>
                <div id="adminMenuGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 10px;"></div>
            </div>

            <div id="adm-view-orders" class="hidden">
    <h3>Order History</h3>
    
    <div class="card" style="margin: 15px 0; padding: 15px;">
        <div class="grid-2" style="margin-bottom: 10px;">
            <div>
                <label class="text-muted" style="font-size: 0.8rem;">Start Date</label>
                <input type="date" id="historyStart" class="input">
            </div>
            <div>
                <label class="text-muted" style="font-size: 0.8rem;">End Date</label>
                <input type="date" id="historyEnd" class="input">
            </div>
        </div>
        <button class="btn btn-primary w-full" onclick="searchHistory()">üîç Search History</button>
    </div>

    <h4 style="margin-bottom: 10px;">Results</h4>
    <div id="adminOrdersList">
        <p class="text-muted text-center" style="padding:20px;">Select dates and click Search to view past orders.</p>
    </div>
</div>

            <div id="adm-view-settings" class="hidden">
                <div class="card">
                    <h3>Store Profile & Status</h3>
<div style="display:flex; flex-direction:column; gap:10px; margin-top:15px;">
    <label class="text-muted">Outlet Name</label>
    <input type="text" id="storeName" class="input" placeholder="e.g. Juice Therapy">

    <label class="text-muted">Store Phone Number (without +91)</label>
    <input type="tel" id="storePhone" class="input" placeholder="e.g. 9007952259">
    <label class="text-muted">Store UPI ID (for receiving payments)</label>
    <input type="text" id="storeUpi" class="input" placeholder="e.g. 9876543210@upl or merchant@okicici">
    
    <label class="text-muted">Address</label>
    <textarea id="storeAddress" class="input" placeholder="Full Address" rows="3"></textarea>
    
    <label class="text-muted">Opening Hours</label>
    <div class="flex gap-2">
        <input type="time" id="storeOpenTime" class="input">
        <span style="align-self:center;">to</span>
        <input type="time" id="storeCloseTime" class="input">
    </div>

    <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center;">
        <span>Outlet Status:</span>
        <label class="flex items-center gap-2" style="cursor:pointer;">
            <input type="checkbox" id="storeIsOpen" style="transform:scale(1.5);">
            <span id="storeStatusLabel" style="font-weight:bold; color:var(--success);">OPEN</span>
        </label>
    </div>
    
    <label class="text-muted">Bill Footer Note</label>
    <input type="text" id="storeFooter" class="input" placeholder="e.g. Thank you!">
    
    <label class="text-muted">Website / Promo Link</label>
    <input type="text" id="storeLink" class="input" placeholder="e.g. www.juicetherapy.com">
    
    <button class="btn btn-primary w-full" onclick="saveStoreSettings()">üíæ Save Settings</button>
</div>
                </div>
            </div>
        </div>
    </div>

    <div id="outletPanel" class="hidden">
        <header>
            <div class="header-content">
    <div class="flex items-center gap-2">
        <img src="logo.png" style="height:30px;"> 
        <h2>Outlet POS</h2>
    </div>
    
    <div class="flex gap-2">
        <button id="btnConnectPrinter" class="btn btn-warning btn-sm" onclick="connectPrinter()">üñ®Ô∏è Connect</button>
        <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
    </div>
</div>
        </header>
        <div class="app-layout">
            <div class="tabs">
    <button class="btn btn-secondary tab-btn active" onclick="switchOutletTab('pos')" id="tab-pos" title="New Order">üõí</button>
    
    <button class="btn btn-secondary tab-btn" onclick="switchOutletTab('incoming')" id="tab-incoming" title="Incoming" style="position: relative;">
        üîî 
        <span id="badgeIncoming" class="hidden" style="background:red; border-radius:50%; width:10px; height:10px; display:inline-block; position:absolute; top:5px; right:5px; border:1px solid white;"></span>
    </button>
    
    <button class="btn btn-secondary tab-btn" onclick="switchOutletTab('current')" id="tab-current" title="Current">‚è≥</button>
    <button class="btn btn-secondary tab-btn" onclick="switchOutletTab('completed')" id="tab-completed" title="Completed">‚úÖ</button>
</div>

            <div id="view-pos" class="pos-container">
                <div class="pos-left">
                    <input type="text" class="input" placeholder="üîç Search items..." onkeyup="filterMenu(this.value)">
                    <div class="menu-area">
                        <div class="cat-sidebar" id="posSidebar"></div>
                        <div class="item-grid" id="posGrid"></div>
                    </div>
                </div>
                <div class="cart-panel">
                    <div class="flex justify-between items-center">
                        <h3>Cart</h3>
                        <span class="btn-danger" style="padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;" onclick="clearCart()">Clear</span>
                    </div>
                    <div style="margin-top: 10px;">
                        <input type="tel" id="posPhone" class="input" placeholder="Customer Phone (Auto-create)" maxlength="10">
                    </div>
                    <div class="cart-items" id="cartItemsList"></div>
                    <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
                        <div class="flex justify-between font-bold" style="font-size: 1.2rem; margin-bottom: 10px;">
                            <span>Total</span>
                            <span id="cartTotal">‚Çπ0</span>
                        </div>
                        <button id="btnPlaceOrder" class="btn btn-primary w-full" onclick="placeOrder()">Place Order</button>
                        <button id="btnUpdateOrder" class="btn btn-warning w-full hidden" onclick="updateExistingOrder()">Update Order</button>
                    </div>
                </div>
            </div>

            <div id="view-incoming" class="hidden">
                <div id="incomingOrdersList"></div>
            </div>

            <div id="view-current" class="hidden">
                <div id="currentOrdersList"></div>
            </div>

            <div id="view-completed" class="hidden">
                <div id="completedOrdersList"></div>
            </div>
        </div>
    </div>

    <div id="customerPanel" class="hidden">
        <header>
            <div class="header-content">
    <div class="flex items-center gap-2">
        <img src="logo.png" style="height:30px;"> 
        <h2>My Juice Therapy</h2>
    </div>
    <div class="flex gap-2 items-center">
        <button class="btn btn-secondary btn-sm" style="position:relative;" onclick="openNotifications()">
            üîî
            <span id="custNotifBadge" class="hidden" style="position:absolute; top:-5px; right:-5px; background:red; color:white; font-size:0.7rem; padding:2px 6px; border-radius:10px;">New</span>
        </button>
        <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
    </div>
</div>
        </header>
        <div class="app-layout">
<div id="custOutletInfo" class="card" style="border-left: 5px solid var(--success); margin-bottom: 20px;">
    <div class="flex justify-between items-start">
        <div>
            <h2 id="infoStoreName" style="color:var(--primary); margin-bottom:5px;">Juice Therapy</h2>
            <p id="infoAddress" class="text-muted" style="font-size:0.9rem; margin-bottom:5px;"></p>
            <div class="flex gap-2" style="font-size:0.85rem; color:#aaa;">
                <span>üïí <span id="infoTiming">--:-- to --:--</span></span>
                <span>‚Ä¢</span>
                <span id="infoStatus" style="font-weight:bold; color:var(--success);">OPEN</span>
            </div>
        </div>
    </div>

    <div class="grid-4" style="grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-top:15px;">
        <button class="btn btn-secondary btn-sm" onclick="contactStore('call')">üìû Call</button>
        <button class="btn btn-secondary btn-sm" style="background:#25D366; color:white;" onclick="contactStore('whatsapp')">üí¨ WhatsApp</button>
        <button class="btn btn-secondary btn-sm" onclick="contactStore('save')">üíæ Save No.</button>
    </div>
</div>
            <div class="card text-center" style="background: linear-gradient(135deg, var(--primary), #FF9F43);">
                <h3>Welcome, <span id="custNameDisplay">Guest</span></h3>
                <h1 style="font-size: 3rem; margin: 10px 0;" id="custPoints">0</h1>
                <p>Bonus Points Available</p>
            </div>
            <div class="tabs">
                <button class="btn btn-secondary tab-btn active" onclick="switchCustTab('menu')" id="btn-cust-menu">üçî Order Now</button>
                <button class="btn btn-secondary tab-btn" onclick="switchCustTab('history')" id="btn-cust-history">üìú My History</button>
            </div>
            <div id="cust-view-menu">
<input type="text" class="input" placeholder="üîç Search items..." 
           style="margin-bottom: 10px;" 
           onkeyup="filterCustomerMenu(this.value)">                
<div class="pos-container" style="height: 60vh;">
                    <div class="pos-left">
                         <div class="menu-area">
                            <div class="cat-sidebar" id="custSidebar"></div>
                            <div class="item-grid" id="custGrid"></div>
                         </div>
                    </div>
                    <div class="cart-panel">
                        <h3>My Cart</h3>
                        <div class="cart-items" id="custCartItems"></div>
                        <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
                            <div class="flex justify-between font-bold" style="font-size: 1.2rem; margin-bottom: 10px;">
                                <span>Total</span>
                                <span id="custCartTotal">‚Çπ0</span>
                            </div>
                            <button class="btn btn-primary w-full" onclick="placeCustomerOrder()">Request Order</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="cust-view-history" class="hidden">
                <div id="custHistoryList"></div>
            </div>
        </div>
    </div>

    <div id="paymentModal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 400; display: flex; align-items: center; justify-content: center;">
        <div class="card" style="width: 90%; max-width: 400px;">
            
            <div id="paymentInputSection">
                <h3 style="margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">Final Billing</h3>
                
                <div class="flex justify-between" style="margin-bottom: 10px;">
                    <span class="text-muted">Customer:</span>
                    <span id="payCustPhone" class="font-bold">...</span>
                </div>
                
                <div class="flex justify-between" style="margin-bottom: 10px;">
                    <span class="text-muted">Bill Total:</span>
                    <span id="payBillTotal" class="font-bold" style="font-size: 1.2rem;">‚Çπ0</span>
                </div>

                <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                    <div class="flex justify-between items-center">
                        <span>Available Bonus:</span>
                        <span id="payAvailPoints" style="color: var(--primary); font-weight: bold;">0 pts</span>
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                        <input type="number" id="redeemInput" class="input" placeholder="0" style="margin:0; text-align: right;" oninput="updatePaymentCalc()">
                        <button class="btn btn-sm btn-secondary" onclick="useMaxPoints()">Max</button>
                    </div>
                    <div class="text-muted" style="font-size: 0.8rem; margin-top: 5px;">1 Point = ‚Çπ1 | New bonus will add to balance.</div>
                </div>

                <div style="margin-bottom: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <label class="text-muted" style="font-size: 0.9rem; display: block; margin-bottom: 8px;">Payment Mode</label>
                    <div class="flex gap-2">
                        <button id="btnModeCash" class="btn btn-sm btn-primary w-full" onclick="setPaymentMode('Cash')">üíµ Cash</button>
                        <button id="btnModeOnline" class="btn btn-sm btn-secondary w-full" onclick="setPaymentMode('Online')">üì± Online / UPI</button>
                    </div>
                    <input type="hidden" id="paymentModeInput" value="Cash">
                </div>

                <div class="flex justify-between" style="margin-bottom: 20px; font-size: 1.3rem; font-weight: bold; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                    <span>Net Payable:</span>
                    <span id="payNetTotal" style="color: var(--success);">‚Çπ0</span>
                </div>

                <div id="cashCalcSection" style="margin-bottom: 20px; padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
                    <div class="flex justify-between items-center" style="margin-bottom: 8px;">
                        <span class="text-muted">üíµ Customer Gave:</span>
                        <input type="number" id="cashGiven" class="input" placeholder="‚Çπ" style="width: 120px; margin:0; text-align: right; font-size: 1.1rem; font-weight: bold;" oninput="calculateChange()">
                    </div>
                    <div class="flex justify-between items-center" style="font-size: 1.1rem; font-weight: bold; border-top: 1px dashed rgba(255,255,255,0.2); padding-top: 8px;">
                        <span>üîÑ Return Change:</span>
                        <span id="cashReturn" style="color: var(--warning);">‚Çπ0</span>
                    </div>
                </div>

                <div class="flex gap-2">
                    <button class="btn btn-secondary w-full" onclick="closePaymentModal()">Cancel</button>
                    <button class="btn btn-success w-full" onclick="processPayment()">Confirm & Pay</button>
                </div>
            </div>

            <div id="paymentSuccessSection" class="hidden text-center" style="padding: 10px;">
                <div style="font-size: 4rem; margin-bottom: 10px;">‚úÖ</div>
                <h3 style="margin-bottom: 5px;">Payment Successful!</h3>
                <p class="text-muted" style="margin-bottom: 20px;">Order #<span id="billSerial"></span> completed.</p>
                
                <div style="display:flex; flex-direction:column; gap:10px;">
                    <button class="btn btn-secondary w-full" style="background:#444; color:white; border:1px solid #666;" onclick="printBillDirect(PAYMENT_DATA.orderId)">
        üñ®Ô∏è Print Receipt
    </button>
                    <button class="btn btn-success w-full" style="background:#25D366; border:none;" onclick="sendBill('whatsapp')">
                        üì± Send via WhatsApp
                    </button>
                    <button class="btn btn-primary w-full" onclick="sendBill('sms')">
                        üí¨ Send via SMS
                    </button>
                    <button class="btn btn-secondary w-full" onclick="closePaymentModal()">
                        ‚ùå Close
                    </button>
                </div>
            </div>

        </div>
    </div>

    <div id="addItemModal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200; display: flex; align-items: center; justify-content: center;">
        <div class="card" style="width: 90%; max-width: 400px;">
            <h3>Add/Edit Item</h3>
            <input type="text" id="newItemName" class="input" placeholder="Item Name">
            <input type="number" id="newItemPrice" class="input" placeholder="Price">
            <select id="newItemCat" class="input"><option value="">Select Category</option></select>
            <div class="flex gap-2" style="margin-top: 10px;">
                <button class="btn btn-secondary w-full" onclick="document.getElementById('addItemModal').classList.add('hidden')">Cancel</button>
                <button class="btn btn-primary w-full" onclick="saveMenuItem()">Save</button>
            </div>
        </div>
    </div>

    <div id="addCategoryModal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 210; display: flex; align-items: center; justify-content: center;">
        <div class="card" style="width: 90%; max-width: 350px;">
            <h3>New Category</h3>
            <input type="text" id="newCatName" class="input" placeholder="Category Name">
            <div class="flex gap-2" style="margin-top: 10px;">
                <button class="btn btn-secondary w-full" onclick="document.getElementById('addCategoryModal').classList.add('hidden')">Cancel</button>
                <button class="btn btn-primary w-full" onclick="saveCategory()">Save</button>
            </div>
        </div>
    </div>

    <div id="customerNameModal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 300; display: flex; align-items: center; justify-content: center;">
        <div class="card" style="width: 90%; max-width: 400px; text-align: center;">
            <h3 style="margin-bottom: 10px;">Welcome!</h3>
            <p style="margin-bottom: 20px; color: var(--text-muted);">Please enter your name to continue.</p>
            <input type="text" id="newCustName" class="input" placeholder="Your Name">
            <button class="btn btn-primary w-full" onclick="saveCustomerName()">Start Ordering</button>
        </div>
    </div>

    <script>
        const STATE = {
            user: null,
            role: null, 
            menu: [],
            categories: [],
            cart: [],
            custCart: [], 
            orders: [],
            editingOrderId: null,
            activeCategory: 'All',
	    adminActiveCategory: 'All',
            tempPhone: null,
	    searchQuery: '',
            storeSettings: { name: 'Juice Therapy', address: '', footer: 'Thank you!', link: '' }
        };
let TEMP_EDIT_ITEMS = [];
let SALES_CHART_INSTANCE = null;
        window.onload = () => {
           
            const checkFirebase = setInterval(() => {
                if (window.firebaseReady) {
                    clearInterval(checkFirebase);
                    initApp();
                }
            }, 100);
            
            const d = new Date();
            document.getElementById('dashEnd').valueAsDate = d;
            d.setMonth(d.getMonth() - 1);
            document.getElementById('dashStart').valueAsDate = d;
        };

        function initApp() {
        // LISTEN FOR FOREGROUND MESSAGES (While app is open)
const { onMessage, messaging } = window.firebaseModules;
onMessage(messaging, (payload) => {
    console.log('Message received. ', payload);
    const { title, body, image } = payload.notification;
    
    // Use your existing Toast or create a custom popup
    showToast(`üîî ${title}: ${body}`);
});
    window.firebaseModules.onAuthStateChanged(window.auth, (user) => {
        if (user) {
            // CASE A: Staff/Admin is logged in via Firebase Auth
            checkUserRole(user); 
        } else {
            // CASE B: No Staff logged in. Check for Customer Session.
            const savedPhone = localStorage.getItem('jt_cust_phone');
            
            if (savedPhone) {
                restoreCustomerSession(savedPhone);
            } else {
                // CASE C: No one is logged in
                document.getElementById('loginScreen').classList.remove('hidden');
            }
        }
    });
}

        async function checkUserRole(user) {
            // Load Store Settings for everyone (needed for bills)
            loadStoreSettings();

            if (user.email === 'admin@jt.com' || user.email === 'titir95biplab@gmail.com') {
                STATE.role = 'admin';
                showPanel('adminPanel');
                loadCategories();
                loadMenu();
                loadAnalytics();
                return;
            } 
            
            const { doc, getDoc } = window.firebaseModules;
            try {
                const userDoc = await getDoc(doc(window.db, 'staff', user.uid)); 
                if (userDoc.exists() && userDoc.data().role === 'admin') {
                    STATE.role = 'admin';
                    showPanel('adminPanel');
                    loadCategories();
                    loadMenu();
                    loadAnalytics();
                } else {
                    STATE.role = 'staff';
                    showPanel('outletPanel');
                    loadCategories();
                    loadMenu();
                    loadOrders(); 
                }
            } catch (e) {
                STATE.role = 'staff';
                showPanel('outletPanel');
                loadCategories();
                loadMenu();
                loadOrders(); 
            }
        }

        function showPanel(panelId) {
            ['loginScreen', 'adminPanel', 'outletPanel', 'customerPanel'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(panelId).classList.remove('hidden');
        }

        function setLoginMode(mode) {
            document.getElementById('customerLogin').classList.add('hidden');
            document.getElementById('staffLogin').classList.add('hidden');
            document.getElementById('btnRoleCust').classList.remove('btn-primary');
            document.getElementById('btnRoleStaff').classList.remove('btn-primary');
            if(mode === 'customer') {
                document.getElementById('customerLogin').classList.remove('hidden');
                document.getElementById('btnRoleCust').classList.add('btn-primary');
            } else {
                document.getElementById('staffLogin').classList.remove('hidden');
                document.getElementById('btnRoleStaff').classList.add('btn-primary');
            }
        }

        async function loginStaff() {
            const email = document.getElementById('staffEmail').value;
            const pass = document.getElementById('staffPass').value;
            try { await window.firebaseModules.signInWithEmailAndPassword(window.auth, email, pass); } 
            catch (e) { showToast(e.message, 'error'); }
        }

        async function loginCustomer() {
    let rawPhone = document.getElementById('custPhoneLogin').value;
    
    // 1. Sanitize: Remove spaces, dashes, +91, etc.
    // This turns "+91 900-795-2259" into "9007952259"
    const phone = rawPhone.replace(/\D/g, '').slice(-10); 

    // 2. Check length AFTER cleaning
    if (phone.length !== 10) {
        return showToast('Please enter valid 10-digit number', 'error');
    }
    
    const { doc, getDoc } = window.firebaseModules;
            
            try {
                // Show loading feedback (Optional but good)
                showToast('Checking ID...', 'info');

                const snap = await getDoc(doc(window.db, 'customers', phone));
                
                if (!snap.exists() || !snap.data().name) {
                    STATE.tempPhone = phone;
                    document.getElementById('customerNameModal').classList.remove('hidden');
                    return;
                }
                
                finalizeCustomerLogin(phone, snap.data());

            } catch (e) {
                console.error("Login Error:", e);
                // This will tell us if it's a Permission issue!
                showToast('Login Failed: ' + e.message, 'error'); 
            }
        }

async function restoreCustomerSession(phone) {
    const { doc, getDoc } = window.firebaseModules;
    try {
        const snap = await getDoc(doc(window.db, 'customers', phone));
        if (snap.exists()) {
            // User exists, log them back in with fresh data
            finalizeCustomerLogin(phone, snap.data());
        } else {
            // User might have been deleted, clear invalid session
            localStorage.removeItem('jt_cust_phone');
            document.getElementById('loginScreen').classList.remove('hidden');
        }
    } catch (e) {
        console.error("Session Restore Error:", e);
        document.getElementById('loginScreen').classList.remove('hidden');
    }
}

        async function saveCustomerName() {
            const name = document.getElementById('newCustName').value;
            if(!name) return showToast('Name is required', 'error');
            const { doc, setDoc, serverTimestamp } = window.firebaseModules;
            await setDoc(doc(window.db, 'customers', STATE.tempPhone), {
                phone: STATE.tempPhone, name: name, points: 0, joined: serverTimestamp()
            }, { merge: true });
            document.getElementById('customerNameModal').classList.add('hidden');
            finalizeCustomerLogin(STATE.tempPhone, { name, points: 0 });
        }

        function finalizeCustomerLogin(phone, data) {
            localStorage.setItem('jt_cust_phone', phone);
            STATE.user = { uid: phone, phone: phone, name: data.name };
            STATE.role = 'customer';
            document.getElementById('custNameDisplay').innerText = data.name;
            document.getElementById('custPoints').innerText = data.points || 0;
            trackUserActivity(phone);
            loadCategories();
            loadMenu();
            loadCustomerHistory(phone);
            loadStoreSettings();
            loadCustomerNotifications();
    
    // ASK FOR PERMISSION NOW üëá
    requestNotificationPermission();

    showPanel('customerPanel');
        }

        function logout() {
    // 1. CLEAR CUSTOMER SESSION
    localStorage.removeItem('jt_cust_phone');
    
    // 2. SIGN OUT STAFF (Firebase)
    window.auth.signOut();
    
    // 3. RELOAD
    location.reload();
}

        // --- ADMIN SETTINGS & TABS ---
        function switchAdminTab(tab) {
            ['dashboard', 'menu', 'orders', 'settings', 'notify'].forEach(t => {
                const btn = document.getElementById(`btn-adm-${t}`);
                const view = document.getElementById(`adm-view-${t}`);
                if(btn) btn.classList.remove('active');
                if(view) view.classList.add('hidden');
            });

            const activeBtn = document.getElementById(`btn-adm-${tab}`);
    const activeView = document.getElementById(`adm-view-${tab}`);
    
    if(activeBtn) activeBtn.classList.add('active');
    if(activeView) activeView.classList.remove('hidden');

    // --- UPDATED LOGIC HERE ---
    if(tab === 'orders') {
        const d = new Date();
        document.getElementById('historyEnd').valueAsDate = d;
        document.getElementById('historyStart').valueAsDate = d; 
        
        // AUTO-LOAD: Trigger search immediately for Today
        searchHistory(); 
    }

    if(tab === 'dashboard') {
        // AUTO-LOAD: Set dashboard to "Today" by default
        setDashboardRange('today');
        loadActiveUsersReport();
    }
    
    if(tab === 'menu') updateCategorySelects();
    if(tab === 'notify') loadAdminNotificationHistory();
}

async function sendBroadcastNotification() {
    const title = document.getElementById('notifTitle').value;
    const body = document.getElementById('notifBody').value;
    const image = document.getElementById('notifImage').value;

    if(!title || !body) return showToast('Title and Body required', 'error');
    if(!confirm('Send this notification to ALL users?')) return;

    // 1. Calculate Expiration (7 Days from now)
    const expiresDate = new Date();
    expiresDate.setDate(expiresDate.getDate() + 7);

    const { addDoc, collection, serverTimestamp, Timestamp } = window.firebaseModules;

    try {
        // 2. Add to Firestore
        await addDoc(collection(window.db, 'notifications'), {
            title: title,
            message: body, // Keeping 'message' key to match your customer view
            image: image || null,
            target: 'ALL',
            timestamp: serverTimestamp(),
            expiresAt: Timestamp.fromDate(expiresDate) // TTL Field
        });

        showToast('Notification Sent & Saved!');
        
        // Clear inputs
        document.getElementById('notifTitle').value = '';
        document.getElementById('notifBody').value = '';
        document.getElementById('notifImage').value = '';

    } catch (e) {
        console.error(e);
        showToast('Error sending: ' + e.message, 'error');
    }
}

        function loadStoreSettings() {
    const { doc, onSnapshot } = window.firebaseModules;
    onSnapshot(doc(window.db, 'settings', 'store'), (snap) => {
        if (snap.exists()) {
            STATE.storeSettings = snap.data();
            const s = STATE.storeSettings;

            // 1. Update Admin Inputs (Only if element exists)
            if(document.getElementById('storeName')) {
                document.getElementById('storeName').value = s.name || '';
                document.getElementById('storePhone').value = s.phone || '9007952259';
document.getElementById('storeUpi').value = s.upi || '';
                document.getElementById('storeAddress').value = s.address || '';
                document.getElementById('storeOpenTime').value = s.openTime || '';
                document.getElementById('storeCloseTime').value = s.closeTime || '';
                document.getElementById('storeFooter').value = s.footer || '';
                document.getElementById('storeLink').value = s.link || '';
                
                // Toggle Switch Logic
                const check = document.getElementById('storeIsOpen');
                const label = document.getElementById('storeStatusLabel');
                check.checked = s.isOpen !== false; // Default to true if undefined
                
                // Add event listener to change label dynamically when clicked
                check.onchange = () => {
                    label.innerText = check.checked ? "OPEN" : "CLOSED";
                    label.style.color = check.checked ? "var(--success)" : "var(--danger)";
                };
                // Trigger once to set initial state text
                check.onchange(); 
            }

            // 2. Update Customer Info Card
            if(document.getElementById('infoStoreName')) {
                document.getElementById('infoStoreName').innerText = s.name || 'Juice Therapy';
                document.getElementById('infoAddress').innerText = s.address || '';
                
                // Timing Format
                const t1 = formatTime(s.openTime);
                const t2 = formatTime(s.closeTime);
                document.getElementById('infoTiming').innerText = (t1 && t2) ? `${t1} - ${t2}` : 'Timings not set';

                // Status Indicator
                const statusEl = document.getElementById('infoStatus');
                const cardEl = document.getElementById('custOutletInfo');
                
                if (s.isOpen === false) {
                    statusEl.innerText = "CLOSED";
                    statusEl.style.color = "var(--danger)";
                    cardEl.style.borderLeftColor = "var(--danger)";
                } else {
                    statusEl.innerText = "OPEN";
                    statusEl.style.color = "var(--success)";
                    cardEl.style.borderLeftColor = "var(--success)";
                }
            }
        }
    });
}

        async function saveStoreSettings() {
    // 1. Get Values
    const isOpen = document.getElementById('storeIsOpen').checked;
    
    const settings = {
        name: document.getElementById('storeName').value,
        phone: document.getElementById('storePhone').value,
        upi: document.getElementById('storeUpi').value, // <--- NEW FIELD
        address: document.getElementById('storeAddress').value,
        openTime: document.getElementById('storeOpenTime').value,
        closeTime: document.getElementById('storeCloseTime').value,
        isOpen: isOpen,
        footer: document.getElementById('storeFooter').value,
        link: document.getElementById('storeLink').value
    };
    
    try {
        const { doc, setDoc } = window.firebaseModules;
        
        // 2. Save with Merge (Protects existing data)
        await setDoc(doc(window.db, 'settings', 'store'), settings, { merge: true });
        
        // 3. Force UI Update (Visual Feedback)
        const statusLabel = document.getElementById('storeStatusLabel');
        statusLabel.innerText = isOpen ? "OPEN" : "CLOSED";
        statusLabel.style.color = isOpen ? "var(--success)" : "var(--danger)";
        
        showToast('Settings Saved Successfully!');
        
    } catch (e) {
        console.error("Save Error:", e);
        // Alert the user if it fails (so you know if it's a permission issue)
        showToast('Error Saving: ' + e.message, 'error');
        
        // Optional: Revert checkbox if save failed
        document.getElementById('storeIsOpen').checked = !isOpen; 
    }
}

// Helper for contact buttons
function contactStore(action) {
    const phone = STATE.storeSettings.phone || '9007952259';
    const cleanPhone = phone.replace(/\D/g, ''); // Remove spaces/dashes
    
    if (action === 'call') {
        window.open(`tel:+91${cleanPhone}`, '_self');
    } 
    else if (action === 'whatsapp') {
        window.open(`https://wa.me/91${cleanPhone}`, '_blank');
    } 
    else if (action === 'save') {
        // Generate vCard for "Save Contact"
        const vCardData = `BEGIN:VCARD
VERSION:3.0
FN:${STATE.storeSettings.name || 'Juice Therapy'}
TEL;TYPE=CELL:+91${cleanPhone}
END:VCARD`;
        const blob = new Blob([vCardData], { type: "text/vcard" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "JuiceTherapy.vcf";
        a.click();
        URL.revokeObjectURL(url);
    }
}

function callCustomer(phone, event) {
    if(event) event.stopPropagation(); // Prevent opening order details
    if(!phone) return showToast('No phone number found', 'error');
    
    // Remove spaces or dashes just in case
    const cleanPhone = phone.toString().replace(/\D/g, ''); 
    window.open(`tel:+91${cleanPhone}`, '_self');
}

// Helper for 12-hour time format
function formatTime(timeStr) {
    if (!timeStr) return '';
    const [h, m] = timeStr.split(':');
    const hour = parseInt(h);
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const h12 = hour % 12 || 12;
    return `${h12}:${m} ${ampm}`;
}

        function loadCategories() {
            const { collection, onSnapshot, query, orderBy } = window.firebaseModules;
            onSnapshot(query(collection(window.db, 'categories'), orderBy('name')), (snap) => {
                STATE.categories = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if (STATE.role === 'admin') renderAdminCategories();
                updateCategorySelects();
                if(STATE.role === 'staff') renderOutletMenu();
                if(STATE.role === 'customer') renderCustomerMenu();
            });
        }

        function renderAdminCategories() {
    const list = document.getElementById('adminCategoryList');
    
    // 1. "All Items" Button
    const allActive = STATE.adminActiveCategory === 'All' ? 'btn-primary' : 'btn-secondary';
    
    let html = `
        <button class="btn ${allActive} btn-sm" onclick="filterAdminMenu('All')">
            All Items
        </button>
    `;

    // 2. Category Buttons
    html += STATE.categories.map(c => {
        // Highlight if active
        const isActive = STATE.adminActiveCategory === c.name;
        const btnClass = isActive ? 'btn-primary' : 'btn-secondary';
        
        return `
        <div class="btn ${btnClass} btn-sm" 
             style="display:inline-flex; gap:8px; align-items:center; padding-right:8px;" 
             onclick="filterAdminMenu('${c.name}')">
            
            <span>${c.name}</span>
            
            <span style="cursor:pointer; background:rgba(0,0,0,0.2); width:20px; height:20px; line-height:20px; border-radius:50%; text-align:center; font-size:14px; display:inline-block;" 
                  onclick="event.stopPropagation(); deleteCategory('${c.id}')"
                  title="Delete Category">
                  &times;
            </span>
        </div>
        `;
    }).join('');
    
    list.innerHTML = html;
}

// --- NEW HELPER FUNCTION ---
function filterAdminMenu(catName) {
    STATE.adminActiveCategory = catName;
    renderAdminCategories(); // Update button colors
    renderAdminMenu();       // Filter the grid
}

        function updateCategorySelects() {
            const opts = `<option value="">Select Category</option>` + STATE.categories.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            document.getElementById('newItemCat').innerHTML = opts;
        }

        async function saveCategory() {
            const name = document.getElementById('newCatName').value;
            if(!name) return;
            await window.firebaseModules.addDoc(window.firebaseModules.collection(window.db, 'categories'), { name });
            document.getElementById('addCategoryModal').classList.add('hidden');
            document.getElementById('newCatName').value = '';
        }

        async function deleteCategory(id) {
            if(!confirm('Delete Category?')) return;
            await window.firebaseModules.deleteDoc(window.firebaseModules.doc(window.db, 'categories', id));
        }

        function showCategoryModal() { document.getElementById('addCategoryModal').classList.remove('hidden'); }

        function loadMenu() {
            const { collection, onSnapshot, query, orderBy } = window.firebaseModules;
            onSnapshot(query(collection(window.db, 'menu'), orderBy('name')), (snap) => {
                STATE.menu = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if (STATE.role === 'admin') renderAdminMenu();
                if (STATE.role === 'staff') renderOutletMenu();
                if (STATE.role === 'customer') renderCustomerMenu();
            });
        }

        function renderAdminMenu() {
    const grid = document.getElementById('adminMenuGrid');
    
    // 1. FILTER LOGIC
    let items = STATE.menu;
    
    // Only filter if not "All"
    if (STATE.adminActiveCategory !== 'All') {
        items = items.filter(i => i.category === STATE.adminActiveCategory);
    }

    // 2. Empty State
    if (items.length === 0) {
        grid.innerHTML = `
            <div class="text-muted" style="grid-column: 1/-1; text-align:center; padding:30px; border:1px dashed #444; border-radius:8px;">
                No items found in "${STATE.adminActiveCategory}" category.
                <br><br>
                <button class="btn btn-sm btn-primary" onclick="showAddItemModal()">+ Add Item Here</button>
            </div>`;
        return;
    }

    // 3. Render Grid
    grid.innerHTML = items.map(item => `
        <div class="card" style="margin:0; display:flex; flex-direction:column; height:100%;">
            <div class="flex justify-between">
                <h4>${item.name}</h4>
                <span class="text-muted">‚Çπ${item.price}</span>
            </div>
            <div class="text-muted" style="font-size:0.8rem; margin-bottom:10px; flex:1;">
                ${item.category || 'Uncategorized'}
            </div>
            <div class="flex gap-2" style="margin-top:auto;">
                <button class="btn btn-secondary w-full" onclick="editItem('${item.id}')">Edit</button>
                <button class="btn btn-danger w-full" onclick="deleteItem('${item.id}')">Delete</button>
            </div>
        </div>
    `).join('');
}
// Helper function to reset date filter buttons to secondary state
function resetDateButtons() {
    document.getElementById('btnToday').classList.remove('btn-primary');
    document.getElementById('btnToday').classList.add('btn-secondary');
    document.getElementById('btnYesterday').classList.remove('btn-primary');
    document.getElementById('btnYesterday').classList.add('btn-secondary');
    document.getElementById('btnLast7').classList.remove('btn-primary');
    document.getElementById('btnLast7').classList.add('btn-secondary');
}

function setDashboardRange(type) {
    const startDate = new Date();
    const endDate = new Date();

    // Reset all buttons to secondary state
    resetDateButtons();

    if (type === 'today') {
        // Start = Today, End = Today
        // (No change needed, defaults are already Today)
        document.getElementById('btnToday').classList.remove('btn-secondary');
        document.getElementById('btnToday').classList.add('btn-primary');
    } 
    else if (type === 'yesterday') {
        // Start = Yesterday, End = Yesterday
        startDate.setDate(startDate.getDate() - 1);
        endDate.setDate(endDate.getDate() - 1);
        document.getElementById('btnYesterday').classList.remove('btn-secondary');
        document.getElementById('btnYesterday').classList.add('btn-primary');
    } 
    else if (type === 'last7') {
        // Start = 7 days ago, End = Today
        startDate.setDate(startDate.getDate() - 7);
        document.getElementById('btnLast7').classList.remove('btn-secondary');
        document.getElementById('btnLast7').classList.add('btn-primary');
    }

    // Update Input Fields
    document.getElementById('dashStart').valueAsDate = startDate;
    document.getElementById('dashEnd').valueAsDate = endDate;

    // Trigger Load
    loadAnalytics();
}

        // --- ADMIN ANALYTICS & ORDERS ---
        async function loadAnalytics() {
loadActiveUsersReport();    
const startInput = document.getElementById('dashStart').value;
    const endInput = document.getElementById('dashEnd').value;
    
    if(!startInput || !endInput) return showToast('Please select dates', 'error');

    // 1. Setup Dates
    const startDate = new Date(startInput);
    const endDate = new Date(endInput);
    endDate.setHours(23, 59, 59, 999);

    const { collection, query, where, getDocs, orderBy } = window.firebaseModules;
    
    // UI Loading State
    document.getElementById('statTotalSales').innerText = '...';
    document.getElementById('topItemsList').innerHTML = '<p class="text-muted">Analyzing...</p>';
    
    // 2. Query ALL Completed Orders (We filter by date in JS to allow flexible "Last 30 Days" graph logic)
    // NOTE: For huge databases, you would split this into two queries, but for <5000 orders this is faster.
    const q = query(collection(window.db, 'orders'), where('status', '==', 'completed'));
    
    try {
        const snap = await getDocs(q);
        
        // --- Variables for Selected Range ---
        let totalSales = 0;
        let count = 0;
        let bonusRedeemed = 0;
        let cashTotal = 0;
        let onlineTotal = 0;
        let itemMap = {}; // Format: { "Mango Shake": { qty: 5, revenue: 500 } }

        // --- Variables for Last 30 Days Graph ---
        let dailySales = {}; // Format: { "2023-10-01": 5000, "2023-10-02": 3200 }
        
        // Initialize last 30 days keys
        for (let i = 29; i >= 0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            const dateKey = d.toISOString().split('T')[0];
            dailySales[dateKey] = 0;
        }

        // 3. Process Data
        snap.forEach(doc => {
            const data = doc.data();
            if (!data.timestamp) return;
            
            const orderDate = data.timestamp.toDate();
            const dateKey = orderDate.toISOString().split('T')[0];

            // A. Populate Graph Data (Last 30 Days)
            if (dailySales.hasOwnProperty(dateKey)) {
                dailySales[dateKey] += (data.finalPaid || data.total || 0);
            }

            // B. Filter for Selected Range (Metrics & Item Analytics)
            if (orderDate >= startDate && orderDate <= endDate) {
                const finalAmt = data.finalPaid !== undefined ? data.finalPaid : data.total;
                
                totalSales += finalAmt;
                count++;
                bonusRedeemed += (data.redeemed || 0);

                // Payment Mode Split
                if (data.paymentMode === 'Online') onlineTotal += finalAmt;
                else cashTotal += finalAmt; // Default to cash if undefined or 'Cash'

                // Item Analysis
                if (data.items && Array.isArray(data.items)) {
                    data.items.forEach(item => {
                        if (!itemMap[item.name]) {
                            itemMap[item.name] = { qty: 0, revenue: 0 };
                        }
                        itemMap[item.name].qty += (item.qty || 0);
                        itemMap[item.name].revenue += (item.price * item.qty || 0);
                    });
                }
            }
        });

        // 4. Update Metric Cards
        document.getElementById('statTotalSales').innerText = '‚Çπ' + totalSales;
        document.getElementById('statTotalOrders').innerText = count;
        document.getElementById('statAvgValue').innerText = count ? '‚Çπ' + Math.floor(totalSales/count) : '‚Çπ0';
        document.getElementById('statBonus').innerText = '‚Çπ' + bonusRedeemed;
        document.getElementById('statCash').innerText = '‚Çπ' + cashTotal;
        document.getElementById('statOnline').innerText = '‚Çπ' + onlineTotal;

        // 5. Update Top Items List & Detailed Table
        renderItemAnalytics(itemMap);

        // 6. Render Graph
        renderSalesChart(dailySales);

    } catch (e) {
        console.error("Analytics Error:", e);
        showToast('Error loading analytics', 'error');
    }
}

function renderItemAnalytics(itemMap) {
    // Convert Map to Array and Sort by Quantity Descending
    const sortedItems = Object.entries(itemMap)
        .map(([name, data]) => ({ name, ...data }))
        .sort((a, b) => b.qty - a.qty);

    // A. Render Top 5 Items List
    const topListEl = document.getElementById('topItemsList');
    if (sortedItems.length === 0) {
        topListEl.innerHTML = '<p class="text-muted">No items sold in this period.</p>';
    } else {
        topListEl.innerHTML = sortedItems.slice(0, 5).map((item, index) => `
            <div style="display:flex; justify-content:space-between; border-bottom:1px solid rgba(255,255,255,0.05); padding:5px 0;">
                <span>${index+1}. ${item.name}</span>
                <span class="text-muted">${item.qty} sold</span>
            </div>
        `).join('');
    }

    // B. Render Detailed Table
    const tableBody = document.getElementById('itemAnalyticsTable');
    if (sortedItems.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted" style="padding:20px;">No data</td></tr>';
    } else {
        tableBody.innerHTML = sortedItems.map(item => `
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                <td style="padding: 10px;">${item.name}</td>
                <td style="padding: 10px; text-align: center;">${item.qty}</td>
                <td style="padding: 10px; text-align: right;">‚Çπ${item.revenue}</td>
            </tr>
        `).join('');
    }
}

function renderSalesChart(dailyData) {
    const ctx = document.getElementById('salesChart').getContext('2d');
    
    // Prepare Data Arrays
    const labels = Object.keys(dailyData).map(dateStr => {
        const d = new Date(dateStr);
        return `${d.getDate()}/${d.getMonth()+1}`; // Format: DD/MM
    });
    const dataPoints = Object.values(dailyData);

    // DESTROY OLD CHART (Crucial to prevent glitches)
    if (SALES_CHART_INSTANCE) {
        SALES_CHART_INSTANCE.destroy();
    }

    // Create New Chart
    SALES_CHART_INSTANCE = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Daily Sales (‚Çπ)',
                data: dataPoints,
                borderColor: '#FF6B35', // Your Primary Brand Color
                backgroundColor: 'rgba(255, 107, 53, 0.2)',
                borderWidth: 2,
                tension: 0.3, // Curve smoothing
                fill: true,
                pointRadius: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: { 
                    mode: 'index', 
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            return ' Sales: ‚Çπ' + context.raw;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                    ticks: { color: '#888' }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#888', maxTicksLimit: 10 }
                }
            }
        }
    });
}

        function loadAdminOrders() {
            const { collection, query, where, onSnapshot } = window.firebaseModules;
            
            const q = query(collection(window.db, 'orders'), where('status', '==', 'completed'));
            
            onSnapshot(q, (snap) => {
                const list = document.getElementById('adminOrdersList');
                
                if(snap.empty) {
                    list.innerHTML = '<p class="text-muted text-center">No completed orders found.</p>';
                    return;
                }

                const orders = snap.docs.map(d => ({id: d.id, ...d.data()}));
                orders.sort((a, b) => {
                    const tA = a.timestamp ? a.timestamp.seconds : 0;
                    const tB = b.timestamp ? b.timestamp.seconds : 0;
                    return tB - tA;
                });

                list.innerHTML = orders.map(o => {
                    const dateStr = o.timestamp ? new Date(o.timestamp.toDate()).toLocaleDateString() : 'N/A';
                    return `
                    <div class="order-card" onclick="viewOrderDetails('${o.id}')" style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;">
                        <div>
                            <div style="font-weight:bold; font-size:1.1rem;">${o.customerName || o.phone}</div>
                            <div class="text-muted" style="font-size:0.85rem;">${dateStr} ‚Ä¢ ‚Çπ${o.total} ‚Ä¢ ${o.paymentMode || 'Cash'}</div>
                            <div class="text-muted" style="font-size:0.8rem;">${o.items.length} Items</div>
                        </div>
                        <div>
                            <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); adminDeleteOrder('${o.id}')">Delete</button>
                        </div>
                    </div>
                `;}).join('');
            });
        }
        
        async function adminDeleteOrder(id) {
            if(!confirm('Delete this record? Warning: 5% Bonus points awarded will be deducted from the customer.')) return;
            
            const { doc, runTransaction } = window.firebaseModules;
            
            try {
                await runTransaction(window.db, async (transaction) => {
                    // 1. Get Order
                    const orderRef = doc(window.db, 'orders', id);
                    const orderDoc = await transaction.get(orderRef);
                    
                    if (!orderDoc.exists()) throw "Order does not exist!";
                    
                    const orderData = orderDoc.data();
                    
                    // 2. Adjust Customer Points if order was completed
                    if (orderData.status === 'completed' && orderData.phone) {
                        const bonus = Math.floor(orderData.total * 0.05);
                        const custRef = doc(window.db, 'customers', orderData.phone);
                        const custDoc = await transaction.get(custRef);
                        
                        if (custDoc.exists()) {
                            const currentPoints = custDoc.data().points || 0;
                            transaction.update(custRef, { points: currentPoints - bonus });
                        }
                    }
                    
                    // 3. Delete Order
                    transaction.delete(orderRef);
                });
                
                showToast('Order deleted & points reversed');
                loadAdminOrders(); 
            } catch (e) {
                console.error(e);
                showToast('Error: ' + e.message, 'error');
            }
        }

// --- ORDER DETAILS & ADMIN EDIT ---
        let CURRENT_VIEW_ORDER_ID = null;

        async function viewOrderDetails(orderId) {
            CURRENT_VIEW_ORDER_ID = orderId;
            const { doc, getDoc } = window.firebaseModules;
            
            // 1. Fetch Order
            const snap = await getDoc(doc(window.db, 'orders', orderId));
            if(!snap.exists()) return showToast('Order not found', 'error');
            const data = snap.data();
// 1. Load items into temporary state
TEMP_EDIT_ITEMS = JSON.parse(JSON.stringify(data.items)); // Deep copy to avoid reference issues

// 2. Populate the "Add Item" dropdown
const itemSelect = document.getElementById('adminAddItemSelect');
itemSelect.innerHTML = `<option value="">+ Add Menu Item</option>` + 
    STATE.menu.map(m => `<option value="${m.id}">${m.name} (‚Çπ${m.price})</option>`).join('');

            // 2. Populate Modal Fields
            document.getElementById('viewStoreName').innerText = STATE.storeSettings?.name || 'Juice Therapy';
            document.getElementById('viewOrderId').innerText = `Order #${data.timestamp ? data.timestamp.toMillis().toString().slice(-4) : '...'}`;
            document.getElementById('viewDate').innerText = data.timestamp ? data.timestamp.toDate().toLocaleString() : '';
            
            document.getElementById('editCustName').value = data.customerName || 'Guest';
            document.getElementById('editCustPhone').value = data.phone || '';
            
            // Populate Items
            const itemsHtml = data.items.map(i => `
                <div class="flex justify-between" style="font-size:0.9rem; margin-bottom:4px;">
                    <span>${i.qty} x ${i.name}</span>
                    <span>‚Çπ${i.price * i.qty}</span>
                </div>
            `).join('');
            document.getElementById('viewItemsList').innerHTML = itemsHtml;

            // Populate Payment
            document.getElementById('editTotal').value = data.finalPaid || data.total;
            document.getElementById('editMode').value = data.paymentMode || 'Cash';

            // 3. Reset Edit State
            disableAdminEdit();
            
            // 4. Show "Edit" button ONLY if Admin
            if(STATE.role === 'admin') {
                document.getElementById('btnAdminEdit').classList.remove('hidden');
            } else {
                document.getElementById('btnAdminEdit').classList.add('hidden');
            }

            document.getElementById('orderDetailsModal').classList.remove('hidden');
        }

        function closeDetailsModal() {
            document.getElementById('orderDetailsModal').classList.add('hidden');
        }

        // --- ADMIN EDIT LOGIC ---
        function enableAdminEdit() {
            // Enable Inputs
            document.getElementById('editCustName').disabled = false;
            document.getElementById('editCustPhone').disabled = false;
            document.getElementById('editTotal').disabled = false;
            document.getElementById('editMode').disabled = false;
  
// NEW: Toggle Item Views
    document.getElementById('viewItemsList').classList.add('hidden'); // Hide static
    document.getElementById('editItemsWrapper').classList.remove('hidden'); // Show dynamic
    
    renderEditItems(); // Draw the editable list
          
            // Toggle Buttons
            document.getElementById('btnAdminEdit').classList.add('hidden');
            document.getElementById('btnAdminSave').classList.remove('hidden');
        }

        function disableAdminEdit() {
            document.getElementById('editCustName').disabled = true;
            document.getElementById('editCustPhone').disabled = true;
            document.getElementById('editTotal').disabled = true;
            document.getElementById('editMode').disabled = true;
            
// NEW: Toggle Item Views Back
    document.getElementById('viewItemsList').classList.remove('hidden');
    document.getElementById('editItemsWrapper').classList.add('hidden');
            document.getElementById('btnAdminEdit').classList.remove('hidden');
            document.getElementById('btnAdminSave').classList.add('hidden');
        }

        async function saveAdminOrder() {
    if(!confirm('Save changes to this historical order?\n(Customer points will be recalculated)')) return;

    // 1. Prepare the New Data from your Inputs/Temp State
    const newTotal = Number(document.getElementById('editTotal').value);
    const newItems = TEMP_EDIT_ITEMS;
    const newPhone = document.getElementById('editCustPhone').value;
    const newName = document.getElementById('editCustName').value;
    const newMode = document.getElementById('editMode').value;

    try {
        const { doc, runTransaction, serverTimestamp } = window.firebaseModules;
        
        // 2. Run a Transaction (Ensures points & order update together)
        await runTransaction(window.db, async (transaction) => {
            
            // A. Get references
            const orderRef = doc(window.db, 'orders', CURRENT_VIEW_ORDER_ID);
            const orderDoc = await transaction.get(orderRef);
            if (!orderDoc.exists()) throw "Order does not exist!";

            const oldOrderData = orderDoc.data();
            const isCompleted = oldOrderData.status === 'completed';

            // B. Calculate Point Adjustments (Only if order is completed)
            let newBonus = 0;
            
            if (isCompleted) {
                // Calculate what the bonus SHOULD be now (5% of new total)
                newBonus = Math.floor(newTotal * 0.05);

                // Get the OLD bonus (use recorded 'bonusEarned' or calculate it if missing)
                const oldBonus = oldOrderData.bonusEarned !== undefined 
                    ? oldOrderData.bonusEarned 
                    : Math.floor(oldOrderData.total * 0.05);

                const pointDifference = newBonus - oldBonus;

                // Update Customer Points
                // Note: We use the OLD phone to find the customer in case you changed the number
                const custPhone = oldOrderData.phone; 
                const custRef = doc(window.db, 'customers', custPhone);
                const custDoc = await transaction.get(custRef);

                if (custDoc.exists()) {
                    const currentPoints = custDoc.data().points || 0;
                    const newBalance = currentPoints + pointDifference;
                    
                    // Prevent negative points (optional, but good practice)
                    if (newBalance < 0) {
                        // You can throw an error here if you want to block the edit, 
                        // or just set it to 0. We'll allow it but warn in console.
                        console.warn("Customer points dropped below zero.");
                    }

                    transaction.update(custRef, { points: newBalance });
                }
            }

            // C. Update the Order Document
            transaction.update(orderRef, {
                customerName: newName,
                phone: newPhone,
                finalPaid: newTotal,
                total: newTotal,
                paymentMode: newMode,
                items: newItems,
                bonusEarned: newBonus // Save the new bonus amount so next time it's accurate
            });
        });
        
        // 3. Success UI Updates
        showToast('Order & Points Updated Successfully');
        disableAdminEdit();
        closeDetailsModal();
        
        // Refresh Lists
        if(STATE.role === 'admin') searchHistory();
        else loadOrders(); 

    } catch(e) {
        console.error(e);
        showToast('Update Failed: ' + e.message, 'error');
    }
}

// 1. Render the editable list with Qty inputs and Delete buttons
function renderEditItems() {
    const container = document.getElementById('editItemsList');
    container.innerHTML = TEMP_EDIT_ITEMS.map((item, index) => `
        <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.05); padding:8px; border-radius:6px;">
            <div style="flex:1;">
                <div style="font-size:0.9rem;">${item.name}</div>
                <div class="text-muted" style="font-size:0.75rem;">‚Çπ${item.price} each</div>
            </div>
            <div style="display:flex; align-items:center; gap:8px;">
                <input type="number" value="${item.qty}" min="1" 
                    style="width:50px; padding:4px; border-radius:4px; border:none;"
                    onchange="adminUpdateItemQty(${index}, this.value)">
                <button class="btn btn-danger btn-sm" onclick="adminRemoveItem(${index})">üóëÔ∏è</button>
            </div>
        </div>
    `).join('');
    
    recalcEditTotal(); // Auto-update the total price
}

// 2. Update Quantity
function adminUpdateItemQty(index, newQty) {
    const qty = parseInt(newQty);
    if (qty > 0) {
        TEMP_EDIT_ITEMS[index].qty = qty;
        recalcEditTotal();
    }
}

// 3. Remove Item
function adminRemoveItem(index) {
    TEMP_EDIT_ITEMS.splice(index, 1);
    renderEditItems();
}

// 4. Add New Item from Dropdown
function adminAddNewItem(selectEl) {
    const itemId = selectEl.value;
    if (!itemId) return;

    const menuItem = STATE.menu.find(m => m.id === itemId);
    if (menuItem) {
        // Check if already exists, just add qty
        const existing = TEMP_EDIT_ITEMS.find(i => i.id === itemId);
        if (existing) {
            existing.qty++;
        } else {
            TEMP_EDIT_ITEMS.push({ ...menuItem, qty: 1 });
        }
        renderEditItems();
    }
    selectEl.value = ""; // Reset dropdown
}

// 5. Auto-Calculate Total
function recalcEditTotal() {
    const total = TEMP_EDIT_ITEMS.reduce((sum, item) => sum + (item.price * item.qty), 0);
    document.getElementById('editTotal').value = total;
}

        function filterAdminOrders(val) {
            const cards = document.querySelectorAll('#adminOrdersList .order-card');
            cards.forEach(c => c.style.display = c.innerText.includes(val) ? 'flex' : 'none');
        }

        // --- MENU ITEM LOGIC ---
        function showAddItemModal(id = null) {
            document.getElementById('addItemModal').classList.remove('hidden');
            if(id) {
                const item = STATE.menu.find(i => i.id === id);
                document.getElementById('newItemName').value = item.name;
                document.getElementById('newItemPrice').value = item.price;
                document.getElementById('newItemCat').value = item.category;
                document.getElementById('addItemModal').dataset.id = id;
            } else {
                document.getElementById('newItemName').value = '';
                document.getElementById('newItemPrice').value = '';
                document.getElementById('newItemCat').value = '';
                delete document.getElementById('addItemModal').dataset.id;
            }
        }

        async function saveMenuItem() {
            const name = document.getElementById('newItemName').value;
            const price = Number(document.getElementById('newItemPrice').value);
            const category = document.getElementById('newItemCat').value;
            const id = document.getElementById('addItemModal').dataset.id;
            const { collection, addDoc, doc, updateDoc } = window.firebaseModules;
            try {
                if(id) { await updateDoc(doc(window.db, 'menu', id), { name, price, category }); } 
                else { await addDoc(collection(window.db, 'menu'), { name, price, category }); }
                document.getElementById('addItemModal').classList.add('hidden');
                showToast('Saved');
            } catch(e) { showToast(e.message, 'error'); }
        }

        async function editItem(id) { showAddItemModal(id); }
        async function deleteItem(id) {
            if(!confirm('Delete item?')) return;
            await window.firebaseModules.deleteDoc(window.firebaseModules.doc(window.db, 'menu', id));
        }

        // --- OUTLET POS ---
        function switchOutletTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            ['view-pos', 'view-incoming', 'view-current', 'view-completed'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
        }

function filterMenu(text) {
            STATE.searchQuery = text.trim().toLowerCase();
            renderOutletMenu();
        }

        function renderOutletMenu() {
            const sidebar = document.getElementById('posSidebar');
            
            // 1. Safe Category Rendering (Fixes clicking issues)
            const cats = ['All', ...STATE.categories.map(c => c.name)];
            
            sidebar.innerHTML = cats.map(cat => {
                // Escape quotes to prevent code breaking on names like "Chef's Special"
                const safeCat = cat.replace(/'/g, "\\'");
                const isActive = STATE.activeCategory === cat;
                
                return `
                <div class="cat-btn ${isActive ? 'active' : ''}" 
                     onclick="filterCategory('${safeCat}')">${cat}</div>
                `;
            }).join('');
            
            const grid = document.getElementById('posGrid');
            let items = [];

            // 2. Robust Filtering Logic
            if (STATE.searchQuery) {
                // If searching, ignore category and look at names
                items = STATE.menu.filter(item => 
                    item.name.toLowerCase().includes(STATE.searchQuery)
                );
            } else {
                // If filtering by category
                if (STATE.activeCategory === 'All') {
                    items = STATE.menu;
                } else {
                    // FIX: Compare trimmed strings to ignore accidental spaces
                    items = STATE.menu.filter(m => 
                        (m.category || '').trim() === STATE.activeCategory.trim()
                    );
                }
            }
            
            // 3. Render Items (With New Visual Design)
            if (items.length === 0) {
                const msg = STATE.searchQuery 
                    ? `No items match "${STATE.searchQuery}"` 
                    : `No items in ${STATE.activeCategory}`;
                grid.innerHTML = `<div class="text-muted" style="grid-column: 1/-1; text-align:center; padding:20px;">${msg}</div>`;
            } else {
                grid.innerHTML = items.map(item => {
                    const cartItem = STATE.cart.find(c => c.id === item.id);
                    const qty = cartItem ? cartItem.qty : 0;
                    
                    // Quantity Badge
                    const qtyBadge = qty > 0 
                        ? `<div style="position:absolute; top:8px; right:8px; background:white; color:var(--primary); width:22px; height:22px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:0.8rem; box-shadow:0 2px 5px rgba(0,0,0,0.5); z-index:2;">${qty}</div>` 
                        : '';
                    
                    // Highlight if selected
                    const selectedStyle = qty > 0 ? 'border-color: var(--primary); background: rgba(255, 107, 53, 0.15);' : '';

                    return `
                    <div class="menu-item" onclick="addToCart('${item.id}')" style="${selectedStyle}">
                        ${qtyBadge}
                        <div class="item-name-clamp" title="${item.name}">${item.name}</div>
                        <div class="item-price-tag">‚Çπ${item.price}</div>
                    </div>
                `}).join('');
            }
        }

        function filterCategory(cat) {
            STATE.activeCategory = cat;
            
            // Clear Search when switching categories
            STATE.searchQuery = ''; 
            const searchInput = document.querySelector('#view-pos input[type="text"]');
            if(searchInput) searchInput.value = '';

            if(STATE.role === 'staff') renderOutletMenu();
            if(STATE.role === 'customer') renderCustomerMenu();
        }

        function addToCart(itemId) {
            const item = STATE.menu.find(i => i.id === itemId);
            const targetCart = STATE.role === 'customer' ? STATE.custCart : STATE.cart;
            const existing = targetCart.find(c => c.id === itemId);
            if(existing) existing.qty++;
            else targetCart.push({ ...item, qty: 1 });
            renderActiveCart();
        }

        function updateQty(itemId, delta) {
            const targetCart = STATE.role === 'customer' ? STATE.custCart : STATE.cart;
            const item = targetCart.find(c => c.id === itemId);
            if(!item) return;
            item.qty += delta;
            if(item.qty <= 0) {
                if(STATE.role === 'customer') STATE.custCart = STATE.custCart.filter(c => c.id !== itemId);
                else STATE.cart = STATE.cart.filter(c => c.id !== itemId);
            }
            renderActiveCart();
        }

        function clearCart() {
            STATE.cart = [];
            STATE.editingOrderId = null;
            document.getElementById('posPhone').value = '';
            document.getElementById('btnPlaceOrder').classList.remove('hidden');
            document.getElementById('btnUpdateOrder').classList.add('hidden');
            renderActiveCart();
        }

        function renderActiveCart() {
            if(STATE.role === 'customer') {
                renderCartGeneric(document.getElementById('custCartItems'), document.getElementById('custCartTotal'), STATE.custCart);
                renderCustomerMenu();
            } else {
                renderCartGeneric(document.getElementById('cartItemsList'), document.getElementById('cartTotal'), STATE.cart);
                renderOutletMenu();
            }
        }

        function renderCartGeneric(container, totalEl, cartArray) {
            if(cartArray.length === 0) {
                container.innerHTML = '<div class="text-center text-muted" style="margin-top:20px;">Cart is empty</div>';
                totalEl.innerText = '‚Çπ0';
                return;
            }
            let total = 0;
            container.innerHTML = cartArray.map(item => {
                total += item.price * item.qty;
                return `
                    <div class="cart-item">
                        <div>
                            <div style="font-size: 0.9rem;">${item.name}</div>
                            <div class="text-muted" style="font-size: 0.8rem;">‚Çπ${item.price} x ${item.qty}</div>
                        </div>
                        <div class="qty-controls">
                            <div class="qty-btn" onclick="updateQty('${item.id}', -1)">-</div>
                            <span style="padding: 0 5px;">${item.qty}</span>
                            <div class="qty-btn" onclick="updateQty('${item.id}', 1)">+</div>
                        </div>
                    </div>
                `;
            }).join('');
            totalEl.innerText = '‚Çπ' + total;
        }

        async function placeOrder() {
            const phone = document.getElementById('posPhone').value;
            if(phone.length !== 10) return showToast('Enter 10-digit Phone', 'error');
            if(STATE.cart.length === 0) return showToast('Cart is empty', 'error');
            await submitOrder(phone, STATE.cart, 'pending');
            clearCart();
            switchOutletTab('current');
        }

        async function placeCustomerOrder() {
            if(STATE.custCart.length === 0) return showToast('Cart is empty', 'error');
            await submitOrder(STATE.user.phone, STATE.custCart, 'requested');
            STATE.custCart = [];
            renderActiveCart();
            showToast('Order Request Sent');
            switchCustTab('history');
        }

        async function submitOrder(phone, items, status) {
            const { addDoc, collection, serverTimestamp, doc, setDoc, getDoc } = window.firebaseModules;
            
            // 1. Fetch Customer Details
            const custRef = doc(window.db, 'customers', phone);
            const custSnap = await getDoc(custRef);
            
            let custName = ''; // Default if name not found

            if (!custSnap.exists()) {
                // Create new customer if they don't exist
                await setDoc(custRef, { phone, points: 0, joined: serverTimestamp() });
            } else {
                // Get existing name
                custName = custSnap.data().name || '';
            }
            
            const total = items.reduce((s, i) => s + (i.price * i.qty), 0);
            
            // 2. Save Order WITH Name
            await addDoc(collection(window.db, 'orders'), {
                items: items, 
                phone: phone, 
                customerName: custName, // <--- Name restored here
                total: total, 
                status: status, 
                timestamp: serverTimestamp()
            });
        }

        function loadOrders() {
    const { collection, query, orderBy, onSnapshot, where } = window.firebaseModules;
    
    // 1. Define "Start of Today" (Midnight)
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // 2. Updated Query: Only fetch orders where timestamp is >= Today
    // NOTE: This will require a Firestore Index. Check your browser console for the link!
    const q = query(
        collection(window.db, 'orders'), 
        where('timestamp', '>=', today),
        orderBy('timestamp', 'desc')
    );
    
    onSnapshot(q, (snap) => {
        const orders = snap.docs.map(d => ({id: d.id, ...d.data()}));

STATE.orders = orders;
        
        // Filter 1: Incoming Requests
        const requested = orders.filter(o => o.status === 'requested');
        renderIncoming(requested);
        
        // Filter 2: Pending Orders
        const pending = orders.filter(o => o.status === 'pending');
        renderCurrentOrders(pending);
        
        // Filter 3: Completed Orders (Already filtered to "Today" by the query above)
        const completed = orders.filter(o => o.status === 'completed');
        renderCompletedOrders(completed);
        
        // Badge Logic
        const badge = document.getElementById('badgeIncoming');
        if(requested.length > 0) badge.classList.remove('hidden');
        else badge.classList.add('hidden');
    });
}

async function searchHistory() {
    const startVal = document.getElementById('historyStart').value;
    const endVal = document.getElementById('historyEnd').value;
    
    if(!startVal || !endVal) return showToast('Please select both dates', 'error');

    const startDate = new Date(startVal);
    const endDate = new Date(endVal);
    endDate.setHours(23, 59, 59, 999); // Set to end of the selected day

    // UI Loading State
    const list = document.getElementById('adminOrdersList');
    list.innerHTML = '<p class="text-center">Searching...</p>';

    const { collection, query, where, orderBy, getDocs } = window.firebaseModules;

    try {
        // Query for history range
        const q = query(
            collection(window.db, 'orders'),
            where('timestamp', '>=', startDate),
            where('timestamp', '<=', endDate),
            orderBy('timestamp', 'desc')
        );

        const snap = await getDocs(q);

        if(snap.empty) {
            list.innerHTML = '<p class="text-muted text-center" style="padding:20px;">No orders found in this range.</p>';
            return;
        }

        const orders = snap.docs.map(d => ({id: d.id, ...d.data()}));

        // Render Results (Reusing your card design)
        list.innerHTML = orders.map(o => {
            const dateStr = o.timestamp ? new Date(o.timestamp.toDate()).toLocaleDateString() + ' ' + new Date(o.timestamp.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'N/A';
            
            // Determine status color
            let statusColor = '#4CAF50'; // Default success
            if(o.status === 'cancelled') statusColor = '#FF5252';
            if(o.status === 'pending') statusColor = '#FFC107';

            return `
            <div class="order-card" onclick="viewOrderDetails('${o.id}')" style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;">
                <div>
                    <div style="font-weight:bold; font-size:1.1rem;">${o.customerName || o.phone}</div>
                    <div class="text-muted" style="font-size:0.85rem;">${dateStr} ‚Ä¢ <span style="color:${statusColor}">${o.status.toUpperCase()}</span></div>
                    <div class="text-muted" style="font-size:0.8rem;">‚Çπ${o.total} ‚Ä¢ ${o.paymentMode || 'Cash'}</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-weight:bold; font-size:1.2rem;">‚Çπ${o.total}</div>
                    <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); adminDeleteOrder('${o.id}')" style="margin-top:5px;">üóëÔ∏è</button>
                </div>
            </div>
        `;}).join('');

    } catch (e) {
        console.error(e);
        list.innerHTML = `<p class="text-danger text-center">Error: ${e.message}</p>`;
        // Note: The first time you run this, check the console for the index link!
    }
}

        function renderIncoming(orders) {
            document.getElementById('incomingOrdersList').innerHTML = orders.map(o => {
                let timeStr = o.timestamp ? o.timestamp.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                const callBtn = `<button class="btn btn-secondary btn-sm" style="padding:2px 6px; margin-left:8px; border-radius:50%;" onclick="callCustomer('${o.phone}', event)">üìû</button>`;

const customerDisplay = o.customerName 
    ? `<strong>${o.customerName}</strong> <span style="font-weight:normal; font-size:0.8rem">(${o.phone})</span>${callBtn}`
    : `<strong>${o.phone}</strong>${callBtn}`;

                return `
                <div class="order-card">
                    <div class="flex justify-between" style="align-items:center; margin-bottom:8px;">
                        <div>
                            <span class="order-status status-requested">REQUESTED</span>
                            <span class="text-muted" style="font-size:0.75rem;">${timeStr}</span>
                        </div>
                        <strong style="font-size:1.1rem;">‚Çπ${o.total}</strong>
                    </div>
                    
                    <div style="margin-bottom:8px;">${customerDisplay}</div>
                    
                    <div class="text-muted" style="font-size:0.9rem; border-top:1px solid rgba(255,255,255,0.1); padding-top:8px;">
                        ${o.items.map(i => `${i.qty}x ${i.name}`).join(', ')}
                    </div>
                    
                    <div class="flex gap-2" style="margin-top:10px;">
                        <button class="btn btn-success w-full" onclick="updateOrderStatus('${o.id}', 'pending')">Accept</button>
                        <button class="btn btn-danger w-full" onclick="updateOrderStatus('${o.id}', 'cancelled')">Reject</button>
                    </div>
                </div>
            `}).join('');
        }

       function renderCurrentOrders(orders) {
            document.getElementById('currentOrdersList').innerHTML = orders.map(o => {
                // 1. Format Date & Time
                let timeStr = 'Just now';
                if(o.timestamp) {
                    const d = o.timestamp.toDate();
                    timeStr = `${d.getDate()}/${d.getMonth()+1} ${d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                }

                const callBtn = `<button class="btn btn-secondary btn-sm" style="padding:2px 6px; margin-left:8px; border-radius:50%;" onclick="callCustomer('${o.phone}', event)">üìû</button>`;

// 2. Format Name & Phone Display
const customerDisplay = o.customerName 
    ? `<div style="font-weight:bold; font-size:1rem; line-height:1.2; display:flex; align-items:center;">
          ${o.customerName} ${callBtn}
       </div>
       <div style="font-size:0.85rem; color:#aaa;">${o.phone}</div>`
    : `<div style="font-weight:bold; font-size:1rem; display:flex; align-items:center;">
          ${o.phone} ${callBtn}
       </div>`;

                return `
                <div class="order-card">
                    <div class="flex justify-between" style="align-items:flex-start; margin-bottom:8px;">
                        <div>
                            <div style="margin-bottom:5px;">${customerDisplay}</div>
                            <span class="order-status status-pending" style="font-size:0.65rem;">PENDING</span>
                            <span class="text-muted" style="font-size:0.75rem; margin-left:5px;">üìÖ ${timeStr}</span>
                        </div>
                        <div style="text-align:right;">
                            <strong style="font-size:1.2rem; display:block;">‚Çπ${o.total}</strong>
                            <button class="btn btn-danger btn-sm" style="padding: 2px 8px; margin-top:5px; font-size:0.7rem;" onclick="deletePendingOrder('${o.id}')">üóëÔ∏è Cancel</button>
                        </div>
                    </div>
                    
                    <div class="text-muted" style="font-size:0.9rem; border-top:1px solid rgba(255,255,255,0.1); padding-top:8px; margin-top:5px;">
                        ${o.items.map(i => `${i.qty}x ${i.name}`).join(', ')}
                    </div>
                    
                    <div class="flex gap-2" style="margin-top:12px;">
    <button class="btn btn-secondary" style="background:#444;" onclick="printKOTDirect('${o.id}')">üñ®Ô∏è KOT</button>
    
    <button class="btn btn-secondary w-full" onclick="editOrder('${o.id}')">‚úèÔ∏è Edit</button>
    <button class="btn btn-success w-full" onclick="openPaymentModal('${o.id}', ${o.total}, '${o.phone}')">‚úÖ Bill</button>
</div>
                </div>
            `}).join('');
        }

function printKOT(orderId) {
    // 1. Find the order in our local list (Pending or Completed)
    // We search all lists to be safe
    const allOrders = [...STATE.orders]; 
    const order = allOrders.find(o => o.id === orderId);

    if (!order) return showToast('Order data not found for printing', 'error');

    // 2. Format Data
    const serial = order.timestamp ? order.timestamp.toMillis().toString().slice(-4) : '????';
    const dateObj = order.timestamp ? order.timestamp.toDate() : new Date();
    const time = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const totalQty = order.items.reduce((sum, i) => sum + i.qty, 0);

    // 3. Generate HTML
    const html = `
        <div class="kot-header">
            <div class="kot-title">KOT #${serial}</div>
            <div class="kot-meta">${time} ‚Ä¢ ${order.status.toUpperCase()}</div>
            <div class="kot-meta">Customer: ${order.customerName || 'Guest'}</div>
        </div>
        <div class="kot-items">
            ${order.items.map(item => `
                <div class="kot-item-row">
                    <div style="width:20px;">${item.qty}</div>
                    <div style="flex:1;">${item.name}</div>
                </div>
            `).join('')}
        </div>
        <div class="kot-footer">
            Total Items: ${totalQty}<br>
            *** KITCHEN COPY ***
        </div>
    `;

    // 4. Inject and Print
    document.getElementById('kot-receipt').innerHTML = html;
    
    // Small delay to ensure rendering before print trigger
    setTimeout(() => {
        window.print();
    }, 200);
}

        function renderCompletedOrders(orders) {
            document.getElementById('completedOrdersList').innerHTML = orders.map(o => {
                // 1. Format Date & Time
                let timeStr = '';
                if(o.timestamp) {
                    const d = o.timestamp.toDate();
                    timeStr = `${d.getDate()}/${d.getMonth()+1} ${d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                }

                // 2. Format Name & Phone
                const customerDisplay = o.customerName 
                    ? `<div style="font-weight:bold; font-size:1rem; line-height:1.2;">${o.customerName}</div><div style="font-size:0.85rem; color:#aaa;">${o.phone}</div>`
                    : `<div style="font-weight:bold; font-size:1rem;">${o.phone}</div>`;

                return `
                <div class="order-card" onclick="viewOrderDetails('${o.id}')" style="cursor:pointer;">
                    <div class="flex justify-between" style="align-items:flex-start;">
                        <div>
                            <div style="margin-bottom:5px;">${customerDisplay}</div>
                            <span class="order-status status-completed" style="font-size:0.65rem;">COMPLETED</span>
                            <span class="text-muted" style="font-size:0.75rem; margin-left:5px;">üìÖ ${timeStr}</span>
                        </div>
                        <div style="text-align:right;">
                            <strong style="font-size:1.2rem; display:block;">‚Çπ${o.total}</strong>
                            <span class="text-muted" style="font-size:0.7rem;">${o.paymentMode || 'Cash'}</span>
                        </div>
                    </div>
                    
                    <div class="text-muted" style="font-size:0.9rem; border-top:1px solid rgba(255,255,255,0.1); padding-top:8px; margin-top:8px;">
                        ${o.items.map(i => `${i.qty}x ${i.name}`).join(', ')}
                    </div>

<div class="flex gap-2" style="margin-top:10px;">
    <button class="btn btn-secondary btn-sm" style="background:#444;" onclick="event.stopPropagation(); printBillDirect('${o.id}')">
        üñ®Ô∏è
    </button>
    <button class="btn btn-secondary w-full btn-sm" onclick="callCustomer('${o.phone}', event)">
        üìû Call
    </button>

    <button class="btn btn-success w-full btn-sm" onclick="event.stopPropagation(); sendBillFromHistory('${o.phone}', '${o.id}', 'whatsapp')">
        üì± WA
    </button>
    <button class="btn btn-primary w-full btn-sm" onclick="event.stopPropagation(); sendBillFromHistory('${o.phone}', '${o.id}', 'sms')">
        üí¨ SMS
    </button>
</div>
                </div>
            `}).join('');
        }

        // Added 'type' parameter to handle both sms and whatsapp
        function sendBillFromHistory(phone, orderId, type) {
            const { doc, getDoc } = window.firebaseModules;
            getDoc(doc(window.db, 'orders', orderId)).then(snap => {
                if(snap.exists()) {
                    const data = snap.data();
                    // Load data into global state so sendBill() can read it
                    PAYMENT_DATA = { 
                        ...data, 
                        serial: data.timestamp ? data.timestamp.toMillis().toString().slice(-4) : '0000', 
                        bonusEarned: data.bonusEarned || 0, 
                        finalPaid: data.finalPaid || data.total, 
                        change: data.changeReturn || 0, 
                        mode: data.paymentMode || 'Cash' 
                    };
                    // Call the main send function with the specific type
                    sendBill(type);
                }
            });
        }

        async function updateOrderStatus(id, status) {
            await window.firebaseModules.updateDoc(window.firebaseModules.doc(window.db, 'orders', id), { status });
        }

        function editOrder(orderId) {
            const { doc, getDoc } = window.firebaseModules;
            getDoc(doc(window.db, 'orders', orderId)).then(snap => {
                if(snap.exists()) {
                    const data = snap.data();
                    STATE.cart = data.items;
                    STATE.editingOrderId = orderId;
                    switchOutletTab('pos');
                    document.getElementById('posPhone').value = data.phone;
                    document.getElementById('btnPlaceOrder').classList.add('hidden');
                    document.getElementById('btnUpdateOrder').classList.remove('hidden');
                    renderActiveCart();
                    showToast('Order Loaded for Editing');
                }
            });
        }
async function deletePendingOrder(orderId) {
            if(!confirm('Are you sure you want to cancel this order?')) return;
            
            try {
                // FIX: Use updateDoc instead of deleteDoc to avoid Permission Errors.
                // Marking as 'cancelled' removes it from the Pending list essentially "deleting" it from view.
                const { doc, updateDoc } = window.firebaseModules;
                
                await updateDoc(doc(window.db, 'orders', orderId), {
                    status: 'cancelled'
                });
                
                showToast('Order Cancelled Successfully');
            } catch (e) {
                console.error(e);
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function updateExistingOrder() {
            if(!STATE.editingOrderId) return;
            
            // 1. Capture the (potentially edited) Phone Number
            const newPhone = document.getElementById('posPhone').value;
            
            if(!newPhone || newPhone.length !== 10) {
                return showToast('Please enter a valid 10-digit phone number', 'error');
            }

            const total = STATE.cart.reduce((s, i) => s + (i.price * i.qty), 0);
            
            const { doc, updateDoc, getDoc, setDoc, serverTimestamp } = window.firebaseModules;

            try {
                // 2. Ensure Customer Exists (in case the number was changed to a new customer)
                const custRef = doc(window.db, 'customers', newPhone);
                const custSnap = await getDoc(custRef);
                
                let custName = '';
                if (!custSnap.exists()) {
                    // Create new customer profile for the new number
                    await setDoc(custRef, { phone: newPhone, points: 0, joined: serverTimestamp() });
                } else {
                    custName = custSnap.data().name || '';
                }

                // 3. Update the Order with New Items AND New Phone/Name
                await updateDoc(doc(window.db, 'orders', STATE.editingOrderId), {
                    items: STATE.cart, 
                    total: total,
                    phone: newPhone,       // Update Phone
                    customerName: custName // Update Name associated with that phone
                });
                
                showToast('Order & Phone Updated');
                clearCart();
                switchOutletTab('current');

            } catch (e) {
                console.error(e);
                showToast('Update failed: ' + e.message, 'error');
            }
        }

        // --- PAYMENT & BILLING ---
        let PAYMENT_DATA = { orderId: null, total: 0, phone: null, maxPoints: 0 };

        function setPaymentMode(mode) {
            document.getElementById('paymentModeInput').value = mode;
            const btnCash = document.getElementById('btnModeCash');
            const btnOnline = document.getElementById('btnModeOnline');
            const cashSection = document.getElementById('cashCalcSection');
            
            if(mode === 'Cash') {
                btnCash.classList.add('btn-primary');
                btnCash.classList.remove('btn-secondary');
                btnOnline.classList.add('btn-secondary');
                btnOnline.classList.remove('btn-primary');
                cashSection.classList.remove('hidden');
            } else {
                btnOnline.classList.add('btn-primary');
                btnOnline.classList.remove('btn-secondary');
                btnCash.classList.add('btn-secondary');
                btnCash.classList.remove('btn-primary');
                cashSection.classList.add('hidden');
            }
        }

        function calculateChange() {
            const given = parseInt(document.getElementById('cashGiven').value) || 0;
            const redeem = parseInt(document.getElementById('redeemInput').value) || 0;
            const netPayable = PAYMENT_DATA.total - redeem;
            const change = given - netPayable;
            const returnEl = document.getElementById('cashReturn');
            
            if(change >= 0) {
                returnEl.innerText = '‚Çπ' + change;
                returnEl.style.color = 'var(--success)';
            } else {
                returnEl.innerText = 'Short by ‚Çπ' + Math.abs(change);
                returnEl.style.color = 'var(--danger)';
            }
        }

        async function openPaymentModal(orderId, total, phone) {
            PAYMENT_DATA = { orderId, total, phone, maxPoints: 0 };
            
            // UI Reset
            document.getElementById('payCustPhone').innerText = phone;
            document.getElementById('payBillTotal').innerText = '‚Çπ' + total;
            document.getElementById('redeemInput').value = '';
            document.getElementById('payNetTotal').innerText = '‚Çπ' + total;
            document.getElementById('payAvailPoints').innerText = 'Loading...';
            document.getElementById('cashGiven').value = '';
            document.getElementById('cashReturn').innerText = '‚Çπ0';
            
            // SHOW Input Section, HIDE Success Section
            document.getElementById('paymentModal').classList.remove('hidden');
            document.getElementById('paymentInputSection').classList.remove('hidden');
            document.getElementById('paymentSuccessSection').classList.add('hidden');

            setPaymentMode('Cash');

            // Fetch Customer Points
            const { doc, getDoc } = window.firebaseModules;
            const custRef = doc(window.db, 'customers', phone);
            const snap = await getDoc(custRef);
            
            if(snap.exists()) {
                const pts = snap.data().points || 0;
                PAYMENT_DATA.maxPoints = pts;
                document.getElementById('payAvailPoints').innerText = pts + ' pts';
            } else {
                document.getElementById('payAvailPoints').innerText = '0 pts';
            }
        }

        function updatePaymentCalc() {
            let redeem = parseInt(document.getElementById('redeemInput').value) || 0;
            const bill = PAYMENT_DATA.total;
            const max = PAYMENT_DATA.maxPoints;

            if (redeem > max) redeem = max;
            if (redeem > bill) redeem = bill;

            document.getElementById('redeemInput').value = redeem > 0 ? redeem : '';
            document.getElementById('payNetTotal').innerText = '‚Çπ' + (bill - redeem);
            calculateChange();
        }

        function useMaxPoints() {
            let maxUsable = Math.min(PAYMENT_DATA.maxPoints, PAYMENT_DATA.total);
            document.getElementById('redeemInput').value = maxUsable;
            updatePaymentCalc();
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.add('hidden');
        }

        async function processPayment() {
            const redeem = parseInt(document.getElementById('redeemInput').value) || 0;
            const netPayable = PAYMENT_DATA.total - redeem;
            const payMode = document.getElementById('paymentModeInput').value;
            const cashGiven = parseInt(document.getElementById('cashGiven').value) || 0;
            const changeReturn = cashGiven - netPayable;

            if(!confirm(`Confirm Payment?\nMode: ${payMode}\nAmount: ‚Çπ${netPayable}`)) return;

            const { doc, runTransaction } = window.firebaseModules;

            try {
                await runTransaction(window.db, async (transaction) => {
                    const orderRef = doc(window.db, 'orders', PAYMENT_DATA.orderId);
                    const custRef = doc(window.db, 'customers', PAYMENT_DATA.phone);

                    const orderDoc = await transaction.get(orderRef);
                    const custDoc = await transaction.get(custRef);
                    if (!orderDoc.exists()) throw "Order not found!";
                    
                    // Save items for bill
                    PAYMENT_DATA.items = orderDoc.data().items;
                    PAYMENT_DATA.serial = orderDoc.data().timestamp ? orderDoc.data().timestamp.toMillis().toString().slice(-4) : '0000';
                    
                    const currentPoints = custDoc.exists() ? (custDoc.data().points || 0) : 0;
                    if (redeem > currentPoints) throw "Insufficient points!";

                    const newBonus = Math.floor(netPayable * 0.05);
                    
                    // Update Customer
                    if(custDoc.exists()) {
                        transaction.update(custRef, { points: (currentPoints - redeem) + newBonus });
                    }

                    // Update Order
                    transaction.update(orderRef, { 
                        status: 'completed',
                        redeemed: redeem,
                        finalPaid: netPayable,
                        bonusEarned: newBonus,
                        paymentMode: payMode,
                        cashGiven: (payMode === 'Cash' ? cashGiven : 0),
                        changeReturn: (payMode === 'Cash' ? changeReturn : 0)
                    });

                    // Store Data for Bill
                    PAYMENT_DATA.finalPaid = netPayable;
                    PAYMENT_DATA.redeemed = redeem;
                    PAYMENT_DATA.bonusEarned = newBonus;
                    PAYMENT_DATA.cashGiven = cashGiven;
                    PAYMENT_DATA.change = changeReturn;
                    PAYMENT_DATA.mode = payMode;
                });

                // Show Success Screen
                document.getElementById('paymentInputSection').classList.add('hidden');
                document.getElementById('paymentSuccessSection').classList.remove('hidden');
                document.getElementById('billSerial').innerText = PAYMENT_DATA.serial;
                showToast(`Paid! Earned ${PAYMENT_DATA.bonusEarned} pts`);
            } catch (e) {
                console.error(e);
                showToast('Payment Failed: ' + e, 'error');
            }
        }

        function sendBill(type) {
            const s = STATE.storeSettings || { name: 'Juice Therapy', address: '', footer: 'Thank you!', link: '' };
            const d = PAYMENT_DATA;
            const date = new Date().toLocaleString('en-IN');
            
            let text = `üßæ *${s.name}*\n${s.address}\n\n`;
            text += `--------------------------------\n`;
            text += `*BILL RECEIPT* #${d.serial}\nDate: ${date}\nCustomer: ${d.phone}\n`;
            text += `--------------------------------\n`;
            
            if(d.items) {
                d.items.forEach(i => {
                    text += `${i.name} x ${i.qty} = ‚Çπ${i.price * i.qty}\n`;
                });
            }
            
            text += `--------------------------------\n`;
            text += `Total Amount:   ‚Çπ${d.total}\n`;
            if(d.redeemed > 0) text += `Bonus Used:    -‚Çπ${d.redeemed}\n`;
            text += `--------------------------------\n`;
            text += `*NET PAYABLE:   ‚Çπ${d.finalPaid}*\n`;
            text += `Paid via:       ${d.mode}\n`;
            
            if(d.mode === 'Cash') {
                text += `Cash Given:     ‚Çπ${d.cashGiven}\n`;
                text += `Return Change:  ‚Çπ${d.change}\n`;
            }
            
            text += `--------------------------------\n`;
            text += `Points Earned:  +${d.bonusEarned}\n`;
            text += `--------------------------------\n`;
            text += `${s.footer}\n${s.link}`;

            const encoded = encodeURIComponent(text);
            
            if (type === 'whatsapp') {
                window.open(`https://wa.me/91${d.phone}?text=${encoded}`, '_blank');
            } else {
                const shortText = `Bill for ${s.name}: ‚Çπ${d.finalPaid} paid. Points earned: ${d.bonusEarned}. Thanks!`;
                window.open(`sms:${d.phone}?body=${encodeURIComponent(shortText)}`, '_blank');
            }
        }

        // --- CUSTOMER PANEL ---
        function switchCustTab(tab) {
            document.getElementById('btn-cust-menu').classList.toggle('active', tab === 'menu');
            document.getElementById('btn-cust-history').classList.toggle('active', tab === 'history');
            document.getElementById('cust-view-menu').classList.toggle('hidden', tab !== 'menu');
            document.getElementById('cust-view-history').classList.toggle('hidden', tab !== 'history');
        }
function filterCustomerMenu(text) {
    STATE.searchQuery = text.trim().toLowerCase();
    renderCustomerMenu();
}
        function renderCustomerMenu() {
    const sidebar = document.getElementById('custSidebar');
    
    // 1. Render Categories (Safe rendering)
    const cats = ['All', ...STATE.categories.map(c => c.name)];
    
    sidebar.innerHTML = cats.map(cat => {
        const safeCat = cat.replace(/'/g, "\\'"); // Prevent errors with names like "Chef's"
        return `
        <div class="cat-btn ${cat === STATE.activeCategory ? 'active' : ''}" 
             onclick="filterCategory('${safeCat}')">${cat}</div>
        `;
    }).join('');
    
    const grid = document.getElementById('custGrid');
    let items = [];

    // 2. LOGIC FIX: Handle Search vs Category
    if (STATE.searchQuery) {
        // If searching, ignore category and search ALL items
        items = STATE.menu.filter(item => 
            item.name.toLowerCase().includes(STATE.searchQuery)
        );
    } else {
        // If not searching, use Category
        if (STATE.activeCategory === 'All') {
            items = STATE.menu;
        } else {
            // Trim strings to ensure "Juice " matches "Juice"
            items = STATE.menu.filter(m => 
                (m.category || '').trim() === STATE.activeCategory.trim()
            );
        }
    }
    
    // 3. Render Items
    if (items.length === 0) {
        grid.innerHTML = '<div class="text-muted" style="grid-column: 1/-1; text-align:center; padding:20px;">No items found</div>';
    } else {
        grid.innerHTML = items.map(item => {
            const cartItem = STATE.custCart.find(c => c.id === item.id);
            const qty = cartItem ? cartItem.qty : 0;
            
            // Badge & Styling
            const qtyBadge = qty > 0 ? `<div style="position:absolute; top:8px; right:8px; background:white; color:var(--primary); width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; box-shadow:0 2px 4px rgba(0,0,0,0.3); font-size:0.8rem;">${qty}</div>` : '';
            const borderStyle = qty > 0 ? 'border: 1px solid var(--primary); background: rgba(255, 107, 53, 0.1);' : '';

            return `
            <div class="menu-item" onclick="addToCart('${item.id}')" style="position:relative; ${borderStyle}">
                ${qtyBadge}
                <div style="font-weight:600; font-size: 0.9rem; padding-right:15px;">${item.name}</div>
                <div style="color: var(--primary); margin-top:5px;">‚Çπ${item.price}</div>
            </div>
        `}).join('');
    }
}

        function loadCustomerHistory(phone) {
            const { collection, query, where, onSnapshot } = window.firebaseModules;
            
            const q = query(collection(window.db, 'orders'), where('phone', '==', phone));
            
            onSnapshot(q, (snap) => {
                const list = document.getElementById('custHistoryList');
                if(snap.empty) { 
                    list.innerHTML = '<p class="text-center text-muted" style="padding:20px;">No orders found.</p>'; 
                    return; 
                }

                const sortedDocs = snap.docs.sort((a, b) => {
                    const tA = a.data().timestamp ? a.data().timestamp.seconds : 0;
                    const tB = b.data().timestamp ? b.data().timestamp.seconds : 0;
                    return tB - tA;
                });

                list.innerHTML = sortedDocs.map(d => {
                    const o = d.data();
                    let stClass = 'status-pending';
                    if (o.status === 'completed') stClass = 'status-completed';
                    else if (o.status === 'requested') stClass = 'status-requested';
                    else if (o.status === 'cancelled') stClass = 'status-cancelled';

                    let dateStr = 'Processing...';
                    if(o.timestamp) {
                        const dateObj = o.timestamp.toDate();
                        dateStr = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    }

                    return `
                        <div class="order-card">
                            <div class="flex justify-between" style="margin-bottom:8px;">
                                <div style="display:flex; flex-direction:column; gap:4px;">
                                    <span class="order-status ${stClass}" style="width:fit-content;">${o.status.toUpperCase()}</span>
                                    <span style="font-size:0.75rem; color:#888;">${dateStr}</span>
                                </div>
                                <div style="font-weight:bold; font-size:1.1rem;">‚Çπ${o.total}</div>
                            </div>
                            <div class="text-muted" style="font-size:0.85rem; border-top:1px solid rgba(255,255,255,0.05); padding-top:8px;">
                                ${o.items.map(i => `${i.qty} x ${i.name}`).join(', ')}
                            </div>
                        </div>
                    `;
                }).join('');
            });
        }

        function showToast(msg, type='success') {
            const el = document.getElementById('notification');
            el.innerText = msg;
            el.style.backgroundColor = type === 'error' ? 'var(--danger)' : 'var(--surface)';
            el.style.transform = 'translateX(0)';
            setTimeout(() => el.style.transform = 'translateX(150%)', 3000);
        }

        window.installPWA = async () => {
            if (window.deferredPrompt) {
                window.deferredPrompt.prompt();
                const { outcome } = await window.deferredPrompt.userChoice;
                if (outcome === 'accepted') document.getElementById('installBtn').style.display = 'none';
                window.deferredPrompt = null;
            }
        };
// ==========================================
// WEB BLUETOOTH PRINTING LOGIC
// ==========================================
let bluetoothDevice;
let printCharacteristic;

async function connectPrinter() {
    try {
        // 1. Request Device
        bluetoothDevice = await navigator.bluetooth.requestDevice({
            filters: [{ services: ['000018f0-0000-1000-8000-00805f9b34fb'] }], 
            optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
        });

        // 2. Connect
        const server = await bluetoothDevice.gatt.connect();
        const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
        printCharacteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');

        // UI Update
        const btn = document.getElementById('btnConnectPrinter');
        btn.innerText = "‚úÖ Connected";
        btn.classList.remove('btn-warning');
        btn.classList.add('btn-success');
        showToast('Printer Connected!');

        // Handle Disconnect
        bluetoothDevice.addEventListener('gattserverdisconnected', () => {
            printCharacteristic = null;
            btn.innerText = "üñ®Ô∏è Connect";
            btn.classList.add('btn-warning');
            btn.classList.remove('btn-success');
        });

    } catch (error) {
        console.error(error);
        // Fallback for generic printers
        tryGenericConnection();
    }
}

async function tryGenericConnection() {
    try {
        bluetoothDevice = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
        });
        const server = await bluetoothDevice.gatt.connect();
        const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
        printCharacteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');
        
        const btn = document.getElementById('btnConnectPrinter');
        btn.innerText = "‚úÖ Connected";
        btn.classList.remove('btn-warning');
        btn.classList.add('btn-success');
        showToast('Printer Connected!');
    } catch(e) {
        showToast('Connection Failed: ' + e.message, 'error');
    }
}

async function printKOTDirect(orderId) {
    if (!printCharacteristic) return showToast('Please Connect Printer First', 'error');

    const order = STATE.orders.find(o => o.id === orderId);
    if (!order) return showToast('Order not found', 'error');

    const serial = order.timestamp ? order.timestamp.toMillis().toString().slice(-4) : '????';
    const dateObj = order.timestamp ? order.timestamp.toDate() : new Date();
    const time = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    const encoder = new TextEncoder();
    let data = [];
    const addText = (text) => data.push(...encoder.encode(text));
    const addCmd = (...cmds) => data.push(...cmds);

    // ESC/POS Commands
    addCmd(0x1B, 0x40); // Init
    addCmd(0x1B, 0x61, 1); // Center
    addCmd(0x1B, 0x21, 0x30); // Double Height/Width
    addText(`KOT #${serial}\n`);
    addCmd(0x1B, 0x21, 0x00); // Normal
    addText(`${time}\n${order.status.toUpperCase()}\n`);
    addText(`Cust: ${order.customerName || 'Guest'}\n`);
    addText(`Ph: ${order.phone || 'N/A'}\n`);
    addText("--------------------------------\n");
    
    addCmd(0x1B, 0x61, 0); // Left
    order.items.forEach(item => {
        addCmd(0x1B, 0x45, 1); // Bold
        addText(`${item.qty} x ${item.name}\n`);
        addCmd(0x1B, 0x45, 0); // Bold Off
    });

    addText("--------------------------------\n");
    addCmd(0x1B, 0x61, 1); // Center
    addText("KITCHEN COPY\n\n\n"); 

    const uint8Data = new Uint8Array(data);
    const chunkSize = 50;
    
    for (let i = 0; i < uint8Data.length; i += chunkSize) {
        const chunk = uint8Data.slice(i, i + chunkSize);
        await printCharacteristic.writeValue(chunk);
        await new Promise(resolve => setTimeout(resolve, 20));
    }
}
async function printBillDirect(orderId) {
    if (!printCharacteristic) return showToast('Please Connect Printer First', 'error');

    // 1. Fetch Order
    // Try finding in STATE.orders first
    let order = STATE.orders.find(o => o.id === orderId);
    
    // Fallback: If not found (rare) or if we just paid and STATE isn't updated yet, use PAYMENT_DATA
    if (!order && PAYMENT_DATA.orderId === orderId) {
        order = { ...PAYMENT_DATA, items: PAYMENT_DATA.items || [] };
    }
    
    if (!order) return showToast('Order data not found', 'error');
    
    const s = STATE.storeSettings || { name: 'Juice Therapy', address: '', phone: '', footer: 'Thank you!' };

    // 2. Prepare Data
    // Use safe fallbacks for values to prevent crashes
    const serial = (order.timestamp && order.timestamp.toMillis) 
        ? order.timestamp.toMillis().toString().slice(-4) 
        : (PAYMENT_DATA.serial || '----');
        
    const dateObj = (order.timestamp && order.timestamp.toDate) 
        ? order.timestamp.toDate() 
        : new Date();
        
    const date = dateObj.toLocaleDateString();
    const time = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    // Encoder Helpers
    const encoder = new TextEncoder();
    let data = [];
    const addText = (text) => data.push(...encoder.encode(text));
    const addCmd = (...cmds) => data.push(...cmds);

    try {
        // --- START RECEIPT ---
        addCmd(0x1B, 0x40); // Initialize
        addCmd(0x1B, 0x61, 1); // Center Align

        // STORE HEADER
        addCmd(0x1B, 0x21, 0x30); // Double Height/Width
        addText(`${s.name}\n`);
        addCmd(0x1B, 0x21, 0x00); // Normal Text
        
        if(s.address) addText(`${s.address}\n`);
        const storePhone = s.phone || ''; 
        if(storePhone) addText(`Ph: ${storePhone}\n`);
        addText("--------------------------------\n");
        
        // BILL META
        addCmd(0x1B, 0x61, 0); // Left Align
        addText(`Date: ${date} ${time}\n`);
        addText(`Bill No: ${serial}\n`);
        addText(`Cust: ${order.customerName || 'Guest'}\n`);
        addText(`Ph: ${order.phone || 'N/A'}\n`);
        addText("--------------------------------\n");
        
        // ITEMS HEADER
        addText("Item             Qty    Price   Amt\n");
        addText("--------------------------------\n");

        // ITEMS LIST
        if(order.items && Array.isArray(order.items)) {
            order.items.forEach(item => {
                const amt = (item.price * item.qty).toFixed(2);
                addText(`${item.name}\n`);
                // Formatting for 58mm paper (approx 32 chars)
                addText(`   x ${item.qty}    ${item.price}   ${amt}\n`);
            });
        }

        addText("--------------------------------\n");

        // TOTALS
        addCmd(0x1B, 0x61, 2); // Right Align
        addText(`Total:  ${order.total}\n`);
        
        if(order.redeemed > 0) {
            addText(`Bonus Used: -${order.redeemed}\n`);
        }
        
        addCmd(0x1B, 0x45, 1); // Bold ON
        const finalPay = order.finalPaid !== undefined ? order.finalPaid : order.total;
        addText(`NET PAYABLE:  ${finalPay}\n`);
        addCmd(0x1B, 0x45, 0); // Bold OFF
        
        addText(`Mode: ${order.paymentMode || 'Cash'}\n`);
        
        // Cash Details
        // Check both Order object and Payment Data fallback
        const cashGiven = order.cashGiven || PAYMENT_DATA.cashGiven;
        const change = order.changeReturn || PAYMENT_DATA.change;
        
        if(order.paymentMode === 'Cash' && cashGiven) {
            addText(`Cash Given:  ${cashGiven}\n`);
            addText(`Change:  ${change}\n`);
        }

        addText("--------------------------------\n");
        
        // FOOTER
        addCmd(0x1B, 0x61, 1); // Center Align
        const bonusEarned = order.bonusEarned || PAYMENT_DATA.bonusEarned;
        if(bonusEarned > 0) {
            addText(`* Points Earned: ${bonusEarned} *\n`);
        }
        
        if(s.footer) addText(`${s.footer}\n`);
        addText("\n\n\n"); // Feed paper

        // --- SEND TO PRINTER (WITH CHUNKING) ---
        // This is the CRITICAL FIX for long bills
        const uint8Data = new Uint8Array(data);
        const chunkSize = 50; // Safe size for most bluetooth printers
        
        for (let i = 0; i < uint8Data.length; i += chunkSize) {
            const chunk = uint8Data.slice(i, i + chunkSize);
            await printCharacteristic.writeValue(chunk);
            // Tiny delay to let printer buffer process data
            await new Promise(resolve => setTimeout(resolve, 20)); 
        }

    } catch (e) {
        console.error(e);
        showToast('Print Error: ' + e.message, 'error');
    }
}

// ==========================================
// PWA INSTALLATION LOGIC
// ==========================================
let deferredPrompt; 

// AUTOMATIC UPDATE RELOADER (Replaces the old Step 1)
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js').then(reg => {
        reg.addEventListener('updatefound', () => {
            const newWorker = reg.installing;
            newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    // New update found!
                    showToast('Update available! Reloading...');
                    setTimeout(() => window.location.reload(), 2000);
                }
            });
        });
    });
}


// 2. Listen for "Can be installed" event (Android/Chrome/Edge)
window.addEventListener('beforeinstallprompt', (e) => {
    // Prevent Chrome 67 and earlier from automatically showing the prompt
    e.preventDefault();
    // Stash the event so it can be triggered later.
    deferredPrompt = e;
    
    // SHOW the Install Button
    const btn = document.getElementById('pwaInstallBtn');
    if(btn) {
        btn.classList.remove('hidden');
        
        // Add Click Event
        btn.addEventListener('click', async () => {
            // Hide button immediately
            btn.classList.add('hidden');
            // Show the browser's install prompt
            deferredPrompt.prompt();
            // Wait for user choice
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to install prompt: ${outcome}`);
            deferredPrompt = null;
        });
    }
});

// iOS/Safari PWA Install Detection
function isIOS() {
    return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
}

function isInStandaloneMode() {
    return ('standalone' in window.navigator) && (window.navigator.standalone);
}

// Show iOS install instructions if on iOS Safari and not installed
if (isIOS() && !isInStandaloneMode()) {
    // Wait a bit to not overwhelm user on first load
    setTimeout(() => {
        const btn = document.getElementById('pwaInstallBtn');
        if(btn) {
            btn.classList.remove('hidden');
            btn.innerHTML = 'üì≤ Install App';
            
            // Show instructions modal for iOS
            btn.addEventListener('click', () => {
                showIOSInstallInstructions();
            });
        }
    }, 3000); // Show after 3 seconds
}

// Function to show iOS installation instructions
function showIOSInstallInstructions() {
    const modal = document.createElement('div');
    modal.id = 'iosInstallModal';
    modal.style.cssText = `
        position: fixed;
        inset: 0;
        background: rgba(10, 14, 39, 0.95);
        backdrop-filter: blur(10px);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeIn 0.3s ease;
    `;
    
    modal.innerHTML = `
        <div style="
            background: rgba(30, 33, 57, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 30px 24px;
            max-width: 400px;
            width: 100%;
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        ">
            <div style="text-align: center; margin-bottom: 24px;">
                <div style="font-size: 3.5rem; margin-bottom: 16px;">üì≤</div>
                <h2 style="
                    background: linear-gradient(135deg, #FF6B35, #FF8555);
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                    font-size: 1.5rem;
                    font-weight: 800;
                    margin-bottom: 12px;
                ">Install Juice Therapy</h2>
                <p style="color: #9CA3AF; font-size: 0.95rem; line-height: 1.5;">
                    Install this app on your iPhone for the best experience
                </p>
            </div>
            
            <div style="
                background: rgba(255,255,255,0.05);
                border-radius: 16px;
                padding: 20px;
                margin-bottom: 20px;
                border: 1px solid rgba(255,255,255,0.1);
            ">
                <div style="margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                        <div style="
                            width: 32px;
                            height: 32px;
                            border-radius: 8px;
                            background: linear-gradient(135deg, #FF6B35, #FF8555);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 1.2rem;
                            flex-shrink: 0;
                        ">1</div>
                        <p style="color: white; font-size: 0.95rem; margin: 0;">
                            Tap the <strong>Share</strong> button 
                            <span style="font-size: 1.3rem; vertical-align: middle;">‚éã</span>
                            in Safari
                        </p>
                    </div>
                    <p style="color: #9CA3AF; font-size: 0.85rem; margin-left: 44px;">
                        (Bottom of screen on iPhone, top on iPad)
                    </p>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                        <div style="
                            width: 32px;
                            height: 32px;
                            border-radius: 8px;
                            background: linear-gradient(135deg, #FF6B35, #FF8555);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 1.2rem;
                            flex-shrink: 0;
                        ">2</div>
                        <p style="color: white; font-size: 0.95rem; margin: 0;">
                            Scroll and tap <strong>"Add to Home Screen"</strong>
                            <span style="font-size: 1.2rem; vertical-align: middle;">‚ûï</span>
                        </p>
                    </div>
                </div>
                
                <div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="
                            width: 32px;
                            height: 32px;
                            border-radius: 8px;
                            background: linear-gradient(135deg, #FF6B35, #FF8555);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 1.2rem;
                            flex-shrink: 0;
                        ">3</div>
                        <p style="color: white; font-size: 0.95rem; margin: 0;">
                            Tap <strong>"Add"</strong> to confirm
                        </p>
                    </div>
                </div>
            </div>
            
            <button onclick="document.getElementById('iosInstallModal').remove()" style="
                width: 100%;
                padding: 14px;
                background: linear-gradient(135deg, #FF6B35, #E85525);
                color: white;
                border: none;
                border-radius: 12px;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                box-shadow: 0 0 20px rgba(255, 107, 53, 0.3);
            ">Got It!</button>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// 3. Listen for "App Successfully Installed"
window.addEventListener('appinstalled', () => {
    // Hide the button permanently
    const btn = document.getElementById('pwaInstallBtn');
    if(btn) btn.classList.add('hidden');
    console.log('PWA Installed Successfully');
    
    // Optional: Send analytics or show a "Thank You" toast
    showToast('App Installed! Launching...');
});

// ==========================================
// PUSH NOTIFICATION LOGIC
// ==========================================
// REPLACE YOUR OLD FUNCTION WITH THIS NEW ONE
async function requestNotificationPermission() {
    const blocker = document.getElementById('notifBlockerModal');
    const instruction = document.getElementById('permInstruction');

    // 1. Check Current Status
    if (Notification.permission === 'granted') {
        // All good! Hide blocker and proceed
        if(blocker) blocker.classList.add('hidden');
        getAndSaveToken();
    } 
    else if (Notification.permission === 'denied') {
        // User previously said NO. Show strict blocker with instructions.
        if(blocker) blocker.classList.remove('hidden');
        if(instruction) instruction.classList.remove('hidden');
    } 
    else {
        // Status is 'default' (User hasn't been asked yet)
        // Show blocker but hide the "Reset" instruction for now
        if(blocker) blocker.classList.remove('hidden');
        if(instruction) instruction.classList.add('hidden');
    }
}

// NEW HELPER FUNCTION attached to the button
async function retryPermission() {
    const blocker = document.getElementById('notifBlockerModal');
    
    // Attempt to ask again
    const permission = await Notification.requestPermission();
    
    if (permission === 'granted') {
        blocker.classList.add('hidden');
        getAndSaveToken();
        showToast('Thanks! Notifications enabled.');
    } else {
        // If they clicked Block again, show the instructions
        document.getElementById('permInstruction').classList.remove('hidden');
    }
}

// NEW TOKEN SAVING LOGIC (Separated for clarity)
async function getAndSaveToken() {
    try {
        const { getToken, messaging } = window.firebaseModules;
        const registration = await navigator.serviceWorker.ready;

        const token = await getToken(messaging, { 
            vapidKey: 'BNMWPFfWtc6-5ZSm0Eru3u3f-iB7zSpzY2vlHos7HEjbKQPfstSGgFXSnzivajBU4fto4oSKlWCQJwhtjKmNzLQ', // YOUR KEY HERE
            serviceWorkerRegistration: registration
        });

        if (token) {
            console.log('FCM Token:', token);
            // Save to DB
            if (STATE.user && STATE.user.phone) {
                 const { doc, setDoc, serverTimestamp } = window.firebaseModules;
                 await setDoc(doc(window.db, 'customers', STATE.user.phone), {
                    fcmToken: token,
                    lastLogin: serverTimestamp()
                }, { merge: true });
            }
        }
    } catch (err) {
        console.error('Token Error:', err);
    }
}

async function saveTokenToDatabase(token) {
    // Only save if a user is logged in
    if (!STATE.user || !STATE.user.phone) return;

    const { doc, setDoc, serverTimestamp } = window.firebaseModules;
    // Save to a sub-collection 'tokens' or directly on the user doc
    await setDoc(doc(window.db, 'customers', STATE.user.phone), {
        fcmToken: token,
        lastLogin: serverTimestamp()
    }, { merge: true });
    
    console.log('Token saved to database');
}


// ==========================================
// NOTIFICATIONS & OFFERS LOGIC
// ==========================================

function loadCustomerNotifications() {
    const { collection, query, orderBy, onSnapshot, where } = window.firebaseModules;
    // Order by newest first
    const q = query(
        collection(window.db, 'notifications'), 
        where('target', 'in', ['ALL', STATE.user.phone]), 
        orderBy('timestamp', 'desc')
    );

    onSnapshot(q, (snap) => {
        const list = document.getElementById('custNotificationList');
        const badge = document.getElementById('custNotifBadge');
        
        // Safety check: if HTML elements are missing, stop here
        if(!list || !badge) return; 

        if(snap.empty) {
            list.innerHTML = '<div class="text-center text-muted" style="padding:20px;">No new offers at the moment.</div>';
            return;
        }

        // Check for new notifications since last view
        const lastCheck = localStorage.getItem('jt_last_notif_check') || 0;
        let hasNew = false;

        list.innerHTML = snap.docs.map(d => {
            const c = d.data();
            const time = c.timestamp ? c.timestamp.toMillis() : 0;
            const dateStr = c.timestamp ? c.timestamp.toDate().toLocaleDateString() : '';
            
            if(time > lastCheck) hasNew = true;

            return `
            <div style="background:rgba(255,255,255,0.05); border-radius:10px; padding:15px; margin-bottom:15px; border:1px solid rgba(255,255,255,0.1);">
                ${c.image ? `<img src="${c.image}" style="width:100%; max-height:200px; object-fit:cover; border-radius:8px; margin-bottom:10px;">` : ''}
                <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:5px;">
                    <h4 style="color:var(--primary); margin:0;">${c.title}</h4>
                    <span style="font-size:0.7rem; color:#888; white-space:nowrap;">${dateStr}</span>
                </div>
                <p style="font-size:0.95rem; line-height:1.5; color:#eee;">${c.message}</p>
            </div>
            `;
        }).join('');

        if(hasNew) badge.classList.remove('hidden');
    });
}

function openNotifications() {
    const modal = document.getElementById('notificationModal');
    if(modal) {
        modal.classList.remove('hidden');
        // Hide Badge when opened
        document.getElementById('custNotifBadge').classList.add('hidden');
        // Update "Last Seen" timestamp locally
        localStorage.setItem('jt_last_notif_check', Date.now());
    }
}
// --- NEW HELPER FUNCTION ---
async function trackUserActivity(phone) {
    const { doc, updateDoc, serverTimestamp } = window.firebaseModules;
    try {
        // Updates 'lastActive' every time they open the app
        await updateDoc(doc(window.db, 'customers', phone), {
            lastActive: serverTimestamp()
        });
    } catch(e) { console.log("Activity track error", e); }
}
// --- NEW NOTIFICATION HISTORY LOGIC ---
function loadAdminNotificationHistory() {
    const { collection, query, orderBy, onSnapshot, where } = window.firebaseModules;
    
    // Query notifications targeting 'ALL'
    const q = query(
        collection(window.db, 'notifications'), 
        where('target', '==', 'ALL'), 
        orderBy('timestamp', 'desc')
    );

    onSnapshot(q, (snap) => {
        const list = document.getElementById('adminNotifHistory');
        if (!list) return;

        if (snap.empty) {
            list.innerHTML = '<p class="text-muted">No recent broadcasts.</p>';
            return;
        }

        list.innerHTML = snap.docs.map(d => {
            const data = d.data();
            const dateStr = data.timestamp ? data.timestamp.toDate().toLocaleString() : 'Just now';
            // Use the counter from Cloud Function (default to 0 if pending)
            const count = data.deliveryCount !== undefined ? data.deliveryCount : '...';

            return `
            <div class="card" style="padding:10px; border:1px solid rgba(255,255,255,0.1); margin-bottom:10px;">
                <div class="flex justify-between">
                    <strong>${data.title}</strong>
                    <span class="text-muted" style="font-size:0.8rem;">${dateStr}</span>
                </div>
                <div class="text-muted" style="font-size:0.9rem; margin:5px 0;">${data.message}</div>
                
                <div class="flex justify-between items-center" style="margin-top:10px; border-top:1px solid rgba(255,255,255,0.1); padding-top:8px;">
                    <span style="color:var(--success); font-weight:bold;">
                        üì± Delivered to: ${count} devices
                    </span>
                    <button class="btn btn-sm btn-secondary" onclick="resendCampaign('${d.id}')">
                        üîÅ Resend
                    </button>
                </div>
            </div>`;
        }).join('');
    });
}

// --- NEW RESEND LOGIC ---
async function resendCampaign(docId) {
    const { doc, getDoc } = window.firebaseModules;
    const snap = await getDoc(doc(window.db, 'notifications', docId));
    if(snap.exists()) {
        const data = snap.data();
        // Fill the form with old data
        document.getElementById('notifTitle').value = data.title;
        document.getElementById('notifBody').value = data.message;
        document.getElementById('notifImage').value = data.image || '';
        showToast('Campaign details loaded! Click Send.');
        // Scroll to top
        document.getElementById('notifTitle').focus();
    }
}
// --- NEW REPORT FUNCTION ---
async function loadActiveUsersReport() {
    const { collection, query, where, getCountFromServer, Timestamp } = window.firebaseModules;
    
    // Calculate date 7 days ago
    const d = new Date();
    d.setDate(d.getDate() - 7);
    const sevenDaysAgo = Timestamp.fromDate(d);

    // Query: Count users where 'lastActive' > 7 days ago
    const q = query(
        collection(window.db, 'customers'), 
        where('lastActive', '>=', sevenDaysAgo)
    );

    try {
        // NOTE: This requires a Firestore Index. Check console for link if it fails!
        const snapshot = await getCountFromServer(q);
        const activeCount = snapshot.data().count;
        
        // Display it
        const el = document.getElementById('statActiveUsers');
        if(el) el.innerText = activeCount;
    } catch(e) {
        console.log("Report Error (Check Console for Index Link):", e);
    }
}
    </script>

<div id="orderDetailsModal" class="hidden" style="position: fixed; inset: 0; background: rgba(10, 14, 39, 0.95); backdrop-filter: blur(10px); z-index: 500; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s ease;">
    <div class="card" style="width: 90%; max-width: 420px; max-height: 90vh; overflow-y: auto;">
        
        <div class="flex justify-between items-center" style="margin-bottom: 20px; border-bottom: 2px solid rgba(255,107,53,0.2); padding-bottom: 12px;">
            <h3 style="font-size: 1.3rem; font-weight: 700;">Order Details</h3>
            <button class="btn btn-secondary btn-sm" onclick="closeDetailsModal()" style="width: 36px; height: 36px; padding: 0; border-radius: 50%;">‚úñ</button>
        </div>

        <div id="billContent">
            <div class="text-center" style="margin-bottom: 20px;">
                <h2 id="viewStoreName" style="background: linear-gradient(135deg, var(--primary), var(--primary-light)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.5rem; font-weight: 800;">Juice Therapy</h2>
                <p class="text-muted" style="font-size:0.85rem; margin-top: 8px;" id="viewOrderId">#0000</p>
                <p class="text-muted" style="font-size:0.85rem;" id="viewDate">...</p>
            </div>

            <div style="background: rgba(255,255,255,0.06); padding: 14px; border-radius: 12px; margin-bottom: 14px; border: 1px solid rgba(255,255,255,0.1);">
                <label class="text-muted" style="font-size:0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Customer</label>
                <input id="editCustName" class="input" style="margin-bottom:8px; margin-top: 8px;" disabled>
                <input id="editCustPhone" class="input" style="margin-bottom:0;" disabled>
            </div>

            <div id="viewItemsList" style="border-top: 2px dashed rgba(255,107,53,0.2); border-bottom: 2px dashed rgba(255,107,53,0.2); padding: 14px 0; margin-bottom: 14px;"></div>

<div id="editItemsWrapper" class="hidden" style="margin-bottom: 15px; border-top: 1px dashed rgba(255,255,255,0.2); padding-top: 10px;">
    <div id="editItemsList" style="display:flex; flex-direction:column; gap:8px;"></div>
    
    <div style="margin-top: 10px; display:flex; gap:5px;">
        <select id="adminAddItemSelect" class="input" style="margin:0;" onchange="adminAddNewItem(this)">
            <option value="">+ Add Menu Item</option>
        </select>
    </div>
</div>

            <div class="grid-2" style="gap:12px;">
                <div>
                    <label class="text-muted" style="font-size:0.8rem; font-weight: 600;">Total (‚Çπ)</label>
                    <input type="number" id="editTotal" class="input" disabled>
                </div>
                <div>
                    <label class="text-muted" style="font-size:0.8rem; font-weight: 600;">Payment Mode</label>
                    <select id="editMode" class="input" disabled>
                        <option value="Cash">Cash</option>
                        <option value="Online">Online</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="detailsActions" class="flex gap-2" style="margin-top: 24px;">
            <button class="btn btn-secondary w-full" onclick="closeDetailsModal()">Close</button>
            <button id="btnAdminEdit" class="btn btn-warning w-full hidden" onclick="enableAdminEdit()">‚úèÔ∏è Edit</button>
            <button id="btnAdminSave" class="btn btn-success w-full hidden" onclick="saveAdminOrder()">üíæ Save</button>
        </div>
    </div>
</div>
<div id="kot-receipt">
    </div>

<div id="notificationModal" class="hidden" style="position: fixed; inset: 0; background: rgba(10, 14, 39, 0.95); backdrop-filter: blur(10px); z-index: 600; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s ease;">
    <div class="card" style="width: 90%; max-width: 420px; max-height: 80vh; display:flex; flex-direction:column;">
        <div class="flex justify-between items-center" style="margin-bottom: 20px; border-bottom: 2px solid rgba(255,107,53,0.2); padding-bottom: 12px;">
            <h3 style="font-size: 1.3rem; font-weight: 700;">üì¢ Offers & Updates</h3>
            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('notificationModal').classList.add('hidden')" style="width: 36px; height: 36px; padding: 0; border-radius: 50%;">‚úñ</button>
        </div>
        <div id="custNotificationList" style="overflow-y:auto; flex:1; padding-right:8px;">
            </div>
    </div>
</div>

<div id="notifBlockerModal" class="hidden" style="position: fixed; inset: 0; background: linear-gradient(135deg, rgba(10, 14, 39, 0.98), rgba(22, 33, 62, 0.98)); backdrop-filter: blur(20px); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px;">
    <div style="font-size: 5rem; margin-bottom: 30px; animation: pulse 2s ease-in-out infinite;">üîî</div>
    <h2 style="background: linear-gradient(135deg, var(--primary), var(--primary-light)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 2rem; font-weight: 800; margin-bottom: 15px;">Notifications Required</h2>
    <p style="color: var(--text-muted); max-width: 320px; margin-bottom: 40px; line-height: 1.6; font-size: 1.05rem;">
        To use this app, you must enable notifications for order updates.
    </p>
    
    <button class="btn btn-primary" onclick="retryPermission()" style="padding: 16px 40px; font-size: 1.1rem;">Enable Notifications</button>
    
    <p id="permInstruction" class="hidden" style="margin-top: 30px; font-size: 0.95rem; color: var(--warning); border: 2px solid var(--warning); padding: 16px 20px; border-radius: 12px; background: rgba(245, 158, 11, 0.1); max-width: 350px;">
        ‚ö†Ô∏è <strong>Permission Blocked!</strong><br>
        Please click the üîí Lock Icon in your browser address bar and select "Reset Permission" or "Allow".
    </p>
</div>

</body>
</html>
