<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Juice Therapy - Smart POS System</title>
    <meta name="theme-color" content="#FF6B35">
    <meta name="description" content="Smart POS, CRM & Loyalty System">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, query, where, orderBy, onSnapshot, serverTimestamp, increment, Timestamp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-messaging.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCbHeWurSgxdE1cYFvTGsoyzpK7PQ_1Z0o",
            authDomain: "jt-s-pos.firebaseapp.com",
            projectId: "jt-s-pos",
            storageBucket: "jt-s-pos.firebasestorage.app",
            messagingSenderId: "365172962139",
            appId: "1:365172962139:web:eaad048f98d2af1ff8207e"
        };

        const app = initializeApp(firebaseConfig);
        window.auth = getAuth(app);
        window.db = getFirestore(app);
        
        // Try to initialize messaging (optional, for PWA notifications)
        try {
            window.messaging = getMessaging(app);
        } catch (e) {
            console.log('Firebase Messaging not available:', e);
        }

        // Export Firebase modules to window for use in inline scripts
        window.firebaseModules = {
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            collection,
            doc,
            getDoc,
            getDocs,
            setDoc,
            updateDoc,
            deleteDoc,
            query,
            where,
            orderBy,
            onSnapshot,
            serverTimestamp,
            increment,
            Timestamp
        };

        // Set flag that Firebase is ready
        window.firebaseReady = true;

        console.log('üî• Firebase initialized successfully');
        console.log('‚úÖ Firebase modules ready');
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Color System - Vibrant Tropical Theme */
            --primary: #FF6B35;
            --primary-light: #FF8C61;
            --primary-dark: #E05526;
            --secondary: #F7931E;
            --accent: #FFD23F;
            --success: #06D6A0;
            --danger: #EF476F;
            --warning: #FCA311;
            
            /* Neutral Palette */
            --dark: #1A1A2E;
            --dark-2: #16213E;
            --dark-3: #0F3460;
            --light: #FAFAFA;
            --light-2: #F0F0F0;
            --light-3: #E0E0E0;
            --white: #FFFFFF;
            
            /* Gradients */
            --gradient-primary: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            --gradient-secondary: linear-gradient(135deg, #06D6A0 0%, #00B4D8 100%);
            --gradient-dark: linear-gradient(135deg, #1A1A2E 0%, #0F3460 100%);
            --gradient-glass: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            
            /* Shadows */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.16);
            --shadow-xl: 0 12px 48px rgba(0, 0, 0, 0.24);
            --shadow-glow: 0 0 20px rgba(255, 107, 53, 0.3);
            
            /* Typography */
            --font-display: 'Syne', sans-serif;
            --font-body: 'Manrope', sans-serif;
            
            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-2xl: 48px;
            
            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;
            
            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: 500ms cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        body {
            font-family: var(--font-body);
            background: var(--gradient-dark);
            color: var(--white);
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }

        /* Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255, 107, 53, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(6, 214, 160, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(247, 147, 30, 0.1) 0%, transparent 50%);
            animation: backgroundPulse 15s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes backgroundPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Container */
        .app-container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--spacing-lg);
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: var(--spacing-lg);
        }

        .login-card {
            background: var(--gradient-glass);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-xl);
            padding: var(--spacing-2xl);
            box-shadow: var(--shadow-xl);
            max-width: 450px;
            width: 100%;
            animation: slideUp 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-logo {
            text-align: center;
            margin-bottom: var(--spacing-xl);
        }

        .login-logo h1 {
            font-family: var(--font-display);
            font-size: 2.5rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--spacing-sm);
            letter-spacing: -1px;
        }

        .login-logo p {
            color: var(--light-2);
            font-size: 0.95rem;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select {
            width: 100%;
            padding: var(--spacing-md);
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            color: var(--white);
            font-family: var(--font-body);
            font-size: 1rem;
            transition: all var(--transition-base);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        select option {
            background: var(--dark);
            color: var(--white);
        }

        /* Buttons */
        .btn {
            padding: var(--spacing-md) var(--spacing-xl);
            border: none;
            border-radius: var(--radius-md);
            font-family: var(--font-body);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: var(--white);
            box-shadow: var(--shadow-glow);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 30px rgba(255, 107, 53, 0.5);
        }

        .btn-secondary {
            background: var(--gradient-secondary);
            color: var(--white);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(6, 214, 160, 0.4);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-ghost {
            background: rgba(255, 255, 255, 0.05);
            color: var(--white);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .btn-ghost:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--primary);
        }

        .btn-small {
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: 0.85rem;
        }

        .btn-block {
            width: 100%;
        }

        /* Header */
        .app-header {
            background: var(--gradient-glass);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header-left h2 {
            font-family: var(--font-display);
            font-size: 1.8rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--spacing-xs);
        }

        .header-left p {
            color: var(--light-2);
            font-size: 0.9rem;
        }

        .header-right {
            display: flex;
            gap: var(--spacing-md);
            align-items: center;
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--white);
        }

        .user-role {
            font-size: 0.85rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Main Content Grid */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: var(--spacing-xl);
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Cards */
        .card {
            background: var(--gradient-glass);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-lg);
            transition: all var(--transition-base);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .card-title {
            font-family: var(--font-display);
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--white);
        }

        /* Menu Grid */
        .menu-categories {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
        }

        .category-btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-full);
            color: var(--white);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .category-btn:hover,
        .category-btn.active {
            background: var(--gradient-primary);
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: var(--spacing-md);
            max-height: 600px;
            overflow-y: auto;
            padding-right: var(--spacing-sm);
        }

        .menu-grid::-webkit-scrollbar {
            width: 8px;
        }

        .menu-grid::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-full);
        }

        .menu-grid::-webkit-scrollbar-thumb {
            background: var(--gradient-primary);
            border-radius: var(--radius-full);
        }

        .menu-item {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            cursor: pointer;
            transition: all var(--transition-base);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .menu-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity var(--transition-base);
        }

        .menu-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .menu-item:hover::before {
            opacity: 0.1;
        }

        .menu-item.selected {
            background: var(--gradient-primary);
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .menu-item.unavailable {
            opacity: 0.5;
            cursor: not-allowed !important;
            pointer-events: none;
        }

        .menu-item-name {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: var(--spacing-xs);
            position: relative;
            z-index: 1;
        }

        .menu-item-price {
            color: var(--accent);
            font-weight: 700;
            font-size: 1.1rem;
            position: relative;
            z-index: 1;
        }

        /* Order Panel */
        .order-panel {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }

        .current-order {
            background: var(--gradient-glass);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-lg);
        }

        .order-items {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: var(--spacing-lg);
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md);
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-sm);
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .order-item-info h4 {
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }

        .order-item-quantity {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .quantity-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--gradient-primary);
            border: none;
            color: var(--white);
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .quantity-btn:hover {
            transform: scale(1.1);
        }

        .order-summary {
            border-top: 2px solid rgba(255, 255, 255, 0.1);
            padding-top: var(--spacing-lg);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--spacing-sm);
            font-size: 0.95rem;
        }

        .summary-row.total {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent);
            margin-top: var(--spacing-md);
            padding-top: var(--spacing-md);
            border-top: 2px solid rgba(255, 255, 255, 0.1);
        }

        /* Order Queue */
        .order-queue {
            max-height: 400px;
            overflow-y: auto;
        }

        .order-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            transition: all var(--transition-base);
            cursor: pointer;
        }

        .order-card:hover {
            transform: translateX(4px);
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
        }

        .order-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .order-serial {
            font-family: var(--font-display);
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--accent);
        }

        .order-status {
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .order-status.pending {
            background: var(--warning);
            color: var(--dark);
        }

        .order-status.approved {
            background: var(--success);
            color: var(--white);
        }

        .order-status.completed {
            background: var(--dark-3);
            color: var(--light);
        }

        .order-customer {
            font-size: 0.9rem;
            color: var(--light-2);
            margin-bottom: var(--spacing-xs);
        }

        .order-total {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--accent);
        }

        /* Bonus Display */
        .bonus-display {
            background: var(--gradient-secondary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            text-align: center;
            box-shadow: var(--shadow-lg);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .bonus-amount {
            font-family: var(--font-display);
            font-size: 3rem;
            font-weight: 800;
            color: var(--white);
            margin-bottom: var(--spacing-sm);
        }

        .bonus-label {
            font-size: 1rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-lg);
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background: var(--gradient-glass);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            max-width: 500px;
            width: 100%;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .modal-title {
            font-family: var(--font-display);
            font-size: 1.6rem;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--white);
            font-size: 1.5rem;
            cursor: pointer;
            padding: var(--spacing-sm);
            transition: all var(--transition-base);
        }

        .modal-close:hover {
            color: var(--danger);
            transform: rotate(90deg);
        }

        /* Payment Options */
        .payment-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .payment-option {
            padding: var(--spacing-lg);
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-base);
            text-align: center;
        }

        .payment-option:hover,
        .payment-option.selected {
            background: var(--gradient-primary);
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .payment-icon {
            font-size: 2rem;
            margin-bottom: var(--spacing-sm);
        }

        .payment-label {
            font-weight: 600;
            font-size: 1rem;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
            background: var(--gradient-glass);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-left: 4px solid var(--success);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-xl);
            max-width: 350px;
            z-index: 2000;
            animation: slideInRight 0.4s ease-out;
        }

        .notification.error {
            border-left-color: var(--danger);
        }

        .notification.warning {
            border-left-color: var(--warning);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .menu-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                text-align: center;
            }

            .header-right {
                width: 100%;
                justify-content: center;
            }

            .menu-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .login-card {
                padding: var(--spacing-lg);
            }

            .login-logo h1 {
                font-size: 2rem;
            }
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: var(--spacing-lg) auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .tab-btn {
            padding: var(--spacing-md) var(--spacing-lg);
            background: none;
            border: none;
            color: var(--light-2);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all var(--transition-base);
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .tab-btn:hover {
            color: var(--white);
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        /* Install Banner */
        .install-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--gradient-primary);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-xl);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--spacing-md);
            animation: slideUp 0.5s ease-out;
        }
        .install-text { flex: 1; }
        .install-text h3 { font-size: 1rem; margin-bottom: 4px; }
        .install-text p { font-size: 0.85rem; opacity: 0.9; }
        .install-actions { display: flex; gap: var(--spacing-sm); }

        /* POS Layout */
        .pos-layout {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: var(--spacing-md);
            min-height: 400px;
        }
        .category-sidebar {
            background: rgba(255,255,255,0.03);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
            overflow-y: auto;
        }
        .category-item {
            padding: var(--spacing-md);
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-sm);
            cursor: pointer;
            transition: all var(--transition-base);
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
        }
        .category-item:hover, .category-item.active {
            background: var(--gradient-primary);
            border-color: var(--primary);
            transform: translateX(4px);
        }
        .items-grid-container { overflow-y: auto; max-height: 600px; }
        .items-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-md);
        }
        .pos-top-nav {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            background: var(--gradient-glass);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--radius-lg);
            padding: var(--spacing-sm);
        }
        .pos-nav-btn {
            flex: 1;
            padding: var(--spacing-md);
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: var(--radius-md);
            color: var(--white);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-base);
            font-size: 0.95rem;
            font-family: var(--font-body);
        }
        .pos-nav-btn:hover, .pos-nav-btn.active {
            background: var(--gradient-primary);
            border-color: var(--primary);
        }
        .logo-img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
        }

        /* Mobile Responsive */
        @media (max-width: 1200px) {
            .main-content { grid-template-columns: 1fr; }
        }
        @media (max-width: 1024px) {
            .pos-layout { grid-template-columns: 1fr; }
            .category-sidebar {
                display: flex;
                overflow-x: auto;
                gap: var(--spacing-sm);
            }
            .category-item { min-width: 100px; margin-bottom: 0; }
            .items-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            body { font-size: 14px; }
            .app-container { padding: var(--spacing-sm); }
            .menu-grid { grid-template-columns: repeat(2, 1fr); }
            .card { padding: var(--spacing-md); }
            .logo-img { width: 50px; height: 50px; }
            .install-banner { flex-direction: column; text-align: center; }
        }
        @media (max-width: 640px) {
            .items-grid { grid-template-columns: 1fr; }
            .pos-top-nav { flex-direction: column; }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div class="login-logo">
                <img src="logo.png" alt="Juice Therapy Logo" class="logo-img" onerror="this.style.display='none'">
                <h1>üçπ Juice Therapy</h1>
                <p>Smart POS & Loyalty System</p>
            </div>
            
            <div class="form-group">
                <label>Account Type</label>
                <select id="accountType" onchange="handleAccountTypeChange()">
                    <option value="customer">Customer Account</option>
                    <option value="outlet">Outlet Account</option>
                    <option value="admin">Admin Account</option>
                </select>
            </div>

            <!-- Customer Login (Phone Only - No OTP) -->
            <div id="customerLoginFields">
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="customerPhone" placeholder="Enter 10-digit phone number" maxlength="10">
                </div>

                <div class="form-group" id="customerNameGroup">
                    <label>Your Name</label>
                    <input type="text" id="customerName" placeholder="Enter your name (first time only)">
                </div>
            </div>

            <!-- Admin/Outlet Login (Email & Password) -->
            <div id="staffLoginFields" class="hidden">
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="staffEmail" placeholder="your.email@example.com">
                </div>

                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="staffPassword" placeholder="Enter password">
                </div>

                <div class="form-group" id="outletStaffSelectGroup" class="hidden">
                    <label>Select Staff</label>
                    <select id="staffSelect">
                        <option value="">Choose staff member</option>
                    </select>
                </div>
            </div>

            <button class="btn btn-primary btn-block" id="loginBtn" onclick="login()">
                Login
            </button>

            <p style="text-align: center; margin-top: var(--spacing-lg); color: var(--light-2); font-size: 0.85rem;">
                <span id="loginHelpText">Enter your phone number to continue</span>
            </p>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="hidden">
        <div class="app-container">
            <header class="app-header">
                <div class="header-left">
                    <h2>üçπ Admin Dashboard</h2>
                    <p>Complete control of your outlet operations</p>
                </div>
                <div class="header-right">
                    <div class="user-info">
                        <div class="user-name" id="adminName">Admin User</div>
                        <div class="user-role">Administrator</div>
                    </div>
                    <button class="btn btn-ghost btn-small" onclick="logout()">Logout</button>
                </div>
            </header>

            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('menu')">Menu Items</button>
                <button class="tab-btn" onclick="switchTab('orders')">All Orders</button>
                <button class="tab-btn" onclick="switchTab('customers')">Customers</button>
                <button class="tab-btn" onclick="switchTab('staff')">Staff</button>
                <button class="tab-btn" onclick="switchTab('notifications')">Notifications</button>
            </div>

            <div id="menuTab" class="tab-content active">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Menu & Categories</h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary btn-small" onclick="showAddCategoryModal()">+ Category</button>
                            <button class="btn btn-primary btn-small" onclick="showAddItemModal()">+ Add Item</button>
                        </div>
                    </div>
                    
                    <!-- Categories Quick List -->
                    <div style="margin-bottom: 20px; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 12px;">
                        <h4 style="margin-bottom: 12px; font-size: 1rem;">Categories</h4>
                        <div id="categoriesList" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                    </div>
                    
                    <!-- Menu Items by Category -->
                    <div id="adminMenuList"></div>
                </div>
            </div>

            <div id="ordersTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Order History</h3>
                    </div>
                    <div id="adminOrdersList"></div>
                </div>
            </div>

            <div id="customersTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Customer Database</h3>
                    </div>
                    <div id="customersList"></div>
                </div>
            </div>

            <div id="staffTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Staff Management</h3>
                        <button class="btn btn-primary btn-small" onclick="showAddStaffModal()">+ Add Staff</button>
                    </div>
                    <div id="staffList"></div>
                </div>
            </div>

            <div id="notificationsTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Send Notification</h3>
                    </div>
                    <div class="form-group">
                        <label>Notification Title</label>
                        <input type="text" id="notifTitle" placeholder="e.g., New Item Launch!">
                    </div>
                    <div class="form-group">
                        <label>Message</label>
                        <input type="text" id="notifMessage" placeholder="Check out our new Kiwi Blast!">
                    </div>
                    <button class="btn btn-primary" onclick="sendNotification()">Send to All Customers</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Outlet Panel -->
    <div id="outletPanel" class="hidden">
        <div class="app-container">
            <header class="app-header">
                <div class="header-left">
                    <img src="logo.png" alt="Logo" class="logo-img" onerror="this.style.display='none'">
                    <h2>üçπ Outlet POS</h2>
                    <p>Staff: <span id="currentStaff">-</span></p>
                </div>
                <div class="header-right">
                    <div class="user-info">
                        <div class="user-name">Outlet Staff</div>
                        <div class="user-role">Point of Sale</div>
                    </div>
                    <button class="btn btn-ghost btn-small" onclick="logout()">Logout</button>
                </div>
            </header>

            <!-- THREE-BUTTON NAVIGATION -->
            <div class="pos-top-nav">
                <button class="pos-nav-btn active" onclick="showPOSSection('pos')">üõí POS</button>
                <button class="pos-nav-btn" onclick="showPOSSection('current')">üìã Current Orders</button>
                <button class="pos-nav-btn" onclick="showPOSSection('completed')">‚úÖ Today's Completed</button>
            </div>

            <!-- POS SECTION -->
            <div id="posSection">
                <div class="main-content">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Select Items</h3>
                        </div>
                        <div class="pos-layout">
                            <div class="category-sidebar">
                                <h4 style="margin-bottom: 12px; font-size: 0.9rem; text-align: center;">Categories</h4>
                                <div id="outletCategoryList"></div>
                            </div>
                            <div class="items-grid-container">
                                <div class="items-grid" id="outletMenuGrid"></div>
                            </div>
                        </div>
                    </div>

                    <div class="order-panel">
                        <div class="current-order">
                            <h3 class="card-title" style="margin-bottom: var(--spacing-lg);">New Order</h3>
                            <div class="form-group">
                                <label>Customer Phone</label>
                                <input type="tel" id="customerPhone" placeholder="10-digit number" maxlength="10">
                                <small style="color: var(--light-2); display: block; margin-top: 4px;">
                                    Auto-creates customer if new
                                </small>
                            </div>
                            <div class="order-items" id="orderItems"></div>
                            <div class="order-summary">
                                <div class="summary-row"><span>Subtotal:</span><span id="subtotal">‚Çπ0</span></div>
                                <div class="summary-row total"><span>Total:</span><span id="orderTotal">‚Çπ0</span></div>
                            </div>
                            <button class="btn btn-primary btn-block" onclick="placeOrder()">Place Order</button>
                            <button class="btn btn-ghost btn-block" onclick="clearOrder()">Clear</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CURRENT ORDERS SECTION -->
            <div id="currentOrdersSection" class="hidden">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Current Orders</h3>
                        <button class="btn btn-ghost btn-small" onclick="loadCurrentOrders()">üîÑ Refresh</button>
                    </div>
                    <div id="currentOrdersList"></div>
                </div>
            </div>

            <!-- COMPLETED ORDERS SECTION -->
            <div id="completedOrdersSection" class="hidden">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Today's Completed</h3>
                        <button class="btn btn-ghost btn-small" onclick="loadTodayCompleted()">üîÑ Refresh</button>
                    </div>
                    <div id="completedOrdersList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Panel -->
    <div id="customerPanel" class="hidden">
        <div class="app-container">
            <header class="app-header">
                <div class="header-left">
                    <h2>üçπ Juice Therapy</h2>
                    <p>Welcome, <span id="customerName">Guest</span>!</p>
                </div>
                <div class="header-right">
                    <button class="btn btn-ghost btn-small" onclick="showOutletInfo()">üìç Outlet Info</button>
                    <button class="btn btn-ghost btn-small" onclick="logout()">Logout</button>
                </div>
            </header>

            <div class="bonus-display">
                <div class="bonus-amount" id="customerBonus">0</div>
                <div class="bonus-label">Bonus Points Available</div>
                <p style="margin-top: var(--spacing-sm); font-size: 0.9rem; opacity: 0.9;">
                    1 Point = ‚Çπ1 | Earn 5% on every purchase
                </p>
            </div>

            <div style="margin-top: var(--spacing-xl);">
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="switchCustomerTab('browse')">Browse Menu</button>
                    <button class="tab-btn" onclick="switchCustomerTab('myorders')">My Orders</button>
                </div>

                <div id="browseTab" class="tab-content active">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Menu</h3>
                        </div>
                        <div class="menu-categories">
                            <button class="category-btn active" onclick="filterCustomerCategory('all')">All</button>
                            <button class="category-btn" onclick="filterCustomerCategory('juice')">Juices</button>
                            <button class="category-btn" onclick="filterCustomerCategory('smoothie')">Smoothies</button>
                            <button class="category-btn" onclick="filterCustomerCategory('shake')">Shakes</button>
                        </div>
                        <div class="menu-grid" id="customerMenuGrid"></div>
                    </div>

                    <div class="current-order" style="margin-top: var(--spacing-xl);">
                        <h3 class="card-title" style="margin-bottom: var(--spacing-lg);">My Cart</h3>
                        
                        <div class="order-items" id="customerCartItems">
                            <p style="text-align: center; color: var(--light-2); padding: var(--spacing-lg);">
                                Your cart is empty
                            </p>
                        </div>

                        <div class="order-summary">
                            <div class="summary-row total">
                                <span>Total:</span>
                                <span id="customerCartTotal">‚Çπ0</span>
                            </div>
                        </div>

                        <button class="btn btn-primary btn-block" onclick="placeCustomerOrder()" style="margin-top: var(--spacing-lg);">
                            Place Order
                        </button>
                        <button class="btn btn-ghost btn-block" onclick="clearCustomerCart()" style="margin-top: var(--spacing-sm);">
                            Clear Cart
                        </button>
                    </div>
                </div>

                <div id="myordersTab" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Order History</h3>
                        </div>
                        <div id="customerOrderHistory"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Complete Payment</h3>
                <button class="modal-close" onclick="closePaymentModal()">&times;</button>
            </div>

            <div class="form-group">
                <label>Available Bonus Points</label>
                <input type="number" id="availableBonus" readonly>
            </div>

            <div class="form-group">
                <label>Use Bonus Points (‚Çπ)</label>
                <input type="number" id="bonusToUse" min="0" placeholder="Enter amount">
            </div>

            <div class="payment-options">
                <div class="payment-option" onclick="selectPayment('cash')">
                    <div class="payment-icon">üíµ</div>
                    <div class="payment-label">Cash</div>
                </div>
                <div class="payment-option" onclick="selectPayment('online')">
                    <div class="payment-icon">üì±</div>
                    <div class="payment-label">Online</div>
                </div>
            </div>

            <div class="summary-row total" style="margin-bottom: var(--spacing-lg);">
                <span>Final Amount:</span>
                <span id="finalAmount">‚Çπ0</span>
            </div>

            <button class="btn btn-success btn-block" onclick="completePayment()">
                Complete Order
            </button>
        </div>
    </div>

    <!-- Outlet Info Modal -->
    <div id="outletInfoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Outlet Information</h3>
                <button class="modal-close" onclick="closeOutletInfo()">&times;</button>
            </div>

            <div style="line-height: 1.8;">
                <p><strong>Name:</strong> Juice Therapy - Birati</p>
                <p><strong>Address:</strong> 123 Main Road, Birati, Kolkata - 700051</p>
                <p><strong>Phone:</strong> +91 98765 43210</p>
                <p><strong>Opening:</strong> 8:00 AM</p>
                <p><strong>Closing:</strong> 10:00 PM</p>
            </div>

            <button class="btn btn-primary btn-block" onclick="saveContact()" style="margin-top: var(--spacing-lg);">
                üíæ Save to Contacts
            </button>
        </div>
    </div>

    <!-- KOT Print Modal -->
    <div id="kotPrintModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Print KOT</h3>
                <button class="modal-close" onclick="closeKOTModal()">&times;</button>
            </div>

            <div id="kotPreview" style="background: white; color: black; padding: var(--spacing-lg); border-radius: var(--radius-md); font-family: monospace; font-size: 0.9rem; line-height: 1.6; margin-bottom: var(--spacing-lg);">
                <!-- KOT content will be rendered here -->
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                <button class="btn btn-primary" onclick="printKOTBluetooth()">
                    üñ®Ô∏è Print via Bluetooth
                </button>
                <button class="btn btn-secondary" onclick="printKOTBrowser()">
                    üñ®Ô∏è Print via Browser
                </button>
            </div>

            <div style="margin-top: var(--spacing-md);">
                <button class="btn btn-ghost btn-block" onclick="shareKOT()">
                    üì§ Share KOT
                </button>
            </div>
        </div>
    </div>

    <script>
        // Application State
        const APP_STATE = {
            currentUser: null,
            currentRole: null,
            currentStaff: null,
            currentOrder: [],
            currentOrderId: null,
            selectedPayment: null,
            customerCart: [],
            searchQuery: '',
            currentKOTOrder: null,
            bluetoothDevice: null,
            categories: [],
            menu: [],
            customers: {},
            orders: [],
            orderCounter: 1000,
        };

        // Initialize app when Firebase is ready
        async function initializeApp() {
            try {
                // Wait for Firebase to be ready
                let attempts = 0;
                while (!window.firebaseReady && attempts < 20) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }

                if (!window.firebaseReady || !window.firebaseModules) {
                    throw new Error('Firebase not initialized');
                }

                // Load categories from Firestore
                await loadCategories();
                // Load menu items from Firestore
                await loadMenuItems();
                
                console.log('‚úÖ App initialized with Firebase data');
            } catch (error) {
                console.error('Error initializing app:', error);
                // Use default data if Firebase fails
                APP_STATE.categories = [
                    { id: 'juice', name: 'Juices', icon: 'üßÉ' },
                    { id: 'smoothie', name: 'Smoothies', icon: 'ü•§' },
                    { id: 'shake', name: 'Shakes', icon: 'ü•õ' },
                ];
                APP_STATE.menu = [
                    { id: 'item1', name: 'Mango Juice', category: 'juice', price: 80, available: true },
                    { id: 'item2', name: 'Kiwi Juice', category: 'juice', price: 120, available: true },
                    { id: 'item3', name: 'Orange Juice', category: 'juice', price: 60, available: true },
                    { id: 'item4', name: 'Mixed Berry Smoothie', category: 'smoothie', price: 150, available: true },
                    { id: 'item5', name: 'Banana Smoothie', category: 'smoothie', price: 100, available: true },
                    { id: 'item6', name: 'Chocolate Shake', category: 'shake', price: 110, available: true },
                    { id: 'item7', name: 'Vanilla Shake', category: 'shake', price: 100, available: true },
                    { id: 'item8', name: 'Strawberry Shake', category: 'shake', price: 120, available: true },
                ];
                console.log('‚ö†Ô∏è Using default menu data (offline mode)');
            }
        }

        // Load Categories from Firestore
        async function loadCategories() {
            const { collection, getDocs } = window.firebaseModules;
            const categoriesRef = collection(window.db, 'categories');
            const snapshot = await getDocs(categoriesRef);
            
            APP_STATE.categories = [];
            snapshot.forEach(doc => {
                APP_STATE.categories.push({ id: doc.id, ...doc.data() });
            });

            // If no categories exist, create defaults
            if (APP_STATE.categories.length === 0) {
                const defaultCategories = [
                    { id: 'juice', name: 'Juices', icon: 'üßÉ' },
                    { id: 'smoothie', name: 'Smoothies', icon: 'ü•§' },
                    { id: 'shake', name: 'Shakes', icon: 'ü•õ' },
                ];
                
                for (const cat of defaultCategories) {
                    await saveCategory(cat);
                    APP_STATE.categories.push(cat);
                }
            }
        }

        // Load Menu Items from Firestore
        async function loadMenuItems() {
            const { collection, getDocs } = window.firebaseModules;
            const menuRef = collection(window.db, 'menu');
            const snapshot = await getDocs(menuRef);
            
            APP_STATE.menu = [];
            snapshot.forEach(doc => {
                APP_STATE.menu.push({ id: doc.id, ...doc.data() });
            });

            // If no menu items exist, create defaults
            if (APP_STATE.menu.length === 0) {
                const defaultItems = [
                    { name: 'Mango Juice', category: 'juice', price: 80, available: true },
                    { name: 'Kiwi Juice', category: 'juice', price: 120, available: true },
                    { name: 'Orange Juice', category: 'juice', price: 60, available: true },
                    { name: 'Mixed Berry Smoothie', category: 'smoothie', price: 150, available: true },
                    { name: 'Banana Smoothie', category: 'smoothie', price: 100, available: true },
                    { name: 'Chocolate Shake', category: 'shake', price: 110, available: true },
                    { name: 'Vanilla Shake', category: 'shake', price: 100, available: true },
                    { name: 'Strawberry Shake', category: 'shake', price: 120, available: true },
                ];

                for (const item of defaultItems) {
                    const itemId = await saveMenuItem(item);
                    APP_STATE.menu.push({ id: itemId, ...item });
                }
            }
        }

        // Save Category to Firestore
        async function saveCategory(category) {
            const { doc, setDoc } = window.firebaseModules;
            const categoryRef = doc(window.db, 'categories', category.id);
            await setDoc(categoryRef, {
                name: category.name,
                icon: category.icon,
                createdAt: new Date().toISOString()
            });
        }

        // Save Menu Item to Firestore
        async function saveMenuItem(item) {
            const { collection, doc, setDoc } = window.firebaseModules;
            const itemId = item.id || doc(collection(window.db, 'menu')).id;
            const itemRef = doc(window.db, 'menu', itemId);
            
            await setDoc(itemRef, {
                name: item.name,
                category: item.category,
                price: item.price,
                available: item.available !== undefined ? item.available : true,
                createdAt: item.createdAt || new Date().toISOString()
            });
            
            return itemId;
        }

        // Handle Account Type Change
        function handleAccountTypeChange() {
            const accountType = document.getElementById('accountType').value;
            const customerFields = document.getElementById('customerLoginFields');
            const staffFields = document.getElementById('staffLoginFields');
            const outletStaffGroup = document.getElementById('outletStaffSelectGroup');
            const helpText = document.getElementById('loginHelpText');

            if (accountType === 'customer') {
                customerFields.classList.remove('hidden');
                staffFields.classList.add('hidden');
                helpText.textContent = 'Enter your phone number to continue';
            } else {
                customerFields.classList.add('hidden');
                staffFields.classList.remove('hidden');
                
                if (accountType === 'outlet') {
                    outletStaffGroup.classList.remove('hidden');
                    loadStaffList(); // Load staff from Firestore
                    helpText.textContent = 'Outlet staff: Login with email & select your name';
                } else {
                    outletStaffGroup.classList.add('hidden');
                    helpText.textContent = 'Admin: Login with your credentials';
                }
            }
        }

        // Load Staff List from Firestore
        async function loadStaffList() {
            try {
                if (!window.firebaseReady) return;
                
                const { collection, getDocs } = window.firebaseModules;
                const staffRef = collection(window.db, 'staff');
                const snapshot = await getDocs(staffRef);
                
                const staffSelect = document.getElementById('staffSelect');
                staffSelect.innerHTML = '<option value="">Choose staff member</option>';
                
                snapshot.forEach(doc => {
                    const staff = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = staff.name;
                    staffSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading staff:', error);
            }
        }

        // Login Function
        async function login() {
            const accountType = document.getElementById('accountType').value;
            
            if (accountType === 'customer') {
                await loginCustomer();
            } else {
                await loginStaff(accountType);
            }
        }

        // Customer Login (Simple Phone Number - No Authentication)
        async function loginCustomer() {
            const phone = document.getElementById('customerPhone').value;
            const name = document.getElementById('customerName').value;

            if (phone.length !== 10) {
                showNotification('Please enter a valid 10-digit phone number', 'error');
                return;
            }

            try {
                // Use phone number as unique ID (no Firebase Auth needed)
                const customerId = 'customer_' + phone;
                
                const { doc, getDoc, setDoc } = window.firebaseModules;
                const customerRef = doc(window.db, 'customers', customerId);
                const customerDoc = await getDoc(customerRef);

                if (!customerDoc.exists()) {
                    // First time user - require name
                    if (!name) {
                        showNotification('Please enter your name for first-time registration', 'error');
                        return;
                    }

                    // Create new customer
                    await setDoc(customerRef, {
                        name: name,
                        phone: phone,
                        bonusPoints: 0,
                        createdAt: new Date().toISOString()
                    });
                    
                    showNotification(`Welcome ${name}! Account created successfully.`, 'success');
                } else {
                    showNotification(`Welcome back!`, 'success');
                }

                APP_STATE.currentUser = customerId;
                APP_STATE.currentRole = 'customer';

                showCustomerPanel();
                document.getElementById('loginScreen').classList.add('hidden');

            } catch (error) {
                console.error('Error logging in customer:', error);
                showNotification('Login failed: ' + error.message, 'error');
            }
        }

        // Staff Login (Email & Password)
        async function loginStaff(role) {
            const email = document.getElementById('staffEmail').value;
            const password = document.getElementById('staffPassword').value;

            if (!email || !password) {
                showNotification('Please enter email and password', 'error');
                return;
            }

            if (role === 'outlet') {
                const staff = document.getElementById('staffSelect').value;
                if (!staff) {
                    showNotification('Please select a staff member', 'error');
                    return;
                }
                APP_STATE.currentStaff = staff;
            }

            try {
                const { signInWithEmailAndPassword } = window.firebaseModules;
                const userCredential = await signInWithEmailAndPassword(window.auth, email, password);
                const user = userCredential.user;

                // Verify role in Firestore
                const { doc, getDoc } = window.firebaseModules;
                const userRef = doc(window.db, 'users', user.uid);
                const userDoc = await getDoc(userRef);

                if (!userDoc.exists()) {
                    await window.auth.signOut();
                    showNotification('User not authorized', 'error');
                    return;
                }

                const userData = userDoc.data();
                if (userData.role !== role) {
                    await window.auth.signOut();
                    showNotification(`This account is not authorized as ${role}`, 'error');
                    return;
                }

                APP_STATE.currentUser = user.uid;
                APP_STATE.currentRole = role;

                if (role === 'admin') {
                    showAdminPanel();
                } else if (role === 'outlet') {
                    showOutletPanel();
                }

                document.getElementById('loginScreen').classList.add('hidden');
                showNotification('Login successful!', 'success');

            } catch (error) {
                console.error('Login error:', error);
                if (error.code === 'auth/invalid-credential') {
                    showNotification('Invalid email or password', 'error');
                } else {
                    showNotification('Login failed: ' + error.message, 'error');
                }
            }
        }

        // Logout
        async function logout() {
            try {
                // Only sign out from Firebase Auth if it's staff (admin/outlet)
                if (APP_STATE.currentRole !== 'customer') {
                    await window.auth.signOut();
                }
                
                APP_STATE.currentUser = null;
                APP_STATE.currentRole = null;
                APP_STATE.currentStaff = null;
                APP_STATE.currentOrder = [];
                APP_STATE.customerCart = [];
                
                document.getElementById('adminPanel').classList.add('hidden');
                document.getElementById('outletPanel').classList.add('hidden');
                document.getElementById('customerPanel').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                
                // Reset form
                document.getElementById('customerPhone').value = '';
                document.getElementById('staffEmail').value = '';
                document.getElementById('staffPassword').value = '';
                document.getElementById('staffSelect').value = '';
                document.getElementById('customerName').value = '';
                document.getElementById('loginBtn').disabled = false;
                
                showNotification('Logged out successfully', 'success');
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Show Panels
        function showAdminPanel() {
            document.getElementById('adminPanel').classList.remove('hidden');
            renderCategoriesList();
            renderAdminMenu();
            renderCustomersList();
            renderStaffList();
        }

        function showOutletPanel() {
            document.getElementById('outletPanel').classList.remove('hidden');
            document.getElementById('currentStaff').textContent = 
                document.getElementById('staffSelect').options[document.getElementById('staffSelect').selectedIndex].text;
            renderOutletMenu();
            renderCurrentOrders();
            renderTodayCompletedOrders();
        }

        function showCustomerPanel() {
            document.getElementById('customerPanel').classList.remove('hidden');
            loadCustomerData();
            renderCustomerMenu();
            renderCustomerOrderHistory();
        }

        // Load Customer Data from Firestore
        async function loadCustomerData() {
            try {
                const { doc, getDoc } = window.firebaseModules;
                const customerRef = doc(window.db, 'customers', APP_STATE.currentUser);
                const customerDoc = await getDoc(customerRef);

                if (customerDoc.exists()) {
                    const customer = customerDoc.data();
                    document.getElementById('customerName').textContent = customer.name;
                    document.getElementById('customerBonus').textContent = customer.bonusPoints || 0;
                }
            } catch (error) {
                console.error('Error loading customer data:', error);
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            console.log('üçπ Juice Therapy POS System Loaded');
            initializeApp();
            handleAccountTypeChange(); // Set initial state
        });
        function renderOutletMenu() {
            const grid = document.getElementById('outletMenuGrid');
            
            // Filter by search query
            let filteredMenu = APP_STATE.menu;
            if (APP_STATE.searchQuery) {
                filteredMenu = filteredMenu.filter(item => 
                    item.name.toLowerCase().includes(APP_STATE.searchQuery.toLowerCase())
                );
            }

            if (filteredMenu.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: var(--light-2); padding: var(--spacing-lg); grid-column: 1/-1;">No items found</p>';
                return;
            }

            grid.innerHTML = filteredMenu.map(item => `
                <div class="menu-item ${APP_STATE.currentOrder.find(o => o.id === '${item.id}') ? 'selected' : ''} ${!item.available ? 'unavailable' : ''}" 
                     onclick="${item.available ? `addToOrder('${item.id}')` : ''}" 
                     data-category="${item.category}"
                     style="${!item.available ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                    <div class="menu-item-name">${item.name}</div>
                    <div class="menu-item-price">‚Çπ${item.price}</div>
                    ${!item.available ? '<div style="font-size: 0.7rem; color: var(--danger); margin-top: 4px;">Out of Stock</div>' : ''}
                </div>
            `).join('');

            // Update category buttons
            updateCategoryButtons('outlet');
        }

        // Update Category Buttons
        function updateCategoryButtons(panel) {
            const containerSelector = panel === 'outlet' ? '#outletPanel .menu-categories' : '#customerPanel .menu-categories';
            const container = document.querySelector(containerSelector);
            if (!container) return;

            container.innerHTML = `
                <button class="category-btn active" onclick="${panel === 'outlet' ? 'filterCategory' : 'filterCustomerCategory'}('all')">All</button>
                ${APP_STATE.categories.map(cat => `
                    <button class="category-btn" onclick="${panel === 'outlet' ? 'filterCategory' : 'filterCustomerCategory'}('${cat.id}')">
                        ${cat.icon} ${cat.name}
                    </button>
                `).join('')}
            `;
        }

        // Search Menu Items
        function searchMenuItems(query) {
            APP_STATE.searchQuery = query;
            renderOutletMenu();
        }

        // Add to Order
        function addToOrder(itemId) {
            const item = APP_STATE.menu.find(i => i.id === itemId);
            if (!item) {
                console.error('Item not found:', itemId);
                return;
            }
            
            const existingItem = APP_STATE.currentOrder.find(o => o.id === itemId);

            if (existingItem) {
                existingItem.quantity++;
            } else {
                APP_STATE.currentOrder.push({ ...item, quantity: 1 });
            }

            updateOrderDisplay();
            renderOutletMenu();
        }

        // Update Order Display
        function updateOrderDisplay() {
            const container = document.getElementById('orderItems');
            
            if (APP_STATE.currentOrder.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--light-2); padding: var(--spacing-lg);">Select items from menu</p>';
                document.getElementById('subtotal').textContent = '‚Çπ0';
                document.getElementById('orderTotal').textContent = '‚Çπ0';
                return;
            }

            container.innerHTML = APP_STATE.currentOrder.map(item => `
                <div class="order-item">
                    <div class="order-item-info">
                        <h4>${item.name}</h4>
                        <div style="color: var(--accent); font-weight: 700;">‚Çπ${item.price} √ó ${item.quantity}</div>
                    </div>
                    <div class="order-item-quantity">
                        <button class="quantity-btn" onclick="decreaseQuantity(${item.id})">-</button>
                        <span style="font-weight: 700; min-width: 30px; text-align: center;">${item.quantity}</span>
                        <button class="quantity-btn" onclick="increaseQuantity(${item.id})">+</button>
                    </div>
                </div>
            `).join('');

            const subtotal = APP_STATE.currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('subtotal').textContent = `‚Çπ${subtotal}`;
            document.getElementById('orderTotal').textContent = `‚Çπ${subtotal}`;
        }

        // Quantity controls
        function increaseQuantity(itemId) {
            const item = APP_STATE.currentOrder.find(o => o.id === itemId);
            if (item) {
                item.quantity++;
                updateOrderDisplay();
            }
        }

        function decreaseQuantity(itemId) {
            const item = APP_STATE.currentOrder.find(o => o.id === itemId);
            if (item) {
                item.quantity--;
                if (item.quantity === 0) {
                    APP_STATE.currentOrder = APP_STATE.currentOrder.filter(o => o.id !== itemId);
                    renderOutletMenu();
                }
                updateOrderDisplay();
            }
        }

        // Place Order
        function placeOrder() {
            const phone = document.getElementById('customerPhone').value;

            if (!phone || phone.length !== 10) {
                showNotification('Please enter customer phone number', 'error');
                return;
            }

            if (APP_STATE.currentOrder.length === 0) {
                showNotification('Please add items to order', 'error');
                return;
            }

            const order = {
                id: ++APP_STATE.orderCounter,
                serialNo: `JT-${APP_STATE.orderCounter}`,
                customerPhone: phone,
                customerName: APP_STATE.customers[phone]?.name || 'Guest',
                items: [...APP_STATE.currentOrder],
                totalAmount: APP_STATE.currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                bonusUsed: 0,
                paymentMode: null,
                status: 'pending',
                staffId: APP_STATE.currentStaff,
                createdAt: new Date().toISOString()
            };

            APP_STATE.orders.push(order);
            APP_STATE.currentOrder = [];
            
            updateOrderDisplay();
            renderOutletMenu();
            renderCurrentOrders();
            document.getElementById('customerPhone').value = '';

            showNotification('Order placed successfully!', 'success');
        }

        // Clear Order
        function clearOrder() {
            APP_STATE.currentOrder = [];
            updateOrderDisplay();
            renderOutletMenu();
            document.getElementById('customerPhone').value = '';
        }

        // Render Current Orders
        function renderCurrentOrders() {
            const container = document.getElementById('currentOrdersQueue');
            const pendingOrders = APP_STATE.orders.filter(o => o.status === 'pending' || o.status === 'approved');

            if (pendingOrders.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--light-2); padding: var(--spacing-lg);">No current orders</p>';
                return;
            }

            container.innerHTML = pendingOrders.map(order => `
                <div class="order-card" onclick="viewOrder(${order.id})">
                    <div class="order-card-header">
                        <div class="order-serial">${order.serialNo}</div>
                        <div class="order-status ${order.status}">${order.status}</div>
                    </div>
                    <div class="order-customer">${order.customerName} - ${order.customerPhone}</div>
                    <div class="order-total">‚Çπ${order.totalAmount}</div>
                    <div style="margin-top: var(--spacing-sm); display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--spacing-sm);">
                        <button class="btn btn-success btn-small" onclick="event.stopPropagation(); completeOrderClick(${order.id})">Complete</button>
                        <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); showKOTPrint(${order.id})">üñ®Ô∏è KOT</button>
                        <button class="btn btn-ghost btn-small" onclick="event.stopPropagation(); editOrder(${order.id})">Edit</button>
                    </div>
                </div>
            `).join('');
        }

        // Render Today's Completed Orders
        function renderTodayCompletedOrders() {
            const container = document.getElementById('todayCompletedOrders');
            const today = new Date().toDateString();
            const todayOrders = APP_STATE.orders.filter(o => 
                o.status === 'completed' && new Date(o.completedAt).toDateString() === today
            );

            if (todayOrders.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--light-2); padding: var(--spacing-lg);">No orders completed today</p>';
                return;
            }

            const totalSales = todayOrders.reduce((sum, o) => sum + o.totalAmount - o.bonusUsed, 0);
            const totalOrders = todayOrders.length;

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                    <div style="background: var(--gradient-primary); padding: var(--spacing-lg); border-radius: var(--radius-md); text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; margin-bottom: var(--spacing-xs);">‚Çπ${totalSales}</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Total Sales</div>
                    </div>
                    <div style="background: var(--gradient-secondary); padding: var(--spacing-lg); border-radius: var(--radius-md); text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; margin-bottom: var(--spacing-xs);">${totalOrders}</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Orders</div>
                    </div>
                </div>
                <div class="order-queue">
                    ${todayOrders.reverse().map(order => `
                        <div class="order-card" onclick="viewOrder(${order.id})">
                            <div class="order-card-header">
                                <div class="order-serial">${order.serialNo}</div>
                                <div style="font-size: 0.75rem; color: var(--light-2);">
                                    ${new Date(order.completedAt).toLocaleTimeString()}
                                </div>
                            </div>
                            <div class="order-customer">${order.customerName} - ${order.customerPhone}</div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: var(--spacing-sm);">
                                <div class="order-total">‚Çπ${order.totalAmount - order.bonusUsed}</div>
                                <div style="font-size: 0.8rem; padding: 4px 8px; background: rgba(255,255,255,0.1); border-radius: 6px;">
                                    ${order.paymentMode === 'cash' ? 'üíµ Cash' : 'üì± Online'}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Switch Outlet Tab
        function switchOutletTab(tab) {
            document.querySelectorAll('#outletPanel .tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            if (tab === 'current') {
                document.getElementById('currentOrdersTab').classList.add('active');
                document.getElementById('todayOrdersTab').classList.remove('active');
                renderCurrentOrders();
            } else if (tab === 'today') {
                document.getElementById('currentOrdersTab').classList.remove('active');
                document.getElementById('todayOrdersTab').classList.add('active');
                renderTodayCompletedOrders();
            }
        }

        // Complete Order Click
        function completeOrderClick(orderId) {
            APP_STATE.currentOrderId = orderId;
            const order = APP_STATE.orders.find(o => o.id === orderId);
            const customer = APP_STATE.customers[order.customerPhone];

            document.getElementById('availableBonus').value = customer?.bonusPoints || 0;
            document.getElementById('bonusToUse').value = 0;
            document.getElementById('finalAmount').textContent = `‚Çπ${order.totalAmount}`;
            
            document.getElementById('paymentModal').classList.add('active');
        }

        // Payment Modal Functions
        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('active');
            APP_STATE.currentOrderId = null;
            APP_STATE.selectedPayment = null;
            document.querySelectorAll('.payment-option').forEach(el => el.classList.remove('selected'));
        }

        function selectPayment(mode) {
            APP_STATE.selectedPayment = mode;
            document.querySelectorAll('.payment-option').forEach(el => el.classList.remove('selected'));
            event.target.closest('.payment-option').classList.add('selected');
        }

        document.getElementById('bonusToUse').addEventListener('input', function() {
            const order = APP_STATE.orders.find(o => o.id === APP_STATE.currentOrderId);
            const available = parseInt(document.getElementById('availableBonus').value) || 0;
            const toUse = Math.min(parseInt(this.value) || 0, available, order.totalAmount);
            
            this.value = toUse;
            document.getElementById('finalAmount').textContent = `‚Çπ${order.totalAmount - toUse}`;
        });

        // Complete Payment
        function completePayment() {
            if (!APP_STATE.selectedPayment) {
                showNotification('Please select payment method', 'error');
                return;
            }

            const order = APP_STATE.orders.find(o => o.id === APP_STATE.currentOrderId);
            const bonusUsed = parseInt(document.getElementById('bonusToUse').value) || 0;
            const paidAmount = order.totalAmount - bonusUsed;

            order.bonusUsed = bonusUsed;
            order.paymentMode = APP_STATE.selectedPayment;
            order.status = 'completed';
            order.completedAt = new Date().toISOString();

            // Update customer data
            if (!APP_STATE.customers[order.customerPhone]) {
                APP_STATE.customers[order.customerPhone] = { name: order.customerName, bonusPoints: 0, orders: [] };
            }

            const customer = APP_STATE.customers[order.customerPhone];
            customer.bonusPoints -= bonusUsed;
            customer.bonusPoints += Math.floor(paidAmount * 0.05);
            customer.orders.push(order);

            // Generate WhatsApp bill
            const billText = generateBill(order);
            const whatsappUrl = `https://wa.me/91${order.customerPhone}?text=${encodeURIComponent(billText)}`;
            window.open(whatsappUrl, '_blank');

            closePaymentModal();
            renderCurrentOrders();
            showNotification('Order completed! WhatsApp bill sent.', 'success');
        }

        // View Order Details
        function viewOrder(orderId) {
            const order = APP_STATE.orders.find(o => o.id === orderId);
            if (!order) return;

            const itemsList = order.items.map(item => 
                `${item.name} (${item.quantity}) - ‚Çπ${item.price * item.quantity}`
            ).join('\n');

            alert(`Order Details\n\n` +
                  `Serial: ${order.serialNo}\n` +
                  `Customer: ${order.customerName}\n` +
                  `Phone: ${order.customerPhone}\n` +
                  `Status: ${order.status}\n\n` +
                  `Items:\n${itemsList}\n\n` +
                  `Total: ‚Çπ${order.totalAmount}\n` +
                  `Bonus Used: ‚Çπ${order.bonusUsed}\n` +
                  `Payment: ${order.paymentMode || 'Pending'}`
            );
        }

        // Edit Order
        function editOrder(orderId) {
            const order = APP_STATE.orders.find(o => o.id === orderId);
            if (!order) return;

            if (order.status === 'completed') {
                showNotification('Cannot edit completed orders', 'error');
                return;
            }

            // Load order into current order
            APP_STATE.currentOrder = order.items.map(item => ({...item}));
            document.getElementById('customerPhone').value = order.customerPhone;
            
            // Remove from orders list temporarily
            APP_STATE.orders = APP_STATE.orders.filter(o => o.id !== orderId);
            
            updateOrderDisplay();
            renderOutletMenu();
            renderCurrentOrders();
            
            showNotification('Order loaded for editing', 'success');
        }

        // Show Add Item Modal (Admin)
        function showAddItemModal() {
            const name = prompt('Enter item name:');
            if (!name) return;

            // Show category selection
            const categoryOptions = APP_STATE.categories.map((cat, idx) => 
                `${idx + 1}. ${cat.icon} ${cat.name}`
            ).join('\n');
            
            const categoryChoice = prompt(`Select category:\n${categoryOptions}\n\nEnter number:`);
            if (!categoryChoice) return;

            const categoryIndex = parseInt(categoryChoice) - 1;
            if (categoryIndex < 0 || categoryIndex >= APP_STATE.categories.length) {
                showNotification('Invalid category selection', 'error');
                return;
            }

            const category = APP_STATE.categories[categoryIndex].id;

            const price = parseInt(prompt('Enter price (‚Çπ):'));
            if (!price || isNaN(price)) {
                showNotification('Invalid price', 'error');
                return;
            }

            const newItem = {
                id: Math.max(...APP_STATE.menu.map(m => m.id), 0) + 1,
                name: name,
                category: category,
                price: price,
                available: true
            };

            APP_STATE.menu.push(newItem);
            renderAdminMenu();
            renderOutletMenu();
            renderCustomerMenu();
            showNotification(`${name} added successfully!`, 'success');
        }

        // Show Add Category Modal (Admin)
        function showAddCategoryModal() {
            const name = prompt('Enter category name:');
            if (!name) return;

            const icon = prompt('Enter emoji icon (e.g., üçπ):');
            if (!icon) return;

            const id = name.toLowerCase().replace(/\s+/g, '-');

            // Check if category already exists
            if (APP_STATE.categories.find(c => c.id === id)) {
                showNotification('Category already exists', 'error');
                return;
            }

            const newCategory = {
                id: id,
                name: name,
                icon: icon
            };

            APP_STATE.categories.push(newCategory);
            renderCategoriesList();
            renderOutletMenu();
            renderCustomerMenu();
            showNotification(`Category "${name}" created!`, 'success');
        }

        // Delete Category
        function deleteCategory(categoryId) {
            const itemCount = APP_STATE.menu.filter(m => m.category === categoryId).length;
            
            if (itemCount > 0) {
                const confirm = window.confirm(`This category has ${itemCount} items. Delete anyway? Items will also be deleted.`);
                if (!confirm) return;
                
                // Delete all items in this category
                APP_STATE.menu = APP_STATE.menu.filter(m => m.category !== categoryId);
            }

            APP_STATE.categories = APP_STATE.categories.filter(c => c.id !== categoryId);
            renderCategoriesList();
            renderAdminMenu();
            renderOutletMenu();
            renderCustomerMenu();
            showNotification('Category deleted', 'success');
        }

        // Edit Category
        function editCategory(categoryId) {
            const category = APP_STATE.categories.find(c => c.id === categoryId);
            if (!category) return;

            const newName = prompt('Enter new category name:', category.name);
            if (!newName) return;

            const newIcon = prompt('Enter new emoji icon:', category.icon);
            if (!newIcon) return;

            category.name = newName;
            category.icon = newIcon;

            renderCategoriesList();
            showNotification('Category updated', 'success');
        }

        // Delete Menu Item
        function deleteMenuItem(itemId) {
            const item = APP_STATE.menu.find(m => m.id === itemId);
            if (!item) return;

            const confirm = window.confirm(`Delete "${item.name}"?`);
            if (!confirm) return;

            APP_STATE.menu = APP_STATE.menu.filter(m => m.id !== itemId);
            renderAdminMenu();
            renderOutletMenu();
            renderCustomerMenu();
            showNotification('Item deleted', 'success');
        }

        // Edit Menu Item
        function editMenuItem(itemId) {
            const item = APP_STATE.menu.find(m => m.id === itemId);
            if (!item) return;

            const newName = prompt('Enter new name:', item.name);
            if (!newName) return;

            const newPrice = parseInt(prompt('Enter new price:', item.price));
            if (!newPrice || isNaN(newPrice)) {
                showNotification('Invalid price', 'error');
                return;
            }

            item.name = newName;
            item.price = newPrice;

            renderAdminMenu();
            renderOutletMenu();
            renderCustomerMenu();
            showNotification('Item updated', 'success');
        }

        // Toggle Item Availability
        function toggleItemAvailability(itemId) {
            const item = APP_STATE.menu.find(m => m.id === itemId);
            if (!item) return;

            item.available = !item.available;
            renderAdminMenu();
            renderOutletMenu();
            renderCustomerMenu();
            showNotification(`${item.name} is now ${item.available ? 'available' : 'unavailable'}`, 'success');
        }

        // Generate Bill Text
        function generateBill(order) {
            const bonusEarned = Math.floor((order.totalAmount - order.bonusUsed) * 0.05);
            return `üçπ *Juice Therapy ‚Äì Birati*

Order No: ${order.serialNo}
Customer: ${order.customerName}
Phone: ${order.customerPhone}

*Items:*
${order.items.map(item => `‚Ä¢ ${item.name} (${item.quantity}) ‚Äì ‚Çπ${item.price * item.quantity}`).join('\n')}

Bonus Used: ‚Çπ${order.bonusUsed}
Paid Amount: ‚Çπ${order.totalAmount - order.bonusUsed}
Payment Mode: ${order.paymentMode.toUpperCase()}

üéÅ You earned ${bonusEarned} bonus points!

üôè Thank you for choosing Juice Therapy!`;
        }

        // Filter Category
        function filterCategory(category) {
            document.querySelectorAll('#outletPanel .category-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            const items = document.querySelectorAll('#outletMenuGrid .menu-item');
            items.forEach(item => {
                if (category === 'all' || item.dataset.category === category) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Customer Functions
        function renderCustomerMenu() {
            const grid = document.getElementById('customerMenuGrid');
            grid.innerHTML = APP_STATE.menu.filter(item => item.available).map(item => `
                <div class="menu-item ${APP_STATE.customerCart.find(o => o.id === '${item.id}') ? 'selected' : ''}" 
                     onclick="addToCustomerCart('${item.id}')" data-category="${item.category}">
                    <div class="menu-item-name">${item.name}</div>
                    <div class="menu-item-price">‚Çπ${item.price}</div>
                </div>
            `).join('');

            updateCategoryButtons('customer');
        }

        function addToCustomerCart(itemId) {
            const item = APP_STATE.menu.find(i => i.id === itemId);
            if (!item) {
                console.error('Item not found:', itemId);
                return;
            }
            
            const existingItem = APP_STATE.customerCart.find(o => o.id === itemId);

            if (existingItem) {
                existingItem.quantity++;
            } else {
                APP_STATE.customerCart.push({ ...item, quantity: 1 });
            }

            updateCustomerCartDisplay();
            renderCustomerMenu();
        }

        function updateCustomerCartDisplay() {
            const container = document.getElementById('customerCartItems');
            
            if (APP_STATE.customerCart.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--light-2); padding: var(--spacing-lg);">Your cart is empty</p>';
                document.getElementById('customerCartTotal').textContent = '‚Çπ0';
                return;
            }

            container.innerHTML = APP_STATE.customerCart.map(item => `
                <div class="order-item">
                    <div class="order-item-info">
                        <h4>${item.name}</h4>
                        <div style="color: var(--accent); font-weight: 700;">‚Çπ${item.price} √ó ${item.quantity}</div>
                    </div>
                    <div class="order-item-quantity">
                        <button class="quantity-btn" onclick="decreaseCustomerCartQuantity(${item.id})">-</button>
                        <span style="font-weight: 700; min-width: 30px; text-align: center;">${item.quantity}</span>
                        <button class="quantity-btn" onclick="increaseCustomerCartQuantity(${item.id})">+</button>
                    </div>
                </div>
            `).join('');

            const total = APP_STATE.customerCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('customerCartTotal').textContent = `‚Çπ${total}`;
        }

        function increaseCustomerCartQuantity(itemId) {
            const item = APP_STATE.customerCart.find(o => o.id === itemId);
            if (item) {
                item.quantity++;
                updateCustomerCartDisplay();
            }
        }

        function decreaseCustomerCartQuantity(itemId) {
            const item = APP_STATE.customerCart.find(o => o.id === itemId);
            if (item) {
                item.quantity--;
                if (item.quantity === 0) {
                    APP_STATE.customerCart = APP_STATE.customerCart.filter(o => o.id !== itemId);
                    renderCustomerMenu();
                }
                updateCustomerCartDisplay();
            }
        }

        function placeCustomerOrder() {
            if (APP_STATE.customerCart.length === 0) {
                showNotification('Please add items to cart', 'error');
                return;
            }

            const customer = APP_STATE.customers[APP_STATE.currentUser];
            const order = {
                id: ++APP_STATE.orderCounter,
                serialNo: `JT-${APP_STATE.orderCounter}`,
                customerPhone: APP_STATE.currentUser,
                customerName: customer.name,
                items: [...APP_STATE.customerCart],
                totalAmount: APP_STATE.customerCart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                bonusUsed: 0,
                paymentMode: null,
                status: 'pending',
                staffId: null,
                createdAt: new Date().toISOString()
            };

            APP_STATE.orders.push(order);
            APP_STATE.customerCart = [];
            
            updateCustomerCartDisplay();
            renderCustomerMenu();
            renderCustomerOrderHistory();

            showNotification('Order placed! Waiting for outlet approval.', 'success');
        }

        function clearCustomerCart() {
            APP_STATE.customerCart = [];
            updateCustomerCartDisplay();
            renderCustomerMenu();
        }

        function filterCustomerCategory(category) {
            document.querySelectorAll('#customerPanel .category-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            const items = document.querySelectorAll('#customerMenuGrid .menu-item');
            items.forEach(item => {
                if (category === 'all' || item.dataset.category === category) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function renderCustomerOrderHistory() {
            const container = document.getElementById('customerOrderHistory');
            const customer = APP_STATE.customers[APP_STATE.currentUser];
            const customerOrders = APP_STATE.orders.filter(o => o.customerPhone === APP_STATE.currentUser);

            if (customerOrders.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--light-2); padding: var(--spacing-lg);">No orders yet</p>';
                return;
            }

            container.innerHTML = customerOrders.map(order => `
                <div class="order-card">
                    <div class="order-card-header">
                        <div class="order-serial">${order.serialNo}</div>
                        <div class="order-status ${order.status}">${order.status}</div>
                    </div>
                    <div style="font-size: 0.9rem; color: var(--light-2); margin: var(--spacing-sm) 0;">
                        ${new Date(order.createdAt).toLocaleString()}
                    </div>
                    <div style="margin: var(--spacing-sm) 0;">
                        ${order.items.map(item => `${item.name} (${item.quantity})`).join(', ')}
                    </div>
                    <div class="order-total">‚Çπ${order.totalAmount}</div>
                </div>
            `).join('');
        }

        // Outlet Info
        function showOutletInfo() {
            document.getElementById('outletInfoModal').classList.add('active');
        }

        function closeOutletInfo() {
            document.getElementById('outletInfoModal').classList.remove('active');
        }

        function saveContact() {
            showNotification('Contact save functionality would open phone\'s contact app', 'success');
            closeOutletInfo();
        }

        // Admin Functions
        function renderAdminMenu() {
            const container = document.getElementById('adminMenuList');
            
            // Group items by category
            const groupedItems = {};
            APP_STATE.categories.forEach(cat => {
                groupedItems[cat.id] = {
                    category: cat,
                    items: APP_STATE.menu.filter(m => m.category === cat.id)
                };
            });

            container.innerHTML = `
                ${Object.values(groupedItems).map(group => `
                    <div style="margin-bottom: var(--spacing-xl);">
                        <h3 style="font-family: var(--font-display); font-size: 1.3rem; margin-bottom: var(--spacing-md); color: var(--accent);">
                            ${group.category.icon} ${group.category.name}
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: var(--spacing-md);">
                            ${group.items.map(item => `
                                <div class="order-card" style="background: ${item.available ? 'rgba(255, 255, 255, 0.05)' : 'rgba(239, 71, 111, 0.1)'};">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-sm);">
                                        <h4 style="flex: 1;">${item.name}</h4>
                                        <div style="padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 700; 
                                                    background: ${item.available ? 'var(--success)' : 'var(--danger)'}; color: white;">
                                            ${item.available ? 'ACTIVE' : 'INACTIVE'}
                                        </div>
                                    </div>
                                    <div style="color: var(--accent); font-weight: 700; margin-bottom: var(--spacing-md); font-size: 1.2rem;">‚Çπ${item.price}</div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-sm);">
                                        <button class="btn btn-ghost btn-small" onclick="editMenuItem(${item.id})">‚úèÔ∏è Edit</button>
                                        <button class="btn btn-ghost btn-small" onclick="toggleItemAvailability(${item.id})">
                                            ${item.available ? 'üö´ Disable' : '‚úÖ Enable'}
                                        </button>
                                    </div>
                                    <button class="btn btn-danger btn-small" onclick="deleteMenuItem(${item.id})" style="width: 100%; margin-top: var(--spacing-sm);">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            `).join('')}
                            ${group.items.length === 0 ? `
                                <p style="text-align: center; color: var(--light-2); padding: var(--spacing-lg); grid-column: 1/-1;">
                                    No items in this category
                                </p>
                            ` : ''}
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function renderCategoriesList() {
            const container = document.getElementById('categoriesList');
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: var(--spacing-md);">
                    ${APP_STATE.categories.map(cat => {
                        const itemCount = APP_STATE.menu.filter(m => m.category === cat.id).length;
                        return `
                            <div class="order-card" style="background: var(--gradient-primary);">
                                <div style="text-align: center; font-size: 3rem; margin-bottom: var(--spacing-sm);">
                                    ${cat.icon}
                                </div>
                                <h4 style="text-align: center; margin-bottom: var(--spacing-sm); font-size: 1.2rem;">
                                    ${cat.name}
                                </h4>
                                <div style="text-align: center; color: rgba(255,255,255,0.9); margin-bottom: var(--spacing-md); font-size: 0.9rem;">
                                    ${itemCount} item${itemCount !== 1 ? 's' : ''}
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-sm);">
                                    <button class="btn btn-ghost btn-small" onclick="editCategory('${cat.id}')">Edit</button>
                                    <button class="btn btn-danger btn-small" onclick="deleteCategory('${cat.id}')">Delete</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderCustomersList() {
            const container = document.getElementById('customersList');
            container.innerHTML = `
                <div style="display: grid; gap: var(--spacing-md);">
                    ${Object.entries(APP_STATE.customers).map(([phone, customer]) => `
                        <div class="order-card">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4>${customer.name}</h4>
                                    <div style="color: var(--light-2); font-size: 0.9rem;">${phone}</div>
                                </div>
                                <div>
                                    <div style="color: var(--accent); font-weight: 700; font-size: 1.2rem;">${customer.bonusPoints} pts</div>
                                    <div style="font-size: 0.85rem; color: var(--light-2);">Bonus Points</div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderStaffList() {
            const container = document.getElementById('staffList');
            
            // Load staff from Firestore
            if (window.firebaseReady) {
                const { collection, getDocs } = window.firebaseModules;
                getDocs(collection(window.db, 'staff')).then(snapshot => {
                    if (snapshot.empty) {
                        container.innerHTML = '<p style="text-align: center; color: var(--light-2); padding: var(--spacing-lg);">No staff members yet. Add your first staff member!</p>';
                        return;
                    }

                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: var(--spacing-md);">
                            ${snapshot.docs.map(doc => {
                                const staff = doc.data();
                                return `
                                    <div class="order-card">
                                        <h4 style="margin-bottom: var(--spacing-sm);">${staff.name}</h4>
                                        <div style="color: var(--light-2); font-size: 0.9rem; margin-bottom: var(--spacing-sm);">
                                            ${staff.role || 'Staff Member'}
                                        </div>
                                        <div style="color: var(--accent); font-size: 0.85rem; margin-bottom: var(--spacing-md);">
                                            ID: ${doc.id}
                                        </div>
                                        <div style="display: flex; gap: var(--spacing-sm);">
                                            <button class="btn btn-ghost btn-small" onclick="editStaff('${doc.id}', '${staff.name}', '${staff.role || ''}')">Edit</button>
                                            <button class="btn btn-danger btn-small" onclick="deleteStaff('${doc.id}', '${staff.name}')">Delete</button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }).catch(error => {
                    console.error('Error loading staff:', error);
                    container.innerHTML = '<p style="text-align: center; color: var(--danger); padding: var(--spacing-lg);">Error loading staff list</p>';
                });
            } else {
                container.innerHTML = '<p style="text-align: center; color: var(--light-2); padding: var(--spacing-lg);">Loading staff...</p>';
            }
        }

        // Add Staff Modal
        async function showAddStaffModal() {
            const name = prompt('Enter staff name:');
            if (!name) return;

            const role = prompt('Enter role (e.g., Cashier, Manager):') || 'Staff Member';

            try {
                const { collection, doc, setDoc } = window.firebaseModules;
                const staffId = 'staff_' + Date.now();
                const staffRef = doc(window.db, 'staff', staffId);

                await setDoc(staffRef, {
                    name: name,
                    role: role,
                    active: true,
                    createdAt: new Date().toISOString()
                });

                showNotification(`Staff member "${name}" added successfully!`, 'success');
                renderStaffList();
                loadStaffList(); // Refresh dropdown
            } catch (error) {
                console.error('Error adding staff:', error);
                showNotification('Error adding staff: ' + error.message, 'error');
            }
        }

        // Edit Staff
        async function editStaff(staffId, currentName, currentRole) {
            const newName = prompt('Enter new name:', currentName);
            if (!newName) return;

            const newRole = prompt('Enter new role:', currentRole) || 'Staff Member';

            try {
                const { doc, updateDoc } = window.firebaseModules;
                const staffRef = doc(window.db, 'staff', staffId);

                await updateDoc(staffRef, {
                    name: newName,
                    role: newRole
                });

                showNotification('Staff updated successfully!', 'success');
                renderStaffList();
                loadStaffList();
            } catch (error) {
                console.error('Error updating staff:', error);
                showNotification('Error updating staff: ' + error.message, 'error');
            }
        }

        // Delete Staff
        async function deleteStaff(staffId, staffName) {
            const confirm = window.confirm(`Delete staff member "${staffName}"?`);
            if (!confirm) return;

            try {
                const { doc, deleteDoc } = window.firebaseModules;
                const staffRef = doc(window.db, 'staff', staffId);

                await deleteDoc(staffRef);

                showNotification('Staff deleted successfully!', 'success');
                renderStaffList();
                loadStaffList();
            } catch (error) {
                console.error('Error deleting staff:', error);
                showNotification('Error deleting staff: ' + error.message, 'error');
            }
        }

        function sendNotification() {
            const title = document.getElementById('notifTitle').value;
            const message = document.getElementById('notifMessage').value;

            if (!title || !message) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            showNotification('Notification sent to all customers!', 'success');
            document.getElementById('notifTitle').value = '';
            document.getElementById('notifMessage').value = '';
        }

        // Tab Switching
        function switchTab(tab) {
            document.querySelectorAll('#adminPanel .tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            document.querySelectorAll('#adminPanel .tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');

            // Render content when tab is opened
            if (tab === 'categories') {
                renderCategoriesList();
            } else if (tab === 'menu') {
                renderAdminMenu();
            }
        }

        function switchCustomerTab(tab) {
            document.querySelectorAll('#customerPanel .tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            document.querySelectorAll('#customerPanel .tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        // Notification System
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="font-weight: 600; margin-bottom: var(--spacing-xs);">
                    ${type === 'success' ? '‚úì Success' : type === 'error' ? '‚úï Error' : '‚ö† Warning'}
                </div>
                <div>${message}</div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ==================== KOT PRINTING FUNCTIONS ====================

        // Show KOT Print Modal
        function showKOTPrint(orderId) {
            const order = APP_STATE.orders.find(o => o.id === orderId);
            if (!order) return;

            APP_STATE.currentKOTOrder = order;
            renderKOTPreview(order);
            document.getElementById('kotPrintModal').classList.add('active');
        }

        // Close KOT Modal
        function closeKOTModal() {
            document.getElementById('kotPrintModal').classList.remove('active');
            APP_STATE.currentKOTOrder = null;
        }

        // Render KOT Preview
        function renderKOTPreview(order) {
            const container = document.getElementById('kotPreview');
            const now = new Date();
            
            const kotHTML = `
                <div style="text-align: center; border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 10px;">
                    <div style="font-size: 1.3rem; font-weight: bold;">üçπ JUICE THERAPY</div>
                    <div style="font-size: 0.9rem;">Birati, Kolkata</div>
                    <div style="font-size: 1.1rem; font-weight: bold; margin-top: 8px;">-- KITCHEN ORDER TICKET --</div>
                </div>

                <div style="margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span><strong>Order No:</strong> ${order.serialNo}</span>
                        <span><strong>Token:</strong> #${order.id % 100}</span>
                    </div>
                    <div><strong>Date:</strong> ${now.toLocaleDateString('en-IN')}</div>
                    <div><strong>Time:</strong> ${now.toLocaleTimeString('en-IN')}</div>
                    <div><strong>Staff:</strong> ${APP_STATE.currentStaff || 'N/A'}</div>
                </div>

                <div style="border-top: 2px dashed #000; border-bottom: 2px dashed #000; padding: 10px 0; margin: 10px 0;">
                    <div style="font-weight: bold; margin-bottom: 8px;">ITEMS:</div>
                    ${order.items.map(item => `
                        <div style="margin-bottom: 6px;">
                            <div style="display: flex; justify-content: space-between; font-size: 1.1rem;">
                                <span><strong>${item.quantity}x</strong> ${item.name}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div style="text-align: center; margin-top: 15px; padding-top: 10px; border-top: 2px dashed #000;">
                    <div style="font-weight: bold; font-size: 1.1rem;">Total Items: ${order.items.reduce((sum, item) => sum + item.quantity, 0)}</div>
                    <div style="margin-top: 10px; font-size: 0.9rem;">Please prepare this order</div>
                </div>
            `;

            container.innerHTML = kotHTML;
        }

        // Print KOT via Bluetooth Thermal Printer
        async function printKOTBluetooth() {
            const order = APP_STATE.currentKOTOrder;
            if (!order) return;

            try {
                // Request Bluetooth device
                if (!APP_STATE.bluetoothDevice) {
                    showNotification('Connecting to Bluetooth printer...', 'success');
                    
                    const device = await navigator.bluetooth.requestDevice({
                        acceptAllDevices: true,
                        optionalServices: [
                            '000018f0-0000-1000-8000-00805f9b34fb',
                            '49535343-fe7d-4ae5-8fa9-9fafd205e455'
                        ]
                    });

                    const server = await device.gatt.connect();
                    APP_STATE.bluetoothDevice = { device, server };
                    showNotification('Connected to printer!', 'success');
                }

                // Get the printer service and characteristic
                const service = await APP_STATE.bluetoothDevice.server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
                const characteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');

                // Generate ESC/POS commands for thermal printer
                const kotData = generateESCPOSCommands(order);

                // Send data to printer
                await characteristic.writeValue(kotData);

                showNotification('KOT printed successfully!', 'success');
                closeKOTModal();

            } catch (error) {
                console.error('Bluetooth print error:', error);
                
                if (error.message && error.message.includes('User cancelled')) {
                    showNotification('Bluetooth connection cancelled', 'warning');
                } else {
                    showNotification('Bluetooth printing failed. Try browser print instead.', 'error');
                }
            }
        }

        // Generate ESC/POS commands for thermal printer
        function generateESCPOSCommands(order) {
            const encoder = new TextEncoder();
            const ESC = 0x1B;
            const GS = 0x1D;
            const LF = 0x0A;
            const now = new Date();

            // Build command sequence
            let commands = [];

            // Initialize printer
            commands.push(ESC, 0x40);

            // Set alignment to center
            commands.push(ESC, 0x61, 0x01);

            // Bold ON
            commands.push(ESC, 0x45, 0x01);
            commands = commands.concat(Array.from(encoder.encode('JUICE THERAPY\n')));
            commands.push(ESC, 0x45, 0x00); // Bold OFF

            commands = commands.concat(Array.from(encoder.encode('Birati, Kolkata\n')));
            commands.push(LF);

            // Bold ON
            commands.push(ESC, 0x45, 0x01);
            commands = commands.concat(Array.from(encoder.encode('-- KITCHEN ORDER TICKET --\n')));
            commands.push(ESC, 0x45, 0x00); // Bold OFF

            commands = commands.concat(Array.from(encoder.encode('================================\n')));

            // Set alignment to left
            commands.push(ESC, 0x61, 0x00);

            commands = commands.concat(Array.from(encoder.encode(`Order No: ${order.serialNo}\n`)));
            commands = commands.concat(Array.from(encoder.encode(`Token: #${order.id % 100}\n`)));
            commands = commands.concat(Array.from(encoder.encode(`Date: ${now.toLocaleDateString('en-IN')}\n`)));
            commands = commands.concat(Array.from(encoder.encode(`Time: ${now.toLocaleTimeString('en-IN')}\n`)));
            commands = commands.concat(Array.from(encoder.encode(`Staff: ${APP_STATE.currentStaff || 'N/A'}\n`)));

            commands = commands.concat(Array.from(encoder.encode('================================\n')));

            // Bold ON for ITEMS
            commands.push(ESC, 0x45, 0x01);
            commands = commands.concat(Array.from(encoder.encode('ITEMS:\n')));
            commands.push(ESC, 0x45, 0x00); // Bold OFF

            // Print items
            order.items.forEach(item => {
                commands.push(ESC, 0x45, 0x01); // Bold ON
                commands = commands.concat(Array.from(encoder.encode(`${item.quantity}x `)));
                commands.push(ESC, 0x45, 0x00); // Bold OFF
                commands = commands.concat(Array.from(encoder.encode(`${item.name}\n`)));
            });

            commands = commands.concat(Array.from(encoder.encode('================================\n')));

            // Set alignment to center
            commands.push(ESC, 0x61, 0x01);

            const totalItems = order.items.reduce((sum, item) => sum + item.quantity, 0);
            commands.push(ESC, 0x45, 0x01); // Bold ON
            commands = commands.concat(Array.from(encoder.encode(`Total Items: ${totalItems}\n`)));
            commands.push(ESC, 0x45, 0x00); // Bold OFF

            commands.push(LF);
            commands = commands.concat(Array.from(encoder.encode('Please prepare this order\n')));

            // Feed paper
            commands.push(LF, LF, LF);

            // Cut paper (if supported)
            commands.push(GS, 0x56, 0x00);

            return new Uint8Array(commands);
        }

        // Print KOT via Browser Print Dialog
        function printKOTBrowser() {
            const order = APP_STATE.currentKOTOrder;
            if (!order) return;

            const now = new Date();
            const totalItems = order.items.reduce((sum, item) => sum + item.quantity, 0);

            // Create print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>KOT - ${order.serialNo}</title>
                    <style>
                        @page {
                            size: 80mm auto;
                            margin: 5mm;
                        }
                        body {
                            font-family: 'Courier New', monospace;
                            font-size: 12px;
                            line-height: 1.4;
                            margin: 0;
                            padding: 10px;
                        }
                        .center { text-align: center; }
                        .bold { font-weight: bold; }
                        .large { font-size: 14px; }
                        .divider { border-top: 2px dashed #000; margin: 10px 0; }
                        .item { margin: 5px 0; }
                        .qty { font-weight: bold; }
                
        /* Install Banner */
        .install-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--gradient-primary);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-xl);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--spacing-md);
            animation: slideUp 0.5s ease-out;
        }
        .install-text { flex: 1; }
        .install-text h3 { font-size: 1rem; margin-bottom: 4px; }
        .install-text p { font-size: 0.85rem; opacity: 0.9; }
        .install-actions { display: flex; gap: var(--spacing-sm); }

        /* POS Layout */
        .pos-layout {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: var(--spacing-md);
            min-height: 400px;
        }
        .category-sidebar {
            background: rgba(255,255,255,0.03);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
            overflow-y: auto;
        }
        .category-item {
            padding: var(--spacing-md);
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-sm);
            cursor: pointer;
            transition: all var(--transition-base);
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
        }
        .category-item:hover, .category-item.active {
            background: var(--gradient-primary);
            border-color: var(--primary);
            transform: translateX(4px);
        }
        .items-grid-container { overflow-y: auto; max-height: 600px; }
        .items-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-md);
        }
        .pos-top-nav {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            background: var(--gradient-glass);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--radius-lg);
            padding: var(--spacing-sm);
        }
        .pos-nav-btn {
            flex: 1;
            padding: var(--spacing-md);
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: var(--radius-md);
            color: var(--white);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-base);
            font-size: 0.95rem;
            font-family: var(--font-body);
        }
        .pos-nav-btn:hover, .pos-nav-btn.active {
            background: var(--gradient-primary);
            border-color: var(--primary);
        }
        .logo-img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
        }

        /* Mobile Responsive */
        @media (max-width: 1200px) {
            .main-content { grid-template-columns: 1fr; }
        }
        @media (max-width: 1024px) {
            .pos-layout { grid-template-columns: 1fr; }
            .category-sidebar {
                display: flex;
                overflow-x: auto;
                gap: var(--spacing-sm);
            }
            .category-item { min-width: 100px; margin-bottom: 0; }
            .items-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            body { font-size: 14px; }
            .app-container { padding: var(--spacing-sm); }
            .menu-grid { grid-template-columns: repeat(2, 1fr); }
            .card { padding: var(--spacing-md); }
            .logo-img { width: 50px; height: 50px; }
            .install-banner { flex-direction: column; text-align: center; }
        }
        @media (max-width: 640px) {
            .items-grid { grid-template-columns: 1fr; }
            .pos-top-nav { flex-direction: column; }
        }
    </style>
                </head>
                <body>
                    <div class="center">
                        <div class="bold large">üçπ JUICE THERAPY</div>
                        <div>Birati, Kolkata</div>
                        <div class="bold" style="margin-top: 8px;">-- KITCHEN ORDER TICKET --</div>
                    </div>
                    
                    <div class="divider"></div>
                    
                    <div>
                        <div><span class="bold">Order No:</span> ${order.serialNo}</div>
                        <div><span class="bold">Token:</span> #${order.id % 100}</div>
                        <div><span class="bold">Date:</span> ${now.toLocaleDateString('en-IN')}</div>
                        <div><span class="bold">Time:</span> ${now.toLocaleTimeString('en-IN')}</div>
                        <div><span class="bold">Staff:</span> ${APP_STATE.currentStaff || 'N/A'}</div>
                    </div>
                    
                    <div class="divider"></div>
                    
                    <div class="bold">ITEMS:</div>
                    ${order.items.map(item => `
                        <div class="item">
                            <span class="qty">${item.quantity}x</span> ${item.name}
                        </div>
                    `).join('')}
                    
                    <div class="divider"></div>
                    
                    <div class="center">
                        <div class="bold">Total Items: ${totalItems}</div>
                        <div style="margin-top: 10px;">Please prepare this order</div>
                    </div>
                
    <!-- Install Banner -->
    <div id="installBanner" class="install-banner hidden">
        <div class="install-text">
            <h3>üì± Install App</h3>
            <p>Add to home screen for quick access</p>
        </div>
        <div class="install-actions">
            <button class="btn btn-primary btn-small" onclick="installApp()">Install</button>
            <button class="btn btn-ghost btn-small" onclick="dismissInstall()">Later</button>
        </div>
    </div>

</body>
                </html>
            `);

            printWindow.document.close();
            
            // Wait for content to load, then print
            setTimeout(() => {
                printWindow.print();
                setTimeout(() => printWindow.close(), 500);
            }, 250);

            closeKOTModal();
            showNotification('Print dialog opened', 'success');
        }

        // Share KOT (via WhatsApp or other apps)
        async function shareKOT() {
            const order = APP_STATE.currentKOTOrder;
            if (!order) return;

            const now = new Date();
            const totalItems = order.items.reduce((sum, item) => sum + item.quantity, 0);

            const kotText = `üçπ *JUICE THERAPY*
Birati, Kolkata

*-- KITCHEN ORDER TICKET --*

Order No: ${order.serialNo}
Token: #${order.id % 100}
Date: ${now.toLocaleDateString('en-IN')}
Time: ${now.toLocaleTimeString('en-IN')}
Staff: ${APP_STATE.currentStaff || 'N/A'}

*ITEMS:*
${order.items.map(item => `*${item.quantity}x* ${item.name}`).join('\n')}

*Total Items: ${totalItems}*

Please prepare this order`;

            if (navigator.share) {
                try {
                    await navigator.share({
                        title: `KOT - ${order.serialNo}`,
                        text: kotText
                    });
                    showNotification('KOT shared successfully!', 'success');
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.error('Share error:', error);
                    }
                }
            } else {
                // Fallback: Copy to clipboard
                navigator.clipboard.writeText(kotText);
                showNotification('KOT copied to clipboard!', 'success');
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            console.log('üçπ Juice Therapy POS System Loaded');
            initializeApp();
            handleAccountTypeChange();
        });
    

        // ========================================
        // ENHANCED FUNCTIONS - ALL REQUIREMENTS
        // ========================================
        
        // PWA Install
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if (!localStorage.getItem('installDismissed')) {
                document.getElementById('installBanner')?.classList.remove('hidden');
            }
        });
        async function installApp() {
            if (!deferredPrompt) {
                showNotification('Install not available', 'error');
                return;
            }
            document.getElementById('installBanner')?.classList.add('hidden');
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') showNotification('Installed!', 'success');
            deferredPrompt = null;
        }
        function dismissInstall() {
            document.getElementById('installBanner')?.classList.add('hidden');
            localStorage.setItem('installDismissed', 'true');
        }

        // Global state additions
        APP_STATE.selectedCategory = 'all';
        APP_STATE.editingItemId = null;
        APP_STATE.completedOrders = [];

        // POS Section Navigation
        function showPOSSection(section) {
            document.querySelectorAll('.pos-nav-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            ['posSection', 'currentOrdersSection', 'completedOrdersSection'].forEach(s => {
                document.getElementById(s)?.classList.add('hidden');
            });
            if (section === 'pos') {
                document.getElementById('posSection')?.classList.remove('hidden');
                renderOutletMenu();
            } else if (section === 'current') {
                document.getElementById('currentOrdersSection')?.classList.remove('hidden');
                loadCurrentOrders();
            } else if (section === 'completed') {
                document.getElementById('completedOrdersSection')?.classList.remove('hidden');
                loadTodayCompleted();
            }
        }

        // Render outlet menu with categories
        function renderOutletMenu() {
            const catList = document.getElementById('outletCategoryList');
            const grid = document.getElementById('outletMenuGrid');
            if (!catList || !grid) return;
            
            const cats = [...new Set(APP_STATE.menu.map(i => i.category || 'other'))];
            let catHTML = '<div class="category-item active" onclick="filterOutletCategory('all')">All</div>';
            APP_STATE.categories.forEach(cat => {
                if (cats.includes(cat.id)) {
                    catHTML += `<div class="category-item" onclick="filterOutletCategory('${cat.id}')">${cat.icon || ''} ${cat.name}</div>`;
                }
            });
            catList.innerHTML = catHTML;
            filterOutletCategory('all');
        }

        function filterOutletCategory(catId) {
            APP_STATE.selectedCategory = catId;
            document.querySelectorAll('.category-item').forEach(el => el.classList.remove('active'));
            event?.target?.classList.add('active');
            
            const grid = document.getElementById('outletMenuGrid');
            if (!grid) return;
            
            const items = catId === 'all' 
                ? APP_STATE.menu.filter(i => i.available !== false)
                : APP_STATE.menu.filter(i => i.category === catId && i.available !== false);
            
            let html = '';
            items.forEach(item => {
                const inOrder = APP_STATE.currentOrder.find(o => o.id === item.id);
                const qty = inOrder ? inOrder.quantity : 0;
                html += `
                    <div class="menu-item ${qty > 0 ? 'selected' : ''}" onclick="toggleMenuItem('${item.id}')">
                        <div class="menu-item-name">${item.name}</div>
                        <div class="menu-item-price">‚Çπ${item.price}</div>
                        ${qty > 0 ? `<div style="margin-top:8px;padding:4px 8px;background:var(--accent);color:var(--dark);border-radius:4px;font-weight:700;font-size:0.85rem;">Qty: ${qty}</div>` : ''}
                    </div>
                `;
            });
            grid.innerHTML = html || '<p style="padding:40px;text-align:center;grid-column:1/-1;">No items</p>';
        }

        // Current orders
        async function loadCurrentOrders() {
            try {
                const { collection, query, where, getDocs, orderBy } = window.firebaseModules;
                const q = query(collection(window.db, 'orders'), where('status', 'in', ['pending', 'approved']), orderBy('createdAt', 'desc'));
                const snap = await getDocs(q);
                const orders = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                renderCurrentOrders(orders);
            } catch (e) {
                console.error(e);
                document.getElementById('currentOrdersList').innerHTML = '<p style="padding:20px;text-align:center;">Error loading</p>';
            }
        }

        function renderCurrentOrders(orders) {
            const el = document.getElementById('currentOrdersList');
            if (!el) return;
            if (!orders.length) {
                el.innerHTML = '<p style="padding:40px;text-align:center;">No orders</p>';
                return;
            }
            let html = '';
            orders.forEach(ord => {
                const time = ord.createdAt?.toDate ? ord.createdAt.toDate().toLocaleTimeString('en-IN', {hour:'2-digit',minute:'2-digit'}) : 'N/A';
                const items = ord.items?.reduce((s,i) => s + (i.quantity||0), 0) || 0;
                html += `
                    <div class="order-card">
                        <div class="order-card-header">
                            <span class="order-serial">${ord.serialNo||'N/A'}</span>
                            <span class="order-status ${ord.status}">${(ord.status||'pending').toUpperCase()}</span>
                        </div>
                        <div>üìû ${ord.customerId||'N/A'}</div>
                        <div style="font-size:0.85rem;color:var(--light-2);margin:4px 0;">‚è∞ ${time} ‚Ä¢ ${items} items</div>
                        <div class="order-total">‚Çπ${(ord.total||0).toFixed(2)}</div>
                        <button class="btn btn-small btn-success" onclick="completeOrder('${ord.id}')" style="margin-top:12px;width:100%;">Complete</button>
                    </div>
                `;
            });
            el.innerHTML = html;
        }

        async function completeOrder(orderId) {
            if (!confirm('Complete this order?')) return;
            try {
                const { doc, updateDoc } = window.firebaseModules;
                await updateDoc(doc(window.db, 'orders', orderId), {status: 'completed', completedAt: new Date().toISOString()});
                showNotification('Order completed!', 'success');
                loadCurrentOrders();
            } catch (e) {
                console.error(e);
                showNotification('Failed to complete', 'error');
            }
        }

        // Completed orders
        async function loadTodayCompleted() {
            try {
                const { collection, query, where, getDocs, orderBy, Timestamp } = window.firebaseModules;
                const today = new Date();
                today.setHours(0,0,0,0);
                const q = query(collection(window.db, 'orders'), where('status', '==', 'completed'), where('createdAt', '>=', Timestamp.fromDate(today)), orderBy('createdAt', 'desc'));
                const snap = await getDocs(q);
                const orders = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                APP_STATE.completedOrders = orders;
                renderCompletedOrders(orders);
            } catch (e) {
                console.error(e);
                document.getElementById('completedOrdersList').innerHTML = '<p style="padding:20px;text-align:center;">Error</p>';
            }
        }

        function renderCompletedOrders(orders) {
            const el = document.getElementById('completedOrdersList');
            if (!el) return;
            if (!orders.length) {
                el.innerHTML = '<p style="padding:40px;text-align:center;">No completed orders today</p>';
                return;
            }
            let html = '';
            orders.forEach(ord => {
                const time = ord.createdAt?.toDate ? ord.createdAt.toDate().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'}) : 'N/A';
                const items = ord.items?.reduce((s,i) => s + (i.quantity||0), 0) || 0;
                html += `
                    <div class="order-card">
                        <div class="order-card-header">
                            <span class="order-serial">${ord.serialNo||'N/A'}</span>
                            <span class="order-status completed">COMPLETED</span>
                        </div>
                        <div>üìû ${ord.customerId||'N/A'}</div>
                        <div style="font-size:0.85rem;color:var(--light-2);margin:4px 0;">‚è∞ ${time} ‚Ä¢ ${items} items</div>
                        <div class="order-total">‚Çπ${(ord.total||0).toFixed(2)}</div>
                        <button class="btn btn-small btn-primary" onclick="sendWhatsAppBill('${ord.id}','${ord.customerId}')" style="margin-top:12px;width:100%;">üì± WhatsApp Bill</button>
                    </div>
                `;
            });
            el.innerHTML = html;
        }

        function sendWhatsAppBill(orderId, phone) {
            const ord = APP_STATE.completedOrders?.find(o => o.id === orderId);
            if (!ord) return;
            let bill = `üçπ *JUICE THERAPY*\nBill: ${ord.serialNo||'N/A'}\nüìû ${ord.customerId||'N/A'}\n\n*ITEMS:*\n`;
            (ord.items||[]).forEach(i => {
                bill += `${i.quantity}x ${i.name} - ‚Çπ${(i.price*i.quantity).toFixed(2)}\n`;
            });
            bill += `\n*TOTAL: ‚Çπ${(ord.total||0).toFixed(2)}*\n\nThank you! üôè`;
            window.open(`https://wa.me/91${phone}?text=${encodeURIComponent(bill)}`, '_blank');
            showNotification('Opening WhatsApp...', 'success');
        }

        // Edit menu item
        function showEditItemModal(itemId) {
            const item = APP_STATE.menu.find(i => i.id === itemId);
            if (!item) return;
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemPrice').value = item.price;
            document.getElementById('itemCategory').value = item.category || '';
            document.getElementById('itemAvailable').checked = item.available !== false;
            APP_STATE.editingItemId = itemId;
            const modal = document.getElementById('addItemModal');
            modal.querySelector('.modal-title').textContent = 'Edit Item';
            const btn = modal.querySelector('.btn-primary');
            btn.textContent = 'Update';
            btn.onclick = () => updateMenuItem(itemId);
            modal.classList.add('active');
        }

        async function updateMenuItem(itemId) {
            const name = document.getElementById('itemName').value.trim();
            const price = parseFloat(document.getElementById('itemPrice').value);
            const category = document.getElementById('itemCategory').value;
            const available = document.getElementById('itemAvailable').checked;
            if (!name || !price || price <= 0) {
                showNotification('Invalid input', 'error');
                return;
            }
            try {
                const { doc, updateDoc } = window.firebaseModules;
                await updateDoc(doc(window.db, 'menu', itemId), {name, price, category: category||null, available});
                showNotification('Updated!', 'success');
                closeAddItemModal();
                await loadMenuItems();
                renderAdminMenu();
            } catch (e) {
                console.error(e);
                showNotification('Update failed', 'error');
            }
        }

        // Delete category properly
        async function deleteCategory(categoryId) {
            if (!confirm('Delete category? Items will be uncategorized.')) return;
            try {
                const { doc, deleteDoc, query, collection, where, getDocs, updateDoc } = window.firebaseModules;
                await deleteDoc(doc(window.db, 'categories', categoryId));
                const q = query(collection(window.db, 'menu'), where('category', '==', categoryId));
                const snap = await getDocs(q);
                await Promise.all(snap.docs.map(d => updateDoc(d.ref, {category: null})));
                showNotification('Deleted', 'success');
                await loadCategories();
                await loadMenuItems();
                renderAdminCategories();
                renderAdminMenu();
            } catch (e) {
                console.error(e);
                showNotification('Delete failed: ' + e.message, 'error');
            }
        }

        // Override placeOrder for auto-customer creation
        const originalPlaceOrder = window.placeOrder || function() {};
        window.placeOrder = async function() {
            const phoneInput = document.getElementById('customerPhone');
            const phone = phoneInput?.value.trim();
            if (!phone || phone.length !== 10 || !/^[0-9]+$/.test(phone)) {
                showNotification('Enter valid 10-digit phone number', 'error');
                phoneInput?.focus();
                return;
            }
            if (APP_STATE.currentOrder.length === 0) {
                showNotification('Add items to order', 'error');
                return;
            }
            try {
                const { doc, getDoc, setDoc, collection, addDoc, serverTimestamp, updateDoc, increment } = window.firebaseModules;
                const custRef = doc(window.db, 'customers', phone);
                const custSnap = await getDoc(custRef);
                if (!custSnap.exists()) {
                    await setDoc(custRef, {
                        phone,
                        name: `Guest ${phone.slice(-4)}`,
                        totalSpent: 0,
                        totalOrders: 0,
                        bonusPoints: 0,
                        createdAt: serverTimestamp()
                    });
                    showNotification('New customer created', 'success');
                }
                const subtotal = APP_STATE.currentOrder.reduce((s,i) => s + (i.price * i.quantity), 0);
                const bonusEarned = Math.floor(subtotal / 100);
                const orderData = {
                    customerId: phone,
                    items: APP_STATE.currentOrder,
                    subtotal,
                    total: subtotal,
                    bonusUsed: 0,
                    bonusEarned,
                    status: 'pending',
                    outletId: APP_STATE.currentOutlet || 'main',
                    staffName: APP_STATE.currentStaff || 'Staff',
                    createdAt: serverTimestamp(),
                    serialNo: `JT${Date.now().toString().slice(-6)}`
                };
                const orderRef = await addDoc(collection(window.db, 'orders'), orderData);
                await updateDoc(custRef, {totalOrders: increment(1)});
                showNotification('Order placed! üéâ', 'success');
                APP_STATE.currentOrder = [];
                phoneInput.value = '';
                renderCurrentOrder();
                APP_STATE.currentKOTOrder = {...orderData, id: orderRef.id};
                showKOTModal();
            } catch (e) {
                console.error(e);
                showNotification('Failed: ' + e.message, 'error');
            }
        };

        // Initialize outlet POS on login
        const originalLogin = window.login || function() {};
        window.login = async function() {
            await originalLogin();
            // If outlet user logged in, initialize menu
            setTimeout(() => {
                if (document.getElementById('outletPanel')?.classList.contains('hidden') === false) {
                    renderOutletMenu();
                }
            }, 500);
        };

</script>

    <!-- Install Banner -->
    <div id="installBanner" class="install-banner hidden">
        <div class="install-text">
            <h3>üì± Install App</h3>
            <p>Add to home screen for quick access</p>
        </div>
        <div class="install-actions">
            <button class="btn btn-primary btn-small" onclick="installApp()">Install</button>
            <button class="btn btn-ghost btn-small" onclick="dismissInstall()">Later</button>
        </div>
    </div>

</body>
</html>
